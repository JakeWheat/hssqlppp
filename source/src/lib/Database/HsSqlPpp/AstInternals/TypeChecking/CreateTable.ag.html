<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >CreateTable</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >{-</p
    ><p
    >This file contains the code for typechecking create table statements (and also create table as statements). It's pretty limited at the moment, the bits that work are:</p
    ><p
    >gathers enough information to add the table attributes types to the catalog</p
    ><p
    >typechecks row check constraints properly, but table check constraints and all other constraints are not checked at all.</p
    ><p
    >doesn't check for duplicate attribute names. doesn't check if the types are valid for a table (e.g. disallow setof types)</p
    ><p
    >We produce a valid catalog update if the types of the attributes check ok, any errors in the constraints aren't leaked.</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">


<span class="ConId">ATTR</span> <span class="ConId">AttributeDef</span> <span class="Symbol">[||</span><span class="VarId">attrName</span> <span class="Symbol">:</span> <span class="ConId">String</span>
                     <span class="VarId">namedType</span> <span class="Symbol">:</span> <span class="Symbol">{</span><span class="ConId">Maybe</span> <span class="ConId">Type</span><span class="Symbol">}]</span>

<span class="ConId">ATTR</span> <span class="ConId">AttributeDefList</span> <span class="Symbol">[||</span><span class="VarId">attrs</span> <span class="Symbol">:</span> <span class="Symbol">{[(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="ConId">Maybe</span> <span class="ConId">Type</span><span class="Symbol">)]}]</span>


<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">CreateTable</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span>
            <span class="Symbol">[</span><span class="ConId">CatCreateTable</span> <span class="Symbol">@</span><span class="VarId">name</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="VarId">defaultSystemColumns</span><span class="Symbol">]</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="Symbol">:</span> <span class="Symbol">{[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]}</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="Symbol">=</span> <span class="VarId">mapMaybe</span> <span class="VarId">okAt</span> <span class="Symbol">@</span><span class="VarId">atts</span><span class="Symbol">.</span><span class="VarId">attrs</span>
                    <span class="Keyword">where</span>
                      <span class="VarId">okAt</span> <span class="Symbol">(</span><span class="VarId">s</span><span class="Symbol">,</span> <span class="ConId">Just</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">s</span><span class="Symbol">,</span><span class="VarId">t</span><span class="Symbol">)</span>
                      <span class="VarId">okAt</span> <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="ConId">Nothing</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>

        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">CreateTable</span> <span class="Symbol">@</span><span class="VarId">ann</span>
                                   <span class="Symbol">@</span><span class="VarId">name</span>
                                   <span class="Symbol">@</span><span class="VarId">atts</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                                   <span class="Symbol">@</span><span class="VarId">cons</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">cons</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span>
                          <span class="Symbol">(</span><span class="ConId">LBIds</span> <span class="String">&quot;attributedefs&quot;</span> <span class="ConId">Nothing</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span><span class="Symbol">)</span>
                          <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Keyword">of</span>
                      <span class="ConId">Left</span> <span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;statement-createtable-cons.lib &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span>
                      <span class="ConId">Right</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">e</span>

<span class="Symbol">{</span>
<span class="Function">defaultSystemColumns</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
<span class="Function">defaultSystemColumns</span> <span class="Symbol">=</span> <span class="Symbol">[(</span><span class="String">&quot;tableoid&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;oid&quot;</span><span class="Symbol">)</span>
                       <span class="Symbol">,(</span><span class="String">&quot;cmax&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;cid&quot;</span><span class="Symbol">)</span>
                       <span class="Symbol">,(</span><span class="String">&quot;xmax&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;xid&quot;</span><span class="Symbol">)</span>
                       <span class="Symbol">,(</span><span class="String">&quot;cmin&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;cid&quot;</span><span class="Symbol">)</span>
                       <span class="Symbol">,(</span><span class="String">&quot;xmin&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;xid&quot;</span><span class="Symbol">)</span>
                       <span class="Symbol">,(</span><span class="String">&quot;ctid&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;tid&quot;</span><span class="Symbol">)]</span>
<span class="Symbol">}</span>


<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">CreateTableAs</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="ConId">CompositeType</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">expr</span><span class="Symbol">.</span><span class="VarId">uType</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span>
           <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="Symbol">[])</span> <span class="VarId">id</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
           <span class="VarId">ats</span> <span class="Symbol">&lt;-</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span>
           <span class="VarId">return</span> <span class="Symbol">[</span><span class="ConId">CatCreateTable</span> <span class="Symbol">@</span><span class="VarId">name</span> <span class="VarId">ats</span> <span class="VarId">defaultSystemColumns</span><span class="Symbol">]</span>

        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="Symbol">:</span> <span class="Symbol">{</span><span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]}</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="Symbol">=</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">expr</span><span class="Symbol">.</span><span class="VarId">uType</span>

        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">CreateTableAs</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">name</span> <span class="Symbol">@</span><span class="VarId">expr</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>

</pre></div></div></div><p
    >{- attribute name and type gathering -}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">


<span class="ConId">SEM</span> <span class="ConId">AttributeDef</span>
    <span class="Symbol">|</span> <span class="ConId">AttributeDef</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">attrName</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="Symbol">@</span><span class="VarId">name</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">namedType</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">typ</span><span class="Symbol">.</span><span class="VarId">namedType</span>


<span class="ConId">SEM</span> <span class="ConId">AttributeDefList</span>
    <span class="Symbol">|</span> <span class="ConId">Cons</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="Symbol">=</span> <span class="Symbol">(@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">attrName</span><span class="Symbol">,</span> <span class="Symbol">@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">namedType</span><span class="Symbol">)</span> <span class="Symbol">:</span> <span class="Symbol">@</span><span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">attrs</span>
    <span class="Symbol">|</span> <span class="ConId">Nil</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>

</pre></div></div></div><p
    >{- row check constraint: inject the column name and type into the column constraints -}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">SEM</span> <span class="ConId">AttributeDef</span>
    <span class="Symbol">|</span> <span class="ConId">AttributeDef</span>
        <span class="VarId">cons</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span><span class="Symbol">)</span> <span class="VarId">id</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                   <span class="VarId">t</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">typ</span><span class="Symbol">.</span><span class="VarId">namedType</span>
                   <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span>
                            <span class="Symbol">(</span><span class="ConId">LBIds</span> <span class="String">&quot;attribute def&quot;</span> <span class="ConId">Nothing</span>
                                   <span class="Symbol">[(@</span><span class="VarId">name</span><span class="Symbol">,</span> <span class="VarId">t</span><span class="Symbol">)])</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span>


</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
