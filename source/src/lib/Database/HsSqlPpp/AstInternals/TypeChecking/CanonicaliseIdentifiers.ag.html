<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >CanonicaliseIdentifiers</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >{-</p
    ><p
    >This is the code to canonicalise the identifiers.</p
    ><p
    >Basically, this adds range qualifiers to all identifiers where it makes sense. We don't do any errors at this stage, so ambiguous and unrecognised identifiers are left as is for the type checking phase to deal with. This is mainly so we don't change the type of the annotation on the tree.</p
    ><p
    >In addition, star expansion (only when referred to at top level select list or equivalent, count(*) and other stars are left for the type checker) is done here. If e.g. order by 3,1 like syntax is needed, then this can be fixed up here also.</p
    ><p
    >We need the the sources of identifiers from the catalog: tables, views, functions.</p
    ><p
    >Identifiers are added to the environment only in table refs (I think there are a few more places, e.g. refering to the name of a column in a select list in a order by or similar, these aren't currently supported, need to get a comprehensive list of these first).</p
    ><p
    >Identifiers are qualified straightforwardly in:</p
    ><p
    >select lists wheres group bys havings order bys</p
    ><p
    >All of the above use the same environment which comes out of the top level trefs in a statement.</p
    ><p
    >Identifiers in on expressions in joins need to be fixed up also, they use an environment which is local to that join.</p
    ><p
    >Identifiers in a using join aren't changed, since they refer to either table.</p
    ><p
    >How exactly is the environment updated?</p
    ><p
    >Vanilla tref, subtref and trefun all set the exact environment.</p
    ><p
    >For joins: the two environments are combined (this goes into the onexpr). If there is a table name alias, then the aliases are replaced. If there are column aliases as well, then the whole lot gets replaced with these.</p
    ><p
    >===================================================</p
    ><p
    >= environment: data type, read api, update api</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="Symbol">{</span>

<span class="Keyword">data</span> <span class="ConId">Environment</span> <span class="Symbol">=</span> <span class="ConId">Environment</span> <span class="ConId">Int</span>

<span class="Function">qualifyID</span> <span class="Symbol">::</span> <span class="ConId">Environment</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="ConId">Maybe</span> <span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">String</span><span class="Symbol">)</span>
<span class="Function">qualifyID</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>

<span class="Function">makeEnvironment</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Comment">-- range qualifier</span>
                <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Comment">-- attribute names</span>
                <span class="Symbol">-&gt;</span> <span class="ConId">Environment</span>
<span class="Function">makeEnvironment</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>

<span class="Function">emptyEnvironment</span> <span class="Symbol">::</span> <span class="ConId">Environment</span>
<span class="Function">emptyEnvironment</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>

<span class="Function">unimplementedEnvironment</span> <span class="Symbol">::</span> <span class="ConId">Environment</span>
<span class="Function">unimplementedEnvironment</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>


<span class="Function">joinEnvironments</span> <span class="Symbol">::</span> <span class="ConId">Environment</span> <span class="Symbol">-&gt;</span> <span class="ConId">Environment</span> <span class="Symbol">-&gt;</span> <span class="ConId">Environment</span>
<span class="Function">joinEnvironments</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>

<span class="Function">aliasEnvironmentRangeName</span> <span class="Symbol">::</span> <span class="ConId">Environment</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Environment</span>
<span class="Function">aliasEnvironmentRangeName</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>

<span class="Function">expandStar</span> <span class="Symbol">::</span> <span class="ConId">Environment</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Comment">--qualifier</span>
           <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">expandStar</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>

<span class="Symbol">}</span>

</pre></div></div></div><p
    >{-</p
    ><p
    >= Creating environments</p
    ><p
    >environments are created in trefs, and also select lists (to support subtref).</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">ATTR</span> <span class="ConId">TableRef</span> <span class="ConId">SelectList</span>
         <span class="Symbol">[</span>
         <span class="Symbol">|</span>
         <span class="Symbol">|</span> <span class="VarId">cenv</span> <span class="Symbol">:</span> <span class="ConId">Environment</span>
         <span class="Symbol">]</span>

<span class="ConId">SEM</span> <span class="ConId">TableRef</span>
    <span class="Symbol">|</span> <span class="ConId">Tref</span> <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">fields</span> <span class="Symbol">=</span> <span class="VarId">getTableFields</span> <span class="Symbol">@</span><span class="VarId">tbl</span>
    <span class="Symbol">|</span> <span class="ConId">JoinTref</span> <span class="ConId">SubTref</span> <span class="ConId">FunTref</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="VarId">unimplementedEnvironment</span>

<span class="ConId">SEM</span> <span class="ConId">SelectList</span>
    <span class="Symbol">|</span> <span class="ConId">SelectList</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="VarId">unimplementedEnvironment</span>

<span class="Symbol">{</span>
<span class="Function">getTableFields</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">getTableFields</span> <span class="Symbol">=</span> <span class="VarId">undefined</span>
<span class="Symbol">}</span>

</pre></div></div></div><p
    >{-</p
    ><p
    >= Passing environments around</p
    ><p
    >Passing up: * through nested trefs * from trefs to selects * from select lists -&gt; select -&gt; wrapping subtref -}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">ATTR</span> <span class="ConId">TableRefList</span> <span class="ConId">QueryExpr</span>
         <span class="Symbol">[</span>
         <span class="Symbol">|</span>
         <span class="Symbol">|</span> <span class="VarId">cenv</span> <span class="Symbol">:</span> <span class="ConId">Environment</span>
         <span class="Symbol">]</span>

<span class="ConId">SEM</span> <span class="ConId">TableRefList</span>
    <span class="Symbol">|</span> <span class="ConId">Cons</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="VarId">joinEnvironments</span> <span class="Symbol">@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">@</span><span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">cenv</span>
    <span class="Symbol">|</span> <span class="ConId">Nil</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="VarId">emptyEnvironment</span>

<span class="ConId">SEM</span> <span class="ConId">QueryExpr</span>
    <span class="Symbol">|</span> <span class="ConId">Select</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">selSelectList</span><span class="Symbol">.</span><span class="VarId">cenv</span>
    <span class="Symbol">|</span> <span class="ConId">CombineSelect</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">sel1</span><span class="Symbol">.</span><span class="VarId">cenv</span>
    <span class="Symbol">|</span> <span class="ConId">Values</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="VarId">unimplementedEnvironment</span>
    <span class="Symbol">|</span> <span class="ConId">WithSelect</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cenv</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">cenv</span>


</pre></div></div></div><p
    >{-</p
    ><p
    >== Passing down</p
    ><ul
    ><li
      >from jointref to onexpr</li
      ><li
      >from select to (select list, where, group by, having, order by</li
      ><li
      >through scalar expression trees</li
      ></ul
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">ATTR</span> <span class="ConId">OnExpr</span> <span class="ConId">JoinExpr</span> <span class="ConId">ScalarExpr</span>
         <span class="Symbol">[</span> <span class="VarId">env</span> <span class="Symbol">:</span> <span class="ConId">Environment</span>
         <span class="Symbol">|</span>
         <span class="Symbol">|</span>
         <span class="Symbol">]</span>

<span class="ConId">SEM</span> <span class="ConId">TableRef</span>
    <span class="Symbol">|</span> <span class="ConId">JoinTref</span> <span class="VarId">onExpr</span><span class="Symbol">.</span><span class="VarId">env</span> <span class="Symbol">=</span> <span class="VarId">unimplementedEnvironment</span>


<span class="Comment">-- this is where the environment from the top level tref in a query</span>
<span class="Comment">-- expression is sent back down into the select list, where, etc.</span>

<span class="ConId">SEM</span> <span class="ConId">QueryExpr</span>
    <span class="Symbol">|</span> <span class="ConId">Select</span> <span class="VarId">selSelectList</span><span class="Symbol">.</span><span class="VarId">env</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">selTref</span><span class="Symbol">.</span><span class="VarId">cenv</span>
             <span class="VarId">selWhere</span><span class="Symbol">.</span><span class="VarId">env</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">selTref</span><span class="Symbol">.</span><span class="VarId">cenv</span>
             <span class="VarId">selGroupBy</span><span class="Symbol">.</span><span class="VarId">env</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">selTref</span><span class="Symbol">.</span><span class="VarId">cenv</span>
             <span class="VarId">selHaving</span><span class="Symbol">.</span><span class="VarId">env</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">selTref</span><span class="Symbol">.</span><span class="VarId">cenv</span>
             <span class="VarId">selOrderBy</span><span class="Symbol">.</span><span class="VarId">env</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">selTref</span><span class="Symbol">.</span><span class="VarId">cenv</span>

</pre></div></div></div><p
    >{-</p
    ><p
    >= Accessing environments</p
    ><p
    >Environment is used to fix up identifiers in scalar expressions.</p
    ><p
    >For adding qualifiers, all the identifiers in a scalar expression are updated the same.</p
    ><p
    >The roots are: Select.selSelectList -&gt; SelectItemList -&gt; (SelEx,SelectItem).ex Select.selWhere MaybeBoolExpression Select.selGroupBy -&gt; ExpressionList Select.selHaving -&gt; MaybeBoolExpression Select.setOrdereBy -&gt; ExpressionDirectionPairList JoinedTref.onExpr</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="Symbol">{</span>



<span class="Symbol">}</span>

<span class="ConId">ATTR</span> <span class="ConId">Root</span> <span class="ConId">AllNodes</span> <span class="Symbol">[</span> <span class="Comment">--cat : Catalog</span>
                   <span class="Symbol">|</span>
                   <span class="Symbol">|</span> <span class="VarId">canonicalisedIdentifiersTree</span> <span class="Symbol">:</span> <span class="ConId">SELF</span>
                   <span class="Symbol">]</span>

<span class="Symbol">{</span>
<span class="Function">canonicaliseIdentifiers</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">QueryExpr</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">QueryExpr</span><span class="Symbol">]</span>
<span class="Function">canonicaliseIdentifiers</span> <span class="VarId">cat</span> <span class="VarId">sts</span> <span class="Symbol">=</span>
    <span class="Keyword">let</span> <span class="VarId">t</span> <span class="Symbol">=</span> <span class="VarId">sem_Root</span> <span class="Symbol">(</span><span class="ConId">Root</span> <span class="VarId">sts</span><span class="Symbol">)</span>
        <span class="VarId">ta</span> <span class="Symbol">=</span> <span class="VarId">wrap_Root</span> <span class="VarId">t</span> <span class="ConId">Inh_Root</span> <span class="Symbol">{</span><span class="VarId">cat_Inh_Root</span> <span class="Symbol">=</span> <span class="VarId">cat</span><span class="Symbol">}</span>
        <span class="VarId">tl</span> <span class="Symbol">=</span> <span class="VarId">canonicalisedIdentifiersTree_Syn_Root</span> <span class="VarId">ta</span>
    <span class="Keyword">in</span> <span class="Keyword">case</span> <span class="VarId">tl</span> <span class="Keyword">of</span>
         <span class="ConId">Root</span> <span class="VarId">r</span> <span class="Symbol">-&gt;</span> <span class="VarId">r</span>

<span class="Symbol">}</span>
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
