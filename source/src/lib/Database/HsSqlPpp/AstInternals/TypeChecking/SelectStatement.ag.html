<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >SelectStatement</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >{-</p
    ><p
    >= basic select statements</p
    ><p
    >This is a bit of a mess, will be rewritten with a proper literate flavour once all the different bits are type checking ok, which should make it much more readable.</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">SelectStatement</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span>
            <span class="Keyword">do</span>
            <span class="VarId">pt</span> <span class="Symbol">&lt;-</span> <span class="VarId">sequence</span> <span class="Symbol">$</span> <span class="VarId">getPlaceholderTypes</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
            <span class="VarId">st</span> <span class="Symbol">&lt;-</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">uType</span>
            <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">pt</span>
                   <span class="Symbol">,</span><span class="Keyword">case</span> <span class="VarId">st</span> <span class="Keyword">of</span>
                      <span class="Symbol">[(</span><span class="VarId">_</span><span class="Symbol">,(</span><span class="ConId">Pseudo</span> <span class="ConId">Void</span><span class="Symbol">))]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[]</span>
                      <span class="VarId">t</span> <span class="Symbol">-&gt;</span> <span class="VarId">t</span><span class="Symbol">)</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">SelectStatement</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>

<span class="ConId">SEM</span> <span class="ConId">SelectExpression</span>
    <span class="Symbol">|</span> <span class="ConId">Values</span> <span class="ConId">Select</span> <span class="ConId">CombineSelect</span> <span class="ConId">WithSelect</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">:</span> <span class="ConId">Et</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">=</span> <span class="VarId">setTypeAddErrors</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span>

</pre></div></div></div><p
    >{-</p
    ><p
    >================================================================================</p
    ><p
    >Type checking select expressions</p
    ><p
    >The main issue is the complicated flow of identifier bindings through the various parts. This is the rough order in which this happens:</p
    ><p
    >with from where groupby having select combine orderby limit</p
    ><p
    >if a type error occurs, we want to give up on any following stages, rather than create loads of type errors (maybe this could be refined more).</p
    ><p
    >The select list produces the final type which the selectexpression has.</p
    ><p
    >inside the from, if we have any join expressions we need to pass the types from the joined trefs to the join expressions.</p
    ><p
    >So, the basic plan is to propagate the iden bindings in the cat attribute as elsewhere, and also pass along a flag to say whether the previous stage type checked or not, so we can bail if it has failed.</p
    ><p
    >alternative idea: explore transforming the ast for a select expression into something using relational algebra-like operations - can then follow the flow of ids easily. The problem might be with updating the annotations in the original tree though.</p
    ><p
    >== cat passing current bodge</p
    ><p
    >cat flow: current simple version: from tref -&gt; select list -&gt; where</p
    ><p
    >(so we take the identifiers and types from the tref part, and send them into the selectlist and where parts)</p
    ><p
    >full order of identifier passing: 1. from 2. where 3. group by 4. having 5. select</p
    ><p
    >group by notes, from the pg manual: group by expressions can be an input column name, or the name or ordinal number of an output column (SELECT list item), or an arbitrary expression formed from input-column values. In case of ambiguity, a GROUP BY name will be interpreted as an input-column name rather than an output column name.</p
    ><p
    >For now, just send the input columns in as identifiers -}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">SEM</span> <span class="ConId">SelectExpression</span>
    <span class="Symbol">|</span> <span class="ConId">Select</span>
         <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">foldM</span> <span class="Symbol">(</span><span class="VarId">flip</span> <span class="Symbol">$</span> <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span><span class="Symbol">)</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">@</span><span class="VarId">selTref</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Keyword">of</span>
                        <span class="ConId">Left</span> <span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;selectexpression-select-loc.newlib &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span> <span class="Comment">-- @lhs.cat</span>
                        <span class="ConId">Right</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">e</span>
         <span class="VarId">selSelectList</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span>
         <span class="VarId">selWhere</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span>
         <span class="VarId">selGroupBy</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span>
         <span class="VarId">selOrderBy</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span>

<span class="ConId">ATTR</span> <span class="ConId">SelectExpression</span> <span class="Symbol">[||</span><span class="VarId">libUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">LocalBindingsUpdate</span><span class="Symbol">]}</span>
                         <span class="VarId">uType</span> <span class="Symbol">:</span> <span class="Symbol">{</span><span class="ConId">Maybe</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]}]</span>

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">SelectStatement</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">libUpdates</span>

<span class="ConId">SEM</span> <span class="ConId">SelectExpression</span>
    <span class="Symbol">|</span> <span class="ConId">Values</span> <span class="ConId">CombineSelect</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
    <span class="Symbol">|</span> <span class="ConId">Select</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">selSelectList</span><span class="Symbol">.</span><span class="VarId">libUpdates</span>
    <span class="Symbol">|</span> <span class="ConId">WithSelect</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">libUpdates</span>


<span class="ConId">SEM</span> <span class="ConId">SelectExpression</span>
    <span class="Symbol">|</span> <span class="ConId">Values</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="VarId">typeCheckValuesExpr</span>
                              <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span>
                              <span class="Symbol">@</span><span class="VarId">vll</span><span class="Symbol">.</span><span class="VarId">uType</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">Values</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">vll</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
    <span class="Symbol">|</span> <span class="ConId">Select</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span>
            <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="ConId">SetOfType</span> <span class="Symbol">$</span> <span class="ConId">CompositeType</span> <span class="Symbol">@</span><span class="VarId">selSelectList</span><span class="Symbol">.</span><span class="VarId">listType</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">Select</span> <span class="Symbol">@</span><span class="VarId">ann</span>
                              <span class="Symbol">@</span><span class="VarId">selDistinct</span>
                              <span class="Symbol">@</span><span class="VarId">selSelectList</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                              <span class="Symbol">@</span><span class="VarId">selTref</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                              <span class="Symbol">@</span><span class="VarId">selWhere</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                              <span class="Symbol">@</span><span class="VarId">selGroupBy</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                              <span class="Symbol">@</span><span class="VarId">selHaving</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                              <span class="Symbol">@</span><span class="VarId">selOrderBy</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                              <span class="Symbol">@</span><span class="VarId">selLimit</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                              <span class="Symbol">@</span><span class="VarId">selOffset</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
    <span class="Symbol">|</span> <span class="ConId">CombineSelect</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span>
          <span class="Keyword">do</span>
          <span class="VarId">sel1t</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">((</span><span class="ConId">SetOfType</span> <span class="Symbol">.</span> <span class="ConId">CompositeType</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">@</span><span class="VarId">sel1</span><span class="Symbol">.</span><span class="VarId">uType</span><span class="Symbol">)</span>
          <span class="VarId">sel2t</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">((</span><span class="ConId">SetOfType</span> <span class="Symbol">.</span> <span class="ConId">CompositeType</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">@</span><span class="VarId">sel2</span><span class="Symbol">.</span><span class="VarId">uType</span><span class="Symbol">)</span>
          <span class="VarId">typeCheckCombineSelect</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="VarId">sel1t</span> <span class="VarId">sel2t</span>

        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">CombineSelect</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">ctype</span>
                                     <span class="Symbol">@</span><span class="VarId">sel1</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                                     <span class="Symbol">@</span><span class="VarId">sel2</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
    <span class="Symbol">|</span> <span class="ConId">WithSelect</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="VarId">lmt</span> <span class="Symbol">((</span><span class="ConId">SetOfType</span> <span class="Symbol">.</span> <span class="ConId">CompositeType</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">uType</span><span class="Symbol">)</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">WithSelect</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">withs</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">withs</span><span class="Symbol">.</span><span class="VarId">producedCat</span>
        <span class="VarId">withs</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>

<span class="ConId">SEM</span> <span class="ConId">SelectExpression</span>
    <span class="Symbol">|</span> <span class="ConId">Values</span> <span class="ConId">CombineSelect</span> <span class="ConId">WithSelect</span> <span class="ConId">Select</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">uType</span> <span class="Symbol">=</span> <span class="VarId">etmt</span> <span class="Symbol">(@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">&gt;&gt;=</span> <span class="VarId">unwrapSetOfComposite</span><span class="Symbol">)</span>

<span class="Symbol">{</span>

<span class="Function">typeCheckValuesExpr</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[[</span><span class="ConId">Maybe</span> <span class="ConId">Type</span><span class="Symbol">]]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Type</span>
<span class="Function">typeCheckValuesExpr</span> <span class="VarId">cat</span> <span class="VarId">rowsTs</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
        <span class="VarId">rts</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">$</span> <span class="VarId">allJust</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">allJust</span> <span class="VarId">rowsTs</span>
        <span class="Keyword">let</span> <span class="VarId">colNames</span> <span class="Symbol">=</span> <span class="VarId">zipWith</span> <span class="Symbol">(++)</span>
                           <span class="Symbol">(</span><span class="VarId">repeat</span> <span class="String">&quot;column&quot;</span><span class="Symbol">)</span>
                           <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">show</span> <span class="Symbol">[</span><span class="Number">1</span><span class="Symbol">..</span><span class="VarId">length</span> <span class="Symbol">$</span> <span class="VarId">head</span> <span class="VarId">rowsTs</span><span class="Symbol">])</span>
        <span class="VarId">unionRelTypes</span> <span class="VarId">cat</span> <span class="VarId">rts</span> <span class="VarId">colNames</span>


<span class="Function">typeCheckCombineSelect</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Type</span>
<span class="Function">typeCheckCombineSelect</span> <span class="VarId">cat</span> <span class="VarId">v1</span> <span class="VarId">v2</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
    <span class="VarId">u1</span> <span class="Symbol">&lt;-</span> <span class="VarId">unwrapSetOfComposite</span> <span class="VarId">v1</span>
    <span class="Keyword">let</span> <span class="VarId">colNames</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">fst</span> <span class="VarId">u1</span>
    <span class="VarId">u2</span> <span class="Symbol">&lt;-</span> <span class="VarId">unwrapSetOfComposite</span> <span class="VarId">v2</span>
    <span class="Keyword">let</span> <span class="VarId">colTypes1</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">snd</span> <span class="VarId">u1</span>
    <span class="Keyword">let</span> <span class="VarId">colTypes2</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">snd</span> <span class="VarId">u2</span>
    <span class="VarId">unionRelTypes</span> <span class="VarId">cat</span> <span class="Symbol">[</span><span class="VarId">colTypes1</span><span class="Symbol">,</span><span class="VarId">colTypes2</span><span class="Symbol">]</span> <span class="VarId">colNames</span>

<span class="Function">unionRelTypes</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[[</span><span class="ConId">Type</span><span class="Symbol">]]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Type</span>
<span class="Function">unionRelTypes</span> <span class="VarId">cat</span> <span class="VarId">rowsTs</span> <span class="VarId">colNames</span> <span class="Symbol">=</span>
  <span class="Keyword">let</span> <span class="VarId">lengths</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">length</span> <span class="VarId">rowsTs</span>
  <span class="Keyword">in</span> <span class="Keyword">case</span> <span class="Symbol">()</span> <span class="Keyword">of</span>
             <span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">null</span> <span class="VarId">rowsTs</span> <span class="Symbol">-&gt;</span>
                   <span class="ConId">Left</span> <span class="Symbol">[</span><span class="ConId">NoRowsGivenForValues</span><span class="Symbol">]</span>
               <span class="Symbol">|</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="VarId">all</span> <span class="Symbol">(==</span><span class="VarId">head</span> <span class="VarId">lengths</span><span class="Symbol">)</span> <span class="VarId">lengths</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span>
                   <span class="ConId">Left</span> <span class="Symbol">[</span><span class="ConId">ValuesListsMustBeSameLength</span><span class="Symbol">]</span>
               <span class="Symbol">|</span> <span class="VarId">otherwise</span> <span class="Symbol">-&gt;</span>
                   <span class="Comment">--i don't think this propagates all the errors, just the first set</span>
                   <span class="VarId">mapM</span> <span class="Symbol">(</span><span class="VarId">resolveResultSetType</span> <span class="VarId">cat</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">transpose</span> <span class="VarId">rowsTs</span><span class="Symbol">)</span> <span class="Symbol">&gt;&gt;=</span>
                     <span class="Symbol">(</span><span class="VarId">return</span> <span class="Symbol">.</span> <span class="ConId">SetOfType</span> <span class="Symbol">.</span> <span class="ConId">CompositeType</span> <span class="Symbol">.</span> <span class="VarId">zip</span> <span class="VarId">colNames</span><span class="Symbol">)</span>

<span class="Symbol">}</span>
</pre></div></div></div><p
    >{- with queries:</p
    ><p
    >reuse the catalog to store the individual with queries as views, so it works as if we're transforming</p
    ><p
    >with a as select_a ,b as select_b ... select_final</p
    ><p
    >to</p
    ><p
    >create view a as select_a create view b as select_b ... select_final</p
    ><p
    >this is slightly hacky - the temporary view definitions should really live in the local identifier bindings rather than the catalog, but does the job without having to alter the local identifier bindings types and functions.</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">ATTR</span> <span class="ConId">WithQuery</span> <span class="Symbol">[||</span><span class="VarId">catUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]}]</span>
<span class="ConId">ATTR</span> <span class="ConId">WithQueryList</span> <span class="Symbol">[</span><span class="VarId">catUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]}||]</span>

<span class="Comment">--producedcat is used to pass the final updated cat out</span>
<span class="ConId">ATTR</span> <span class="ConId">WithQueryList</span> <span class="Symbol">[||</span> <span class="VarId">producedCat</span> <span class="Symbol">:</span> <span class="ConId">Catalog</span><span class="Symbol">]</span>

<span class="ConId">SEM</span> <span class="ConId">WithQueryList</span>
    <span class="Symbol">|</span> <span class="ConId">Cons</span> <span class="ConId">Nil</span>
        <span class="Comment">--newcat is the catalog passed into the head statement</span>
        <span class="Comment">--updated with any catalog changes that that statement has made</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span> <span class="Symbol">=</span> <span class="VarId">fromRight</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">$</span> <span class="VarId">updateCatalog</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">catUpdates</span>
    <span class="Symbol">|</span> <span class="ConId">Cons</span>
        <span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span>
        <span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span>
        <span class="Comment">--produced cat is used to chain the final updated catalog from the last</span>
        <span class="Comment">--element of the list and pass it back up the list so in can be pushed up</span>
        <span class="Comment">-- to the root element and sent out from there</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">producedCat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">producedCat</span>
        <span class="Comment">--this is probably a bit inefficient: it creates a new catalog from scratch</span>
        <span class="Comment">--on each statement instead of chaining on the last updated cat</span>
        <span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">catUpdates</span>
    <span class="Symbol">|</span> <span class="ConId">Nil</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">producedCat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span>

<span class="ConId">SEM</span> <span class="ConId">WithQuery</span>
    <span class="Symbol">|</span> <span class="ConId">WithQuery</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">WithQuery</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">name</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span> <span class="Symbol">=</span> <span class="VarId">maybe</span> <span class="Symbol">[]</span> <span class="VarId">id</span> <span class="Symbol">$</span> <span class="Symbol">@</span><span class="VarId">ex</span><span class="Symbol">.</span><span class="VarId">uType</span> <span class="Comment">--</span><span class="Alert">TODO:</span><span class="Comment"> error ignored</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="ConId">CatCreateView</span> <span class="Symbol">@</span><span class="VarId">name</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">attrs</span><span class="Symbol">]</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>



<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/TableRefs.ag&quot;</span>

<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/SelectLists.ag&quot;</span>
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
