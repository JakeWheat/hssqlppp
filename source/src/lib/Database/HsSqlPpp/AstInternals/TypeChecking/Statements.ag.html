<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Statements</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >{-</p
    ><p
    >This file contains the general code for statements and statement lists, and includes the ag files for various flavours of statement.</p
    ><p
    >The attributes and sem statements in this file are for chaining the cat updates as we progress through a statement list, and for producing the resultant cat after we've checked a whole ast, this can be used e.g. to type check multiple files in a row which depend on eachother.</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="Comment">-- cat updates syn attr is used by each statement to report</span>
<span class="Comment">-- what changes it makes to the catalog, we use this to update</span>
<span class="Comment">-- the cat to feed into the next statement</span>

<span class="ConId">ATTR</span> <span class="ConId">Statement</span> <span class="Symbol">[||</span><span class="VarId">catUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]}</span>
                  <span class="VarId">libUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">LocalBindingsUpdate</span><span class="Symbol">]}]</span>


<span class="ConId">ATTR</span> <span class="ConId">StatementList</span> <span class="Symbol">[</span><span class="VarId">catUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]}</span>
                    <span class="VarId">libUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">LocalBindingsUpdate</span><span class="Symbol">]}||]</span>


<span class="Comment">--producedcat is used to pass the final updated cat out</span>
<span class="ConId">ATTR</span> <span class="ConId">StatementList</span> <span class="ConId">Root</span> <span class="Symbol">[||</span> <span class="VarId">producedCat</span> <span class="Symbol">:</span> <span class="ConId">Catalog</span>
                            <span class="VarId">producedLib</span> <span class="Symbol">:</span> <span class="ConId">LocalBindings</span><span class="Symbol">]</span>

<span class="ConId">ATTR</span> <span class="ConId">Statement</span> <span class="Symbol">[</span><span class="VarId">inProducedCat</span><span class="Symbol">:</span> <span class="ConId">Catalog</span><span class="Symbol">||]</span>

</pre></div></div></div><p
    >{-</p
    ><p
    >Not sure if there is a better way of doing this: what we want to do is to pass in a starting catalog to a list of statements, then add the catalog updates from each statement in order before passing the catalog onto the next statement, and then return the final catalog out the list again.</p
    ><p
    >to pass it from statement to statement, updating as we go, first take the catalog from the statement list and pass it into the head of the list. This head then produces an updated catalog which we pass to the tail. This tail is another list of statements so we just repeat until we get to the end. Then we pass the catalog that made it to the end back up the statement list</p
    ><p
    >localbindings are also updated here - I think the only thing this is used for is to track the actual composite type of a variable declared with record type</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="ConId">SEM</span> <span class="ConId">StatementList</span>
    <span class="Symbol">|</span> <span class="ConId">Cons</span> <span class="ConId">Nil</span>
        <span class="Comment">--newcat is the catalog passed into the head statement</span>
        <span class="Comment">--updated with any catalog changes that that statement has made</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span> <span class="Symbol">=</span> <span class="VarId">fromRight</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">$</span> <span class="VarId">updateCatalog</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">catUpdates</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span> <span class="Symbol">=</span> <span class="VarId">fromRight</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">$</span> <span class="VarId">foldM</span> <span class="Symbol">(</span><span class="VarId">flip</span> <span class="Symbol">$</span> <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span><span class="Symbol">)</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">libUpdates</span>
    <span class="Symbol">|</span> <span class="ConId">Cons</span>
        <span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span>
        <span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span>
        <span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span>
        <span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span>
        <span class="Comment">--produced cat is used to chain the final updated catalog from the last</span>
        <span class="Comment">--element of the list and pass it back up the list so in can be pushed up</span>
        <span class="Comment">-- to the root element and sent out from there</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">producedCat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">producedCat</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">producedLib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">producedLib</span>
        <span class="Comment">--this is probably a bit inefficient: it creates a new catalog from scratch</span>
        <span class="Comment">--on each statement instead of chaining on the last updated cat</span>
        <span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">catUpdates</span>
        <span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">libUpdates</span>
    <span class="Symbol">|</span> <span class="ConId">Nil</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">producedCat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newCat</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">producedLib</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">newLib</span>

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">SelectStatement</span> <span class="ConId">Insert</span> <span class="ConId">Update</span> <span class="ConId">Delete</span> <span class="ConId">CreateView</span> <span class="ConId">CreateDomain</span> <span class="ConId">CreateLanguage</span>
      <span class="ConId">CreateFunction</span> <span class="ConId">CreateType</span> <span class="ConId">CreateTable</span> <span class="ConId">CreateTableAs</span> <span class="ConId">Return</span> <span class="ConId">Assignment</span>
      <span class="ConId">ForSelectStatement</span> <span class="ConId">ForIntegerStatement</span> <span class="ConId">DropFunction</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">:</span> <span class="Symbol">{</span><span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Type</span><span class="Symbol">}</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">:</span> <span class="Symbol">{</span><span class="ConId">Maybe</span> <span class="ConId">StatementType</span><span class="Symbol">}</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">=</span>
            <span class="VarId">updateAnnotation</span>
                <span class="Symbol">(\</span><span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span> <span class="Symbol">{</span><span class="VarId">stType</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span>
                         <span class="Symbol">,</span><span class="VarId">catUpd</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span><span class="Symbol">})</span> <span class="Symbol">$</span>
            <span class="VarId">setTypeAddErrors</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">:</span> <span class="Symbol">{[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]}</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">libUpdates</span>
    <span class="Symbol">|</span> <span class="ConId">Insert</span> <span class="ConId">Update</span> <span class="ConId">Delete</span> <span class="ConId">CreateView</span> <span class="ConId">CreateDomain</span>
      <span class="ConId">CreateFunction</span> <span class="ConId">CreateType</span> <span class="ConId">CreateTable</span> <span class="ConId">CreateTableAs</span> <span class="ConId">Return</span>
      <span class="ConId">Assignment</span> <span class="ConId">ForSelectStatement</span> <span class="ConId">ForIntegerStatement</span> <span class="ConId">Set</span> <span class="ConId">CreateLanguage</span>
      <span class="ConId">Notify</span> <span class="ConId">CreateSequence</span> <span class="ConId">AlterSequence</span> <span class="ConId">DropFunction</span> <span class="ConId">Block</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>

<span class="ConId">SEM</span> <span class="ConId">StatementList</span>
    <span class="Symbol">|</span> <span class="ConId">Cons</span> <span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">inProducedCat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">producedCat</span>

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">Block</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
            <span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
<span class="ConId">SEM</span> <span class="ConId">FnBody</span>
    <span class="Symbol">|</span> <span class="ConId">PlpgsqlFnBody</span>
        <span class="VarId">blk</span><span class="Symbol">.</span><span class="VarId">inProducedCat</span> <span class="Symbol">=</span> <span class="VarId">emptyCatalog</span>

<span class="ConId">SEM</span> <span class="ConId">Root</span>
    <span class="Symbol">|</span> <span class="ConId">Root</span> <span class="VarId">statements</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
           <span class="VarId">statements</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">CaseStatement</span> <span class="ConId">CaseStatementSimple</span> <span class="ConId">ContinueStatement</span> <span class="ConId">Copy</span> <span class="ConId">CopyData</span>
      <span class="ConId">DropSomething</span> <span class="ConId">Execute</span> <span class="ConId">ExecuteInto</span>
      <span class="ConId">If</span> <span class="ConId">NullStatement</span> <span class="ConId">ExitStatement</span> <span class="ConId">Perform</span> <span class="ConId">Raise</span> <span class="ConId">ReturnNext</span> <span class="ConId">ReturnQuery</span> <span class="ConId">Truncate</span>
      <span class="ConId">WhileStatement</span> <span class="ConId">Set</span> <span class="ConId">Notify</span> <span class="ConId">CreateSequence</span> <span class="ConId">LoopStatement</span>
      <span class="ConId">AlterSequence</span> <span class="ConId">AlterTable</span> <span class="ConId">CreateTrigger</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>

<span class="ConId">SEM</span> <span class="ConId">ExpressionListStatementListPair</span>
    <span class="Symbol">|</span> <span class="ConId">Tuple</span>
        <span class="VarId">x2</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">x2</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
<span class="ConId">SEM</span> <span class="ConId">ExpressionStatementListPair</span>
    <span class="Symbol">|</span> <span class="ConId">Tuple</span>
        <span class="VarId">x2</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">x2</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
<span class="ConId">SEM</span> <span class="ConId">FnBody</span>
    <span class="Symbol">|</span> <span class="ConId">SqlFnBody</span>
        <span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">CaseStatement</span> <span class="ConId">CaseStatementSimple</span> <span class="ConId">If</span>
        <span class="VarId">els</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">els</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">ForIntegerStatement</span> <span class="ConId">ForSelectStatement</span> <span class="ConId">WhileStatement</span> <span class="ConId">LoopStatement</span>
        <span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">libUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>



<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/SelectStatement.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/Insert.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/Update.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/Delete.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/CreateTable.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/MiscCreates.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/CreateFunction.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/Block.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/Triggers.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/Drops.ag&quot;</span>
<span class="ConId">INCLUDE</span> <span class="String">&quot;TypeChecking/Plpgsql.ag&quot;</span>

</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
