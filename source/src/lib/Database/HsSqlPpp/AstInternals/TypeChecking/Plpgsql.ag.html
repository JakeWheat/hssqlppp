<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Plpgsql</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >{-</p
    ><p
    >This file contains the checking code for a few plpgsql statements.</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="Comment">--todo: check return type consistent with function return type</span>
<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">Return</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="VarId">maybe</span> <span class="Symbol">(</span><span class="ConId">Right</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span><span class="Symbol">)</span> <span class="ConId">Right</span> <span class="Symbol">@</span><span class="VarId">value</span><span class="Symbol">.</span><span class="VarId">uType</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">Return</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">value</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>


<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">Assignment</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span>
            <span class="Keyword">do</span>
            <span class="VarId">fromType</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">value</span><span class="Symbol">.</span><span class="VarId">uType</span>
            <span class="VarId">toType</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">target</span><span class="Symbol">.</span><span class="VarId">uType</span> <span class="Comment">--unwrapLookup &lt;$&gt; lbLookupID @lhs.lib (getName @target.annotatedTree)</span>
            <span class="VarId">checkAssignmentValid</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="VarId">fromType</span> <span class="VarId">toType</span>
            <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">Assignment</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">target</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">@</span><span class="VarId">value</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">ForIntegerStatement</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span>
          <span class="Keyword">do</span>
          <span class="VarId">fromType</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">from</span><span class="Symbol">.</span><span class="VarId">uType</span>
          <span class="VarId">toType</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">to</span><span class="Symbol">.</span><span class="VarId">uType</span>
          <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">fromType</span> <span class="Symbol">/=</span> <span class="VarId">toType</span><span class="Symbol">)</span> <span class="Symbol">[</span><span class="ConId">FromToTypesNotSame</span> <span class="VarId">fromType</span> <span class="VarId">toType</span><span class="Symbol">]</span>
          <span class="Keyword">case</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">uType</span> <span class="Keyword">of</span>
            <span class="ConId">Just</span> <span class="VarId">t</span> <span class="Symbol">-&gt;</span> <span class="VarId">checkAssignmentValid</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="VarId">fromType</span> <span class="VarId">t</span>
            <span class="ConId">Nothing</span> <span class="Symbol">-&gt;</span> <span class="VarId">return</span> <span class="Symbol">()</span>
          <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">implicitVar</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Keyword">of</span> <span class="Comment">-- pretty hacky</span>
                              <span class="ConId">Identifier</span> <span class="VarId">a</span> <span class="VarId">i</span> <span class="Symbol">|</span> <span class="VarId">errs</span> <span class="VarId">a</span> <span class="Symbol">==</span> <span class="Symbol">[</span><span class="ConId">UnrecognisedIdentifier</span> <span class="VarId">i</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">True</span>
                              <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">False</span>
        <span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span>
            <span class="Keyword">if</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">implicitVar</span>
            <span class="Keyword">then</span> <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span><span class="Symbol">)</span> <span class="VarId">id</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                 <span class="VarId">ft</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">from</span><span class="Symbol">.</span><span class="VarId">uType</span>
                 <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span>
                    <span class="Symbol">(</span><span class="ConId">LBIds</span> <span class="String">&quot;local for loop variable&quot;</span> <span class="ConId">Nothing</span> <span class="Symbol">[((</span><span class="VarId">getName</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span><span class="Symbol">),</span><span class="VarId">ft</span><span class="Symbol">)])</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span>
            <span class="Keyword">else</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span>

        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span>
            <span class="Keyword">let</span> <span class="VarId">i</span> <span class="Symbol">=</span> <span class="Keyword">if</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">implicitVar</span>
                    <span class="Keyword">then</span> <span class="Keyword">let</span> <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">a</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                         <span class="Keyword">in</span> <span class="ConId">Identifier</span> <span class="VarId">a</span> <span class="Symbol">{</span> <span class="VarId">errs</span> <span class="Symbol">=</span> <span class="Symbol">[]}</span> <span class="VarId">i</span>
                    <span class="Keyword">else</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
            <span class="Keyword">in</span> <span class="ConId">ForIntegerStatement</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">lb</span> <span class="VarId">i</span> <span class="Symbol">@</span><span class="VarId">from</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">@</span><span class="VarId">to</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">@</span><span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>


<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">ForSelectStatement</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span>
          <span class="Keyword">do</span>
          <span class="VarId">st</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">(</span><span class="ConId">CompositeType</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">@</span><span class="VarId">sel</span><span class="Symbol">.</span><span class="VarId">uType</span><span class="Symbol">)</span>
          <span class="VarId">toType</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">uType</span>
          <span class="VarId">checkAssignmentValid</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="VarId">st</span> <span class="VarId">toType</span>
          <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span>
        <span class="Comment">--just handles assigning to a record type for now</span>
        <span class="Comment">--one thing that isn't quite right is that the record variable</span>
        <span class="Comment">--holds the last row in it after the for statement, which isn't</span>
        <span class="Comment">--supported here</span>
        <span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span>
            <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span><span class="Symbol">)</span> <span class="VarId">id</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
            <span class="VarId">_</span> <span class="Symbol">&lt;-</span> <span class="Symbol">@</span><span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span>
            <span class="VarId">st</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">(</span><span class="ConId">CompositeType</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">@</span><span class="VarId">sel</span><span class="Symbol">.</span><span class="VarId">uType</span><span class="Symbol">)</span>
            <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">LBIds</span> <span class="String">&quot;for loop record type&quot;</span> <span class="ConId">Nothing</span> <span class="Symbol">[(</span><span class="VarId">getName</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span><span class="Symbol">,</span><span class="VarId">st</span><span class="Symbol">)])</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span>

        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">ForSelectStatement</span> <span class="Symbol">@</span><span class="VarId">ann</span> <span class="Symbol">@</span><span class="VarId">lb</span> <span class="Symbol">@</span><span class="VarId">var</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">@</span><span class="VarId">sel</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span> <span class="Symbol">@</span><span class="VarId">sts</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>

</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
