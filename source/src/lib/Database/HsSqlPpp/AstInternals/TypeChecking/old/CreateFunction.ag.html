<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >CreateFunction</title
    ><link href="../../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >{-</p
    ><p
    >This file contains the ag code for create function statements.</p
    ><pre
    ><code
      >| CreateFunction ann:Annotation
                 name : String
                 params : ParamDefList
                 rettype : TypeName
                 rep : Replace
                 lang : Language
                 body : FnBody
                 vol : Volatility
</code
      ></pre
    ><p
    >DATA FnBody | SqlFnBody ann:Annotation sts : StatementList | PlpgsqlFnBody ann:Annotation vars:VarDefList sts : StatementList</p
    ><p
    >DATA ParamDef | ParamDef ann:Annotation name:String typ:TypeName | ParamDefTp ann:Annotation typ:TypeName</p
    ><p
    >DATA VarDef | VarDef ann:Annotation name : String typ : TypeName value : (Maybe Expression)</p
    ><p
    >paramdeflist: need cat, produces lb vardef needs cat, produces lb function body: gets cat and new lb</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Symbol">{</span>
<span class="Keyword">data</span> <span class="ConId">ParamName</span> <span class="Symbol">=</span> <span class="ConId">NamedParam</span> <span class="ConId">Int</span> <span class="ConId">String</span>
               <span class="Symbol">|</span> <span class="ConId">UnnamedParam</span> <span class="ConId">Int</span>
<span class="Symbol">}</span>

<span class="ConId">ATTR</span> <span class="ConId">ParamDef</span> <span class="Symbol">[</span><span class="VarId">pos</span> <span class="Symbol">:</span> <span class="ConId">Int</span><span class="Symbol">||</span><span class="VarId">paramName</span> <span class="Symbol">:</span> <span class="ConId">ParamName</span>
                          <span class="VarId">namedType</span> <span class="Symbol">:</span> <span class="Symbol">{</span><span class="ConId">Maybe</span> <span class="ConId">Type</span><span class="Symbol">}]</span>

<span class="ConId">ATTR</span> <span class="ConId">ParamDefList</span> <span class="Symbol">[</span><span class="VarId">pos</span> <span class="Symbol">:</span> <span class="ConId">Int</span><span class="Symbol">||</span><span class="VarId">params</span> <span class="Symbol">:</span> <span class="Symbol">{[(</span><span class="ConId">ParamName</span><span class="Symbol">,</span> <span class="ConId">Maybe</span> <span class="ConId">Type</span><span class="Symbol">)]}]</span>


<span class="Comment">-- collect the information to update the local bindings from the parameters</span>
<span class="ConId">SEM</span> <span class="ConId">ParamDef</span>
    <span class="Symbol">|</span> <span class="ConId">ParamDef</span> <span class="ConId">ParamDefTp</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">namedType</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">typ</span><span class="Symbol">.</span><span class="VarId">namedType</span>
    <span class="Symbol">|</span> <span class="ConId">ParamDef</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">paramName</span> <span class="Symbol">=</span> <span class="ConId">NamedParam</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">pos</span> <span class="Symbol">@</span><span class="VarId">name</span>
    <span class="Symbol">|</span> <span class="ConId">ParamDefTp</span>
        <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">paramName</span> <span class="Symbol">=</span> <span class="ConId">UnnamedParam</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">pos</span>

<span class="ConId">SEM</span> <span class="ConId">ParamDefList</span>
     <span class="Symbol">|</span> <span class="ConId">Nil</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">params</span> <span class="Symbol">=</span> <span class="Symbol">[]</span>
     <span class="Symbol">|</span> <span class="ConId">Cons</span> <span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">params</span> <span class="Symbol">=</span> <span class="Symbol">((@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">paramName</span><span class="Symbol">,</span> <span class="Symbol">@</span><span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">namedType</span><span class="Symbol">)</span> <span class="Symbol">:</span> <span class="Symbol">@</span><span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">params</span><span class="Symbol">)</span>
            <span class="VarId">hd</span><span class="Symbol">.</span><span class="VarId">pos</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">pos</span>
            <span class="VarId">tl</span><span class="Symbol">.</span><span class="VarId">pos</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">pos</span> <span class="Symbol">+</span> <span class="Number">1</span>

<span class="Comment">-- create the new local bindings and pass into the function body</span>
<span class="Comment">-- just</span>

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">CreateFunction</span>
        <span class="Comment">--add the parameters to the catalog for the contained statements</span>
        <span class="VarId">body</span><span class="Symbol">.</span><span class="VarId">lib</span> <span class="Symbol">=</span> <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span><span class="Symbol">)</span> <span class="VarId">id</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                   <span class="VarId">_</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">rettype</span><span class="Symbol">.</span><span class="VarId">namedType</span>
                   <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">LBIds</span> <span class="Symbol">(@</span><span class="VarId">name</span> <span class="Symbol">++</span> <span class="String">&quot; parameters&quot;</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="ConId">Just</span> <span class="Symbol">@</span><span class="VarId">name</span><span class="Symbol">)</span> <span class="VarId">paramsNoPos</span><span class="Symbol">)</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">lib</span>
                   <span class="Symbol">&gt;&gt;=</span> <span class="VarId">lbUpdate</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">LBIds</span> <span class="Symbol">(@</span><span class="VarId">name</span> <span class="Symbol">++</span> <span class="String">&quot; parameters&quot;</span><span class="Symbol">)</span> <span class="ConId">Nothing</span> <span class="VarId">paramsPosOnly</span><span class="Symbol">)</span>
                   <span class="Keyword">where</span>
                     <span class="VarId">paramsPosOnly</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
                     <span class="VarId">paramsPosOnly</span> <span class="Symbol">=</span> <span class="VarId">mapMaybe</span> <span class="VarId">prm</span> <span class="Symbol">@</span><span class="VarId">params</span><span class="Symbol">.</span><span class="VarId">params</span>
                     <span class="VarId">prm</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">ParamName</span><span class="Symbol">,</span><span class="ConId">Maybe</span> <span class="ConId">Type</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)</span>
                     <span class="VarId">prm</span> <span class="Symbol">(</span><span class="ConId">NamedParam</span> <span class="VarId">p</span> <span class="VarId">_</span><span class="Symbol">,</span><span class="ConId">Just</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="String">&quot;$&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">p</span><span class="Symbol">,</span> <span class="VarId">t</span><span class="Symbol">)</span>
                     <span class="VarId">prm</span> <span class="Symbol">(</span><span class="ConId">UnnamedParam</span> <span class="VarId">p</span><span class="Symbol">,</span><span class="ConId">Just</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="String">&quot;$&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">p</span><span class="Symbol">,</span> <span class="VarId">t</span><span class="Symbol">)</span>
                     <span class="VarId">prm</span> <span class="VarId">_</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>
                     <span class="VarId">paramsNoPos</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
                     <span class="VarId">paramsNoPos</span> <span class="Symbol">=</span> <span class="VarId">mapMaybe</span> <span class="VarId">pnp</span> <span class="Symbol">@</span><span class="VarId">params</span><span class="Symbol">.</span><span class="VarId">params</span>
                     <span class="VarId">pnp</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">ParamName</span><span class="Symbol">,</span><span class="ConId">Maybe</span> <span class="ConId">Type</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)</span>
                     <span class="VarId">pnp</span> <span class="Symbol">(</span><span class="ConId">NamedParam</span> <span class="VarId">_</span> <span class="VarId">n</span><span class="Symbol">,</span><span class="ConId">Just</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">n</span><span class="Symbol">,</span><span class="VarId">t</span><span class="Symbol">)</span>
                     <span class="VarId">pnp</span> <span class="VarId">_</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>
        <span class="VarId">params</span><span class="Symbol">.</span><span class="VarId">pos</span> <span class="Symbol">=</span> <span class="Number">1</span>

</pre></div></div></div><p
    >{- boilerplate</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

<span class="ConId">SEM</span> <span class="ConId">Statement</span>
    <span class="Symbol">|</span> <span class="ConId">CreateFunction</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">tpe</span> <span class="Symbol">=</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Void</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="Symbol">[])</span> <span class="VarId">id</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                         <span class="Keyword">let</span> <span class="VarId">ps</span> <span class="Symbol">=</span> <span class="VarId">mapMaybe</span> <span class="VarId">lpt</span> <span class="Symbol">@</span><span class="VarId">params</span><span class="Symbol">.</span><span class="VarId">params</span>
                         <span class="VarId">rt</span> <span class="Symbol">&lt;-</span> <span class="VarId">lmt</span> <span class="Symbol">@</span><span class="VarId">rettype</span><span class="Symbol">.</span><span class="VarId">namedType</span>
                         <span class="VarId">return</span> <span class="Symbol">[</span><span class="ConId">CatCreateFunction</span> <span class="ConId">FunName</span>
                                                   <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">toLower</span> <span class="Symbol">@</span><span class="VarId">name</span><span class="Symbol">)</span>
                                                   <span class="VarId">ps</span>
                                                   <span class="VarId">rt</span>
                                                   <span class="ConId">False</span><span class="Symbol">]</span>
                         <span class="Keyword">where</span>
                           <span class="VarId">lpt</span> <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="ConId">Just</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="VarId">t</span>
                           <span class="VarId">lpt</span> <span class="VarId">_</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>

        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">backTree</span> <span class="Symbol">=</span> <span class="ConId">CreateFunction</span> <span class="Symbol">@</span><span class="VarId">ann</span>
                                      <span class="Symbol">@</span><span class="VarId">name</span>
                                      <span class="Symbol">@</span><span class="VarId">params</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                                      <span class="Symbol">@</span><span class="VarId">rettype</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                                      <span class="Symbol">@</span><span class="VarId">rep</span>
                                      <span class="Symbol">@</span><span class="VarId">lang</span>
                                      <span class="Symbol">@</span><span class="VarId">body</span><span class="Symbol">.</span><span class="VarId">annotatedTree</span>
                                      <span class="Symbol">@</span><span class="VarId">vol</span>
        <span class="VarId">loc</span><span class="Symbol">.</span><span class="VarId">statementType</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>
        <span class="VarId">body</span><span class="Symbol">.</span><span class="VarId">cat</span> <span class="Symbol">=</span> <span class="Symbol">@</span><span class="VarId">lhs</span><span class="Symbol">.</span><span class="VarId">inProducedCat</span>




</pre></div></div></div><p
    >{-</p
    ><p
    >== function prototype</p
    ><p
    >all we do here is type check enough to produce the prototype information which is added to the catalog, this means the function name, parameter types, and the return type.</p
    ><p
    >type checking failure is contained so that the function prototype is produced iff the parameter and return types check ok. Any type errors in the function body (including the top level variable declarations don't affect the prototype, and hence callers of the function).</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">




</pre></div></div></div><p
    >{- ISSUE:</p
    ><p
    >when writing an sql file, you can put a create function which refers to a table definition that is given later. As long as the function isn't called before the table definition is given, this is ok. To handle this, need to gather the function prototype, but delay checking the contents until either a) all the other type checking has been done, or b) the function is needed (list ways this can happen: used in a view (even then, not needed until view is used), function can be called directly, or indirectly in another function call, ...)</p
    ><p
    >No thoughts on how to do this - but at some point want to support 'declarative' sql source code, where the order doesn't matter, and this code figures out an order to load it into the database which will get past pgs checks, so hopefully the solution will move towards this goal also. One additional consideration is that the error message in a situation like this would be really helpful if it could tell that a problem like this could be fixed with a reordering, and suggest that reordering.</p
    ><p
    >New plan: do two passes, type check everything but the bodies of functions in first pass, then type check bodies of functions in second pass. Not perfect, but better than current situation. This will be achieved by using a separate cat attribute which is the same as the cat value which gets returned from the annotation functions in AstInternal.ag</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

</pre></div></div></div><p
    >{- TODO: using fromRight on it's own for identifier bindings or cat updates is wrong, if an error is produced then this needs to be added to an annotation somewhere. Some of the code uses error instead of fromRight which is even worse. -}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">



</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
