<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >CatalogInternal</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >This module contains the implementation of the Catalog data types and functions, and provides the api for the other type checking modules.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE DeriveDataTypeable #-}</span>

<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.AstInternals.Catalog.CatalogInternal</span>
    <span class="Symbol">(</span>
     <span class="ConId">Catalog</span>
    <span class="Symbol">,</span><span class="ConId">CastContext</span><span class="Symbol">(..)</span>
    <span class="Symbol">,</span><span class="ConId">CompositeFlavour</span><span class="Symbol">(..)</span>
    <span class="Symbol">,</span><span class="VarId">relationComposites</span>
    <span class="Symbol">,</span><span class="ConId">CompositeDef</span>
    <span class="Symbol">,</span><span class="ConId">FunctionPrototype</span>
    <span class="Symbol">,</span><span class="ConId">DomainDefinition</span>
    <span class="Symbol">,</span><span class="ConId">FunFlav</span><span class="Symbol">(..)</span>
    <span class="Symbol">,</span><span class="VarId">emptyCatalog</span>
    <span class="Symbol">,</span><span class="VarId">defaultCatalog</span>
    <span class="Symbol">,</span><span class="ConId">CatalogUpdate</span><span class="Symbol">(..)</span>
    <span class="Symbol">,</span><span class="VarId">ppCatUpdate</span>
    <span class="Symbol">,</span><span class="VarId">updateCatalog</span>
    <span class="Symbol">,</span><span class="VarId">deconstructCatalog</span>
    <span class="Comment">-- type checker stuff</span>
    <span class="Symbol">,</span><span class="VarId">catCompositeDef</span>
    <span class="Symbol">,</span><span class="VarId">catCompositeAttrsPair</span>
    <span class="Symbol">,</span><span class="VarId">catCompositeAttrs</span>
    <span class="Symbol">,</span><span class="VarId">catCompositePublicAttrs</span>
    <span class="Symbol">,</span><span class="VarId">catTypeCategory</span>
    <span class="Symbol">,</span><span class="VarId">catPreferredType</span>
    <span class="Symbol">,</span><span class="VarId">catCast</span>
    <span class="Symbol">,</span><span class="VarId">catDomainBaseType</span>
    <span class="Symbol">,</span><span class="VarId">catLookupFns</span>
    <span class="Symbol">,</span><span class="VarId">catTypeExists</span>
    <span class="Symbol">,</span><span class="VarId">catLookupType</span>
    <span class="Symbol">,</span><span class="ConId">OperatorType</span><span class="Symbol">(..)</span>
    <span class="Symbol">,</span><span class="VarId">getOperatorType</span>
    <span class="Symbol">,</span><span class="VarId">isOperatorName</span>
    <span class="Comment">-- comparing catalogs</span>
    <span class="Symbol">,</span><span class="ConId">CatalogDiff</span><span class="Symbol">(..)</span>
    <span class="Symbol">,</span><span class="VarId">compareCatalogs</span>
    <span class="Symbol">,</span><span class="VarId">ppCatDiff</span>
    <span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Control.Monad</span>
<span class="Keyword">import</span> <span class="ConId">Data.List</span>
<span class="Keyword">import</span> <span class="ConId">Data.Data</span>
<span class="Comment">-- import Debug.Trace</span>
<span class="Keyword">import</span> <span class="ConId">Data.Char</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.AstInternals.TypeType</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Utils</span>

<span class="Comment">-- | The main datatype, this holds the catalog and context</span>
<span class="Comment">-- information to type check against.</span>
<span class="Keyword">data</span> <span class="ConId">Catalog</span> <span class="Symbol">=</span> <span class="ConId">Catalog</span>
                   <span class="Symbol">{</span><span class="VarId">catTypeNames</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="ConId">Type</span><span class="Symbol">)]</span>
                   <span class="Symbol">,</span><span class="VarId">catDomainDefs</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">DomainDefinition</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catCasts</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">Type</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">,</span><span class="ConId">CastContext</span><span class="Symbol">)]</span>
                   <span class="Symbol">,</span><span class="VarId">catTypeCategories</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">Type</span><span class="Symbol">,</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Bool</span><span class="Symbol">)]</span>
                   <span class="Symbol">,</span><span class="VarId">catPrefixOperators</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catPostfixOperators</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catBinaryOperators</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catFunctions</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catAggregates</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catWindowFunctions</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catAttrDefs</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">CompositeDef</span><span class="Symbol">]</span>
                   <span class="Symbol">,</span><span class="VarId">catUpdates</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]}</span>
                   <span class="Keyword">deriving</span> <span class="ConId">Show</span>

<span class="Comment">-- | Represents an empty catalog. This doesn't contain things</span>
<span class="Comment">-- like the \'and\' operator, 'defaultCatalog' contains these.</span>
<span class="Function">emptyCatalog</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span>
<span class="Function">emptyCatalog</span> <span class="Symbol">=</span> <span class="ConId">Catalog</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span>

<span class="Comment">-- | Represents what you probably want to use as a starting point if</span>
<span class="Comment">-- you are building an catalog from scratch. It contains</span>
<span class="Comment">-- information on built in function like things that aren't in the</span>
<span class="Comment">-- PostgreSQL catalog, such as greatest, coalesce, keyword operators</span>
<span class="Comment">-- like \'and\', etc..</span>
<span class="Function">defaultCatalog</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span>
<span class="Function">defaultCatalog</span> <span class="Symbol">=</span>
  <span class="VarId">emptyCatalog</span> <span class="Symbol">{</span><span class="VarId">catTypeNames</span> <span class="Symbol">=</span> <span class="VarId">pseudoTypes</span>
               <span class="Symbol">,</span><span class="VarId">catBinaryOperators</span> <span class="Symbol">=</span> <span class="VarId">pe</span> <span class="Symbol">:</span> <span class="VarId">keywordOperatorTypes</span>
               <span class="Symbol">,</span><span class="VarId">catFunctions</span> <span class="Symbol">=</span> <span class="VarId">specialFunctionTypes</span><span class="Symbol">}</span>
  <span class="Keyword">where</span>
    <span class="VarId">pe</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="String">&quot;=&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>

<span class="Comment">-- | Use to note what the flavour of a cast is, i.e. if/when it can</span>
<span class="Comment">-- be used implicitly.</span>
<span class="Keyword">data</span> <span class="ConId">CastContext</span> <span class="Symbol">=</span> <span class="ConId">ImplicitCastContext</span>
                 <span class="Symbol">|</span> <span class="ConId">AssignmentCastContext</span>
                 <span class="Symbol">|</span> <span class="ConId">ExplicitCastContext</span>
                   <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">,</span><span class="ConId">Ord</span><span class="Symbol">,</span><span class="ConId">Typeable</span><span class="Symbol">,</span><span class="ConId">Data</span><span class="Symbol">)</span>

<span class="Comment">-- | Used to distinguish between standalone composite types, and</span>
<span class="Comment">-- automatically generated ones, generated from a table or view</span>
<span class="Comment">-- respectively.</span>
<span class="Keyword">data</span> <span class="ConId">CompositeFlavour</span> <span class="Symbol">=</span> <span class="ConId">Composite</span> <span class="Symbol">|</span> <span class="ConId">TableComposite</span> <span class="Symbol">|</span> <span class="ConId">ViewComposite</span>
                        <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Ord</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">)</span>

<span class="Function">relationComposites</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">CompositeFlavour</span><span class="Symbol">]</span>
<span class="Function">relationComposites</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="ConId">TableComposite</span><span class="Symbol">,</span><span class="ConId">ViewComposite</span><span class="Symbol">]</span>

<span class="Comment">-- | Provides the definition of a composite type. The components are</span>
<span class="Comment">-- composite (or table or view) name, the flavour of the composite,</span>
<span class="Comment">-- the types of the composite attributes, and the types of the</span>
<span class="Comment">-- system columns iff the composite represents a table type (the</span>
<span class="Comment">-- third and fourth components are always 'CompositeType's).</span>
<span class="Keyword">type</span> <span class="ConId">CompositeDef</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="ConId">CompositeFlavour</span><span class="Symbol">,</span> <span class="ConId">Type</span><span class="Symbol">,</span> <span class="ConId">Type</span><span class="Symbol">)</span>

<span class="Comment">-- | The components are: function (or operator) name, argument</span>
<span class="Comment">-- types, return type and is variadic.</span>
<span class="Keyword">type</span> <span class="ConId">FunctionPrototype</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">Type</span><span class="Symbol">],</span> <span class="ConId">Type</span><span class="Symbol">,</span> <span class="ConId">Bool</span><span class="Symbol">)</span>

<span class="Comment">-- | The components are domain type, base type (todo: add check</span>
<span class="Comment">-- constraint).</span>
<span class="Keyword">type</span> <span class="ConId">DomainDefinition</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="ConId">Type</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)</span>

<span class="Keyword">data</span> <span class="ConId">CatalogUpdate</span> <span class="Symbol">=</span>
    <span class="Comment">-- | add a new scalar type with the name given, also creates</span>
    <span class="Comment">-- an array type automatically</span>
    <span class="ConId">CatCreateScalar</span> <span class="ConId">Type</span> <span class="ConId">String</span> <span class="ConId">Bool</span>
  <span class="Symbol">|</span> <span class="ConId">CatCreateDomain</span> <span class="ConId">Type</span> <span class="ConId">Type</span>
  <span class="Symbol">|</span> <span class="ConId">CatCreateComposite</span> <span class="ConId">String</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
  <span class="Symbol">|</span> <span class="ConId">CatCreateCast</span> <span class="ConId">Type</span> <span class="ConId">Type</span> <span class="ConId">CastContext</span>
  <span class="Symbol">|</span> <span class="ConId">CatCreateTable</span> <span class="ConId">String</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
  <span class="Symbol">|</span> <span class="ConId">CatCreateView</span> <span class="ConId">String</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
  <span class="Symbol">|</span> <span class="ConId">CatCreateFunction</span> <span class="ConId">FunFlav</span> <span class="ConId">String</span> <span class="Symbol">[</span><span class="ConId">Type</span><span class="Symbol">]</span> <span class="ConId">Type</span> <span class="ConId">Bool</span>
  <span class="Symbol">|</span> <span class="ConId">CatDropFunction</span> <span class="ConId">Bool</span> <span class="ConId">String</span> <span class="Symbol">[</span><span class="ConId">Type</span><span class="Symbol">]</span>
    <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Ord</span><span class="Symbol">,</span><span class="ConId">Typeable</span><span class="Symbol">,</span><span class="ConId">Data</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">)</span>

<span class="Function">ppCatUpdate</span> <span class="Symbol">::</span> <span class="ConId">CatalogUpdate</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateScalar</span> <span class="VarId">t</span> <span class="VarId">c</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatCreateScalar &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">t</span> <span class="Symbol">++</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">++</span> <span class="VarId">c</span> <span class="Symbol">++</span> <span class="String">&quot;,&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">p</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateDomain</span> <span class="VarId">t</span> <span class="VarId">b</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatCreateDomain &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">t</span> <span class="Symbol">++</span> <span class="String">&quot; as &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">b</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateComposite</span> <span class="VarId">nm</span> <span class="VarId">flds</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatCreateComposite &quot;</span> <span class="Symbol">++</span> <span class="VarId">nm</span> <span class="Symbol">++</span> <span class="VarId">showFlds</span> <span class="VarId">flds</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateCast</span> <span class="VarId">s</span> <span class="VarId">t</span> <span class="VarId">ctx</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatCreateCast &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">s</span> <span class="Symbol">++</span> <span class="String">&quot;-&gt;&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">t</span> <span class="Symbol">++</span> <span class="String">&quot; &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">ctx</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateTable</span> <span class="VarId">nm</span> <span class="VarId">flds1</span> <span class="VarId">flds2</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatCreateTable &quot;</span> <span class="Symbol">++</span> <span class="VarId">nm</span> <span class="Symbol">++</span> <span class="VarId">showFlds</span> <span class="VarId">flds1</span> <span class="Symbol">++</span> <span class="VarId">showFlds</span> <span class="VarId">flds2</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateView</span> <span class="VarId">nm</span> <span class="VarId">flds</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatCreateView &quot;</span> <span class="Symbol">++</span> <span class="VarId">nm</span> <span class="Symbol">++</span> <span class="VarId">showFlds</span> <span class="VarId">flds</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateFunction</span> <span class="VarId">flav</span> <span class="VarId">nm</span> <span class="VarId">args</span> <span class="VarId">ret</span> <span class="VarId">vdc</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatCreateFunction &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">flav</span> <span class="Symbol">++</span> <span class="String">&quot; &quot;</span> <span class="Symbol">++</span> <span class="VarId">nm</span>
  <span class="Symbol">++</span> <span class="String">&quot; returns &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">ret</span>
  <span class="Symbol">++</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">++</span> <span class="VarId">intercalate</span> <span class="String">&quot;,&quot;</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">show</span> <span class="VarId">args</span><span class="Symbol">)</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span>
  <span class="Symbol">++</span> <span class="Keyword">if</span> <span class="VarId">vdc</span> <span class="Keyword">then</span> <span class="String">&quot; variadic&quot;</span> <span class="Keyword">else</span> <span class="String">&quot;&quot;</span>
<span class="Function">ppCatUpdate</span> <span class="Symbol">(</span><span class="ConId">CatDropFunction</span> <span class="VarId">_</span> <span class="VarId">nm</span> <span class="VarId">args</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="String">&quot;CatDropFunction &quot;</span> <span class="Symbol">++</span> <span class="VarId">nm</span> <span class="Symbol">++</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">args</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span>

<span class="Function">showFlds</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">showFlds</span> <span class="VarId">flds</span> <span class="Symbol">=</span> <span class="String">&quot;(\n&quot;</span> <span class="Symbol">++</span> <span class="VarId">sfs</span> <span class="VarId">flds</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span>
                <span class="Keyword">where</span>
                  <span class="VarId">sfs</span> <span class="Symbol">((</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="VarId">t</span><span class="Symbol">):</span><span class="VarId">fs</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="String">&quot;    &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">nm</span>
                                    <span class="Symbol">++</span> <span class="String">&quot; &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">t</span> <span class="Symbol">++</span> <span class="String">&quot;\n&quot;</span> <span class="Symbol">++</span> <span class="VarId">sfs</span> <span class="VarId">fs</span>
                  <span class="VarId">sfs</span> <span class="Symbol">[]</span> <span class="Symbol">=</span> <span class="String">&quot;&quot;</span>

<span class="Keyword">data</span> <span class="ConId">FunFlav</span> <span class="Symbol">=</span> <span class="ConId">FunPrefix</span> <span class="Symbol">|</span> <span class="ConId">FunPostfix</span> <span class="Symbol">|</span> <span class="ConId">FunBinary</span>
             <span class="Symbol">|</span> <span class="ConId">FunName</span> <span class="Symbol">|</span> <span class="ConId">FunAgg</span> <span class="Symbol">|</span> <span class="ConId">FunWindow</span>
               <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">,</span><span class="ConId">Ord</span><span class="Symbol">,</span><span class="ConId">Typeable</span><span class="Symbol">,</span><span class="ConId">Data</span><span class="Symbol">)</span>

<span class="Comment">-- | Applies a list of 'CatalogUpdate's to an 'Catalog' value</span>
<span class="Comment">-- to produce a new Catalog value.</span>
<span class="Function">updateCatalog</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span>
                  <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]</span>
                  <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Catalog</span>
<span class="Function">updateCatalog</span> <span class="VarId">cat'</span> <span class="VarId">eus</span> <span class="Symbol">=</span>
  <span class="VarId">foldM</span> <span class="VarId">updateCat'</span> <span class="Symbol">(</span><span class="VarId">cat'</span> <span class="Symbol">{</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="VarId">catUpdates</span> <span class="VarId">cat'</span> <span class="Symbol">++</span> <span class="VarId">eus</span><span class="Symbol">})</span> <span class="VarId">eus</span>
  <span class="Keyword">where</span>
    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatCreateScalar</span> <span class="VarId">ty</span> <span class="VarId">catl</span> <span class="VarId">pref</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">not</span> <span class="VarId">allowed</span><span class="Symbol">)</span>
        <span class="Symbol">[</span><span class="ConId">BadCatalogUpdate</span> <span class="Symbol">$</span> <span class="String">&quot;can only add scalar types\
                            \this way, got &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">ty</span><span class="Symbol">]</span>
      <span class="Keyword">let</span> <span class="ConId">ScalarType</span> <span class="VarId">nm</span> <span class="Symbol">=</span> <span class="VarId">ty</span>
      <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">addTypeWithArray</span> <span class="VarId">cat</span> <span class="VarId">nm</span> <span class="VarId">ty</span> <span class="VarId">catl</span> <span class="VarId">pref</span>
      <span class="Keyword">where</span>
        <span class="VarId">allowed</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">ty</span> <span class="Keyword">of</span>
                          <span class="ConId">ScalarType</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">True</span>
                          <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">False</span>

    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatCreateDomain</span> <span class="VarId">ty</span> <span class="VarId">baseTy</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">not</span> <span class="VarId">allowed</span><span class="Symbol">)</span>
        <span class="Symbol">[</span><span class="ConId">BadCatalogUpdate</span> <span class="Symbol">$</span> <span class="String">&quot;can only add domain types\
                            \this way, got &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">ty</span><span class="Symbol">]</span>
      <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">not</span> <span class="VarId">baseAllowed</span><span class="Symbol">)</span>
        <span class="Symbol">[</span><span class="ConId">BadCatalogUpdate</span> <span class="Symbol">$</span> <span class="String">&quot;can only add domain types\
                                \based on scalars, got &quot;</span>
                                <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">baseTy</span><span class="Symbol">]</span>
      <span class="Keyword">let</span> <span class="ConId">DomainType</span> <span class="VarId">nm</span> <span class="Symbol">=</span> <span class="VarId">ty</span>
      <span class="VarId">catl</span> <span class="Symbol">&lt;-</span> <span class="VarId">catTypeCategory</span> <span class="VarId">cat</span> <span class="VarId">baseTy</span>
      <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">addTypeWithArray</span> <span class="VarId">cat</span> <span class="VarId">nm</span> <span class="VarId">ty</span> <span class="VarId">catl</span> <span class="ConId">False</span><span class="Symbol">)</span> <span class="Symbol">{</span>
                             <span class="VarId">catDomainDefs</span> <span class="Symbol">=</span>
                               <span class="Symbol">(</span><span class="VarId">ty</span><span class="Symbol">,</span><span class="VarId">baseTy</span><span class="Symbol">):</span><span class="VarId">catDomainDefs</span> <span class="VarId">cat</span>
                             <span class="Symbol">,</span><span class="VarId">catCasts</span> <span class="Symbol">=</span>
                               <span class="Symbol">(</span><span class="VarId">ty</span><span class="Symbol">,</span><span class="VarId">baseTy</span><span class="Symbol">,</span><span class="ConId">ImplicitCastContext</span><span class="Symbol">):</span><span class="VarId">catCasts</span> <span class="VarId">cat</span><span class="Symbol">}</span>
      <span class="Keyword">where</span>
        <span class="VarId">allowed</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">ty</span> <span class="Keyword">of</span>
                          <span class="ConId">DomainType</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">True</span>
                          <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">False</span>
        <span class="VarId">baseAllowed</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">baseTy</span> <span class="Keyword">of</span>
                                  <span class="ConId">ScalarType</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">True</span>
                                  <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">False</span>
    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatCreateComposite</span> <span class="VarId">nm</span> <span class="VarId">flds</span><span class="Symbol">)</span> <span class="Symbol">=</span>
      <span class="VarId">return</span> <span class="Symbol">$</span> <span class="Symbol">(</span><span class="VarId">addTypeWithArray</span> <span class="VarId">cat</span> <span class="VarId">nm</span> <span class="Symbol">(</span><span class="ConId">NamedCompositeType</span> <span class="VarId">nm</span><span class="Symbol">)</span> <span class="String">&quot;C&quot;</span> <span class="ConId">False</span><span class="Symbol">)</span> <span class="Symbol">{</span>
                  <span class="VarId">catAttrDefs</span> <span class="Symbol">=</span>
                    <span class="Symbol">(</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="ConId">Composite</span><span class="Symbol">,</span><span class="ConId">CompositeType</span> <span class="VarId">flds</span><span class="Symbol">,</span> <span class="ConId">CompositeType</span> <span class="Symbol">[])</span>
                    <span class="Symbol">:</span> <span class="VarId">catAttrDefs</span> <span class="VarId">cat</span><span class="Symbol">}</span>

    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatCreateCast</span> <span class="VarId">src</span> <span class="VarId">tgt</span> <span class="VarId">ctx</span><span class="Symbol">)</span> <span class="Symbol">=</span>
      <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catCasts</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">src</span><span class="Symbol">,</span><span class="VarId">tgt</span><span class="Symbol">,</span><span class="VarId">ctx</span><span class="Symbol">):</span><span class="VarId">catCasts</span> <span class="VarId">cat</span><span class="Symbol">}</span>

    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatCreateTable</span> <span class="VarId">nm</span> <span class="VarId">attrs</span> <span class="VarId">sysAttrs</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="VarId">checkTypeDoesntExist</span> <span class="VarId">cat</span> <span class="VarId">nm</span> <span class="Symbol">(</span><span class="ConId">NamedCompositeType</span> <span class="VarId">nm</span><span class="Symbol">)</span>
      <span class="VarId">return</span> <span class="Symbol">$</span> <span class="Symbol">(</span><span class="VarId">addTypeWithArray</span> <span class="VarId">cat</span> <span class="VarId">nm</span>
                  <span class="Symbol">(</span><span class="ConId">NamedCompositeType</span> <span class="VarId">nm</span><span class="Symbol">)</span> <span class="String">&quot;C&quot;</span> <span class="ConId">False</span><span class="Symbol">)</span> <span class="Symbol">{</span>
                  <span class="VarId">catAttrDefs</span> <span class="Symbol">=</span>
                    <span class="Symbol">(</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="ConId">TableComposite</span>
                    <span class="Symbol">,</span><span class="ConId">CompositeType</span> <span class="VarId">attrs</span>
                    <span class="Symbol">,</span> <span class="ConId">CompositeType</span> <span class="VarId">sysAttrs</span><span class="Symbol">)</span>
                    <span class="Symbol">:</span> <span class="VarId">catAttrDefs</span> <span class="VarId">cat</span><span class="Symbol">}</span>

    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatCreateView</span> <span class="VarId">nm</span> <span class="VarId">attrs</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="VarId">checkTypeDoesntExist</span> <span class="VarId">cat</span> <span class="VarId">nm</span> <span class="Symbol">(</span><span class="ConId">NamedCompositeType</span> <span class="VarId">nm</span><span class="Symbol">)</span>
      <span class="VarId">return</span> <span class="Symbol">$</span> <span class="Symbol">(</span><span class="VarId">addTypeWithArray</span> <span class="VarId">cat</span> <span class="VarId">nm</span>
                  <span class="Symbol">(</span><span class="ConId">NamedCompositeType</span> <span class="VarId">nm</span><span class="Symbol">)</span> <span class="String">&quot;C&quot;</span> <span class="ConId">False</span><span class="Symbol">)</span> <span class="Symbol">{</span>
                  <span class="VarId">catAttrDefs</span> <span class="Symbol">=</span>
                    <span class="Symbol">(</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="ConId">ViewComposite</span><span class="Symbol">,</span><span class="ConId">CompositeType</span> <span class="VarId">attrs</span><span class="Symbol">,</span> <span class="ConId">CompositeType</span> <span class="Symbol">[])</span>
                    <span class="Symbol">:</span> <span class="VarId">catAttrDefs</span> <span class="VarId">cat</span><span class="Symbol">}</span>

    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatCreateFunction</span> <span class="VarId">f</span> <span class="VarId">nm</span> <span class="VarId">args</span> <span class="VarId">ret</span> <span class="VarId">vdc</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">return</span> <span class="Symbol">$</span> <span class="Keyword">case</span> <span class="VarId">f</span> <span class="Keyword">of</span>
          <span class="ConId">FunPrefix</span> <span class="Symbol">-&gt;</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catPrefixOperators</span> <span class="Symbol">=</span>
                              <span class="VarId">fp</span> <span class="Symbol">:</span> <span class="VarId">catPrefixOperators</span> <span class="VarId">cat</span><span class="Symbol">}</span>
          <span class="ConId">FunPostfix</span> <span class="Symbol">-&gt;</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catPostfixOperators</span> <span class="Symbol">=</span>
                               <span class="VarId">fp</span> <span class="Symbol">:</span> <span class="VarId">catPostfixOperators</span> <span class="VarId">cat</span><span class="Symbol">}</span>
          <span class="ConId">FunBinary</span> <span class="Symbol">-&gt;</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catBinaryOperators</span> <span class="Symbol">=</span>
                              <span class="VarId">fp</span> <span class="Symbol">:</span> <span class="VarId">catBinaryOperators</span> <span class="VarId">cat</span><span class="Symbol">}</span>
          <span class="ConId">FunAgg</span> <span class="Symbol">-&gt;</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catAggregates</span> <span class="Symbol">=</span>
                           <span class="VarId">fp</span> <span class="Symbol">:</span> <span class="VarId">catAggregates</span> <span class="VarId">cat</span><span class="Symbol">}</span>
          <span class="ConId">FunWindow</span> <span class="Symbol">-&gt;</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catWindowFunctions</span> <span class="Symbol">=</span>
                              <span class="VarId">fp</span> <span class="Symbol">:</span> <span class="VarId">catWindowFunctions</span> <span class="VarId">cat</span><span class="Symbol">}</span>
          <span class="ConId">FunName</span> <span class="Symbol">-&gt;</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catFunctions</span> <span class="Symbol">=</span>
                            <span class="VarId">fp</span> <span class="Symbol">:</span> <span class="VarId">catFunctions</span> <span class="VarId">cat</span><span class="Symbol">}</span>
        <span class="Keyword">where</span> <span class="VarId">fp</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="VarId">args</span><span class="Symbol">,</span><span class="VarId">ret</span><span class="Symbol">,</span><span class="VarId">vdc</span><span class="Symbol">)</span>

    <span class="VarId">updateCat'</span> <span class="VarId">cat</span> <span class="Symbol">(</span><span class="ConId">CatDropFunction</span> <span class="VarId">_ifexists</span> <span class="VarId">nm</span> <span class="VarId">args</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
        <span class="Keyword">let</span> <span class="VarId">matches</span> <span class="Symbol">=</span>  <span class="VarId">filter</span> <span class="VarId">matchingFn</span> <span class="Symbol">(</span><span class="VarId">catFunctions</span> <span class="VarId">cat</span><span class="Symbol">)</span>
        <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">null</span> <span class="VarId">matches</span><span class="Symbol">)</span>
                  <span class="Symbol">[</span><span class="ConId">BadCatalogUpdate</span>
                   <span class="Symbol">$</span> <span class="String">&quot;couldn't find function to drop &quot;</span>
                     <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">nm</span> <span class="Symbol">++</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">args</span><span class="Symbol">++</span><span class="String">&quot;)&quot;</span><span class="Symbol">]</span>
        <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">length</span> <span class="VarId">matches</span> <span class="Symbol">&gt;</span> <span class="Number">1</span><span class="Symbol">)</span>
                  <span class="Symbol">[</span><span class="ConId">BadCatalogUpdate</span>
                   <span class="Symbol">$</span> <span class="String">&quot;multiple matching functions to drop &quot;</span>
                     <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">nm</span> <span class="Symbol">++</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">args</span><span class="Symbol">++</span><span class="String">&quot;)&quot;</span><span class="Symbol">]</span>
        <span class="VarId">return</span> <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catFunctions</span> <span class="Symbol">=</span> <span class="VarId">filter</span> <span class="Symbol">(</span><span class="VarId">not</span> <span class="Symbol">.</span> <span class="VarId">matchingFn</span><span class="Symbol">)</span>
                                          <span class="Symbol">(</span><span class="VarId">catFunctions</span> <span class="VarId">cat</span><span class="Symbol">)</span>
                   <span class="Symbol">,</span><span class="VarId">catUpdates</span> <span class="Symbol">=</span> <span class="VarId">filter</span> <span class="Symbol">(</span><span class="VarId">not</span><span class="Symbol">.</span><span class="VarId">matchingUpdate</span><span class="Symbol">)</span>
                                        <span class="Symbol">(</span><span class="VarId">catUpdates</span> <span class="VarId">cat</span><span class="Symbol">)}</span>
        <span class="Keyword">where</span>
          <span class="VarId">matchingFn</span> <span class="Symbol">(</span><span class="VarId">nm1</span><span class="Symbol">,</span><span class="VarId">a1</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">=</span>
            <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm</span> <span class="Symbol">==</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm1</span> <span class="Symbol">&amp;&amp;</span> <span class="VarId">args</span> <span class="Symbol">==</span> <span class="VarId">a1</span>
          <span class="VarId">matchingUpdate</span> <span class="Symbol">(</span><span class="ConId">CatDropFunction</span> <span class="VarId">_</span> <span class="VarId">nm2</span> <span class="VarId">a2</span><span class="Symbol">)</span>
                         <span class="Symbol">|</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm2</span> <span class="Symbol">==</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm</span>
                           <span class="Symbol">&amp;&amp;</span> <span class="VarId">a2</span> <span class="Symbol">==</span> <span class="VarId">args</span> <span class="Symbol">=</span> <span class="ConId">True</span>
          <span class="VarId">matchingUpdate</span> <span class="Symbol">(</span><span class="ConId">CatCreateFunction</span> <span class="VarId">_</span> <span class="VarId">nm2</span> <span class="VarId">a2</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span>
                         <span class="Symbol">|</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm2</span> <span class="Symbol">==</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm</span>
                           <span class="Symbol">&amp;&amp;</span> <span class="VarId">a2</span> <span class="Symbol">==</span> <span class="VarId">args</span> <span class="Symbol">=</span> <span class="ConId">True</span>
          <span class="VarId">matchingUpdate</span> <span class="VarId">_</span> <span class="Symbol">=</span> <span class="ConId">False</span></pre></div></div></div><p
    >todo: look for matching function in list, if not found then error remove from list, and remove from update list</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">    <span class="VarId">addTypeWithArray</span> <span class="VarId">cat</span> <span class="VarId">nm</span> <span class="VarId">ty</span> <span class="VarId">catl</span> <span class="VarId">pref</span> <span class="Symbol">=</span>
      <span class="VarId">cat</span> <span class="Symbol">{</span><span class="VarId">catTypeNames</span> <span class="Symbol">=</span>
               <span class="Symbol">(</span><span class="Char">'_'</span><span class="Symbol">:</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="ConId">ArrayType</span> <span class="VarId">ty</span><span class="Symbol">)</span>
               <span class="Symbol">:</span> <span class="Symbol">(</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="VarId">ty</span><span class="Symbol">)</span>
               <span class="Symbol">:</span> <span class="VarId">catTypeNames</span> <span class="VarId">cat</span>
          <span class="Symbol">,</span><span class="VarId">catTypeCategories</span> <span class="Symbol">=</span>
               <span class="Symbol">(</span><span class="ConId">ArrayType</span> <span class="VarId">ty</span><span class="Symbol">,</span><span class="String">&quot;A&quot;</span><span class="Symbol">,</span><span class="ConId">False</span><span class="Symbol">)</span>
               <span class="Symbol">:</span> <span class="Symbol">(</span><span class="VarId">ty</span><span class="Symbol">,</span><span class="VarId">catl</span><span class="Symbol">,</span><span class="VarId">pref</span><span class="Symbol">)</span>
               <span class="Symbol">:</span> <span class="VarId">catTypeCategories</span> <span class="VarId">cat</span><span class="Symbol">}</span>
    <span class="VarId">checkTypeDoesntExist</span> <span class="VarId">cat</span> <span class="VarId">nm</span> <span class="VarId">ty</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
        <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">any</span> <span class="Symbol">(==</span><span class="VarId">nm</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">fst</span> <span class="Symbol">$</span> <span class="VarId">catTypeNames</span> <span class="VarId">cat</span><span class="Symbol">)</span>
            <span class="Symbol">[</span><span class="ConId">TypeAlreadyExists</span> <span class="VarId">ty</span><span class="Symbol">]</span>
        <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">any</span> <span class="Symbol">(==</span><span class="VarId">ty</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">snd</span> <span class="Symbol">$</span> <span class="VarId">catTypeNames</span> <span class="VarId">cat</span><span class="Symbol">)</span>
            <span class="Symbol">[</span><span class="ConId">TypeAlreadyExists</span> <span class="VarId">ty</span><span class="Symbol">]</span>
        <span class="VarId">return</span> <span class="Symbol">()</span>
<span class="Comment">{-</span>
<span class="Comment"> | Takes part an 'Catalog' value to produce a list of 'CatalogUpdate's.</span>
<span class="Comment"> You can use this to look inside the Catalog data type e.g. if you want to</span>
<span class="Comment"> examine a catalog. It should be the case that:</span>
<span class="Comment"> @</span>
<span class="Comment">  updateCatalog emptyCatalog (deconstructCatalog cat) = cat</span>
<span class="Comment"> @ -}</span>
<span class="Function">deconstructCatalog</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]</span>
<span class="Function">deconstructCatalog</span> <span class="Symbol">=</span> <span class="VarId">catUpdates</span></pre></div></div></div><hr
     /><p
    >= type checking stuff</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">catCompositeDef</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">CompositeFlavour</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
                <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">CompositeDef</span>
<span class="Function">catCompositeDef</span> <span class="VarId">cat</span> <span class="VarId">flvs</span> <span class="VarId">nm</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="Keyword">let</span> <span class="VarId">c</span> <span class="Symbol">=</span> <span class="VarId">filter</span> <span class="VarId">m</span> <span class="Symbol">$</span> <span class="VarId">catAttrDefs</span> <span class="VarId">cat</span>
  <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">null</span> <span class="VarId">c</span><span class="Symbol">)</span>
            <span class="Symbol">[</span><span class="ConId">UnrecognisedRelation</span> <span class="VarId">nm</span><span class="Symbol">]</span>
  <span class="Keyword">case</span> <span class="VarId">c</span> <span class="Keyword">of</span>
    <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">fl1</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">,</span><span class="VarId">s</span><span class="Symbol">):[]</span> <span class="Symbol">-&gt;</span> <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="VarId">fl1</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">,</span><span class="VarId">s</span><span class="Symbol">)</span>
    <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="Symbol">[</span><span class="ConId">InternalError</span> <span class="Symbol">$</span> <span class="String">&quot;problem getting attributes for: &quot;</span>
                               <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">nm</span> <span class="Symbol">++</span> <span class="String">&quot;, &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">c</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">m</span> <span class="Symbol">(</span><span class="VarId">n</span><span class="Symbol">,</span><span class="VarId">t</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">n</span> <span class="Symbol">==</span> <span class="VarId">nm</span> <span class="Symbol">&amp;&amp;</span> <span class="Symbol">(</span><span class="VarId">null</span> <span class="VarId">flvs</span> <span class="Symbol">||</span> <span class="VarId">t</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">flvs</span><span class="Symbol">)</span>

<span class="Function">catCompositeAttrsPair</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">CompositeFlavour</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
                      <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">([(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)],[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)])</span>
<span class="Function">catCompositeAttrsPair</span> <span class="VarId">cat</span> <span class="VarId">flvs</span> <span class="VarId">ty</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
   <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="ConId">CompositeType</span> <span class="VarId">a</span><span class="Symbol">,</span><span class="ConId">CompositeType</span> <span class="VarId">b</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">catCompositeDef</span> <span class="VarId">cat</span> <span class="VarId">flvs</span> <span class="VarId">ty</span>
   <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">)</span>

<span class="Function">catCompositeAttrs</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">CompositeFlavour</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
                  <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
<span class="Function">catCompositeAttrs</span> <span class="VarId">cat</span> <span class="VarId">flvs</span> <span class="VarId">ty</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">catCompositeAttrsPair</span> <span class="VarId">cat</span> <span class="VarId">flvs</span> <span class="VarId">ty</span>
  <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">a</span> <span class="Symbol">++</span> <span class="VarId">b</span>

<span class="Function">catCompositePublicAttrs</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">CompositeFlavour</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
                  <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>
<span class="Function">catCompositePublicAttrs</span> <span class="VarId">cat</span> <span class="VarId">flvs</span> <span class="VarId">ty</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">catCompositeAttrsPair</span> <span class="VarId">cat</span> <span class="VarId">flvs</span> <span class="VarId">ty</span>
  <span class="VarId">return</span> <span class="VarId">a</span>

<span class="Function">catTypeCategory</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">String</span>
<span class="Function">catTypeCategory</span> <span class="VarId">cat</span> <span class="VarId">ty</span> <span class="Symbol">=</span>
  <span class="VarId">fmap</span> <span class="VarId">fst</span> <span class="Symbol">$</span> <span class="VarId">catGetCategoryInfo</span> <span class="VarId">cat</span> <span class="VarId">ty</span>

<span class="Function">catPreferredType</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Bool</span>
<span class="Function">catPreferredType</span> <span class="VarId">cat</span> <span class="VarId">ty</span> <span class="Symbol">=</span>
  <span class="VarId">fmap</span> <span class="VarId">snd</span> <span class="Symbol">$</span> <span class="VarId">catGetCategoryInfo</span> <span class="VarId">cat</span> <span class="VarId">ty</span>

<span class="Function">catCast</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">CastContext</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Bool</span>
<span class="Function">catCast</span> <span class="VarId">cat</span> <span class="VarId">ctx</span> <span class="VarId">from</span> <span class="VarId">to</span> <span class="Symbol">=</span> <span class="Comment">{-trace (&quot;check cast &quot; ++ show from ++ show to) $-}</span>
    <span class="Keyword">case</span> <span class="VarId">from</span> <span class="Keyword">of</span>
      <span class="VarId">t</span><span class="Symbol">@(</span><span class="ConId">DomainType</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="Keyword">do</span>
                <span class="VarId">baseType</span> <span class="Symbol">&lt;-</span> <span class="VarId">catDomainBaseType</span> <span class="VarId">cat</span> <span class="VarId">t</span>
                <span class="VarId">cc</span> <span class="Symbol">&lt;-</span> <span class="VarId">catCast</span> <span class="VarId">cat</span> <span class="VarId">ctx</span> <span class="VarId">baseType</span> <span class="VarId">to</span>
                <span class="VarId">return</span> <span class="Symbol">$</span> <span class="Symbol">(</span><span class="VarId">baseType</span> <span class="Symbol">==</span> <span class="VarId">to</span><span class="Symbol">)</span> <span class="Symbol">||</span>
                               <span class="Symbol">(</span><span class="VarId">cc</span> <span class="Symbol">||</span>
                                  <span class="VarId">any</span> <span class="Symbol">(==</span> <span class="Symbol">(</span><span class="VarId">from</span><span class="Symbol">,</span> <span class="VarId">to</span><span class="Symbol">,</span> <span class="VarId">ctx</span><span class="Symbol">))</span> <span class="Symbol">(</span><span class="VarId">catCasts</span> <span class="VarId">cat</span><span class="Symbol">))</span>
      <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="VarId">any</span> <span class="Symbol">(==(</span><span class="VarId">from</span><span class="Symbol">,</span><span class="VarId">to</span><span class="Symbol">,</span><span class="VarId">ctx</span><span class="Symbol">))</span> <span class="Symbol">(</span><span class="VarId">catCasts</span> <span class="VarId">cat</span><span class="Symbol">)</span>

<span class="Function">catDomainBaseType</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Type</span>
<span class="Function">catDomainBaseType</span> <span class="VarId">cat</span> <span class="VarId">ty</span> <span class="Symbol">=</span>
  <span class="Comment">--check type is domain, check it exists in main list</span>
  <span class="Keyword">case</span> <span class="VarId">lookup</span> <span class="VarId">ty</span> <span class="Symbol">(</span><span class="VarId">catDomainDefs</span> <span class="VarId">cat</span><span class="Symbol">)</span> <span class="Keyword">of</span>
      <span class="ConId">Nothing</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="Symbol">[</span><span class="ConId">DomainDefNotFound</span> <span class="VarId">ty</span><span class="Symbol">]</span>
      <span class="ConId">Just</span> <span class="VarId">t</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="VarId">t</span>

<span class="Function">catLookupFns</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
<span class="Function">catLookupFns</span> <span class="VarId">cat</span> <span class="VarId">name</span> <span class="Symbol">=</span>
    <span class="VarId">filter</span> <span class="Symbol">(\(</span><span class="VarId">nm</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm</span> <span class="Symbol">==</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">name</span><span class="Symbol">)</span> <span class="VarId">catGetAllFns</span>
    <span class="Keyword">where</span>
    <span class="VarId">catGetAllFns</span> <span class="Symbol">=</span>
        <span class="VarId">concat</span> <span class="Symbol">[</span><span class="VarId">catPrefixOperators</span> <span class="VarId">cat</span>
               <span class="Symbol">,</span><span class="VarId">catPostfixOperators</span> <span class="VarId">cat</span>
               <span class="Symbol">,</span><span class="VarId">catBinaryOperators</span> <span class="VarId">cat</span>
               <span class="Symbol">,</span><span class="VarId">catFunctions</span> <span class="VarId">cat</span>
               <span class="Symbol">,</span><span class="VarId">catAggregates</span> <span class="VarId">cat</span>
               <span class="Symbol">,</span><span class="VarId">catWindowFunctions</span> <span class="VarId">cat</span><span class="Symbol">]</span></pre></div></div></div><p
    >== internal support for type checker fns above</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">catGetCategoryInfo</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="ConId">Bool</span><span class="Symbol">)</span>
<span class="Function">catGetCategoryInfo</span> <span class="VarId">cat</span> <span class="VarId">ty</span> <span class="Symbol">=</span>
  <span class="Keyword">case</span> <span class="VarId">ty</span> <span class="Keyword">of</span>
    <span class="ConId">SetOfType</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">(</span><span class="String">&quot;&quot;</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
    <span class="ConId">AnonymousRecordType</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">(</span><span class="String">&quot;&quot;</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
    <span class="ConId">ArrayType</span> <span class="Symbol">(</span><span class="ConId">Pseudo</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">(</span><span class="String">&quot;A&quot;</span><span class="Symbol">,</span><span class="ConId">False</span><span class="Symbol">)</span>
    <span class="ConId">Pseudo</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">(</span><span class="String">&quot;P&quot;</span><span class="Symbol">,</span><span class="ConId">False</span><span class="Symbol">)</span>
    <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="Keyword">let</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="VarId">filter</span> <span class="Symbol">(\(</span><span class="VarId">t</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">ty</span> <span class="Symbol">==</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">catTypeCategories</span> <span class="VarId">cat</span>
         <span class="Keyword">in</span> <span class="Keyword">if</span> <span class="VarId">null</span> <span class="VarId">l</span>
              <span class="Keyword">then</span> <span class="ConId">Left</span> <span class="Symbol">[</span><span class="ConId">InternalError</span> <span class="Symbol">$</span> <span class="String">&quot;no type category for &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">ty</span><span class="Symbol">]</span>
              <span class="Keyword">else</span> <span class="Keyword">let</span> <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">):</span><span class="VarId">_</span> <span class="Symbol">=</span><span class="VarId">l</span>
                   <span class="Keyword">in</span> <span class="ConId">Right</span> <span class="Symbol">(</span><span class="VarId">c</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">)</span>

<span class="Function">catTypeExists</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Type</span>
<span class="Function">catTypeExists</span> <span class="VarId">cat</span> <span class="VarId">t</span> <span class="Symbol">=</span>
    <span class="VarId">errorWhen</span> <span class="Symbol">(</span><span class="VarId">t</span> <span class="Symbol">`</span><span class="VarId">notElem</span><span class="Symbol">`</span> <span class="VarId">map</span> <span class="VarId">snd</span> <span class="Symbol">(</span><span class="VarId">catTypeNames</span> <span class="VarId">cat</span><span class="Symbol">))</span>
              <span class="Symbol">[</span><span class="ConId">UnknownTypeError</span> <span class="VarId">t</span><span class="Symbol">]</span> <span class="Symbol">&gt;&gt;</span>
    <span class="ConId">Right</span> <span class="VarId">t</span>

<span class="Function">catLookupType</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">Type</span>
<span class="Function">catLookupType</span> <span class="VarId">cat</span> <span class="VarId">name</span> <span class="Symbol">=</span>
    <span class="VarId">liftME</span> <span class="Symbol">[</span><span class="ConId">UnknownTypeName</span> <span class="VarId">name</span><span class="Symbol">]</span> <span class="Symbol">$</span>
      <span class="VarId">lookup</span> <span class="VarId">name</span> <span class="Symbol">(</span><span class="VarId">catTypeNames</span> <span class="VarId">cat</span><span class="Symbol">)</span>
</pre></div></div></div><p
    >================================================================================</p
    ><p
    >= built in stuff</p
    ><p
    >keyword operators, all of these are built in and don't appear in any postgresql catalog</p
    ><p
    >This is wrong, these need to be separated into prefix, postfix, binary</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">keywordOperatorTypes</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
<span class="Function">keywordOperatorTypes</span> <span class="Symbol">=</span> <span class="Symbol">[</span>
  <span class="Symbol">(</span><span class="String">&quot;!and&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="VarId">typeBool</span><span class="Symbol">],</span> <span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!or&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="VarId">typeBool</span><span class="Symbol">],</span> <span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!like&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">],</span> <span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!not&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="VarId">typeBool</span><span class="Symbol">],</span> <span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!isnull&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!isnotnull&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="VarId">typeBool</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!arrayctor&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">ArrayType</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyArray</span><span class="Symbol">,</span> <span class="ConId">True</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!between&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span>
               <span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span>
               <span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!substring&quot;</span>
  <span class="Symbol">,[</span><span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">,</span><span class="VarId">typeInt</span><span class="Symbol">,</span><span class="VarId">typeInt</span><span class="Symbol">]</span>
  <span class="Symbol">,</span><span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span>
  <span class="Symbol">,</span><span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;!arraysub&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">Pseudo</span> <span class="ConId">AnyArray</span><span class="Symbol">,</span><span class="VarId">typeInt</span><span class="Symbol">],</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span> <span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">]</span>

<span class="Comment">-- these look like functions, but don't appear in the postgresql catalog.</span>

<span class="Function">specialFunctionTypes</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">FunctionPrototype</span><span class="Symbol">]</span>
<span class="Function">specialFunctionTypes</span> <span class="Symbol">=</span> <span class="Symbol">[</span>
  <span class="Symbol">(</span><span class="String">&quot;coalesce&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">ArrayType</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span> <span class="ConId">True</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;nullif&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span><span class="ConId">False</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;greatest&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">ArrayType</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span><span class="ConId">True</span><span class="Symbol">)</span>
 <span class="Symbol">,(</span><span class="String">&quot;least&quot;</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">ArrayType</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">],</span> <span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">,</span><span class="ConId">True</span><span class="Symbol">)</span>
 <span class="Symbol">]</span>

<span class="Function">pseudoTypes</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="ConId">Type</span><span class="Symbol">)]</span>
<span class="Function">pseudoTypes</span> <span class="Symbol">=</span>
    <span class="Symbol">[(</span><span class="String">&quot;any&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">Any</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;anyarray&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">AnyArray</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;anyelement&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">AnyElement</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;anyenum&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">AnyEnum</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;anynonarray&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">AnyNonArray</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;cstring&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">Cstring</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;record&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">Record</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;trigger&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">Trigger</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;void&quot;</span><span class="Symbol">,</span><span class="ConId">Pseudo</span> <span class="ConId">Void</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;_cstring&quot;</span><span class="Symbol">,</span><span class="ConId">ArrayType</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Cstring</span><span class="Symbol">)</span>
    <span class="Symbol">,(</span><span class="String">&quot;_record&quot;</span><span class="Symbol">,</span><span class="ConId">ArrayType</span> <span class="Symbol">$</span> <span class="ConId">Pseudo</span> <span class="ConId">Record</span><span class="Symbol">)</span>
    <span class="Comment">--,Pseudo Internal</span>
    <span class="Comment">--,Pseudo LanguageHandler</span>
    <span class="Comment">--,Pseudo Opaque</span>
    <span class="Symbol">]</span></pre></div></div></div><p
    >================================================================================</p
    ><p
    >= getOperatorType</p
    ><p
    >used by the pretty printer, not sure this is a very good design</p
    ><p
    >for now, assume that all the overloaded operators that have the same name are all either binary, prefix or postfix, otherwise the getoperatortype would need the types of the arguments to determine the operator type, and the parser would have to be a lot cleverer although, parsec handles - being unary and binary without breaking a sweat, so maybe this isn't too difficult?</p
    ><p
    >this is why binary @ operator isn't currently supported</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">data</span> <span class="ConId">OperatorType</span> <span class="Symbol">=</span> <span class="ConId">BinaryOp</span> <span class="Symbol">|</span> <span class="ConId">PrefixOp</span> <span class="Symbol">|</span> <span class="ConId">PostfixOp</span>
                  <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">)</span>

<span class="Function">getOperatorType</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="ConId">OperatorType</span>
<span class="Function">getOperatorType</span> <span class="VarId">cat</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="Keyword">case</span> <span class="Symbol">()</span> <span class="Keyword">of</span>
          <span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">s</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="Symbol">[</span><span class="String">&quot;!and&quot;</span><span class="Symbol">,</span> <span class="String">&quot;!or&quot;</span><span class="Symbol">,</span><span class="String">&quot;!like&quot;</span><span class="Symbol">,</span><span class="String">&quot;.&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="ConId">BinaryOp</span>
            <span class="Symbol">|</span> <span class="VarId">s</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="Symbol">[</span><span class="String">&quot;!not&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="ConId">PrefixOp</span>
            <span class="Symbol">|</span> <span class="VarId">s</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="Symbol">[</span><span class="String">&quot;!isnull&quot;</span><span class="Symbol">,</span> <span class="String">&quot;!isnotnull&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="ConId">PostfixOp</span>
            <span class="Symbol">|</span> <span class="VarId">any</span> <span class="Symbol">(\(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">x</span> <span class="Symbol">==</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">catBinaryOperators</span> <span class="VarId">cat</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span>
                      <span class="ConId">Right</span> <span class="ConId">BinaryOp</span>
            <span class="Symbol">|</span> <span class="VarId">any</span> <span class="Symbol">(\(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">x</span> <span class="Symbol">==</span> <span class="VarId">s</span> <span class="Symbol">||</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">==</span><span class="String">&quot;-&quot;</span> <span class="Symbol">&amp;&amp;</span> <span class="VarId">s</span><span class="Symbol">==</span><span class="String">&quot;u-&quot;</span><span class="Symbol">))</span>
                  <span class="Symbol">(</span><span class="VarId">catPrefixOperators</span> <span class="VarId">cat</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span>
                      <span class="ConId">Right</span> <span class="ConId">PrefixOp</span>
            <span class="Symbol">|</span> <span class="VarId">any</span> <span class="Symbol">(\(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">x</span> <span class="Symbol">==</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">catPostfixOperators</span> <span class="VarId">cat</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span>
                      <span class="ConId">Right</span> <span class="ConId">PostfixOp</span>
            <span class="Symbol">|</span> <span class="VarId">otherwise</span> <span class="Symbol">-&gt;</span>
                <span class="ConId">Left</span> <span class="Symbol">[</span><span class="ConId">InternalError</span> <span class="Symbol">$</span> <span class="String">&quot;don't know flavour of operator &quot;</span> <span class="Symbol">++</span> <span class="VarId">s</span><span class="Symbol">]</span>

<span class="Function">isOperatorName</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Bool</span>
<span class="Function">isOperatorName</span> <span class="Symbol">=</span> <span class="VarId">any</span> <span class="Symbol">(`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="String">&quot;+-*/&lt;&gt;=~!@#%^&amp;|`?.&quot;</span><span class="Symbol">)</span></pre></div></div></div><p
    >================================================================================</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">-- | items in first catalog and not second, items in second and not first.</span>
<span class="Keyword">data</span> <span class="ConId">CatalogDiff</span> <span class="Symbol">=</span> <span class="ConId">CatalogDiff</span> <span class="Symbol">[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]</span> <span class="Symbol">[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]</span>
               <span class="Keyword">deriving</span> <span class="ConId">Show</span>

<span class="Comment">-- | find differences between two catalogs</span>
<span class="Function">compareCatalogs</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">CatalogDiff</span>
<span class="Function">compareCatalogs</span> <span class="VarId">base</span> <span class="VarId">start</span> <span class="VarId">end</span> <span class="Symbol">=</span>
        <span class="Keyword">let</span> <span class="VarId">baseCatBits</span> <span class="Symbol">=</span> <span class="VarId">deconstructCatalog</span> <span class="VarId">base</span>
            <span class="VarId">startCatBits</span> <span class="Symbol">=</span> <span class="VarId">deconstructCatalog</span> <span class="VarId">start</span> <span class="Symbol">\\</span> <span class="VarId">baseCatBits</span>
            <span class="VarId">endCatBits</span> <span class="Symbol">=</span> <span class="VarId">deconstructCatalog</span> <span class="VarId">end</span> <span class="Symbol">\\</span> <span class="VarId">baseCatBits</span>
            <span class="VarId">missing</span> <span class="Symbol">=</span> <span class="VarId">sort</span> <span class="Symbol">$</span> <span class="VarId">endCatBits</span> <span class="Symbol">\\</span> <span class="VarId">startCatBits</span>
            <span class="VarId">extras</span> <span class="Symbol">=</span> <span class="VarId">sort</span> <span class="Symbol">$</span> <span class="VarId">startCatBits</span> <span class="Symbol">\\</span> <span class="VarId">endCatBits</span>
        <span class="Keyword">in</span> <span class="ConId">CatalogDiff</span> <span class="VarId">missing</span> <span class="VarId">extras</span>

<span class="Comment">-- | print a catdiff in a more human readable way than show.</span>
<span class="Function">ppCatDiff</span> <span class="Symbol">::</span> <span class="ConId">CatalogDiff</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">ppCatDiff</span> <span class="Symbol">(</span><span class="ConId">CatalogDiff</span> <span class="VarId">missing</span> <span class="VarId">extr</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="String">&quot;\nmissing:\n&quot;</span>
    <span class="Symbol">++</span> <span class="VarId">intercalate</span> <span class="String">&quot;\n&quot;</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">ppCatUpdate</span> <span class="VarId">missing</span><span class="Symbol">)</span>
    <span class="Symbol">++</span> <span class="String">&quot;\nextra:\n&quot;</span>
    <span class="Symbol">++</span> <span class="VarId">intercalate</span> <span class="String">&quot;\n&quot;</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">ppCatUpdate</span> <span class="VarId">extr</span><span class="Symbol">)</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
