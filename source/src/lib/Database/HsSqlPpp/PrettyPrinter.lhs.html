<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >PrettyPrinter</title
    ><link href="../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{- | Functions to convert sql asts to valid SQL source code. Includes</span>
<span class="Comment">   a function - 'printSqlAnn' - to output the annotations from a tree</span>
<span class="Comment">   in comments in the outputted SQL source.</span>

<span class="Comment">   Produces sort of readable code, but mainly just written to produce</span>
<span class="Comment">   reparsable text. Could do with some work to make the outputted text</span>
<span class="Comment">   layout better.</span>
<span class="Comment">-}</span>
<span class="Comment">{-# LANGUAGE PatternGuards #-}</span>
<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.PrettyPrinter</span> <span class="Symbol">(</span>
                      <span class="Comment">--convert a sql ast to text</span>
                      <span class="VarId">printSql</span>
                     <span class="Symbol">,</span><span class="VarId">printSqlAnn</span>
                      <span class="Comment">--convert a single expression parse node to text</span>
                     <span class="Symbol">,</span><span class="VarId">printExpression</span>
                     <span class="Symbol">)</span>
    <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Text.PrettyPrint</span>
<span class="Keyword">import</span> <span class="ConId">Data.Char</span>
<span class="Keyword">import</span> <span class="ConId">Data.List</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Ast</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Catalog</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Utils</span></pre></div></div></div><hr
     /><p
    >Public functions</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">-- | convert an ast back to valid SQL source, it's also almost human readable.</span>
<span class="Function">printSql</span> <span class="Symbol">::</span> <span class="ConId">StatementList</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">printSql</span> <span class="Symbol">=</span> <span class="VarId">printSqlAnn</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="String">&quot;&quot;</span><span class="Symbol">)</span>

<span class="Comment">-- | convert the ast back to valid source, and convert any annotations to</span>
<span class="Comment">-- text using the function provided and interpolate the output of</span>
<span class="Comment">-- this function(inside comments) with the SQL source.</span>
<span class="Function">printSqlAnn</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">StatementList</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">printSqlAnn</span> <span class="VarId">f</span> <span class="VarId">ast</span> <span class="Symbol">=</span> <span class="VarId">render</span> <span class="Symbol">$</span> <span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(</span><span class="VarId">convStatement</span> <span class="VarId">f</span><span class="Symbol">)</span> <span class="VarId">ast</span><span class="Symbol">)</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;\n&quot;</span>

<span class="Comment">-- | Testing function, pretty print an expression</span>
<span class="Function">printExpression</span> <span class="Symbol">::</span> <span class="ConId">Expression</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">printExpression</span> <span class="Symbol">=</span> <span class="VarId">render</span> <span class="Symbol">.</span> <span class="VarId">convExp</span></pre></div></div></div><hr
     /><p
    >Conversion routines - convert Sql asts into Docs</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">-- Statements</span>

<span class="Function">convStatement</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Statement</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>

<span class="Comment">-- selects</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">SelectStatement</span> <span class="VarId">ann</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
  <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">s</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Comment">--dml</span>

<span class="Function">convStatement</span> <span class="VarId">pa</span> <span class="Symbol">(</span><span class="ConId">Insert</span> <span class="VarId">ann</span> <span class="VarId">tb</span> <span class="VarId">atts</span> <span class="VarId">idata</span> <span class="VarId">rt</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convPa</span> <span class="VarId">pa</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
  <span class="VarId">text</span> <span class="String">&quot;insert into&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">tb</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">.</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">text</span><span class="Symbol">)</span> <span class="VarId">atts</span>
  <span class="Symbol">$+$</span> <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">idata</span>
  <span class="Symbol">$+$</span> <span class="VarId">convReturning</span> <span class="VarId">rt</span>
  <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Update</span> <span class="VarId">ann</span> <span class="VarId">tb</span> <span class="VarId">scs</span> <span class="VarId">fr</span> <span class="VarId">wh</span> <span class="VarId">rt</span><span class="Symbol">)</span> <span class="Symbol">=</span>
   <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
   <span class="VarId">text</span> <span class="String">&quot;update&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">tb</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;set&quot;</span>
   <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convSet</span> <span class="VarId">scs</span>
   <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;from&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convTref</span> <span class="VarId">fr</span><span class="Symbol">)</span> <span class="VarId">fr</span>
   <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convWhere</span> <span class="VarId">wh</span>
   <span class="Symbol">$+$</span> <span class="VarId">convReturning</span> <span class="VarId">rt</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Delete</span> <span class="VarId">ann</span> <span class="VarId">tbl</span> <span class="VarId">us</span> <span class="VarId">wh</span> <span class="VarId">rt</span><span class="Symbol">)</span> <span class="Symbol">=</span>
   <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
   <span class="VarId">text</span> <span class="String">&quot;delete from&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">tbl</span>
   <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;using&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convTref</span> <span class="VarId">us</span><span class="Symbol">)</span> <span class="VarId">us</span>
   <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convWhere</span> <span class="VarId">wh</span>
   <span class="Symbol">$+$</span> <span class="VarId">convReturning</span> <span class="VarId">rt</span>
   <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Truncate</span> <span class="VarId">ann</span> <span class="VarId">names</span> <span class="VarId">ri</span> <span class="VarId">casc</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;truncate&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">names</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">ri</span> <span class="Keyword">of</span>
                      <span class="ConId">RestartIdentity</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;restart identity&quot;</span>
                      <span class="ConId">ContinueIdentity</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;continue identity&quot;</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCasc</span> <span class="VarId">casc</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Comment">-- ddl</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateTable</span> <span class="VarId">ann</span> <span class="VarId">tbl</span> <span class="VarId">atts</span> <span class="VarId">cns</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create table&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">tbl</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">lparen</span>
    <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">csv</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">convAttDef</span> <span class="VarId">atts</span> <span class="Symbol">++</span> <span class="VarId">map</span> <span class="VarId">convCon</span> <span class="VarId">cns</span><span class="Symbol">)))</span>
    <span class="Symbol">$+$</span> <span class="VarId">rparen</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">convAttDef</span> <span class="Symbol">(</span><span class="ConId">AttributeDef</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">t</span> <span class="VarId">def</span> <span class="VarId">cons</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;default&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="VarId">def</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hsep</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">cCons</span> <span class="VarId">cons</span><span class="Symbol">)</span>
      <span class="VarId">cCons</span> <span class="Symbol">(</span><span class="ConId">NullConstraint</span> <span class="VarId">_</span> <span class="VarId">cn</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">cn</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;null&quot;</span>
      <span class="VarId">cCons</span> <span class="Symbol">(</span><span class="ConId">NotNullConstraint</span> <span class="VarId">_</span> <span class="VarId">cn</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">cn</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;not null&quot;</span>
      <span class="VarId">cCons</span> <span class="Symbol">(</span><span class="ConId">RowCheckConstraint</span> <span class="VarId">_</span> <span class="VarId">cn</span> <span class="VarId">ew</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">cn</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;check&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="VarId">ew</span><span class="Symbol">)</span>
      <span class="VarId">cCons</span> <span class="Symbol">(</span><span class="ConId">RowUniqueConstraint</span> <span class="VarId">_</span> <span class="VarId">cn</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">cn</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;unique&quot;</span>
      <span class="VarId">cCons</span> <span class="Symbol">(</span><span class="ConId">RowPrimaryKeyConstraint</span> <span class="VarId">_</span> <span class="VarId">cn</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">cn</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;primary key&quot;</span>
      <span class="VarId">cCons</span> <span class="Symbol">(</span><span class="ConId">RowReferenceConstraint</span> <span class="VarId">_</span> <span class="VarId">cn</span> <span class="VarId">tb</span> <span class="VarId">att</span> <span class="VarId">ondel</span> <span class="VarId">onupd</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">cn</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;references&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">tb</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">.</span> <span class="VarId">text</span><span class="Symbol">)</span> <span class="VarId">att</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;on delete&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCasc</span> <span class="VarId">ondel</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;on update&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCasc</span> <span class="VarId">onupd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">AlterTable</span> <span class="VarId">ann</span> <span class="VarId">name</span> <span class="VarId">act</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;alter table&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">name</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convAct</span> <span class="VarId">act</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">convAct</span> <span class="Symbol">(</span><span class="ConId">AlterColumnDefault</span> <span class="VarId">_</span> <span class="VarId">nm</span> <span class="VarId">def</span><span class="Symbol">)</span> <span class="Symbol">=</span>
          <span class="VarId">text</span> <span class="String">&quot;alter column&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">nm</span>
          <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;set default&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">def</span>
      <span class="VarId">convAct</span> <span class="Symbol">(</span><span class="ConId">AddConstraint</span> <span class="VarId">_</span> <span class="VarId">con</span><span class="Symbol">)</span> <span class="Symbol">=</span>
          <span class="VarId">text</span> <span class="String">&quot;add &quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCon</span> <span class="VarId">con</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateSequence</span> <span class="VarId">ann</span> <span class="VarId">nm</span> <span class="VarId">incr</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">start</span> <span class="VarId">cache</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create sequence&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">nm</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;increment&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="VarId">show</span> <span class="VarId">incr</span><span class="Symbol">)</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;no minvalue&quot;</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;no maxvalue&quot;</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;start&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="VarId">show</span> <span class="VarId">start</span><span class="Symbol">)</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;cache&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="VarId">show</span> <span class="VarId">cache</span><span class="Symbol">)</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">AlterSequence</span> <span class="VarId">ann</span> <span class="VarId">nm</span> <span class="VarId">o</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;alter sequence&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">nm</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;owned by&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">o</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateTableAs</span> <span class="VarId">ann</span> <span class="VarId">t</span> <span class="VarId">sel</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create table&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">t</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">sel</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateFunction</span> <span class="VarId">ann</span> <span class="VarId">name</span> <span class="VarId">args</span> <span class="VarId">retType</span> <span class="VarId">rep</span> <span class="VarId">lang</span> <span class="VarId">body</span> <span class="VarId">vol</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="Symbol">(</span><span class="String">&quot;create &quot;</span> <span class="Symbol">++</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">rep</span> <span class="Keyword">of</span>
                         <span class="ConId">Replace</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;or replace &quot;</span>
                         <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;&quot;</span><span class="Symbol">)</span> <span class="Symbol">++</span> <span class="String">&quot;function&quot;</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">name</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">convParamDef</span> <span class="VarId">args</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;returns&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">retType</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;$$&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">convFnBody</span> <span class="VarId">body</span>
    <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;$$&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;language&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">lang</span> <span class="Keyword">of</span>
                        <span class="ConId">Sql</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;sql&quot;</span>
                        <span class="ConId">Plpgsql</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;plpgsql&quot;</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">vol</span> <span class="Keyword">of</span>
                       <span class="ConId">Volatile</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;volatile&quot;</span>
                       <span class="ConId">Stable</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;stable&quot;</span>
                       <span class="ConId">Immutable</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;immutable&quot;</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">convFnBody</span> <span class="Symbol">(</span><span class="ConId">SqlFnBody</span> <span class="VarId">ann1</span> <span class="VarId">sts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann1</span> <span class="Symbol">&lt;+&gt;</span>
        <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">sts</span>
      <span class="VarId">convFnBody</span> <span class="Symbol">(</span><span class="ConId">PlpgsqlFnBody</span> <span class="VarId">ann1</span> <span class="VarId">blk</span><span class="Symbol">)</span> <span class="Symbol">=</span>
          <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann1</span> <span class="Symbol">&lt;+&gt;</span>
          <span class="VarId">convStatement</span> <span class="VarId">ca</span> <span class="VarId">blk</span>
      <span class="VarId">convParamDef</span> <span class="Symbol">(</span><span class="ConId">ParamDef</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span>
      <span class="VarId">convParamDef</span>  <span class="Symbol">(</span><span class="ConId">ParamDefTp</span> <span class="VarId">_</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Block</span> <span class="VarId">ann</span> <span class="VarId">lb</span> <span class="VarId">decls</span> <span class="VarId">sts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
  <span class="VarId">convLabel</span> <span class="VarId">lb</span> <span class="Symbol">&lt;&gt;</span>
  <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;declare&quot;</span>
                  <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">vcat</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">convVarDef</span> <span class="VarId">l</span><span class="Symbol">))</span> <span class="VarId">decls</span>
  <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;begin&quot;</span>
  <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">sts</span>
  <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end;&quot;</span>
  <span class="Keyword">where</span>
      <span class="VarId">convVarDef</span> <span class="Symbol">(</span><span class="ConId">VarDef</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">t</span> <span class="VarId">v</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;:=&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">x</span><span class="Symbol">)</span> <span class="VarId">v</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">semi</span>
      <span class="VarId">convVarDef</span> <span class="Symbol">(</span><span class="ConId">VarAlias</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">n1</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;alias for&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">n1</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">semi</span>
      <span class="VarId">convVarDef</span> <span class="Symbol">(</span><span class="ConId">ParamAlias</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;alias for $&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="VarId">show</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">semi</span>


<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateView</span> <span class="VarId">ann</span> <span class="VarId">name</span> <span class="VarId">sel</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create view&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">name</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">sel</span><span class="Symbol">)</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateDomain</span> <span class="VarId">ann</span> <span class="VarId">name</span> <span class="VarId">tp</span> <span class="VarId">n</span> <span class="VarId">ex</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create domain&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">name</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">tp</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">cname</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">checkExp</span> <span class="VarId">ex</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">checkExp</span> <span class="Symbol">=</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;check&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="VarId">e</span><span class="Symbol">))</span>
      <span class="VarId">cname</span> <span class="Symbol">=</span> <span class="Keyword">if</span> <span class="VarId">n</span> <span class="Symbol">==</span> <span class="String">&quot;&quot;</span>
               <span class="Keyword">then</span> <span class="VarId">empty</span>
               <span class="Keyword">else</span> <span class="VarId">text</span> <span class="String">&quot;constraint&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">n</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">DropFunction</span> <span class="VarId">ann</span> <span class="VarId">ifExists</span> <span class="VarId">fns</span> <span class="VarId">casc</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
  <span class="VarId">text</span> <span class="String">&quot;drop function&quot;</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convIfExists</span> <span class="VarId">ifExists</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">doFunction</span> <span class="VarId">fns</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCasc</span> <span class="VarId">casc</span>
  <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
  <span class="Keyword">where</span>
    <span class="VarId">doFunction</span> <span class="Symbol">(</span><span class="VarId">name</span><span class="Symbol">,</span><span class="VarId">types</span><span class="Symbol">)</span> <span class="Symbol">=</span>
      <span class="VarId">text</span> <span class="VarId">name</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">convTypeName</span> <span class="VarId">types</span><span class="Symbol">)</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">DropSomething</span> <span class="VarId">ann</span> <span class="VarId">dropType</span> <span class="VarId">ifExists</span> <span class="VarId">names</span> <span class="VarId">casc</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;drop&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">dropType</span> <span class="Keyword">of</span>
                <span class="ConId">Table</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;table&quot;</span>
                <span class="ConId">View</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;view&quot;</span>
                <span class="ConId">Domain</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;domain&quot;</span>
                <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;type&quot;</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convIfExists</span> <span class="VarId">ifExists</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">names</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCasc</span> <span class="VarId">casc</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateType</span> <span class="VarId">ann</span> <span class="VarId">name</span> <span class="VarId">atts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create type&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">name</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">lparen</span>
    <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">csv</span>
          <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(\(</span><span class="ConId">TypeAttDef</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span><span class="Symbol">)</span>  <span class="VarId">atts</span><span class="Symbol">)))</span>
    <span class="Symbol">$+$</span> <span class="VarId">rparen</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateLanguage</span> <span class="VarId">ann</span> <span class="VarId">name</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create language&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">name</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CreateTrigger</span> <span class="VarId">ann</span> <span class="VarId">name</span> <span class="VarId">wh</span> <span class="VarId">events</span> <span class="VarId">tbl</span> <span class="VarId">firing</span> <span class="VarId">fnName</span> <span class="VarId">fnArgs</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;create trigger&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">name</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">wh</span> <span class="Keyword">of</span>
                      <span class="ConId">TriggerBefore</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;before&quot;</span>
                      <span class="ConId">TriggerAfter</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;after&quot;</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">evs</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;on&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">tbl</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;for&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">firing</span> <span class="Keyword">of</span>
                                        <span class="ConId">EachRow</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;row&quot;</span>
                                        <span class="ConId">EachStatement</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;statement&quot;</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;execute procedure&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">fnName</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">fnArgs</span><span class="Symbol">)</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">evs</span> <span class="Symbol">=</span> <span class="VarId">hcat</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">text</span> <span class="Symbol">$</span> <span class="VarId">intersperse</span> <span class="String">&quot; or &quot;</span>
            <span class="Symbol">$</span> <span class="VarId">map</span> <span class="Symbol">(\</span><span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="Keyword">case</span> <span class="VarId">e</span> <span class="Keyword">of</span>
                                <span class="ConId">TInsert</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;insert&quot;</span>
                                <span class="ConId">TUpdate</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;update&quot;</span>
                                <span class="ConId">TDelete</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;delete&quot;</span><span class="Symbol">)</span> <span class="VarId">events</span>

<span class="Comment">-- plpgsql</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">NullStatement</span> <span class="VarId">ann</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;null&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">ExitStatement</span> <span class="VarId">ann</span> <span class="VarId">lb</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;exit&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybe</span> <span class="VarId">empty</span> <span class="VarId">text</span> <span class="VarId">lb</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Assignment</span> <span class="VarId">ann</span> <span class="VarId">name</span> <span class="VarId">val</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">convExp</span> <span class="VarId">name</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;:=&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">val</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Return</span> <span class="VarId">ann</span> <span class="VarId">ex</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;return&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="VarId">convExp</span> <span class="VarId">ex</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">ReturnNext</span> <span class="VarId">ann</span> <span class="VarId">ex</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;return&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;next&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">ex</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">ReturnQuery</span> <span class="VarId">ann</span> <span class="VarId">sel</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;return&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;query&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">sel</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Raise</span> <span class="VarId">ann</span> <span class="VarId">rt</span> <span class="VarId">st</span> <span class="VarId">exps</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;raise&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="Keyword">case</span> <span class="VarId">rt</span> <span class="Keyword">of</span>
                <span class="ConId">RNotice</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;notice&quot;</span>
                <span class="ConId">RException</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;exception&quot;</span>
                <span class="ConId">RError</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;error&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="ConId">StringLit</span> <span class="VarId">emptyAnnotation</span> <span class="VarId">st</span><span class="Symbol">)</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">comma</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">csvExp</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="VarId">exps</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">ForSelectStatement</span> <span class="VarId">ann</span> <span class="VarId">lb</span> <span class="VarId">i</span> <span class="VarId">sel</span> <span class="VarId">stmts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">convLabel</span> <span class="VarId">lb</span> <span class="Symbol">&lt;&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;for&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">i</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;in&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">sel</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;loop&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">stmts</span>
    <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end loop&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">ForIntegerStatement</span> <span class="VarId">ann</span> <span class="VarId">lb</span> <span class="VarId">var</span> <span class="VarId">st</span> <span class="VarId">en</span> <span class="VarId">stmts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">convLabel</span> <span class="VarId">lb</span> <span class="Symbol">&lt;&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;for&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">var</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;in&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">st</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;..&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">en</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;loop&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">stmts</span>
    <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end loop&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">WhileStatement</span> <span class="VarId">ann</span> <span class="VarId">lb</span> <span class="VarId">ex</span> <span class="VarId">stmts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">convLabel</span> <span class="VarId">lb</span> <span class="Symbol">&lt;&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;while&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">ex</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;loop&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">stmts</span>
    <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end loop&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">LoopStatement</span> <span class="VarId">ann</span> <span class="VarId">lb</span> <span class="VarId">stmts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">convLabel</span> <span class="VarId">lb</span> <span class="Symbol">&lt;&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;loop&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">stmts</span>
    <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end loop&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">ContinueStatement</span> <span class="VarId">ann</span> <span class="VarId">lb</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;continue&quot;</span>
      <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybe</span> <span class="VarId">empty</span> <span class="VarId">text</span> <span class="VarId">lb</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Perform</span> <span class="VarId">ann</span> <span class="VarId">f</span><span class="Symbol">@(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">))</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;perform&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">f</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
<span class="Function">convStatement</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Perform</span> <span class="VarId">_</span> <span class="VarId">x</span><span class="Symbol">)</span> <span class="Symbol">=</span>
   <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;internal error: convStatement not supported for &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Copy</span> <span class="VarId">ann</span> <span class="VarId">tb</span> <span class="VarId">cols</span> <span class="VarId">src</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;copy&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">tb</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">.</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">text</span><span class="Symbol">)</span> <span class="VarId">cols</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;from&quot;</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="Keyword">case</span> <span class="VarId">src</span> <span class="Keyword">of</span>
                 <span class="ConId">CopyFilename</span> <span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="VarId">quotes</span> <span class="Symbol">$</span> <span class="VarId">text</span> <span class="VarId">s</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
                 <span class="ConId">Stdin</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;stdin&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;;&quot;</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CopyData</span> <span class="VarId">ann</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="VarId">s</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;\\.&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">newline</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">If</span> <span class="VarId">ann</span> <span class="VarId">conds</span> <span class="VarId">els</span><span class="Symbol">)</span> <span class="Symbol">=</span>
   <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
   <span class="VarId">text</span> <span class="String">&quot;if&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCond</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">conds</span><span class="Symbol">)</span>
   <span class="Symbol">$+$</span> <span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(\</span><span class="VarId">c</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;elseif&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCond</span> <span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">tail</span> <span class="VarId">conds</span><span class="Symbol">)</span>
   <span class="Symbol">$+$</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="VarId">els</span>
   <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end if&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">convCond</span> <span class="Symbol">(</span><span class="VarId">ex</span><span class="Symbol">,</span> <span class="VarId">sts</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convExp</span> <span class="VarId">ex</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;then&quot;</span>
                           <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">sts</span>
<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">Execute</span> <span class="VarId">ann</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;execute&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">s</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">ExecuteInto</span> <span class="VarId">ann</span> <span class="VarId">s</span> <span class="VarId">is</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;execute&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">s</span>
    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;into&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">is</span>
    <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CaseStatementSimple</span> <span class="VarId">ann</span> <span class="VarId">c</span> <span class="VarId">conds</span> <span class="VarId">els</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;case&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">c</span>
    <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span>
                <span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(</span><span class="VarId">uncurry</span> <span class="VarId">convWhenSt</span><span class="Symbol">)</span> <span class="VarId">conds</span><span class="Symbol">)</span>
                <span class="Symbol">$+$</span> <span class="VarId">convElseSt</span> <span class="VarId">els</span>
                <span class="Symbol">)</span> <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end case&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">convWhenSt</span> <span class="VarId">ex</span> <span class="VarId">sts</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;when&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">ex</span>
                          <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;then&quot;</span> <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">sts</span>
      <span class="VarId">convElseSt</span> <span class="Symbol">=</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;else&quot;</span>
                                     <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">s</span><span class="Symbol">)</span>
<span class="Function">convStatement</span> <span class="VarId">ca</span> <span class="Symbol">(</span><span class="ConId">CaseStatement</span> <span class="VarId">ann</span> <span class="VarId">conds</span> <span class="VarId">els</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="VarId">convPa</span> <span class="VarId">ca</span> <span class="VarId">ann</span> <span class="Symbol">&lt;+&gt;</span>
    <span class="VarId">text</span> <span class="String">&quot;case&quot;</span>
    <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span>
                <span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(</span><span class="VarId">uncurry</span> <span class="VarId">convWhenSt</span><span class="Symbol">)</span> <span class="VarId">conds</span><span class="Symbol">)</span>
                <span class="Symbol">$+$</span> <span class="VarId">convElseSt</span> <span class="VarId">els</span>
                <span class="Symbol">)</span> <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end case&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
    <span class="Keyword">where</span>
      <span class="VarId">convWhenSt</span> <span class="VarId">ex</span> <span class="VarId">sts</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;when&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">ex</span>
                          <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;then&quot;</span> <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">sts</span>
      <span class="VarId">convElseSt</span> <span class="Symbol">=</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;else&quot;</span>
                                     <span class="Symbol">$+$</span> <span class="VarId">convNestedStatements</span> <span class="VarId">ca</span> <span class="VarId">s</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Comment">-- misc</span>

<span class="Function">convStatement</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Set</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">vs</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="String">&quot;set&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;=&quot;</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="Symbol">(</span><span class="VarId">text</span> <span class="Symbol">.</span> <span class="VarId">dv</span><span class="Symbol">)</span> <span class="VarId">vs</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>
  <span class="Keyword">where</span>
    <span class="VarId">dv</span> <span class="Symbol">(</span><span class="ConId">SetStr</span> <span class="VarId">_</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="String">&quot;'&quot;</span> <span class="Symbol">++</span> <span class="VarId">s</span> <span class="Symbol">++</span> <span class="String">&quot;'&quot;</span>
    <span class="VarId">dv</span> <span class="Symbol">(</span><span class="ConId">SetId</span> <span class="VarId">_</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">i</span>
    <span class="VarId">dv</span> <span class="Symbol">(</span><span class="ConId">SetNum</span> <span class="VarId">_</span> <span class="VarId">nm</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">show</span> <span class="VarId">nm</span>

<span class="Function">convStatement</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Notify</span> <span class="VarId">_</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="String">&quot;notify&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">n</span>  <span class="Symbol">&lt;&gt;</span> <span class="VarId">statementEnd</span>

<span class="Function">statementEnd</span> <span class="Symbol">::</span> <span class="ConId">Doc</span>
<span class="Function">statementEnd</span> <span class="Symbol">=</span> <span class="VarId">semi</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">newline</span></pre></div></div></div><hr
     /><p
    >Statement components</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">-- selects</span>

<span class="Function">convSelectExpression</span> <span class="Symbol">::</span> <span class="ConId">Bool</span> <span class="Symbol">-&gt;</span> <span class="ConId">Bool</span> <span class="Symbol">-&gt;</span> <span class="ConId">SelectExpression</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convSelectExpression</span> <span class="VarId">writeSelect</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Select</span> <span class="VarId">_</span> <span class="VarId">dis</span> <span class="VarId">l</span> <span class="VarId">tb</span> <span class="VarId">wh</span> <span class="VarId">grp</span> <span class="VarId">hav</span>
                                <span class="VarId">order</span> <span class="VarId">lim</span> <span class="VarId">off</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">writeSelect</span> <span class="Keyword">then</span> <span class="String">&quot;select&quot;</span> <span class="Keyword">else</span> <span class="String">&quot;&quot;</span><span class="Symbol">)</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">dis</span> <span class="Keyword">of</span>
         <span class="ConId">Dupes</span> <span class="Symbol">-&gt;</span> <span class="VarId">empty</span>
         <span class="ConId">Distinct</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;distinct&quot;</span><span class="Symbol">)</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convSelList</span> <span class="VarId">l</span>
  <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span>
              <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">null</span> <span class="VarId">tb</span>
                 <span class="Keyword">then</span> <span class="VarId">empty</span>
                 <span class="Keyword">else</span> <span class="VarId">text</span> <span class="String">&quot;from&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convTref</span> <span class="VarId">tb</span><span class="Symbol">)</span>
              <span class="Symbol">$+$</span> <span class="VarId">convWhere</span> <span class="VarId">wh</span><span class="Symbol">)</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">g</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;group by&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">g</span><span class="Symbol">)</span> <span class="VarId">grp</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">h</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;having&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">h</span><span class="Symbol">)</span> <span class="VarId">hav</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">o</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;order by&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="Symbol">(\(</span><span class="VarId">oe</span><span class="Symbol">,</span><span class="VarId">od</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">convExp</span> <span class="VarId">oe</span>
                  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convDir</span> <span class="VarId">od</span><span class="Symbol">)</span> <span class="VarId">o</span><span class="Symbol">)</span> <span class="VarId">order</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">lm</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;limit&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">lm</span><span class="Symbol">)</span> <span class="VarId">lim</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">offs</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;offset&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">offs</span><span class="Symbol">)</span> <span class="VarId">off</span>

<span class="Function">convSelectExpression</span> <span class="VarId">writeSelect</span> <span class="VarId">topLev</span> <span class="Symbol">(</span><span class="ConId">CombineSelect</span> <span class="VarId">_</span> <span class="VarId">tp</span> <span class="VarId">s1</span> <span class="VarId">s2</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="Keyword">let</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">convSelectExpression</span> <span class="VarId">writeSelect</span> <span class="ConId">False</span> <span class="VarId">s1</span>
          <span class="Symbol">$+$</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">tp</span> <span class="Keyword">of</span>
                       <span class="ConId">Except</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;except&quot;</span>
                       <span class="ConId">Union</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;union&quot;</span>
                       <span class="ConId">UnionAll</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;union&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;all&quot;</span>
                       <span class="ConId">Intersect</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;intersect&quot;</span><span class="Symbol">)</span>
          <span class="Symbol">$+$</span> <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">False</span> <span class="VarId">s2</span>
  <span class="Keyword">in</span> <span class="Keyword">if</span> <span class="VarId">topLev</span> <span class="Keyword">then</span> <span class="VarId">p</span> <span class="Keyword">else</span> <span class="VarId">parens</span> <span class="VarId">p</span>
<span class="Function">convSelectExpression</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Values</span> <span class="VarId">_</span> <span class="VarId">expss</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="String">&quot;values&quot;</span> <span class="Symbol">$$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">vcat</span> <span class="Symbol">$</span> <span class="VarId">csv</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">.</span> <span class="VarId">csvExp</span><span class="Symbol">)</span> <span class="VarId">expss</span><span class="Symbol">)</span>
<span class="Function">convSelectExpression</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">WithSelect</span> <span class="VarId">_</span> <span class="VarId">wqs</span> <span class="VarId">ex</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="String">&quot;with&quot;</span> <span class="Symbol">$$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">vcat</span> <span class="Symbol">$</span> <span class="VarId">csv</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">pwq</span> <span class="VarId">wqs</span><span class="Symbol">)</span>
       <span class="Symbol">$+$</span> <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">False</span> <span class="VarId">ex</span>
  <span class="Keyword">where</span>
    <span class="VarId">pwq</span> <span class="Symbol">(</span><span class="ConId">WithQuery</span> <span class="VarId">_</span> <span class="VarId">nm</span> <span class="VarId">ex1</span><span class="Symbol">)</span> <span class="Symbol">=</span>
      <span class="VarId">text</span> <span class="VarId">nm</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span>
      <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">False</span> <span class="VarId">ex1</span><span class="Symbol">)</span>

<span class="Function">convTref</span> <span class="Symbol">::</span> <span class="ConId">TableRef</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convTref</span> <span class="Symbol">(</span><span class="ConId">Tref</span> <span class="VarId">_</span> <span class="VarId">f</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convExp</span> <span class="VarId">f</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTrefAlias</span> <span class="VarId">a</span>
<span class="Function">convTref</span> <span class="Symbol">(</span><span class="ConId">JoinedTref</span> <span class="VarId">_</span> <span class="VarId">t1</span> <span class="VarId">nat</span> <span class="VarId">jt</span> <span class="VarId">t2</span> <span class="VarId">ex</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convTref</span> <span class="VarId">t1</span>
        <span class="Symbol">$+$</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">nat</span> <span class="Keyword">of</span>
                      <span class="ConId">Natural</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;natural&quot;</span>
                      <span class="ConId">Unnatural</span> <span class="Symbol">-&gt;</span> <span class="VarId">empty</span><span class="Symbol">)</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">jt</span> <span class="Keyword">of</span>
                          <span class="ConId">Inner</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;inner&quot;</span>
                          <span class="ConId">Cross</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;cross&quot;</span>
                          <span class="ConId">LeftOuter</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;left outer&quot;</span>
                          <span class="ConId">RightOuter</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;right outer&quot;</span>
                          <span class="ConId">FullOuter</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;full outer&quot;</span><span class="Symbol">)</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;join&quot;</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTref</span> <span class="VarId">t2</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">maybeConv</span> <span class="Symbol">(</span><span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">.</span> <span class="VarId">convJoinExpression</span><span class="Symbol">)</span> <span class="VarId">ex</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTrefAlias</span> <span class="VarId">a</span><span class="Symbol">)</span>
        <span class="Keyword">where</span>
          <span class="VarId">convJoinExpression</span> <span class="Symbol">(</span><span class="ConId">JoinOn</span> <span class="VarId">_</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;on&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">e</span>
          <span class="VarId">convJoinExpression</span> <span class="Symbol">(</span><span class="ConId">JoinUsing</span> <span class="VarId">_</span> <span class="VarId">ids</span><span class="Symbol">)</span> <span class="Symbol">=</span>
              <span class="VarId">text</span> <span class="String">&quot;using&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">ids</span><span class="Symbol">)</span>

<span class="Function">convTref</span> <span class="Symbol">(</span><span class="ConId">SubTref</span> <span class="VarId">_</span> <span class="VarId">sub</span> <span class="VarId">alias</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">sub</span><span class="Symbol">)</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTrefAlias</span> <span class="VarId">alias</span>
<span class="Function">convTref</span> <span class="Symbol">(</span><span class="ConId">TrefFun</span> <span class="VarId">_</span> <span class="VarId">f</span><span class="Symbol">@(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convExp</span> <span class="VarId">f</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTrefAlias</span> <span class="VarId">a</span>
<span class="Function">convTref</span> <span class="Symbol">(</span><span class="ConId">TrefFun</span> <span class="VarId">_</span> <span class="VarId">x</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">=</span>
      <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;internal error: node not supported in function tref: &quot;</span>
            <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span>

<span class="Function">convTrefAlias</span> <span class="Symbol">::</span> <span class="ConId">TableAlias</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convTrefAlias</span> <span class="ConId">NoAlias</span> <span class="Symbol">=</span> <span class="VarId">empty</span>
<span class="Function">convTrefAlias</span> <span class="Symbol">(</span><span class="ConId">TableAlias</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="VarId">t</span>
<span class="Function">convTrefAlias</span> <span class="Symbol">(</span><span class="ConId">FullAlias</span> <span class="VarId">t</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="VarId">t</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">s</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">convDir</span> <span class="Symbol">::</span> <span class="ConId">Direction</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convDir</span> <span class="VarId">d</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="Symbol">$</span> <span class="Keyword">case</span> <span class="VarId">d</span> <span class="Keyword">of</span>
                          <span class="ConId">Asc</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;asc&quot;</span>
                          <span class="ConId">Desc</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;desc&quot;</span>

<span class="Function">convWhere</span> <span class="Symbol">::</span> <span class="ConId">Maybe</span> <span class="ConId">Expression</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convWhere</span> <span class="Symbol">(</span><span class="ConId">Just</span> <span class="VarId">ex</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;where&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">ex</span>
<span class="Function">convWhere</span> <span class="ConId">Nothing</span> <span class="Symbol">=</span> <span class="VarId">empty</span>

<span class="Function">convSelList</span> <span class="Symbol">::</span> <span class="ConId">SelectList</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convSelList</span> <span class="Symbol">(</span><span class="ConId">SelectList</span> <span class="VarId">_</span> <span class="VarId">ex</span> <span class="VarId">into</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">hcatCsvMap</span> <span class="VarId">convSelItem</span> <span class="VarId">ex</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(\</span><span class="VarId">i</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;into&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="VarId">into</span>
  <span class="Keyword">where</span>
    <span class="VarId">convSelItem</span> <span class="Symbol">(</span><span class="ConId">SelectItem</span> <span class="VarId">_</span> <span class="VarId">ex1</span> <span class="VarId">nm</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convExpSl</span> <span class="VarId">ex1</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">nm</span>
    <span class="VarId">convSelItem</span> <span class="Symbol">(</span><span class="ConId">SelExp</span> <span class="VarId">_</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convExpSl</span> <span class="VarId">e</span>

<span class="Function">convCasc</span> <span class="Symbol">::</span> <span class="ConId">Cascade</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convCasc</span> <span class="VarId">casc</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="Symbol">$</span> <span class="Keyword">case</span> <span class="VarId">casc</span> <span class="Keyword">of</span>
                                 <span class="ConId">Cascade</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;cascade&quot;</span>
                                 <span class="ConId">Restrict</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;restrict&quot;</span>

<span class="Comment">-- ddl</span>

<span class="Function">convCon</span> <span class="Symbol">::</span> <span class="ConId">Constraint</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convCon</span> <span class="Symbol">(</span><span class="ConId">UniqueConstraint</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;unique&quot;</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">c</span><span class="Symbol">)</span>
<span class="Function">convCon</span> <span class="Symbol">(</span><span class="ConId">PrimaryKeyConstraint</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span>
        <span class="VarId">text</span> <span class="String">&quot;primary key&quot;</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">p</span><span class="Symbol">)</span>
<span class="Function">convCon</span> <span class="Symbol">(</span><span class="ConId">CheckConstraint</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;check&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="VarId">c</span><span class="Symbol">)</span>
<span class="Function">convCon</span> <span class="Symbol">(</span><span class="ConId">ReferenceConstraint</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">at</span> <span class="VarId">tb</span> <span class="VarId">rat</span> <span class="VarId">ondel</span> <span class="VarId">onupd</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">mname</span> <span class="VarId">n</span> <span class="Symbol">&lt;+&gt;</span>
        <span class="VarId">text</span> <span class="String">&quot;foreign key&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">text</span> <span class="VarId">at</span><span class="Symbol">)</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;references&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">tb</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">ifNotEmpty</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">.</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">text</span><span class="Symbol">)</span> <span class="VarId">rat</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;on update&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCasc</span> <span class="VarId">onupd</span>
        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;on delete&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convCasc</span> <span class="VarId">ondel</span>

<span class="Function">mname</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">mname</span> <span class="VarId">n</span> <span class="Symbol">=</span> <span class="Keyword">if</span> <span class="VarId">n</span> <span class="Symbol">==</span> <span class="String">&quot;&quot;</span>
          <span class="Keyword">then</span> <span class="VarId">empty</span>
          <span class="Keyword">else</span> <span class="VarId">text</span> <span class="String">&quot;constraint&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">n</span>

<span class="Function">convReturning</span> <span class="Symbol">::</span> <span class="ConId">Maybe</span> <span class="ConId">SelectList</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convReturning</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">l</span> <span class="Keyword">of</span>
                <span class="ConId">Nothing</span> <span class="Symbol">-&gt;</span> <span class="VarId">empty</span>
                <span class="ConId">Just</span> <span class="VarId">ls</span> <span class="Symbol">-&gt;</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">text</span> <span class="String">&quot;returning&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convSelList</span> <span class="VarId">ls</span><span class="Symbol">)</span>

<span class="Function">convIfExists</span> <span class="Symbol">::</span> <span class="ConId">IfExists</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convIfExists</span> <span class="VarId">i</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">i</span> <span class="Keyword">of</span>
                        <span class="ConId">Require</span> <span class="Symbol">-&gt;</span> <span class="VarId">empty</span>
                        <span class="ConId">IfExists</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;if exists&quot;</span>

<span class="Comment">-- plpgsql</span>

<span class="Function">convNestedStatements</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">StatementList</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convNestedStatements</span> <span class="VarId">pa</span> <span class="Symbol">=</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">.</span> <span class="VarId">vcat</span> <span class="Symbol">.</span> <span class="VarId">map</span> <span class="Symbol">(</span><span class="VarId">convStatement</span> <span class="VarId">pa</span><span class="Symbol">)</span>

<span class="Function">convTypeName</span> <span class="Symbol">::</span> <span class="ConId">TypeName</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convTypeName</span> <span class="Symbol">(</span><span class="ConId">SimpleTypeName</span> <span class="VarId">_</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="VarId">s</span>
<span class="Function">convTypeName</span> <span class="Symbol">(</span><span class="ConId">PrecTypeName</span> <span class="VarId">_</span> <span class="VarId">s</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="VarId">s</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span><span class="Symbol">(</span><span class="VarId">integer</span> <span class="VarId">i</span><span class="Symbol">)</span>
<span class="Function">convTypeName</span> <span class="Symbol">(</span><span class="ConId">Prec2TypeName</span> <span class="VarId">_</span> <span class="VarId">s</span> <span class="VarId">i</span> <span class="VarId">i1</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="VarId">s</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsv</span> <span class="Symbol">[</span><span class="VarId">integer</span> <span class="VarId">i</span><span class="Symbol">,</span> <span class="VarId">integer</span> <span class="VarId">i1</span><span class="Symbol">])</span>
<span class="Function">convTypeName</span> <span class="Symbol">(</span><span class="ConId">ArrayTypeName</span> <span class="VarId">_</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;[]&quot;</span>
<span class="Function">convTypeName</span> <span class="Symbol">(</span><span class="ConId">SetOfTypeName</span> <span class="VarId">_</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;setof&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span>

<span class="Comment">-- expressions</span>

<span class="Function">convExp</span> <span class="Symbol">::</span> <span class="ConId">Expression</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="Keyword">if</span> <span class="VarId">quotesNeeded</span>
     <span class="Keyword">then</span> <span class="VarId">text</span> <span class="Symbol">$</span> <span class="String">&quot;\&quot;&quot;</span> <span class="Symbol">++</span> <span class="VarId">i</span> <span class="Symbol">++</span> <span class="String">&quot;\&quot;&quot;</span>
     <span class="Keyword">else</span> <span class="VarId">text</span> <span class="VarId">i</span>
  <span class="Keyword">where</span>
    <span class="Comment">--needs some work - quotes needed if contains invalid unquoted</span>
    <span class="Comment">--chars, or maybe if matches keyword or similar</span>
    <span class="VarId">quotesNeeded</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">i</span> <span class="Keyword">of</span>
                     <span class="VarId">x</span><span class="Symbol">:</span><span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="VarId">isLetter</span> <span class="VarId">x</span> <span class="Symbol">||</span> <span class="VarId">x</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="String">&quot;_*&quot;</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">True</span>
                     <span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">all</span> <span class="VarId">okChar</span> <span class="VarId">i</span> <span class="Symbol">-&gt;</span> <span class="ConId">False</span>
                       <span class="Symbol">|</span> <span class="VarId">otherwise</span> <span class="Symbol">-&gt;</span> <span class="ConId">True</span>
                   <span class="Keyword">where</span>
                     <span class="VarId">okChar</span> <span class="VarId">x</span> <span class="Symbol">=</span><span class="VarId">isAlphaNum</span> <span class="VarId">x</span> <span class="Symbol">||</span> <span class="VarId">x</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="String">&quot;*_.&quot;</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">QIdentifier</span> <span class="VarId">a</span> <span class="VarId">i1</span><span class="Symbol">@(</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">convExp</span> <span class="VarId">i1</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;.&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">a</span> <span class="VarId">i</span><span class="Symbol">)</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">QIdentifier</span> <span class="VarId">a</span> <span class="VarId">e</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;.&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">a</span> <span class="VarId">i</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">--convExp (PIdentifier _ i) = parens $ convExp i</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">IntegerLit</span> <span class="VarId">_</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">integer</span> <span class="VarId">n</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">FloatLit</span> <span class="VarId">_</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">double</span> <span class="VarId">n</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">StringLit</span> <span class="VarId">_</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Comment">-- needs some thought about using $$?</span>
                          <span class="VarId">text</span> <span class="String">&quot;'&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="VarId">replaceQuotes</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;'&quot;</span>
                          <span class="Keyword">where</span>
                            <span class="VarId">replaceQuotes</span> <span class="Symbol">=</span> <span class="VarId">replace</span> <span class="String">&quot;'&quot;</span> <span class="String">&quot;''&quot;</span> <span class="VarId">s</span> <span class="Comment">{-if tag == &quot;'&quot;</span>
<span class="Comment">                                              then replace &quot;'&quot; &quot;''&quot; s</span>
<span class="Comment">                                              else s-}</span>

<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">es</span><span class="Symbol">)</span> <span class="Symbol">=</span>
    <span class="Comment">--check for special operators</span>
   <span class="Keyword">case</span> <span class="VarId">n</span> <span class="Keyword">of</span>
     <span class="String">&quot;!arrayctor&quot;</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;array&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">brackets</span> <span class="Symbol">(</span><span class="VarId">csvExp</span> <span class="VarId">es</span><span class="Symbol">)</span>
     <span class="String">&quot;!between&quot;</span> <span class="Symbol">-&gt;</span> <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">es</span><span class="Symbol">)</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;between&quot;</span>
                   <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">es</span> <span class="Symbol">!!</span> <span class="Number">1</span><span class="Symbol">))</span>
                  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;and&quot;</span>
                  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">es</span> <span class="Symbol">!!</span> <span class="Number">2</span><span class="Symbol">))</span>
     <span class="String">&quot;!substring&quot;</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;substring&quot;</span>
                     <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">es</span><span class="Symbol">)</span>
                                <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;from&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">es</span> <span class="Symbol">!!</span> <span class="Number">1</span><span class="Symbol">)</span>
                                <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;for&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">es</span> <span class="Symbol">!!</span> <span class="Number">2</span><span class="Symbol">))</span>
     <span class="String">&quot;!arraysub&quot;</span> <span class="Symbol">-&gt;</span> <span class="Keyword">case</span> <span class="VarId">es</span> <span class="Keyword">of</span>
                       <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">i</span> <span class="Symbol">:</span> <span class="VarId">es1</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="VarId">i</span>
                                                 <span class="Symbol">&lt;&gt;</span> <span class="VarId">brackets</span> <span class="Symbol">(</span><span class="VarId">csvExp</span> <span class="VarId">es1</span><span class="Symbol">)</span>
                       <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">es</span><span class="Symbol">))</span>
                            <span class="Symbol">&lt;&gt;</span> <span class="VarId">brackets</span> <span class="Symbol">(</span><span class="VarId">csvExp</span> <span class="Symbol">(</span><span class="VarId">tail</span> <span class="VarId">es</span><span class="Symbol">))</span>
     <span class="String">&quot;!rowctor&quot;</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;row&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">es</span><span class="Symbol">)</span>
     <span class="String">&quot;.&quot;</span>   <span class="Comment">-- special case to avoid ws around '.'. Don't know if this is important</span>
           <span class="Comment">-- or just cosmetic</span>
         <span class="Symbol">|</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">]</span> <span class="Symbol">&lt;-</span> <span class="VarId">es</span> <span class="Symbol">-&gt;</span> <span class="VarId">convExp</span> <span class="VarId">a</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;.&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">convExp</span> <span class="VarId">b</span>
     <span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">isOperatorName</span> <span class="VarId">n</span> <span class="Symbol">-&gt;</span>
        <span class="Keyword">case</span> <span class="VarId">forceRight</span> <span class="Symbol">(</span><span class="VarId">getOperatorType</span> <span class="VarId">defaultTemplate1Catalog</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="Keyword">of</span>
                          <span class="ConId">BinaryOp</span> <span class="Symbol">-&gt;</span>
                              <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">es</span><span class="Symbol">)</span>
                                      <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="VarId">filterKeyword</span> <span class="VarId">n</span><span class="Symbol">)</span>
                                      <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">es</span> <span class="Symbol">!!</span> <span class="Number">1</span><span class="Symbol">))</span>
                          <span class="ConId">PrefixOp</span> <span class="Symbol">-&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">n</span> <span class="Symbol">==</span> <span class="String">&quot;u-&quot;</span>
                                                       <span class="Keyword">then</span> <span class="String">&quot;-&quot;</span>
                                                       <span class="Keyword">else</span> <span class="VarId">filterKeyword</span> <span class="VarId">n</span><span class="Symbol">)</span>
                                               <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">es</span><span class="Symbol">)))</span>
                          <span class="ConId">PostfixOp</span> <span class="Symbol">-&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">es</span><span class="Symbol">)</span>
                                       <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="VarId">filterKeyword</span> <span class="VarId">n</span><span class="Symbol">))</span>
       <span class="Symbol">|</span> <span class="VarId">otherwise</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="VarId">n</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">csvExp</span> <span class="VarId">es</span><span class="Symbol">)</span>
   <span class="Keyword">where</span>
     <span class="VarId">filterKeyword</span> <span class="VarId">t</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">t</span> <span class="Keyword">of</span>
                         <span class="String">&quot;!and&quot;</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;and&quot;</span>
                         <span class="String">&quot;!or&quot;</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;or&quot;</span>
                         <span class="String">&quot;!not&quot;</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;not&quot;</span>
                         <span class="String">&quot;!isnull&quot;</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;is null&quot;</span>
                         <span class="String">&quot;!isnotnull&quot;</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;is not null&quot;</span>
                         <span class="String">&quot;!like&quot;</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;like&quot;</span>
                         <span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">x</span>

<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">BooleanLit</span> <span class="VarId">_</span> <span class="VarId">b</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">bool</span> <span class="VarId">b</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">InPredicate</span> <span class="VarId">_</span> <span class="VarId">att</span> <span class="VarId">t</span> <span class="VarId">lst</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convExp</span> <span class="VarId">att</span> <span class="Symbol">&lt;+&gt;</span> <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">not</span> <span class="VarId">t</span> <span class="Keyword">then</span> <span class="VarId">text</span> <span class="String">&quot;not&quot;</span> <span class="Keyword">else</span> <span class="VarId">empty</span><span class="Symbol">)</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;in&quot;</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">lst</span> <span class="Keyword">of</span>
                       <span class="ConId">InList</span> <span class="VarId">_</span> <span class="VarId">expr</span> <span class="Symbol">-&gt;</span> <span class="VarId">csvExp</span> <span class="VarId">expr</span>
                       <span class="ConId">InSelect</span> <span class="VarId">_</span> <span class="VarId">sel</span> <span class="Symbol">-&gt;</span> <span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">sel</span><span class="Symbol">)</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">LiftOperator</span> <span class="VarId">_</span> <span class="VarId">op</span> <span class="VarId">flav</span> <span class="VarId">args</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convExp</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">args</span><span class="Symbol">)</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">op</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="Symbol">(</span><span class="Keyword">case</span> <span class="VarId">flav</span> <span class="Keyword">of</span>
              <span class="ConId">LiftAny</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;any&quot;</span>
              <span class="ConId">LiftAll</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;all&quot;</span><span class="Symbol">)</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="Symbol">$</span> <span class="VarId">head</span> <span class="Symbol">$</span> <span class="VarId">tail</span> <span class="VarId">args</span><span class="Symbol">)</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">ScalarSubQuery</span> <span class="VarId">_</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">s</span><span class="Symbol">)</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">NullLit</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;null&quot;</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">WindowFn</span> <span class="VarId">_</span> <span class="VarId">fn</span> <span class="VarId">part</span> <span class="VarId">order</span> <span class="VarId">asc</span> <span class="VarId">frm</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">convExp</span> <span class="VarId">fn</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;over&quot;</span>
  <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">hp</span> <span class="Symbol">||</span> <span class="VarId">ho</span>
              <span class="Keyword">then</span> <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">hp</span>
                    <span class="Keyword">then</span> <span class="VarId">text</span> <span class="String">&quot;partition by&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">csvExp</span> <span class="VarId">part</span>
                    <span class="Keyword">else</span> <span class="VarId">empty</span><span class="Symbol">)</span>
                    <span class="Symbol">&lt;+&gt;</span> <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">ho</span>
                         <span class="Keyword">then</span> <span class="VarId">text</span> <span class="String">&quot;order by&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">csvExp</span> <span class="VarId">order</span>
                              <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convDir</span> <span class="VarId">asc</span>
                         <span class="Keyword">else</span> <span class="VarId">empty</span><span class="Symbol">)</span>
                    <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convFrm</span>
              <span class="Keyword">else</span> <span class="VarId">empty</span><span class="Symbol">)</span>
  <span class="Keyword">where</span>
    <span class="VarId">hp</span> <span class="Symbol">=</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="VarId">null</span> <span class="VarId">part</span><span class="Symbol">)</span>
    <span class="VarId">ho</span> <span class="Symbol">=</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="VarId">null</span> <span class="VarId">order</span><span class="Symbol">)</span>
    <span class="VarId">convFrm</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">frm</span> <span class="Keyword">of</span>
                <span class="ConId">FrameUnboundedPreceding</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;range unbounded preceding&quot;</span>
                <span class="ConId">FrameUnboundedFull</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;range between unbounded \
                                           \preceding and unbounded following&quot;</span>
                <span class="ConId">FrameRowsUnboundedPreceding</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;rows unbounded preceding&quot;</span>

<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">Case</span> <span class="VarId">_</span> <span class="VarId">whens</span> <span class="VarId">els</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="String">&quot;case&quot;</span>
  <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">convWhen</span> <span class="VarId">whens</span><span class="Symbol">)</span>
              <span class="Symbol">$+$</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="VarId">els</span><span class="Symbol">)</span>
  <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end&quot;</span>
      <span class="Keyword">where</span>
        <span class="VarId">convWhen</span> <span class="Symbol">(</span><span class="VarId">ex1</span><span class="Symbol">,</span> <span class="VarId">ex2</span><span class="Symbol">)</span> <span class="Symbol">=</span>
            <span class="VarId">text</span> <span class="String">&quot;when&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">ex1</span>
            <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;then&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">ex2</span>

<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">CaseSimple</span> <span class="VarId">_</span> <span class="VarId">val</span> <span class="VarId">whens</span> <span class="VarId">els</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="String">&quot;case&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">val</span>
  <span class="Symbol">$+$</span> <span class="VarId">nest</span> <span class="Number">2</span> <span class="Symbol">(</span><span class="VarId">vcat</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">convWhen</span> <span class="VarId">whens</span><span class="Symbol">)</span>
              <span class="Symbol">$+$</span> <span class="VarId">maybeConv</span> <span class="Symbol">(\</span><span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="VarId">els</span><span class="Symbol">)</span>
  <span class="Symbol">$+$</span> <span class="VarId">text</span> <span class="String">&quot;end&quot;</span>
      <span class="Keyword">where</span>
        <span class="VarId">convWhen</span> <span class="Symbol">(</span><span class="VarId">ex1</span><span class="Symbol">,</span> <span class="VarId">ex2</span><span class="Symbol">)</span> <span class="Symbol">=</span>
            <span class="VarId">text</span> <span class="String">&quot;when&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">ex1</span>
            <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;then&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">ex2</span>

<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">PositionalArg</span> <span class="VarId">_</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;$&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">integer</span> <span class="VarId">a</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">Placeholder</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;?&quot;</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">Exists</span> <span class="VarId">_</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="String">&quot;exists&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convSelectExpression</span> <span class="ConId">True</span> <span class="ConId">True</span> <span class="VarId">s</span><span class="Symbol">)</span>
<span class="Function">convExp</span> <span class="Symbol">(</span><span class="ConId">Cast</span> <span class="VarId">_</span> <span class="VarId">ex</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;cast&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExp</span> <span class="VarId">ex</span>
                                             <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;as&quot;</span>
                                             <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convTypeName</span> <span class="VarId">t</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">convExpSl</span> <span class="Symbol">::</span> <span class="ConId">Expression</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convExpSl</span> <span class="Symbol">(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="String">&quot;.&quot;</span> <span class="VarId">es</span><span class="Symbol">)</span> <span class="Symbol">|</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">@(</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">),</span> <span class="VarId">b</span><span class="Symbol">]</span> <span class="Symbol">&lt;-</span> <span class="VarId">es</span> <span class="Symbol">=</span>
  <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">convExpSl</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;.&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">convExpSl</span> <span class="VarId">b</span>
<span class="Function">convExpSl</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">convExp</span> <span class="VarId">x</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">convSet</span> <span class="Symbol">::</span> <span class="ConId">Expression</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convSet</span> <span class="Symbol">(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="String">&quot;=&quot;</span> <span class="Symbol">[</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">a</span><span class="Symbol">,</span> <span class="VarId">e</span><span class="Symbol">])</span> <span class="Symbol">=</span>
  <span class="VarId">text</span> <span class="VarId">a</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;=&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">convExp</span> <span class="VarId">e</span>
<span class="Function">convSet</span> <span class="Symbol">(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="String">&quot;=&quot;</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">,</span> <span class="VarId">b</span><span class="Symbol">])</span> <span class="Symbol">|</span> <span class="Symbol">(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="String">&quot;!rowctor&quot;</span> <span class="VarId">is1</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">a</span>
                                <span class="Symbol">,(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="String">&quot;!rowctor&quot;</span> <span class="VarId">is2</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">b</span> <span class="Symbol">=</span>
  <span class="VarId">rsNoRow</span> <span class="VarId">is1</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;=&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">rsNoRow</span> <span class="VarId">is2</span>
  <span class="Keyword">where</span>
    <span class="VarId">rsNoRow</span> <span class="VarId">is</span> <span class="Symbol">=</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span> <span class="VarId">is</span><span class="Symbol">)</span>
<span class="Function">convSet</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;bad expression in set in update: &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">a</span>

<span class="Comment">--utils</span>

<span class="Comment">-- convert a list of expressions to horizontal csv</span>

<span class="Function">csvExp</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Expression</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">csvExp</span> <span class="Symbol">=</span> <span class="VarId">hcatCsvMap</span> <span class="VarId">convExp</span>

<span class="Function">maybeConv</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="VarId">t</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="VarId">t</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">maybeConv</span> <span class="VarId">f</span> <span class="VarId">c</span> <span class="Symbol">=</span>
    <span class="Keyword">case</span> <span class="VarId">c</span> <span class="Keyword">of</span>
      <span class="ConId">Nothing</span> <span class="Symbol">-&gt;</span> <span class="VarId">empty</span>
      <span class="ConId">Just</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="VarId">f</span> <span class="VarId">a</span>

<span class="Function">csv</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Doc</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Doc</span><span class="Symbol">]</span>
<span class="Function">csv</span> <span class="Symbol">=</span> <span class="VarId">punctuate</span> <span class="VarId">comma</span>

<span class="Function">hcatCsv</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Doc</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">hcatCsv</span> <span class="Symbol">=</span> <span class="VarId">hcat</span> <span class="Symbol">.</span> <span class="VarId">csv</span>

<span class="Function">ifNotEmpty</span> <span class="Symbol">::</span> <span class="Symbol">([</span><span class="VarId">a</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">ifNotEmpty</span> <span class="VarId">c</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="Keyword">if</span> <span class="VarId">null</span> <span class="VarId">l</span> <span class="Keyword">then</span> <span class="VarId">empty</span> <span class="Keyword">else</span> <span class="VarId">c</span> <span class="VarId">l</span>

<span class="Function">hcatCsvMap</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">hcatCsvMap</span> <span class="VarId">ex</span> <span class="Symbol">=</span> <span class="VarId">hcatCsv</span> <span class="Symbol">.</span> <span class="VarId">map</span> <span class="VarId">ex</span>

<span class="Function">bool</span> <span class="Symbol">::</span> <span class="ConId">Bool</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">bool</span> <span class="VarId">b</span> <span class="Symbol">=</span> <span class="Keyword">if</span> <span class="VarId">b</span> <span class="Keyword">then</span> <span class="VarId">text</span> <span class="String">&quot;true&quot;</span> <span class="Keyword">else</span> <span class="VarId">text</span> <span class="String">&quot;false&quot;</span>

<span class="Function">newline</span> <span class="Symbol">::</span> <span class="ConId">Doc</span>
<span class="Function">newline</span> <span class="Symbol">=</span> <span class="VarId">text</span> <span class="String">&quot;\n&quot;</span>

<span class="Function">convPa</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convPa</span> <span class="VarId">ca</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="Keyword">let</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="VarId">ca</span> <span class="VarId">a</span>
              <span class="Keyword">in</span> <span class="Keyword">if</span> <span class="VarId">s</span> <span class="Symbol">==</span> <span class="String">&quot;&quot;</span>
                   <span class="Keyword">then</span> <span class="VarId">empty</span>
                   <span class="Keyword">else</span> <span class="VarId">text</span> <span class="String">&quot;/*\n&quot;</span> <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">s</span>
                        <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;*/\n&quot;</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">convLabel</span> <span class="Symbol">::</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Doc</span>
<span class="Function">convLabel</span> <span class="Symbol">=</span>
  <span class="VarId">maybe</span> <span class="VarId">empty</span> <span class="Symbol">(\</span><span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="VarId">text</span> <span class="String">&quot;&lt;&lt;&quot;</span>
                     <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="VarId">l</span>
                     <span class="Symbol">&lt;+&gt;</span> <span class="VarId">text</span> <span class="String">&quot;&gt;&gt;&quot;</span> <span class="Symbol">&lt;&gt;</span> <span class="VarId">text</span> <span class="String">&quot;\n&quot;</span><span class="Symbol">)</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
