<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >ParserInternal</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >The main file for parsing sql, uses parsec. Not sure if parsec is the right choice, but it seems to do the job pretty well at the moment.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE RankNTypes,FlexibleContexts #-}</span>

<span class="Comment">-- | Functions to parse SQL.</span>
<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Parsing.ParserInternal</span>
    <span class="Symbol">(</span><span class="Comment">-- * Main</span>
     <span class="VarId">parseStatements</span>
    <span class="Symbol">,</span><span class="VarId">parseStatementsWithPosition</span>
    <span class="Symbol">,</span><span class="VarId">parseStatementsFromFile</span>
    <span class="Symbol">,</span><span class="VarId">parseQueryExpr</span>
     <span class="Comment">-- * Testing</span>
    <span class="Symbol">,</span><span class="VarId">parseScalarExpr</span>
    <span class="Symbol">,</span><span class="VarId">parsePlpgsql</span>
     <span class="Comment">-- * errors</span>
    <span class="Symbol">,</span><span class="ConId">ParseErrorExtra</span><span class="Symbol">(..)</span>
     <span class="Comment">-- * quasiquotation support</span>
    <span class="Symbol">,</span><span class="VarId">parseAntiSql</span>
    <span class="Symbol">,</span><span class="VarId">parseAntiPlpgsql</span>
    <span class="Symbol">,</span><span class="VarId">parseAntiScalarExpr</span>
     <span class="Comment">-- other helpers for internal use</span>
    <span class="Symbol">,</span><span class="VarId">tableAttribute</span>
    <span class="Symbol">,</span><span class="VarId">keyword</span>
    <span class="Symbol">,</span><span class="VarId">parens</span>
    <span class="Symbol">,</span><span class="VarId">symbol</span>
    <span class="Symbol">,</span><span class="VarId">idString</span>
    <span class="Symbol">,</span><span class="VarId">commaSep1</span>
    <span class="Symbol">,</span><span class="VarId">commaSep</span>
    <span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Text.Parsec</span> <span class="Keyword">hiding</span><span class="Symbol">(</span><span class="VarId">many</span><span class="Symbol">,</span> <span class="VarId">optional</span><span class="Symbol">,</span> <span class="Symbol">(&lt;|&gt;),</span> <span class="VarId">string</span><span class="Symbol">,</span> <span class="VarId">label</span><span class="Symbol">)</span>
<span class="Keyword">import</span> <span class="ConId">Text.Parsec.Expr</span>
<span class="Keyword">import</span> <span class="ConId">Text.Parsec.String</span>
<span class="Keyword">import</span> <span class="ConId">Text.Parsec.Perm</span>

<span class="Keyword">import</span> <span class="ConId">Control.Applicative</span>
<span class="Keyword">import</span> <span class="ConId">Control.Monad.Identity</span>

<span class="Keyword">import</span> <span class="ConId">Data.Maybe</span>
<span class="Keyword">import</span> <span class="ConId">Data.Char</span>

<span class="Keyword">import</span> <span class="ConId">Data.Generics.PlateData</span>
<span class="Keyword">import</span> <span class="ConId">Data.Data</span> <span class="Keyword">hiding</span> <span class="Symbol">(</span><span class="ConId">Prefix</span><span class="Symbol">,</span><span class="ConId">Infix</span><span class="Symbol">)</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parsing.Lexer</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parsing.ParseErrors</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.AstInternals.AstAnti</span>
<span class="Comment">--import Database.HsSqlPpp.Ast</span>
<span class="Keyword">import</span> <span class="Keyword">qualified</span> <span class="ConId">Database.HsSqlPpp.Ast</span> <span class="Keyword">as</span> <span class="ConId">A</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span> <span class="Keyword">as</span> <span class="ConId">A</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Utils</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Catalog</span>
<span class="Comment">--import Debug.Trace</span></pre></div></div></div><hr
     /><div id="top-level-parsing-functions"
    ><h1
      >Top level parsing functions</h1
      ><p
      >To support antiquotation, the following approach is used:</p
      ><ul
      ><li
	>makeantinodes processes the generated astinternal.hs, and extracts the ast node types.</li
	><li
	>it modifies these to add anti ctors to the appropriate types, creates a set of trivial conversion functions to convert between anti nodes and regular nodes, and this is written to astanti.hs.</li
	><li
	>astanti then contains exactly the same set of ast nodes as astinternal, but with a few additions to support antiquotes.</li
	><li
	>this parsing code parses to the antinodes, then converts to regular nodes for the public api, and returns antinodes for the sql quasiquoter to use.</li
	><li
	>todo: add a flag so that if we are not parsing for the quasiquoter, any splice syntax is rejected as a parse error.</li
	></ul
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">parseStatements</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Comment">-- ^ filename to use in errors</span>
                <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Comment">-- ^ a string containing the sql to parse</span>
                <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.StatementList</span>
<span class="Function">parseStatements</span> <span class="VarId">f</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">deAS</span> <span class="Symbol">$</span> <span class="VarId">parseIt</span> <span class="VarId">l</span> <span class="VarId">sqlStatements</span> <span class="VarId">f</span> <span class="ConId">Nothing</span> <span class="VarId">s</span> <span class="VarId">startState</span>
  <span class="Keyword">where</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="VarId">lexSqlText</span> <span class="VarId">f</span> <span class="VarId">s</span>

<span class="Function">parseStatementsWithPosition</span> <span class="Symbol">::</span> <span class="ConId">FilePath</span> <span class="Comment">-- ^ filename to use in errors</span>
                            <span class="Symbol">-&gt;</span> <span class="ConId">Int</span> <span class="Comment">-- ^ adjust line number in errors by adding this</span>
                            <span class="Symbol">-&gt;</span> <span class="ConId">Int</span> <span class="Comment">-- ^ adjust column in errors by adding this</span>
                            <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Comment">-- ^ a string containing the sql to parse</span>
                            <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.StatementList</span>
<span class="Function">parseStatementsWithPosition</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="VarId">deAS</span> <span class="Symbol">$</span> <span class="VarId">parseAntiSql</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span>

<span class="Function">parseStatementsFromFile</span> <span class="Symbol">::</span> <span class="ConId">FilePath</span> <span class="Comment">-- ^ file name of file containing sql</span>
                        <span class="Symbol">-&gt;</span> <span class="ConId">IO</span> <span class="Symbol">(</span><span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.StatementList</span><span class="Symbol">)</span>
<span class="Function">parseStatementsFromFile</span> <span class="VarId">fn</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">sc</span> <span class="Symbol">&lt;-</span> <span class="VarId">readFile</span> <span class="VarId">fn</span>
  <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">lexSqlFile</span> <span class="VarId">fn</span>
  <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">deAS</span> <span class="Symbol">$</span> <span class="VarId">parseIt</span> <span class="VarId">x</span> <span class="VarId">sqlStatements</span> <span class="VarId">fn</span> <span class="ConId">Nothing</span> <span class="VarId">sc</span> <span class="VarId">startState</span>
</pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">parseQueryExpr</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Comment">-- ^ filename to use in errors</span>
               <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Comment">-- ^ a string containing the sql to parse</span>
               <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.QueryExpr</span>
<span class="Function">parseQueryExpr</span> <span class="VarId">f</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">deQE</span> <span class="Symbol">$</span> <span class="VarId">parseIt</span> <span class="VarId">l</span> <span class="VarId">pqe</span> <span class="VarId">f</span> <span class="ConId">Nothing</span> <span class="VarId">s</span> <span class="VarId">startState</span>
  <span class="Keyword">where</span>
    <span class="VarId">l</span> <span class="Symbol">=</span> <span class="VarId">lexSqlText</span> <span class="VarId">f</span> <span class="VarId">s</span>
    <span class="VarId">pqe</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">QueryExpr</span>
    <span class="VarId">pqe</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
          <span class="Symbol">(</span><span class="ConId">QueryStatement</span> <span class="VarId">_</span> <span class="VarId">q</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">selectStatement</span>
          <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span><span class="Symbol">)</span>
          <span class="VarId">eof</span>
          <span class="VarId">return</span> <span class="VarId">q</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">-- | Parse expression fragment, used for testing purposes</span>
<span class="Function">parseScalarExpr</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Comment">-- ^ filename for error messages</span>
                <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Comment">-- ^ sql string containing a single expression,</span>
                          <span class="Comment">-- with no trailing ';'</span>
                <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.ScalarExpr</span>
<span class="Function">parseScalarExpr</span> <span class="VarId">f</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">deAE</span> <span class="Symbol">$</span> <span class="VarId">parseIt</span> <span class="VarId">l</span> <span class="Symbol">(</span><span class="VarId">expr</span> <span class="Symbol">&lt;*</span> <span class="VarId">eof</span><span class="Symbol">)</span> <span class="VarId">f</span> <span class="ConId">Nothing</span> <span class="VarId">s</span> <span class="VarId">startState</span>
  <span class="Keyword">where</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="VarId">lexSqlText</span> <span class="VarId">f</span> <span class="VarId">s</span>

<span class="Comment">-- | Parse plpgsql statements, used for testing purposes -</span>
<span class="Comment">-- this can be used to parse a list of plpgsql statements which</span>
<span class="Comment">-- aren't contained in a create function.</span>
<span class="Comment">-- (The produced ast won't pass a type check.)</span>
<span class="Function">parsePlpgsql</span> <span class="Symbol">::</span> <span class="ConId">String</span>
             <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
             <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.StatementList</span>
<span class="Function">parsePlpgsql</span> <span class="VarId">f</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">deAS</span> <span class="Symbol">$</span> <span class="VarId">parseIt</span> <span class="VarId">l</span> <span class="VarId">p</span> <span class="VarId">f</span> <span class="ConId">Nothing</span> <span class="VarId">s</span> <span class="VarId">startState</span>
  <span class="Keyword">where</span>
    <span class="VarId">l</span> <span class="Symbol">=</span> <span class="VarId">lexSqlText</span> <span class="VarId">f</span> <span class="VarId">s</span>
    <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span> <span class="Symbol">&lt;*</span> <span class="VarId">eof</span>

<span class="Function">parseAntiSql</span> <span class="Symbol">::</span> <span class="ConId">FilePath</span>
             <span class="Symbol">-&gt;</span> <span class="ConId">Int</span>
             <span class="Symbol">-&gt;</span> <span class="ConId">Int</span>
             <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
             <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">StatementList</span>
<span class="Function">parseAntiSql</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">parseIt</span> <span class="VarId">lx</span> <span class="VarId">sqlStatements</span> <span class="VarId">f</span> <span class="VarId">ps</span> <span class="VarId">s</span> <span class="VarId">startState</span>
  <span class="Keyword">where</span>
    <span class="VarId">lx</span> <span class="Symbol">=</span> <span class="VarId">lexSqlTextWithPosition</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span>
    <span class="VarId">ps</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">l</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">)</span>

<span class="Function">parseAntiPlpgsql</span> <span class="Symbol">::</span> <span class="ConId">String</span>
                 <span class="Symbol">-&gt;</span> <span class="ConId">Int</span>
                 <span class="Symbol">-&gt;</span> <span class="ConId">Int</span>
                 <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
                 <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span>
<span class="Function">parseAntiPlpgsql</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">parseIt</span> <span class="VarId">lx</span> <span class="VarId">p</span> <span class="VarId">f</span> <span class="VarId">ps</span> <span class="VarId">s</span> <span class="VarId">startState</span>
  <span class="Keyword">where</span>
    <span class="VarId">lx</span> <span class="Symbol">=</span> <span class="VarId">lexSqlText</span> <span class="VarId">f</span> <span class="VarId">s</span>
    <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span> <span class="Symbol">&lt;*</span> <span class="VarId">eof</span>
    <span class="VarId">ps</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">l</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">)</span>

<span class="Function">parseAntiScalarExpr</span> <span class="Symbol">::</span> <span class="ConId">String</span>
                    <span class="Symbol">-&gt;</span> <span class="ConId">Int</span>
                    <span class="Symbol">-&gt;</span> <span class="ConId">Int</span>
                    <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
                    <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">ScalarExpr</span>
<span class="Function">parseAntiScalarExpr</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">parseIt</span> <span class="VarId">lx</span> <span class="VarId">p</span> <span class="VarId">f</span> <span class="VarId">ps</span> <span class="VarId">s</span> <span class="VarId">startState</span>
  <span class="Keyword">where</span>
    <span class="VarId">lx</span> <span class="Symbol">=</span> <span class="VarId">lexSqlText</span> <span class="VarId">f</span> <span class="VarId">s</span>
    <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">expr</span> <span class="Symbol">&lt;*</span> <span class="VarId">eof</span>
    <span class="VarId">ps</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">l</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">)</span>

<span class="Comment">--utility function to do error handling in one place</span>
<span class="Function">parseIt</span> <span class="Symbol">::</span> <span class="VarId">forall</span> <span class="VarId">t</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">b</span><span class="Symbol">.(</span><span class="ConId">Stream</span> <span class="VarId">s</span> <span class="ConId">Identity</span> <span class="VarId">t</span><span class="Symbol">,</span> <span class="ConId">Data</span> <span class="VarId">b</span><span class="Symbol">)</span> <span class="Symbol">=&gt;</span>
           <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="VarId">s</span>
        <span class="Symbol">-&gt;</span> <span class="ConId">Parsec</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">b</span>
        <span class="Symbol">-&gt;</span> <span class="ConId">SourceName</span>
        <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="Symbol">(</span><span class="ConId">Int</span><span class="Symbol">,</span><span class="ConId">Int</span><span class="Symbol">)</span>
        <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
        <span class="Symbol">-&gt;</span> <span class="VarId">u</span>
        <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="VarId">b</span>
<span class="Function">parseIt</span> <span class="VarId">lexed</span> <span class="VarId">parser</span> <span class="VarId">fn</span> <span class="VarId">sp</span> <span class="VarId">src</span> <span class="VarId">ss</span> <span class="Symbol">=</span>
    <span class="Keyword">case</span> <span class="VarId">lexed</span> <span class="Keyword">of</span>
               <span class="ConId">Left</span> <span class="VarId">er</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="VarId">er</span>
               <span class="ConId">Right</span> <span class="VarId">toks</span> <span class="Symbol">-&gt;</span> <span class="Keyword">let</span> <span class="VarId">r1</span> <span class="Symbol">=</span> <span class="VarId">runParser</span> <span class="VarId">parser</span> <span class="VarId">ss</span> <span class="VarId">fn</span> <span class="VarId">toks</span>
                             <span class="Keyword">in</span> <span class="Keyword">case</span> <span class="VarId">toParseErrorExtra</span> <span class="VarId">r1</span> <span class="VarId">sp</span> <span class="VarId">src</span> <span class="Keyword">of</span>
                                  <span class="ConId">Left</span> <span class="VarId">er</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="VarId">er</span>
                                  <span class="ConId">Right</span> <span class="VarId">t</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="VarId">fixupTree</span> <span class="VarId">t</span>

<span class="Function">deAE</span> <span class="Symbol">::</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">ScalarExpr</span>
     <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.ScalarExpr</span>
<span class="Function">deAE</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">x</span> <span class="Keyword">of</span>
                <span class="ConId">Left</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="VarId">e</span>
                <span class="ConId">Right</span> <span class="VarId">ex</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="VarId">convertScalarExpr</span> <span class="VarId">ex</span>
<span class="Function">deAS</span> <span class="Symbol">::</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span>
     <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="Symbol">[</span><span class="ConId">A.Statement</span><span class="Symbol">]</span>
<span class="Function">deAS</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">x</span> <span class="Keyword">of</span>
                <span class="ConId">Left</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="VarId">e</span>
                <span class="ConId">Right</span> <span class="VarId">ex</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="VarId">convertStatements</span> <span class="VarId">ex</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">deQE</span> <span class="Symbol">::</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">QueryExpr</span>
     <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">ParseErrorExtra</span> <span class="ConId">A.QueryExpr</span>
<span class="Function">deQE</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">x</span> <span class="Keyword">of</span>
                <span class="ConId">Left</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="VarId">e</span>
                <span class="ConId">Right</span> <span class="VarId">ex</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="Symbol">$</span> <span class="VarId">queryExpr</span> <span class="VarId">ex</span></pre></div></div></div><hr
       /><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">type</span> <span class="ConId">SParser</span> <span class="Symbol">=</span>  <span class="ConId">GenParser</span> <span class="ConId">Token</span> <span class="ConId">ParseState</span></pre></div></div></div></div
    ><div id="parsing-top-level-statements"
    ><h1
      >Parsing top level statements</h1
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">sqlStatements</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span>
<span class="Function">sqlStatements</span> <span class="Symbol">=</span> <span class="VarId">many</span> <span class="Symbol">(</span><span class="VarId">sqlStatement</span> <span class="ConId">True</span><span class="Symbol">)</span> <span class="Symbol">&lt;*</span> <span class="VarId">eof</span>

<span class="Function">sqlStatement</span> <span class="Symbol">::</span> <span class="ConId">Bool</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">sqlStatement</span> <span class="VarId">reqSemi</span> <span class="Symbol">=</span>
   <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">[</span>
     <span class="VarId">antiStatement</span>
    <span class="Symbol">,</span><span class="VarId">selectStatement</span>
    <span class="Symbol">,</span><span class="VarId">insert</span>
    <span class="Symbol">,</span><span class="VarId">update</span>
    <span class="Symbol">,</span><span class="VarId">delete</span>
    <span class="Symbol">,</span><span class="VarId">truncateSt</span>
    <span class="Symbol">,</span><span class="VarId">copy</span>
    <span class="Symbol">,</span><span class="VarId">set</span>
    <span class="Symbol">,</span><span class="VarId">notify</span>
    <span class="Symbol">,</span><span class="VarId">keyword</span> <span class="String">&quot;create&quot;</span> <span class="Symbol">*&gt;</span>
             <span class="VarId">choice</span> <span class="Symbol">[</span>
                <span class="VarId">createTable</span>
               <span class="Symbol">,</span><span class="VarId">createSequence</span>
               <span class="Symbol">,</span><span class="VarId">createType</span>
               <span class="Symbol">,</span><span class="VarId">createFunction</span>
               <span class="Symbol">,</span><span class="VarId">createView</span>
               <span class="Symbol">,</span><span class="VarId">createDomain</span>
               <span class="Symbol">,</span><span class="VarId">createLanguage</span>
               <span class="Symbol">,</span><span class="VarId">createTrigger</span><span class="Symbol">]</span>
    <span class="Symbol">,</span><span class="VarId">keyword</span> <span class="String">&quot;alter&quot;</span> <span class="Symbol">*&gt;</span>
             <span class="VarId">choice</span> <span class="Symbol">[</span>
                <span class="VarId">alterSequence</span>
               <span class="Symbol">,</span><span class="VarId">alterTable</span><span class="Symbol">]</span>
    <span class="Symbol">,</span><span class="VarId">keyword</span> <span class="String">&quot;drop&quot;</span> <span class="Symbol">*&gt;</span>
             <span class="VarId">choice</span> <span class="Symbol">[</span>
                <span class="VarId">dropSomething</span>
               <span class="Symbol">,</span><span class="VarId">dropFunction</span><span class="Symbol">]]</span>
    <span class="Symbol">&lt;*</span> <span class="Symbol">(</span><span class="Keyword">if</span> <span class="VarId">reqSemi</span>
          <span class="Keyword">then</span> <span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span> <span class="Symbol">&gt;&gt;</span> <span class="VarId">return</span> <span class="Symbol">()</span>
          <span class="Keyword">else</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span><span class="Symbol">)</span> <span class="Symbol">&gt;&gt;</span> <span class="VarId">return</span> <span class="Symbol">()))</span>
   <span class="Symbol">&lt;|&gt;</span> <span class="VarId">copyData</span></pre></div></div></div><hr
       /></div
    ><div id="statement-flavour-parsers"
    ><h1
      >statement flavour parsers</h1
      ><p
      >top level/sql statements first</p
      ><div id="select"
      ><h2
	>select</h2
	><p
	>select parser, parses things starting with the keyword 'select'</p
	><p
	>supports plpgsql 'select into' only for the variants which look like 'select into ([targets]) [columnNames] from ... or 'select [columnNames] into ([targets]) from ... This should be changed so it can only parse an into clause when expecting a plpgsql statement.</p
	><p
	>recurses to support parsing excepts, unions, etc. this recursion needs refactoring cos it's a mess</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">selectStatement</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">selectStatement</span> <span class="Symbol">=</span> <span class="ConId">QueryStatement</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">selectScalarExpr</span>

<span class="Function">selectScalarExpr</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">QueryExpr</span>
<span class="Function">selectScalarExpr</span> <span class="Symbol">=</span>
  <span class="VarId">with</span> <span class="Symbol">&lt;|&gt;</span>
  <span class="VarId">buildExpressionParser</span> <span class="VarId">combTable</span> <span class="VarId">selFactor</span>
  <span class="Keyword">where</span>
        <span class="VarId">selFactor</span> <span class="Symbol">=</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="VarId">selectScalarExpr</span><span class="Symbol">)</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">selQuerySpec</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">values</span>
        <span class="VarId">with</span> <span class="Symbol">=</span> <span class="ConId">WithSelect</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;with&quot;</span><span class="Symbol">)</span>
                          <span class="Symbol">&lt;*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">withQuery</span>
                          <span class="Symbol">&lt;*&gt;</span> <span class="VarId">selectScalarExpr</span>
        <span class="VarId">withQuery</span> <span class="Symbol">=</span> <span class="ConId">WithQuery</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                              <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">idString</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span><span class="Symbol">)</span>
                              <span class="Symbol">&lt;*&gt;</span> <span class="VarId">parens</span> <span class="VarId">selectScalarExpr</span>
        <span class="VarId">combTable</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="VarId">map</span> <span class="Symbol">(\(</span><span class="VarId">c</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Infix</span> <span class="Symbol">(</span><span class="ConId">CombineSelect</span>
                                           <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                                           <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">c</span> <span class="Symbol">&lt;$</span> <span class="VarId">p</span><span class="Symbol">))</span> <span class="ConId">AssocLeft</span><span class="Symbol">)</span>
                        <span class="Symbol">[(</span><span class="ConId">Except</span><span class="Symbol">,</span> <span class="VarId">keyword</span> <span class="String">&quot;except&quot;</span><span class="Symbol">)</span>
                        <span class="Symbol">,(</span><span class="ConId">Intersect</span><span class="Symbol">,</span> <span class="VarId">keyword</span> <span class="String">&quot;intersect&quot;</span><span class="Symbol">)</span>
                        <span class="Symbol">,(</span><span class="ConId">UnionAll</span><span class="Symbol">,</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;union&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;all&quot;</span><span class="Symbol">))</span>
                        <span class="Symbol">,(</span><span class="ConId">Union</span><span class="Symbol">,</span> <span class="VarId">keyword</span> <span class="String">&quot;union&quot;</span><span class="Symbol">)]]</span>
        <span class="VarId">selQuerySpec</span> <span class="Symbol">=</span> <span class="ConId">Select</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;select&quot;</span><span class="Symbol">)</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="ConId">Dupes</span> <span class="Symbol">(</span><span class="ConId">Distinct</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;distinct&quot;</span><span class="Symbol">)</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">selectList</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="VarId">from</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">optionMaybe</span> <span class="VarId">whereClause</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="VarId">groupBy</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">optionMaybe</span> <span class="VarId">having</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="VarId">orderBy</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">optionMaybe</span> <span class="VarId">limit</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">optionMaybe</span> <span class="VarId">offset</span>
        <span class="VarId">from</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;from&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">tableRef</span>
        <span class="VarId">groupBy</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;group&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;by&quot;</span>
                  <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span>
        <span class="VarId">having</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;having&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span>
        <span class="VarId">orderBy</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;order&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;by&quot;</span>
                    <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">oneOrder</span>
        <span class="VarId">oneOrder</span> <span class="Symbol">=</span> <span class="Symbol">(,)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">expr</span>
                       <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="ConId">Asc</span> <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">[</span>
                                        <span class="ConId">Asc</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;asc&quot;</span>
                                       <span class="Symbol">,</span><span class="ConId">Desc</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;desc&quot;</span><span class="Symbol">])</span>
        <span class="VarId">limit</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;limit&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span>
        <span class="VarId">offset</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;offset&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span>
        <span class="VarId">values</span> <span class="Symbol">=</span> <span class="ConId">Values</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;values&quot;</span><span class="Symbol">)</span>
                        <span class="Symbol">&lt;*&gt;</span> <span class="VarId">commaSep1</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">$</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span><span class="Symbol">)</span></pre></div></div></div><p
	>table refs have to cope with: a simple tableref i.e just a name an aliased table ref e.g. select a.b from tbl as a a sub select e.g. select a from (select b from c) - these are handled in nonJoinTref then we combine by seeing if there is a join looking prefix</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">tableRef</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">TableRef</span>
<span class="Function">tableRef</span> <span class="Symbol">=</span>
  <span class="VarId">trefTerm</span> <span class="Symbol">&gt;&gt;=</span> <span class="VarId">maybeParseAnotherJoin</span>
  <span class="Keyword">where</span>
        <span class="VarId">maybeParseAnotherJoin</span> <span class="VarId">tr1</span> <span class="Symbol">=</span>
          <span class="VarId">choice</span> <span class="Symbol">[</span>
                <span class="Keyword">do</span>
                  <span class="VarId">p2</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
                  <span class="Symbol">(</span><span class="VarId">nat</span><span class="Symbol">,</span><span class="VarId">jt</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">joinKw</span>
                  <span class="ConId">JoinTref</span> <span class="VarId">p2</span> <span class="VarId">tr1</span> <span class="VarId">nat</span> <span class="VarId">jt</span>
                                   <span class="Symbol">&lt;$&gt;</span> <span class="VarId">trefTerm</span>
                                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">onExpr</span>
                                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">palias</span>
                    <span class="Symbol">&gt;&gt;=</span> <span class="VarId">maybeParseAnotherJoin</span>
               <span class="Symbol">,</span><span class="VarId">return</span> <span class="VarId">tr1</span><span class="Symbol">]</span>
        <span class="VarId">trefTerm</span> <span class="Symbol">=</span> <span class="VarId">nonJoinTref</span>
                   <span class="Symbol">&lt;|&gt;</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="VarId">tableRef</span><span class="Symbol">)</span>
        <span class="VarId">nonJoinTref</span> <span class="Symbol">=</span> <span class="VarId">try</span> <span class="Symbol">$</span> <span class="VarId">optParens</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                  <span class="VarId">p2</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
                  <span class="VarId">choice</span> <span class="Symbol">[</span>
                         <span class="ConId">SubTref</span> <span class="VarId">p2</span>
                         <span class="Symbol">&lt;$&gt;</span> <span class="VarId">parens</span> <span class="VarId">selectScalarExpr</span>
                         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">palias</span>
                        <span class="Symbol">,</span><span class="ConId">FunTref</span> <span class="VarId">p2</span>
                         <span class="Symbol">&lt;$&gt;</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">identifier</span> <span class="Symbol">&gt;&gt;=</span> <span class="VarId">functionCallSuffix</span><span class="Symbol">)</span>
                         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">palias</span>
                        <span class="Symbol">,</span><span class="ConId">Tref</span> <span class="VarId">p2</span>
                         <span class="Symbol">&lt;$&gt;</span> <span class="VarId">nkwidn</span>
                         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">palias</span><span class="Symbol">]</span>
        <span class="VarId">joinKw</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="Symbol">(</span><span class="ConId">Natural</span><span class="Symbol">,</span> <span class="ConId">JoinType</span><span class="Symbol">)</span>
        <span class="VarId">joinKw</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
             <span class="Comment">--look for the join flavour first</span>
             <span class="VarId">n</span> <span class="Symbol">&lt;-</span> <span class="VarId">option</span> <span class="ConId">Unnatural</span> <span class="Symbol">(</span><span class="ConId">Natural</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;natural&quot;</span><span class="Symbol">)</span>
             <span class="VarId">jt</span> <span class="Symbol">&lt;-</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
                    <span class="ConId">LeftOuter</span> <span class="Symbol">&lt;$</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;left&quot;</span>
                                      <span class="Symbol">*&gt;</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;outer&quot;</span><span class="Symbol">))</span>
                   <span class="Symbol">,</span><span class="ConId">RightOuter</span> <span class="Symbol">&lt;$</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;right&quot;</span>
                                       <span class="Symbol">*&gt;</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;outer&quot;</span><span class="Symbol">))</span>
                   <span class="Symbol">,</span><span class="ConId">FullOuter</span> <span class="Symbol">&lt;$</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;full&quot;</span>
                                      <span class="Symbol">*&gt;</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;outer&quot;</span><span class="Symbol">))</span>
                   <span class="Symbol">,</span><span class="ConId">Cross</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;cross&quot;</span>
                   <span class="Symbol">,</span><span class="ConId">Inner</span> <span class="Symbol">&lt;$</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;inner&quot;</span><span class="Symbol">)]</span>
             <span class="Comment">--recurse back to tref to read the table</span>
             <span class="VarId">keyword</span> <span class="String">&quot;join&quot;</span>
             <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">n</span><span class="Symbol">,</span><span class="VarId">jt</span><span class="Symbol">)</span>
        <span class="VarId">onExpr</span> <span class="Symbol">=</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
                 <span class="ConId">Just</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="ConId">JoinOn</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;on&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">))</span>
                <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="ConId">JoinUsing</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                           <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;using&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">columnNameList</span><span class="Symbol">))</span>
                <span class="Symbol">,</span><span class="VarId">return</span> <span class="ConId">Nothing</span><span class="Symbol">]</span>
        <span class="VarId">palias</span> <span class="Symbol">=</span> <span class="VarId">option</span> <span class="ConId">NoAlias</span>
                   <span class="Symbol">(</span><span class="VarId">optionalSuffix</span>
                      <span class="ConId">TableAlias</span> <span class="Symbol">(</span><span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span><span class="Symbol">)</span> <span class="Symbol">*&gt;</span> <span class="VarId">nkwid</span><span class="Symbol">)</span>
                      <span class="ConId">FullAlias</span> <span class="Symbol">()</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">$</span> <span class="VarId">commaSep1</span> <span class="VarId">idString</span><span class="Symbol">))</span>
        <span class="VarId">badNames</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="String">&quot;as&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;where&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;except&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;union&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;intersect&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;loop&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;inner&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;on&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;left&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;right&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;full&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;cross&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;join&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;natural&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;order&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;group&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;limit&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;using&quot;</span>
                   <span class="Symbol">,</span><span class="String">&quot;from&quot;</span><span class="Symbol">]</span>
        <span class="VarId">nkwidn</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
                 <span class="VarId">i</span> <span class="Symbol">&lt;-</span> <span class="VarId">qName</span>
                 <span class="Keyword">case</span> <span class="VarId">i</span> <span class="Keyword">of</span>
                   <span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="Symbol">|</span> <span class="VarId">n</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">badNames</span>
                       <span class="Symbol">-&gt;</span> <span class="VarId">fail</span> <span class="String">&quot;not keyword&quot;</span>
                   <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="VarId">return</span> <span class="VarId">i</span>
        <span class="VarId">nkwid</span> <span class="Symbol">=</span> <span class="VarId">try</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                 <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
                 <span class="Comment">--avoid all these keywords as aliases since they can</span>
                 <span class="Comment">--appear immediately following a tableref as the next</span>
                 <span class="Comment">--part of the statement, if we don't do this then lots</span>
                 <span class="Comment">--of things don't parse. Seems a bit inelegant but</span>
                 <span class="Comment">--works for the tests and the test sql files don't know</span>
                 <span class="Comment">--if these should be allowed as aliases without &quot;&quot; or</span>
                 <span class="Comment">--[]</span>
                 <span class="Comment">-- </span><span class="Alert">TODO</span><span class="Comment"> find out what the correct behaviour here is.</span>
                 <span class="Keyword">if</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">x</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">badNames</span>
                   <span class="Keyword">then</span> <span class="VarId">fail</span> <span class="String">&quot;not keyword&quot;</span>
                   <span class="Keyword">else</span> <span class="VarId">return</span> <span class="VarId">x</span>

<span class="Function">optParens</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
          <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
<span class="Function">optParens</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">p</span></pre></div></div></div></div
      ><div id="insert-update-and-delete"
      ><h2
	>insert, update and delete</h2
	><p
	>insert statement: supports option column name list, multiple rows to insert and insert from select statements</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">insert</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">insert</span> <span class="Symbol">=</span> <span class="ConId">Insert</span>
         <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;insert&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;into&quot;</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">qName</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="VarId">columnNameList</span><span class="Symbol">)</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">selectScalarExpr</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="VarId">returning</span>

<span class="Function">update</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">update</span> <span class="Symbol">=</span> <span class="ConId">Update</span>
         <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;update&quot;</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">qName</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;set&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">setClause</span><span class="Symbol">)</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;from&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">tableRef</span><span class="Symbol">)</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="VarId">whereClause</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="VarId">returning</span>
    <span class="Keyword">where</span>
      <span class="VarId">setClause</span> <span class="Symbol">=</span>
        <span class="VarId">choice</span> <span class="Symbol">[</span><span class="Keyword">do</span>
          <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
          <span class="VarId">l</span> <span class="Symbol">&lt;-</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep1</span> <span class="VarId">idString</span><span class="Symbol">)</span>
          <span class="VarId">symbol</span> <span class="String">&quot;=&quot;</span>
          <span class="VarId">r</span> <span class="Symbol">&lt;-</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep1</span> <span class="VarId">expr</span><span class="Symbol">)</span>
          <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">FunCall</span> <span class="VarId">p</span> <span class="String">&quot;=&quot;</span> <span class="Symbol">[</span><span class="ConId">FunCall</span> <span class="VarId">p</span> <span class="String">&quot;!rowctor&quot;</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="VarId">l</span>
                                 <span class="Symbol">,</span><span class="ConId">FunCall</span> <span class="VarId">p</span> <span class="String">&quot;!rowctor&quot;</span> <span class="VarId">r</span><span class="Symbol">]</span>
        <span class="Symbol">,</span><span class="Keyword">do</span>
          <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
          <span class="VarId">l</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
          <span class="VarId">symbol</span> <span class="String">&quot;=&quot;</span>
          <span class="VarId">r</span> <span class="Symbol">&lt;-</span> <span class="VarId">expr</span>
          <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">FunCall</span> <span class="VarId">p</span> <span class="String">&quot;=&quot;</span> <span class="Symbol">[</span><span class="ConId">Identifier</span> <span class="VarId">p</span> <span class="VarId">l</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">]]</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">delete</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">delete</span> <span class="Symbol">=</span> <span class="ConId">Delete</span>
         <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;delete&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;from&quot;</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">qName</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;using&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">tableRef</span><span class="Symbol">)</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="VarId">whereClause</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="VarId">returning</span>
</pre></div></div></div></div
      ><div id="other-dml-type-stuff"
      ><h2
	>other dml-type stuff</h2
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">truncateSt</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">truncateSt</span> <span class="Symbol">=</span>
           <span class="ConId">Truncate</span>
           <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;truncate&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;table&quot;</span><span class="Symbol">)</span>
           <span class="Symbol">&lt;*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">idString</span>
           <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="ConId">ContinueIdentity</span> <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">[</span>
                                <span class="ConId">ContinueIdentity</span> <span class="Symbol">&lt;$</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;continue&quot;</span>
                                                     <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;identity&quot;</span><span class="Symbol">)</span>
                               <span class="Symbol">,</span><span class="ConId">RestartIdentity</span> <span class="Symbol">&lt;$</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;restart&quot;</span>
                                                    <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;identity&quot;</span><span class="Symbol">)])</span>
           <span class="Symbol">&lt;*&gt;</span> <span class="VarId">cascade</span>

<span class="Function">copy</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">copy</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
       <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
       <span class="VarId">keyword</span> <span class="String">&quot;copy&quot;</span>
       <span class="VarId">tableName</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
       <span class="VarId">cols</span> <span class="Symbol">&lt;-</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">$</span> <span class="VarId">commaSep1</span> <span class="VarId">idString</span><span class="Symbol">)</span>
       <span class="VarId">keyword</span> <span class="String">&quot;from&quot;</span>
       <span class="VarId">src</span> <span class="Symbol">&lt;-</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
               <span class="ConId">CopyFilename</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">extrStr</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">stringLit</span>
              <span class="Symbol">,</span><span class="ConId">Stdin</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;stdin&quot;</span><span class="Symbol">]</span>
       <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">Copy</span> <span class="VarId">p</span> <span class="VarId">tableName</span> <span class="VarId">cols</span> <span class="VarId">src</span>

<span class="Function">copyData</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">copyData</span> <span class="Symbol">=</span> <span class="ConId">CopyData</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span>
                                        <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                                                 <span class="ConId">CopyPayloadTok</span> <span class="VarId">n</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="VarId">n</span>
                                                 <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span>
</pre></div></div></div><hr
	 /></div
      ></div
    ><div id="misc"
    ><h1
      >misc</h1
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">set</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">set</span> <span class="Symbol">=</span> <span class="ConId">Set</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
          <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;set&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
          <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">((</span><span class="VarId">keyword</span> <span class="String">&quot;to&quot;</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">symbol</span> <span class="String">&quot;=&quot;</span><span class="Symbol">)</span> <span class="Symbol">*&gt;</span>
              <span class="VarId">commaSep1</span> <span class="VarId">sv</span><span class="Symbol">)</span>
      <span class="Keyword">where</span>
        <span class="VarId">sv</span> <span class="Symbol">=</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
              <span class="ConId">SetStr</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">stringN</span>
             <span class="Symbol">,</span><span class="ConId">SetId</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span>
             <span class="Symbol">,</span><span class="ConId">SetNum</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">((</span><span class="VarId">fromInteger</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">integer</span><span class="Symbol">)</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">float</span><span class="Symbol">)]</span>

<span class="Function">notify</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">notify</span> <span class="Symbol">=</span> <span class="ConId">Notify</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;notify&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span></pre></div></div></div><hr
       /></div
    ><div id="ddl"
    ><h1
      >ddl</h1
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">createTable</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">createTable</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="VarId">keyword</span> <span class="String">&quot;table&quot;</span>
  <span class="VarId">tname</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
  <span class="VarId">choice</span> <span class="Symbol">[</span>
     <span class="ConId">CreateTableAs</span> <span class="VarId">p</span> <span class="VarId">tname</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">selectScalarExpr</span><span class="Symbol">)</span>
    <span class="Symbol">,</span><span class="VarId">uncurry</span> <span class="Symbol">(</span><span class="ConId">CreateTable</span> <span class="VarId">p</span> <span class="VarId">tname</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">readAttsAndCons</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="Comment">--parse our unordered list of attribute defs or constraints, for</span>
    <span class="Comment">--each line want to try the constraint parser first, then the</span>
    <span class="Comment">--attribute parser, so we need the swap to feed them in the</span>
    <span class="Comment">--right order into createtable</span>
    <span class="VarId">readAttsAndCons</span> <span class="Symbol">=</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">swap</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">multiPerm</span>
                                         <span class="Symbol">(</span><span class="VarId">try</span> <span class="VarId">tableConstraint</span><span class="Symbol">)</span>
                                         <span class="VarId">tableAttribute</span>
                                         <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;,&quot;</span><span class="Symbol">))</span>
                      <span class="Keyword">where</span> <span class="VarId">swap</span> <span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">b</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">)</span>

<span class="Function">tableAttribute</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">AttributeDef</span>
<span class="Function">tableAttribute</span> <span class="Symbol">=</span> <span class="ConId">AttributeDef</span>
               <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="VarId">typeName</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;default&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="VarId">many</span> <span class="VarId">rowConstraint</span>
  <span class="Keyword">where</span>
    <span class="VarId">rowConstraint</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
       <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
       <span class="VarId">cn</span> <span class="Symbol">&lt;-</span> <span class="VarId">option</span> <span class="String">&quot;&quot;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;constraint&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
       <span class="VarId">choice</span> <span class="Symbol">[</span>
          <span class="ConId">RowUniqueConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;unique&quot;</span>
         <span class="Symbol">,</span><span class="ConId">RowPrimaryKeyConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;primary&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;key&quot;</span>
         <span class="Symbol">,</span><span class="ConId">RowCheckConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;check&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">parens</span> <span class="VarId">expr</span><span class="Symbol">)</span>
         <span class="Symbol">,</span><span class="ConId">NullConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;null&quot;</span>
         <span class="Symbol">,</span><span class="ConId">NotNullConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span> <span class="Symbol">&lt;$</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;not&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;null&quot;</span><span class="Symbol">)</span>
         <span class="Symbol">,</span><span class="ConId">RowReferenceConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span>
         <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;references&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="ConId">Nothing</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="VarId">parens</span> <span class="Symbol">$</span> <span class="ConId">Just</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">onDelete</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">onUpdate</span>
         <span class="Symbol">]</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">onDelete</span><span class="Symbol">,</span><span class="VarId">onUpdate</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Cascade</span>
<span class="Function">onDelete</span> <span class="Symbol">=</span> <span class="VarId">onSomething</span> <span class="String">&quot;delete&quot;</span>
<span class="Function">onUpdate</span> <span class="Symbol">=</span> <span class="VarId">onSomething</span> <span class="String">&quot;update&quot;</span>

<span class="Function">onSomething</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">Cascade</span>
<span class="Function">onSomething</span> <span class="VarId">k</span> <span class="Symbol">=</span> <span class="VarId">option</span> <span class="ConId">Restrict</span> <span class="Symbol">$</span> <span class="VarId">try</span> <span class="Symbol">$</span> <span class="VarId">keyword</span> <span class="String">&quot;on&quot;</span>
                <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="VarId">k</span> <span class="Symbol">*&gt;</span> <span class="VarId">cascade</span>

<span class="Function">tableConstraint</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Constraint</span>
<span class="Function">tableConstraint</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
                <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
                <span class="VarId">cn</span> <span class="Symbol">&lt;-</span> <span class="VarId">option</span> <span class="String">&quot;&quot;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;constraint&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">option</span> <span class="String">&quot;&quot;</span> <span class="VarId">conName</span><span class="Symbol">)</span>
                <span class="VarId">choice</span> <span class="Symbol">[</span>
                   <span class="ConId">UniqueConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span>
                   <span class="Symbol">&lt;$&gt;</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;unique&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">optParens</span> <span class="VarId">columnNameList</span><span class="Symbol">)</span>
                   <span class="Symbol">,</span><span class="ConId">PrimaryKeyConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span>
                   <span class="Symbol">&lt;$&gt;</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;primary&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;key&quot;</span>
                                    <span class="Symbol">*&gt;</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
                                            <span class="Symbol">(:[])</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">idString</span>
                                           <span class="Symbol">,</span><span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep1</span> <span class="VarId">idString</span><span class="Symbol">)])</span>
                   <span class="Symbol">,</span><span class="ConId">CheckConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span>
                   <span class="Symbol">&lt;$&gt;</span><span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;check&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">parens</span> <span class="VarId">expr</span><span class="Symbol">)</span>
                   <span class="Symbol">,</span><span class="ConId">ReferenceConstraint</span> <span class="VarId">p</span> <span class="VarId">cn</span>
                   <span class="Symbol">&lt;$&gt;</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;foreign&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;key&quot;</span>
                            <span class="Symbol">*&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep1</span> <span class="VarId">idString</span><span class="Symbol">))</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;references&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">$</span> <span class="VarId">commaSep1</span> <span class="VarId">idString</span><span class="Symbol">)</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">onUpdate</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">onDelete</span><span class="Symbol">]</span>
                <span class="Keyword">where</span>
                  <span class="VarId">conName</span> <span class="Symbol">=</span> <span class="VarId">try</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                            <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
                            <span class="Keyword">if</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">x</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="Symbol">[</span>
                                    <span class="String">&quot;unique&quot;</span>
                                   <span class="Symbol">,</span><span class="String">&quot;primary&quot;</span>
                                   <span class="Symbol">,</span><span class="String">&quot;check&quot;</span>
                                   <span class="Symbol">,</span><span class="String">&quot;foreign&quot;</span>
                                   <span class="Symbol">,</span><span class="String">&quot;references&quot;</span><span class="Symbol">]</span>
                              <span class="Keyword">then</span> <span class="VarId">fail</span> <span class="String">&quot;not keyword&quot;</span>
                              <span class="Keyword">else</span> <span class="VarId">return</span> <span class="VarId">x</span>

<span class="Function">alterTable</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">alterTable</span> <span class="Symbol">=</span> <span class="ConId">AlterTable</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;table&quot;</span>
                             <span class="Symbol">&lt;*</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;only&quot;</span><span class="Symbol">))</span>
                        <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span>
                        <span class="Symbol">&lt;*&gt;</span> <span class="VarId">many1</span> <span class="VarId">action</span>
             <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
                             <span class="ConId">AlterColumnDefault</span>
                             <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;alter&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;column&quot;</span><span class="Symbol">)</span>
                             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span>
                             <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;set&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;default&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>
                            <span class="Symbol">,</span><span class="ConId">AddConstraint</span>
                             <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;add&quot;</span><span class="Symbol">)</span>
                             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tableConstraint</span><span class="Symbol">]</span>

<span class="Function">createType</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">createType</span> <span class="Symbol">=</span> <span class="ConId">CreateType</span>
             <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;type&quot;</span>
             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span>
             <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep1</span> <span class="VarId">typeAtt</span><span class="Symbol">))</span>
  <span class="Keyword">where</span>
    <span class="VarId">typeAtt</span> <span class="Symbol">=</span> <span class="ConId">TypeAttDef</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">typeName</span>

<span class="Function">createSequence</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">createSequence</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="VarId">keyword</span> <span class="String">&quot;sequence&quot;</span>
  <span class="VarId">nm</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
  <span class="Symbol">(</span><span class="VarId">stw</span><span class="Symbol">,</span> <span class="VarId">incr</span><span class="Symbol">,</span> <span class="VarId">mx</span><span class="Symbol">,</span> <span class="VarId">mn</span><span class="Symbol">,</span> <span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span>
     <span class="VarId">permute</span> <span class="Symbol">((,,,,)</span> <span class="Symbol">&lt;$?&gt;</span> <span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span><span class="VarId">startWith</span><span class="Symbol">)</span>
                     <span class="Symbol">&lt;|?&gt;</span> <span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span><span class="VarId">increment</span><span class="Symbol">)</span>
                     <span class="Symbol">&lt;|?&gt;</span> <span class="Symbol">((</span><span class="Number">2</span><span class="Symbol">::</span><span class="ConId">Integer</span><span class="Symbol">)</span> <span class="Symbol">^</span> <span class="Symbol">(</span><span class="Number">63</span><span class="Symbol">::</span><span class="ConId">Integer</span><span class="Symbol">)</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">,</span> <span class="VarId">maxi</span><span class="Symbol">)</span>
                     <span class="Symbol">&lt;|?&gt;</span> <span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span> <span class="VarId">mini</span><span class="Symbol">)</span>
                     <span class="Symbol">&lt;|?&gt;</span> <span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span> <span class="VarId">cache</span><span class="Symbol">))</span>
  <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">CreateSequence</span> <span class="VarId">p</span> <span class="VarId">nm</span> <span class="VarId">incr</span> <span class="VarId">mn</span> <span class="VarId">mx</span> <span class="VarId">stw</span> <span class="VarId">c</span>
  <span class="Keyword">where</span>
    <span class="VarId">startWith</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;start&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;with&quot;</span><span class="Symbol">)</span> <span class="Symbol">*&gt;</span> <span class="VarId">integer</span>
    <span class="VarId">increment</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;increment&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;by&quot;</span><span class="Symbol">)</span> <span class="Symbol">*&gt;</span> <span class="VarId">integer</span>
    <span class="VarId">maxi</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Number">2</span><span class="Symbol">::</span><span class="ConId">Integer</span><span class="Symbol">)</span> <span class="Symbol">^</span> <span class="Symbol">(</span><span class="Number">63</span><span class="Symbol">::</span><span class="ConId">Integer</span><span class="Symbol">)</span> <span class="Symbol">-</span> <span class="Number">1</span>
           <span class="Symbol">&lt;$</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;no&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;maxvalue&quot;</span><span class="Symbol">)</span>
    <span class="VarId">mini</span> <span class="Symbol">=</span> <span class="Number">1</span> <span class="Symbol">&lt;$</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;no&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;minvalue&quot;</span><span class="Symbol">)</span>
    <span class="VarId">cache</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;cache&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">integer</span>

<span class="Function">alterSequence</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">alterSequence</span> <span class="Symbol">=</span> <span class="ConId">AlterSequence</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                              <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;sequence&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
                              <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;owned&quot;</span>
                                   <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;by&quot;</span>
                                   <span class="Symbol">*&gt;</span> <span class="VarId">qName</span><span class="Symbol">)</span></pre></div></div></div><p
      >create function, support sql functions and plpgsql functions. Parses the body in both cases and provides a statement list for the body rather than just a string.</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">createFunction</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">createFunction</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="VarId">rep</span> <span class="Symbol">&lt;-</span> <span class="VarId">choice</span> <span class="Symbol">[</span><span class="ConId">NoReplace</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;function&quot;</span>
                <span class="Symbol">,</span><span class="ConId">Replace</span> <span class="Symbol">&lt;$</span> <span class="VarId">mapM_</span> <span class="VarId">keyword</span> <span class="Symbol">[</span><span class="String">&quot;or&quot;</span><span class="Symbol">,</span> <span class="String">&quot;replace&quot;</span><span class="Symbol">,</span> <span class="String">&quot;function&quot;</span><span class="Symbol">]</span>
                <span class="Symbol">]</span>
  <span class="VarId">fnName</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
  <span class="VarId">params</span> <span class="Symbol">&lt;-</span> <span class="VarId">parens</span> <span class="Symbol">$</span> <span class="VarId">commaSep</span> <span class="VarId">param</span>
  <span class="VarId">retType</span> <span class="Symbol">&lt;-</span> <span class="VarId">keyword</span> <span class="String">&quot;returns&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">typeName</span>
  <span class="Symbol">((</span><span class="VarId">bodypos</span><span class="Symbol">,</span><span class="VarId">body</span><span class="Symbol">),</span> <span class="VarId">lang</span><span class="Symbol">,</span><span class="VarId">vol</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span>
    <span class="VarId">permute</span> <span class="Symbol">((,,)</span> <span class="Symbol">&lt;$$&gt;</span> <span class="VarId">parseAs</span>
                  <span class="Symbol">&lt;||&gt;</span> <span class="VarId">readLang</span>
                  <span class="Symbol">&lt;|?&gt;</span> <span class="Symbol">(</span><span class="ConId">Volatile</span><span class="Symbol">,</span><span class="VarId">pVol</span><span class="Symbol">))</span>
  <span class="Keyword">case</span> <span class="VarId">parseBody</span> <span class="VarId">lang</span> <span class="VarId">body</span> <span class="VarId">bodypos</span> <span class="Keyword">of</span>
       <span class="ConId">Left</span> <span class="VarId">er</span> <span class="Symbol">-&gt;</span> <span class="VarId">fail</span> <span class="VarId">er</span>
       <span class="ConId">Right</span> <span class="VarId">b</span> <span class="Symbol">-&gt;</span>
         <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">CreateFunction</span> <span class="VarId">p</span> <span class="VarId">fnName</span> <span class="VarId">params</span> <span class="VarId">retType</span> <span class="VarId">rep</span> <span class="VarId">lang</span> <span class="VarId">b</span> <span class="VarId">vol</span>
    <span class="Keyword">where</span>
        <span class="VarId">parseAs</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
                   <span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span>
                   <span class="VarId">bodypos</span> <span class="Symbol">&lt;-</span> <span class="VarId">toMySp</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">getPosition</span>
                   <span class="VarId">body</span> <span class="Symbol">&lt;-</span> <span class="VarId">stringLit</span>
                   <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">bodypos</span><span class="Symbol">,</span><span class="VarId">body</span><span class="Symbol">)</span>
        <span class="VarId">pVol</span> <span class="Symbol">=</span> <span class="VarId">matchAKeyword</span> <span class="Symbol">[(</span><span class="String">&quot;volatile&quot;</span><span class="Symbol">,</span> <span class="ConId">Volatile</span><span class="Symbol">)</span>
                             <span class="Symbol">,(</span><span class="String">&quot;stable&quot;</span><span class="Symbol">,</span> <span class="ConId">Stable</span><span class="Symbol">)</span>
                             <span class="Symbol">,(</span><span class="String">&quot;immutable&quot;</span><span class="Symbol">,</span> <span class="ConId">Immutable</span><span class="Symbol">)]</span>
        <span class="VarId">readLang</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;language&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">matchAKeyword</span> <span class="Symbol">[(</span><span class="String">&quot;plpgsql&quot;</span><span class="Symbol">,</span> <span class="ConId">Plpgsql</span><span class="Symbol">)</span>
                                                       <span class="Symbol">,(</span><span class="String">&quot;sql&quot;</span><span class="Symbol">,</span><span class="ConId">Sql</span><span class="Symbol">)]</span>
        <span class="VarId">parseBody</span> <span class="Symbol">::</span> <span class="ConId">Language</span> <span class="Symbol">-&gt;</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">MySourcePos</span>
                  <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">String</span> <span class="ConId">FnBody</span>
        <span class="VarId">parseBody</span> <span class="VarId">lang</span> <span class="VarId">body</span> <span class="Symbol">(</span><span class="VarId">fileName</span><span class="Symbol">,</span><span class="VarId">line</span><span class="Symbol">,</span><span class="VarId">col</span><span class="Symbol">)</span> <span class="Symbol">=</span>
            <span class="Keyword">case</span> <span class="Symbol">(</span><span class="VarId">parseIt</span>
                  <span class="Symbol">(</span><span class="VarId">lexSqlTextWithPosition</span> <span class="VarId">fileName</span> <span class="VarId">line</span> <span class="VarId">col</span> <span class="Symbol">(</span><span class="VarId">extrStr</span> <span class="VarId">body</span><span class="Symbol">))</span>
                  <span class="Symbol">(</span><span class="VarId">functionBody</span> <span class="VarId">lang</span><span class="Symbol">)</span>
                  <span class="VarId">fileName</span>
                  <span class="Symbol">(</span><span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">line</span><span class="Symbol">,</span><span class="VarId">col</span><span class="Symbol">))</span>
                  <span class="Symbol">(</span><span class="VarId">extrStr</span> <span class="VarId">body</span><span class="Symbol">)</span>
                  <span class="Symbol">())</span> <span class="Keyword">of</span>
                     <span class="ConId">Left</span> <span class="VarId">er</span><span class="Symbol">@(</span><span class="ConId">ParseErrorExtra</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">Left</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">er</span>
                     <span class="ConId">Right</span> <span class="VarId">body'</span> <span class="Symbol">-&gt;</span> <span class="ConId">Right</span> <span class="VarId">body'</span>
        <span class="Comment">-- sql function is just a list of statements, the last one</span>
        <span class="Comment">-- has the trailing semicolon optional</span>
        <span class="VarId">functionBody</span> <span class="ConId">Sql</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
           <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
           <span class="VarId">a</span> <span class="Symbol">&lt;-</span> <span class="VarId">many</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="VarId">sqlStatement</span> <span class="ConId">True</span><span class="Symbol">)</span>
           <span class="Comment">-- this makes my head hurt, should probably write out</span>
           <span class="Comment">-- more longhand</span>
           <span class="ConId">SqlFnBody</span> <span class="VarId">p</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">option</span> <span class="VarId">a</span> <span class="Symbol">((\</span><span class="VarId">b</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span><span class="Symbol">++[</span><span class="VarId">b</span><span class="Symbol">])</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">sqlStatement</span> <span class="ConId">False</span><span class="Symbol">)</span>
        <span class="Comment">-- plpgsql function has an optional declare section, plus</span>
        <span class="Comment">-- the statements are enclosed in begin ... end; (semi colon</span>
        <span class="Comment">-- after end is optional)</span>
        <span class="VarId">functionBody</span> <span class="ConId">Plpgsql</span> <span class="Symbol">=</span>
            <span class="ConId">PlpgsqlFnBody</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Keyword">do</span>
                   <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
                   <span class="VarId">l</span> <span class="Symbol">&lt;-</span> <span class="VarId">label</span>
                   <span class="VarId">block</span> <span class="VarId">p</span> <span class="VarId">l</span> <span class="Symbol">&lt;*</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span><span class="Symbol">)</span> <span class="Symbol">&lt;*</span> <span class="VarId">eof</span></pre></div></div></div><p
      >params to a function</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">param</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ParamDef</span>
<span class="Function">param</span> <span class="Symbol">=</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
         <span class="VarId">try</span> <span class="Symbol">(</span><span class="ConId">ParamDef</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">typeName</span><span class="Symbol">)</span>
        <span class="Symbol">,</span><span class="ConId">ParamDefTp</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">typeName</span><span class="Symbol">]</span></pre></div></div></div><p
      >variable declarations in a plpgsql function</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">varDef</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">VarDef</span>
<span class="Function">varDef</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="VarId">a</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
  <span class="VarId">choice</span> <span class="Symbol">[</span><span class="Keyword">do</span>
          <span class="VarId">keyword</span> <span class="String">&quot;alias&quot;</span>
          <span class="VarId">keyword</span> <span class="String">&quot;for&quot;</span>
          <span class="VarId">choice</span> <span class="Symbol">[</span>
            <span class="ConId">VarAlias</span> <span class="VarId">p</span> <span class="VarId">a</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">idString</span>
           <span class="Symbol">,</span><span class="ConId">ParamAlias</span> <span class="VarId">p</span> <span class="VarId">a</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">liftPositionalArgTok</span><span class="Symbol">]</span>
         <span class="Symbol">,</span><span class="ConId">VarDef</span> <span class="VarId">p</span> <span class="VarId">a</span>
          <span class="Symbol">&lt;$&gt;</span> <span class="VarId">typeName</span>
          <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="Symbol">((</span><span class="VarId">symbol</span> <span class="String">&quot;:=&quot;</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">symbol</span> <span class="String">&quot;=&quot;</span><span class="Symbol">)*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>
          <span class="Symbol">]</span>
    <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span>

<span class="Function">createView</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Comment">{-createView = CreateView</span>
<span class="Comment">             &lt;$&gt; pos &lt;* keyword &quot;view&quot;</span>
<span class="Comment">             &lt;*&gt; idString</span>
<span class="Comment">             &lt;*&gt; (keyword &quot;as&quot; *&gt; selectScalarExpr)-}</span>
<span class="Function">createView</span> <span class="Symbol">=</span> <span class="ConId">CreateView</span>
             <span class="Symbol">&lt;$&gt;</span> <span class="VarId">posAndIgnoreView</span>
             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span>
             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">ignoreAsAndQueryExpr</span>
             <span class="Keyword">where</span>
               <span class="VarId">posAndIgnoreView</span> <span class="Symbol">=</span>
                 <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;view&quot;</span>
               <span class="VarId">ignoreAsAndQueryExpr</span> <span class="Symbol">=</span>
                 <span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">selectScalarExpr</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">createDomain</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">createDomain</span> <span class="Symbol">=</span> <span class="ConId">CreateDomain</span>
               <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;domain&quot;</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="VarId">idString</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">tryOptionMaybe</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span><span class="Symbol">)</span> <span class="Symbol">*&gt;</span> <span class="VarId">typeName</span><span class="Symbol">)</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="String">&quot;&quot;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;constraint&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
               <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;check&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">parens</span> <span class="VarId">expr</span><span class="Symbol">)</span>

<span class="Function">dropSomething</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">dropSomething</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">[</span>
                 <span class="ConId">Domain</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;domain&quot;</span>
                <span class="Symbol">,</span><span class="ConId">Type</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;type&quot;</span>
                <span class="Symbol">,</span><span class="ConId">Table</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;table&quot;</span>
                <span class="Symbol">,</span><span class="ConId">View</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;view&quot;</span>
            <span class="Symbol">])</span>
  <span class="Symbol">(</span><span class="VarId">i</span><span class="Symbol">,</span><span class="VarId">e</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">parseDrop</span> <span class="VarId">idString</span>
  <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">DropSomething</span> <span class="VarId">p</span> <span class="VarId">x</span> <span class="VarId">i</span> <span class="VarId">e</span> <span class="VarId">r</span>

<span class="Function">dropFunction</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">dropFunction</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
               <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
               <span class="VarId">keyword</span> <span class="String">&quot;function&quot;</span>
               <span class="Symbol">(</span><span class="VarId">i</span><span class="Symbol">,</span><span class="VarId">e</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">parseDrop</span> <span class="VarId">pFun</span>
               <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">DropFunction</span> <span class="VarId">p</span> <span class="VarId">i</span> <span class="VarId">e</span> <span class="VarId">r</span>
               <span class="Keyword">where</span>
                 <span class="VarId">pFun</span> <span class="Symbol">=</span> <span class="Symbol">(,)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">idString</span>
                            <span class="Symbol">&lt;*&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep</span> <span class="VarId">typeName</span><span class="Symbol">)</span>

<span class="Function">parseDrop</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
          <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="Symbol">(</span><span class="ConId">IfExists</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">],</span> <span class="ConId">Cascade</span><span class="Symbol">)</span>
<span class="Function">parseDrop</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="Symbol">(,,)</span>
              <span class="Symbol">&lt;$&gt;</span> <span class="VarId">ifExists</span>
              <span class="Symbol">&lt;*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">p</span>
              <span class="Symbol">&lt;*&gt;</span> <span class="VarId">cascade</span>
    <span class="Keyword">where</span>
      <span class="VarId">ifExists</span> <span class="Symbol">=</span> <span class="VarId">option</span> <span class="ConId">Require</span>
                 <span class="Symbol">(</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="ConId">IfExists</span> <span class="Symbol">&lt;$</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;if&quot;</span>
                                     <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;exists&quot;</span><span class="Symbol">))</span>

<span class="Function">createLanguage</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">createLanguage</span> <span class="Symbol">=</span>
  <span class="ConId">CreateLanguage</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                 <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;procedural&quot;</span><span class="Symbol">)</span> <span class="Symbol">*&gt;</span>
                      <span class="VarId">keyword</span> <span class="String">&quot;language&quot;</span> <span class="Symbol">*&gt;</span>
                      <span class="VarId">idString</span><span class="Symbol">)</span>

<span class="Function">createTrigger</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">createTrigger</span> <span class="Symbol">=</span>
  <span class="ConId">CreateTrigger</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;trigger&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="VarId">twhen</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tevents</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;on&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tfiring</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;execute&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;procedure&quot;</span>
                     <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>
                <span class="Symbol">&lt;*&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep</span> <span class="VarId">expr</span><span class="Symbol">)</span>
  <span class="Keyword">where</span>
    <span class="VarId">twhen</span> <span class="Symbol">=</span> <span class="VarId">choice</span> <span class="Symbol">[</span><span class="ConId">TriggerBefore</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;before&quot;</span>
                   <span class="Symbol">,</span><span class="ConId">TriggerAfter</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;after&quot;</span><span class="Symbol">]</span>
    <span class="VarId">tevents</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="Symbol">[</span><span class="ConId">TriggerEvent</span><span class="Symbol">]</span>
    <span class="VarId">tevents</span> <span class="Symbol">=</span> <span class="VarId">sepBy1</span> <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">[</span>
                         <span class="ConId">AntiTriggerEvent</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">splice</span>
                        <span class="Symbol">,</span><span class="ConId">TInsert</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;insert&quot;</span>
                        <span class="Symbol">,</span><span class="ConId">TUpdate</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;update&quot;</span>
                        <span class="Symbol">,</span><span class="ConId">TDelete</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;delete&quot;</span><span class="Symbol">])</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;or&quot;</span><span class="Symbol">)</span>
    <span class="VarId">tfiring</span> <span class="Symbol">=</span> <span class="VarId">option</span> <span class="ConId">EachStatement</span>
                <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;for&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;each&quot;</span><span class="Symbol">)</span> <span class="Symbol">*&gt;</span>
                <span class="VarId">choice</span> <span class="Symbol">[</span>
                  <span class="ConId">EachRow</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;row&quot;</span>
                 <span class="Symbol">,</span><span class="ConId">EachStatement</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;statement&quot;</span><span class="Symbol">])</span></pre></div></div></div><div id="anti-statement"
      ><h2
	>anti statement</h2
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">antiStatement</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">antiStatement</span> <span class="Symbol">=</span> <span class="ConId">AntiStatement</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">splice</span></pre></div></div></div><hr
	 /></div
      ></div
    ><div id="component-parsers-for-sql-statements"
    ><h1
      >component parsers for sql statements</h1
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">whereClause</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">whereClause</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;where&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span></pre></div></div></div><p
      >selectlist and selectitem: the bit between select and from check for into either before the whole list of select columns or after the whole list</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">selectList</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">SelectList</span>
<span class="Function">selectList</span> <span class="Symbol">=</span>
    <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span>
    <span class="VarId">choice</span> <span class="Symbol">[</span>
        <span class="VarId">flip</span> <span class="Symbol">(</span><span class="ConId">SelectList</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">readInto</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">itemList</span>
       <span class="Symbol">,</span><span class="ConId">SelectList</span> <span class="VarId">p</span>  <span class="Symbol">&lt;$&gt;</span> <span class="VarId">itemList</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="VarId">readInto</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">readInto</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;into&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">qName</span>
    <span class="VarId">itemList</span> <span class="Symbol">=</span> <span class="VarId">commaSep1</span> <span class="VarId">selectItem</span>
    <span class="VarId">selectItem</span> <span class="Symbol">=</span> <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span>
                 <span class="VarId">optionalSuffix</span>
                   <span class="Symbol">(</span><span class="ConId">SelExp</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="VarId">expr</span>
                   <span class="Symbol">(</span><span class="ConId">SelectItem</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">()</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span>

<span class="Function">returning</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">SelectList</span>
<span class="Function">returning</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;returning&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">selectList</span>

<span class="Function">columnNameList</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">columnNameList</span> <span class="Symbol">=</span> <span class="VarId">parens</span> <span class="Symbol">$</span> <span class="VarId">commaSep1</span> <span class="VarId">idString</span>

<span class="Function">typeName</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">TypeName</span>
<span class="Function">typeName</span> <span class="Symbol">=</span>
  <span class="VarId">choice</span> <span class="Symbol">[</span>
     <span class="ConId">SetOfTypeName</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;setof&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">typeName</span><span class="Symbol">)</span>
    <span class="Symbol">,</span><span class="VarId">otherTypeName</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">otherTypeName</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
       <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
       <span class="VarId">s</span> <span class="Symbol">&lt;-</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pTypeNameString</span>
       <span class="VarId">choice</span> <span class="Symbol">[</span><span class="VarId">try</span> <span class="Symbol">(</span><span class="ConId">Prec2TypeName</span> <span class="VarId">p</span> <span class="VarId">s</span>
                    <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">integer</span><span class="Symbol">)</span>
                    <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;,&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">integer</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span><span class="Symbol">))</span>
              <span class="Symbol">,</span><span class="ConId">PrecTypeName</span> <span class="VarId">p</span> <span class="VarId">s</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">parens</span> <span class="VarId">integer</span>
              <span class="Symbol">,</span><span class="VarId">arrayTypeName</span> <span class="VarId">p</span> <span class="VarId">s</span>
              <span class="Symbol">,</span><span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">SimpleTypeName</span> <span class="VarId">p</span> <span class="VarId">s</span><span class="Symbol">]</span>
    <span class="VarId">arrayTypeName</span> <span class="VarId">p</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="ConId">ArrayTypeName</span> <span class="VarId">p</span> <span class="Symbol">(</span><span class="ConId">SimpleTypeName</span> <span class="VarId">p</span> <span class="VarId">s</span><span class="Symbol">)</span>
                        <span class="Symbol">&lt;$</span> <span class="VarId">symbol</span> <span class="String">&quot;[&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;]&quot;</span>
    <span class="Comment">--todo: add special cases for the other type names with spaces in them</span>
    <span class="VarId">pTypeNameString</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="String">&quot;double precision&quot;</span> <span class="Symbol">&lt;$</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;double&quot;</span>
                                                  <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;precision&quot;</span><span class="Symbol">))</span>
                      <span class="Symbol">&lt;|&gt;</span> <span class="VarId">idString</span>

<span class="Function">cascade</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Cascade</span>
<span class="Function">cascade</span> <span class="Symbol">=</span> <span class="VarId">option</span> <span class="ConId">Restrict</span> <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">[</span>
                            <span class="ConId">Restrict</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;restrict&quot;</span>
                           <span class="Symbol">,</span><span class="ConId">Cascade</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;cascade&quot;</span><span class="Symbol">])</span></pre></div></div></div><hr
       /></div
    ><div id="plpgsql-statements"
    ><h1
      >plpgsql statements</h1
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">plPgsqlStatement</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">plPgsqlStatement</span> <span class="Symbol">=</span>
   <span class="VarId">sqlStatement</span> <span class="ConId">True</span>
    <span class="Symbol">&lt;|&gt;</span> <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">[</span>
          <span class="VarId">continue</span>
         <span class="Symbol">,</span><span class="VarId">execute</span>
         <span class="Symbol">,</span><span class="VarId">caseStatement</span>
         <span class="Symbol">,</span><span class="VarId">assignment</span>
         <span class="Symbol">,</span><span class="VarId">ifStatement</span>
         <span class="Symbol">,</span><span class="VarId">returnSt</span>
         <span class="Symbol">,</span><span class="VarId">raise</span>
         <span class="Symbol">,</span><span class="VarId">perform</span>
         <span class="Symbol">,</span><span class="VarId">labelPrefixed</span>
         <span class="Symbol">,</span><span class="VarId">nullStatement</span>
         <span class="Symbol">,</span><span class="VarId">exitStatement</span><span class="Symbol">]</span>
         <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span><span class="Symbol">)</span>
   <span class="Keyword">where</span>
     <span class="VarId">labelPrefixed</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
       <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
       <span class="VarId">l</span> <span class="Symbol">&lt;-</span> <span class="VarId">label</span>
       <span class="VarId">choice</span> <span class="Symbol">[</span><span class="VarId">block</span> <span class="VarId">p</span> <span class="VarId">l</span>
              <span class="Symbol">,</span><span class="VarId">forStatement</span> <span class="VarId">p</span> <span class="VarId">l</span>
              <span class="Symbol">,</span><span class="VarId">whileStatement</span> <span class="VarId">p</span> <span class="VarId">l</span>
              <span class="Symbol">,</span><span class="VarId">loopStatement</span> <span class="VarId">p</span> <span class="VarId">l</span><span class="Symbol">]</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">label</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="Symbol">(</span><span class="ConId">Maybe</span> <span class="ConId">String</span><span class="Symbol">)</span>
<span class="Function">label</span> <span class="Symbol">=</span> <span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;&lt;&lt;&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;&gt;&gt;&quot;</span><span class="Symbol">)</span>

<span class="Function">block</span> <span class="Symbol">::</span> <span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">block</span> <span class="VarId">p</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="ConId">Block</span> <span class="VarId">p</span> <span class="VarId">l</span>
            <span class="Symbol">&lt;$&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="VarId">declarePart</span>
            <span class="Symbol">&lt;*&gt;</span> <span class="VarId">statementPart</span>
        <span class="Keyword">where</span>
          <span class="VarId">statementPart</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;begin&quot;</span>
                    <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span>
                    <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span>
          <span class="VarId">declarePart</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;declare&quot;</span>
                        <span class="Symbol">*&gt;</span> <span class="VarId">manyTill</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="VarId">varDef</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">lookAhead</span> <span class="Symbol">$</span> <span class="VarId">keyword</span> <span class="String">&quot;begin&quot;</span><span class="Symbol">)</span>


<span class="Function">nullStatement</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">nullStatement</span> <span class="Symbol">=</span> <span class="ConId">NullStatement</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;null&quot;</span><span class="Symbol">)</span>

<span class="Function">exitStatement</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">exitStatement</span> <span class="Symbol">=</span> <span class="ConId">ExitStatement</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;exit&quot;</span><span class="Symbol">)</span>
                              <span class="Symbol">&lt;*&gt;</span> <span class="VarId">optional</span> <span class="VarId">idString</span>


<span class="Function">continue</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">continue</span> <span class="Symbol">=</span> <span class="ConId">ContinueStatement</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;continue&quot;</span><span class="Symbol">)</span>
                             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">optional</span> <span class="VarId">idString</span>

<span class="Function">perform</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">perform</span> <span class="Symbol">=</span> <span class="ConId">Perform</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;perform&quot;</span><span class="Symbol">)</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">expr</span>

<span class="Function">execute</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">execute</span> <span class="Symbol">=</span> <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;execute&quot;</span> <span class="Symbol">&gt;&gt;</span>
          <span class="VarId">optionalSuffix</span>
            <span class="Symbol">(</span><span class="ConId">Execute</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="VarId">expr</span>
            <span class="Symbol">(</span><span class="ConId">ExecuteInto</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">()</span> <span class="VarId">readInto</span>
    <span class="Keyword">where</span>
      <span class="VarId">readInto</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;into&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">idString</span>

<span class="Function">assignment</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">assignment</span> <span class="Symbol">=</span> <span class="ConId">Assignment</span>
             <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
             <span class="Comment">-- put the := in the first try to attempt to get a</span>
             <span class="Comment">-- better error if the code looks like malformed</span>
             <span class="Comment">-- assignment statement</span>
             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">qName</span> <span class="Symbol">&lt;*</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;:=&quot;</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">symbol</span> <span class="String">&quot;=&quot;</span><span class="Symbol">))</span>
             <span class="Symbol">&lt;*&gt;</span> <span class="VarId">expr</span>

<span class="Function">returnSt</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">returnSt</span> <span class="Symbol">=</span> <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;return&quot;</span> <span class="Symbol">&gt;&gt;</span>
           <span class="VarId">choice</span> <span class="Symbol">[</span>
            <span class="ConId">ReturnNext</span> <span class="VarId">p</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;next&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>
           <span class="Symbol">,</span><span class="ConId">ReturnQuery</span> <span class="VarId">p</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;query&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">selectScalarExpr</span><span class="Symbol">)</span>
           <span class="Symbol">,</span><span class="ConId">Return</span> <span class="VarId">p</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="VarId">expr</span><span class="Symbol">]</span>

<span class="Function">raise</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">raise</span> <span class="Symbol">=</span> <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;raise&quot;</span> <span class="Symbol">&gt;&gt;</span>
        <span class="ConId">Raise</span> <span class="VarId">p</span>
        <span class="Symbol">&lt;$&gt;</span> <span class="VarId">raiseType</span>
        <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">extrStr</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">stringLit</span><span class="Symbol">)</span>
        <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;,&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span><span class="Symbol">)</span>
        <span class="Keyword">where</span>
          <span class="VarId">raiseType</span> <span class="Symbol">=</span> <span class="VarId">matchAKeyword</span> <span class="Symbol">[(</span><span class="String">&quot;notice&quot;</span><span class="Symbol">,</span> <span class="ConId">RNotice</span><span class="Symbol">)</span>
                                     <span class="Symbol">,(</span><span class="String">&quot;exception&quot;</span><span class="Symbol">,</span> <span class="ConId">RException</span><span class="Symbol">)</span>
                                     <span class="Symbol">,(</span><span class="String">&quot;error&quot;</span><span class="Symbol">,</span> <span class="ConId">RError</span><span class="Symbol">)]</span>

<span class="Function">forStatement</span> <span class="Symbol">::</span> <span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">forStatement</span> <span class="VarId">p</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
               <span class="VarId">keyword</span> <span class="String">&quot;for&quot;</span>
               <span class="VarId">start</span> <span class="Symbol">&lt;-</span> <span class="VarId">qName</span>
               <span class="VarId">keyword</span> <span class="String">&quot;in&quot;</span>
               <span class="VarId">choice</span> <span class="Symbol">[</span><span class="ConId">ForQueryStatement</span> <span class="VarId">p</span> <span class="VarId">l</span> <span class="VarId">start</span>
                       <span class="Symbol">&lt;$&gt;</span> <span class="VarId">try</span> <span class="VarId">selectScalarExpr</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">theRest</span>
                      <span class="Symbol">,</span><span class="ConId">ForIntegerStatement</span> <span class="VarId">p</span> <span class="VarId">l</span> <span class="VarId">start</span>
                              <span class="Symbol">&lt;$&gt;</span> <span class="VarId">expr</span>
                              <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;..&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>
                              <span class="Symbol">&lt;*&gt;</span> <span class="VarId">theRest</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">theRest</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;loop&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span>
              <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;loop&quot;</span>

<span class="Function">whileStatement</span> <span class="Symbol">::</span> <span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">whileStatement</span> <span class="VarId">p</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="ConId">WhileStatement</span> <span class="VarId">p</span> <span class="VarId">l</span>
                     <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;while&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;loop&quot;</span><span class="Symbol">)</span>
                     <span class="Symbol">&lt;*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;loop&quot;</span>
<span class="Function">loopStatement</span> <span class="Symbol">::</span> <span class="ConId">Annotation</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">loopStatement</span> <span class="VarId">p</span> <span class="VarId">l</span> <span class="Symbol">=</span> <span class="ConId">LoopStatement</span> <span class="VarId">p</span> <span class="VarId">l</span>
                    <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;loop&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;loop&quot;</span><span class="Symbol">)</span>
</pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">ifStatement</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">ifStatement</span> <span class="Symbol">=</span> <span class="ConId">If</span>
              <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;if&quot;</span><span class="Symbol">)</span>
              <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">ifPart</span> <span class="Symbol">&lt;:&gt;</span> <span class="VarId">elseifParts</span><span class="Symbol">)</span>
              <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">elsePart</span> <span class="Symbol">&lt;*</span> <span class="VarId">endIf</span><span class="Symbol">)</span>
  <span class="Keyword">where</span>
    <span class="VarId">ifPart</span> <span class="Symbol">=</span> <span class="VarId">expr</span> <span class="Symbol">&lt;.&gt;</span> <span class="Symbol">(</span><span class="VarId">thn</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span><span class="Symbol">)</span>
    <span class="VarId">elseifParts</span> <span class="Symbol">=</span> <span class="VarId">many</span> <span class="Symbol">((</span><span class="VarId">elseif</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span> <span class="Symbol">&lt;.&gt;</span> <span class="Symbol">(</span><span class="VarId">thn</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span><span class="Symbol">))</span>
    <span class="VarId">elsePart</span> <span class="Symbol">=</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span><span class="Symbol">)</span>
    <span class="VarId">endIf</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;if&quot;</span>
    <span class="VarId">thn</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;then&quot;</span>
    <span class="VarId">elseif</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;elseif&quot;</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;elsif&quot;</span>
    <span class="Comment">--might as well throw this in as well after all that</span>
    <span class="Comment">-- can't do &lt;,&gt; unfortunately, so use &lt;.&gt; instead</span>
    <span class="Symbol">(&lt;.&gt;)</span> <span class="VarId">a</span> <span class="VarId">b</span> <span class="Symbol">=</span> <span class="Symbol">(,)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">a</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">b</span>

<span class="Function">caseStatement</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Statement</span>
<span class="Function">caseStatement</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
    <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
    <span class="VarId">keyword</span> <span class="String">&quot;case&quot;</span>
    <span class="VarId">choice</span> <span class="Symbol">[</span><span class="VarId">try</span> <span class="Symbol">(</span><span class="ConId">CaseStatementSimple</span> <span class="VarId">p</span>
                 <span class="Symbol">&lt;$&gt;</span> <span class="VarId">expr</span>
                 <span class="Symbol">&lt;*&gt;</span> <span class="VarId">many</span> <span class="VarId">whenSt</span>
                 <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span><span class="Symbol">)</span>
                        <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;case&quot;</span><span class="Symbol">)</span>
           <span class="Symbol">,</span><span class="ConId">CaseStatement</span> <span class="VarId">p</span>
                 <span class="Symbol">&lt;$&gt;</span> <span class="VarId">many</span> <span class="VarId">whenSt</span>
                 <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span><span class="Symbol">)</span>
                        <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;case&quot;</span><span class="Symbol">]</span>
    <span class="Keyword">where</span>
      <span class="VarId">whenSt</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;when&quot;</span> <span class="Symbol">&gt;&gt;</span>
               <span class="Symbol">(,)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;then&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">many</span> <span class="VarId">plPgsqlStatement</span><span class="Symbol">)</span></pre></div></div></div><hr
       /></div
    ><div id="expressions"
    ><h1
      >expressions</h1
      ><p
      >This is the bit that makes it the most obvious that I don't really know haskell, parsing theory or parsec ... robbed a parsing example from haskell-cafe and mainly just kept changing it until it seemed to work</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">expr</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">expr</span> <span class="Symbol">=</span> <span class="VarId">buildExpressionParser</span> <span class="VarId">table</span> <span class="VarId">factor</span>
       <span class="Symbol">&lt;?&gt;</span> <span class="String">&quot;expression&quot;</span>

<span class="Function">factor</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">factor</span> <span class="Symbol">=</span></pre></div></div></div><p
      >First job is to take care of forms which start like a vanilla expression, and then add a suffix on</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">  <span class="VarId">fct</span> <span class="Symbol">&gt;&gt;=</span> <span class="VarId">tryExprSuffix</span>
  <span class="Keyword">where</span>
    <span class="VarId">tryExprSuffix</span> <span class="VarId">e</span> <span class="Symbol">=</span>
      <span class="VarId">option</span> <span class="VarId">e</span> <span class="Symbol">(</span><span class="VarId">choice</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(\</span><span class="VarId">f</span> <span class="Symbol">-&gt;</span> <span class="VarId">f</span> <span class="VarId">e</span><span class="Symbol">)</span>
                                 <span class="Symbol">[</span><span class="VarId">inPredicateSuffix</span>
                                 <span class="Symbol">,</span><span class="VarId">functionCallSuffix</span>
                                 <span class="Symbol">,</span><span class="VarId">windowFnSuffix</span>
                                 <span class="Symbol">,</span><span class="VarId">castSuffix</span>
                                 <span class="Symbol">,</span><span class="VarId">betweenSuffix</span>
                                 <span class="Symbol">,</span><span class="VarId">arraySubSuffix</span>
                                 <span class="Symbol">,</span><span class="VarId">qualIdSuffix</span><span class="Symbol">])</span>
                <span class="Symbol">&gt;&gt;=</span> <span class="VarId">tryExprSuffix</span><span class="Symbol">)</span>
    <span class="VarId">fct</span> <span class="Symbol">=</span> <span class="VarId">choice</span> <span class="Symbol">[</span></pre></div></div></div><p
      >order these so the ones which can be valid prefixes of others appear further down the list (used to be a lot more important when there wasn't a separate lexer), probably want to refactor this to use the optionalsuffix parsers to improve speed.</p
      ><p
      >One little speed optimisation, to help with pretty printed code which can contain a lot of parens - check for nested (( This little addition speeds up ./ParseFile.lhs sqltestfiles/system.sql on my system from ~4 minutes to ~4 seconds (most of the 4s is probably compilation overhead).</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">       <span class="Comment">--try (lookAhead (symbol &quot;(&quot; &gt;&gt; symbol &quot;(&quot;)) &gt;&gt; parens expr</span></pre></div></div></div><p
      >start with the factors which start with parens - eliminate scalar subqueries since they're easy to distinguish from the others then do in predicate before row constructor, since an in predicate can start with a row constructor looking thing, then finally vanilla parens</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">      <span class="Comment">--,</span>
       <span class="VarId">scalarSubQuery</span>
      <span class="Symbol">,</span><span class="VarId">try</span> <span class="VarId">rowCtor</span>
      <span class="Symbol">,</span><span class="VarId">parens</span> <span class="VarId">expr</span></pre></div></div></div><p
      >try a few random things which can't start a different expression</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">      <span class="Symbol">,</span><span class="VarId">positionalArg</span>
      <span class="Symbol">,</span><span class="VarId">placeholder</span>
      <span class="Symbol">,</span><span class="VarId">stringLit</span>
      <span class="Symbol">,</span><span class="VarId">floatLit</span>
      <span class="Symbol">,</span><span class="VarId">integerLit</span></pre></div></div></div><p
      >put the factors which start with keywords before the ones which start with a function, so we don't try an parse a keyword as a function name</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">      <span class="Symbol">,</span><span class="VarId">caseScalarExpr</span>
      <span class="Symbol">,</span><span class="VarId">exists</span>
      <span class="Symbol">,</span><span class="VarId">booleanLit</span>
      <span class="Symbol">,</span><span class="VarId">nullLit</span>
      <span class="Symbol">,</span><span class="VarId">arrayLit</span>
      <span class="Symbol">,</span><span class="VarId">castKeyword</span>
      <span class="Symbol">,</span><span class="VarId">substring</span></pre></div></div></div><p
      >now do identifiers, functions, and window functions (each is a prefix to the next one)</p
      ><p
      >want to allow splices in e.g. function calls: $(fnname)(). To do this, don't want to parse anti expression above, but need to parse these following suffixes starting with a splice, but if there is no suffix, want to parse as an antiexpression rather than an antiidentifier</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">      <span class="Symbol">,</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
             <span class="VarId">i</span> <span class="Symbol">&lt;-</span> <span class="VarId">antiIdentifier</span>
             <span class="VarId">choice</span> <span class="Symbol">[</span><span class="VarId">inPredicateSuffix</span> <span class="VarId">i</span>
                    <span class="Symbol">,</span><span class="VarId">threadOptionalSuffix</span> <span class="Symbol">(</span><span class="VarId">functionCallSuffix</span> <span class="VarId">i</span><span class="Symbol">)</span>
                                          <span class="VarId">windowFnSuffix</span><span class="Symbol">]</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">      <span class="Symbol">,</span><span class="VarId">antiScalarExpr</span>
      <span class="Symbol">,</span><span class="VarId">antiIdentifier1</span>
      <span class="Symbol">,</span><span class="VarId">identifier</span>
      <span class="Symbol">]</span></pre></div></div></div><div id="operator-table"
      ><h2
	>operator table</h2
	><p
	>proper hacky, but sort of does the job the 'missing' notes refer to pg operators which aren't yet supported, or supported in a different way (e.g. cast uses the type name parser for one of it's argument, not the expression parser - I don't know if there is a better way of doing this but there usually is in parsec)</p
	><p
	>pg's operator table is on this page: http://www.postgresql.org/docs/8.4/interactive/sql-syntax-lexical.html#SQL-SYNTAX-OPERATORS</p
	><p
	>will probably need something more custom to handle full range of sql syntactical novelty, in particular the precedence rules mix these operators up with irregular syntax operators, you can create new operators during parsing, and some operators are prefix/postfix or binary depending on the types of their operands (how do you parse something like this?)</p
	><p
	>The full list of operators from a standard template1 database should be used here.</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">table</span> <span class="Symbol">::</span> <span class="Symbol">[[</span><span class="ConId">Operator</span> <span class="Symbol">[</span><span class="ConId">Token</span><span class="Symbol">]</span> <span class="ConId">ParseState</span> <span class="ConId">Identity</span> <span class="ConId">ScalarExpr</span><span class="Symbol">]]</span>
<span class="Function">table</span> <span class="Symbol">=</span> <span class="Symbol">[[</span><span class="Comment">{-binary &quot;.&quot; AssocLeft-}</span><span class="Symbol">]</span>
         <span class="Comment">--[binary &quot;::&quot; (BinOpCall Cast) AssocLeft]</span>
         <span class="Comment">--missing [] for array element select</span>
        <span class="Symbol">,[</span><span class="VarId">prefix</span> <span class="String">&quot;-&quot;</span> <span class="String">&quot;u-&quot;</span><span class="Symbol">]</span>
        <span class="Symbol">,[</span><span class="VarId">binary</span> <span class="String">&quot;^&quot;</span> <span class="ConId">AssocLeft</span><span class="Symbol">]</span>
        <span class="Symbol">,[</span><span class="VarId">binary</span> <span class="String">&quot;*&quot;</span> <span class="ConId">AssocLeft</span>
         <span class="Symbol">,</span><span class="VarId">idHackBinary</span> <span class="String">&quot;*&quot;</span> <span class="ConId">AssocLeft</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;/&quot;</span> <span class="ConId">AssocLeft</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;%&quot;</span> <span class="ConId">AssocLeft</span><span class="Symbol">]</span>
        <span class="Symbol">,[</span><span class="VarId">binary</span> <span class="String">&quot;+&quot;</span> <span class="ConId">AssocLeft</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;-&quot;</span> <span class="ConId">AssocLeft</span><span class="Symbol">]</span>
         <span class="Comment">--should be is isnull and notnull</span>
        <span class="Symbol">,[</span><span class="VarId">postfixks</span> <span class="Symbol">[</span><span class="String">&quot;is&quot;</span><span class="Symbol">,</span> <span class="String">&quot;not&quot;</span><span class="Symbol">,</span> <span class="String">&quot;null&quot;</span><span class="Symbol">]</span> <span class="String">&quot;!isnotnull&quot;</span>
         <span class="Symbol">,</span><span class="VarId">postfixks</span> <span class="Symbol">[</span><span class="String">&quot;is&quot;</span><span class="Symbol">,</span> <span class="String">&quot;null&quot;</span><span class="Symbol">]</span> <span class="String">&quot;!isnull&quot;</span><span class="Symbol">]</span>
         <span class="Comment">--other operators all added in this list according to the pg docs:</span>
        <span class="Symbol">,[</span><span class="VarId">binary</span> <span class="String">&quot;&lt;-&gt;&quot;</span> <span class="ConId">AssocNone</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;&lt;=&quot;</span> <span class="ConId">AssocRight</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;&gt;=&quot;</span> <span class="ConId">AssocRight</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;||&quot;</span> <span class="ConId">AssocLeft</span>
         <span class="Symbol">,</span><span class="VarId">prefix</span> <span class="String">&quot;@&quot;</span> <span class="String">&quot;@&quot;</span>
         <span class="Symbol">]</span>
         <span class="Comment">--in should be here, but is treated as a factor instead</span>
         <span class="Comment">--between</span>
         <span class="Comment">--overlaps</span>
        <span class="Symbol">,[</span><span class="VarId">binaryk</span> <span class="String">&quot;like&quot;</span> <span class="String">&quot;!like&quot;</span> <span class="ConId">AssocNone</span>
         <span class="Symbol">,</span><span class="VarId">binarycust</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;!=&quot;</span><span class="Symbol">)</span> <span class="String">&quot;&lt;&gt;&quot;</span> <span class="ConId">AssocNone</span><span class="Symbol">]</span>
         <span class="Comment">--(also ilike similar)</span>
        <span class="Symbol">,[</span><span class="VarId">binary</span> <span class="String">&quot;&lt;&quot;</span> <span class="ConId">AssocNone</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;&gt;&quot;</span> <span class="ConId">AssocNone</span><span class="Symbol">]</span>
        <span class="Symbol">,[</span><span class="VarId">binary</span> <span class="String">&quot;=&quot;</span> <span class="ConId">AssocRight</span>
         <span class="Symbol">,</span><span class="VarId">binary</span> <span class="String">&quot;&lt;&gt;&quot;</span> <span class="ConId">AssocNone</span><span class="Symbol">]</span>
        <span class="Symbol">,[</span><span class="VarId">notNot</span>
         <span class="Symbol">,</span><span class="VarId">prefixk</span> <span class="String">&quot;not&quot;</span> <span class="String">&quot;!not&quot;</span>
         <span class="Symbol">]</span>
        <span class="Symbol">,[</span><span class="VarId">binaryk</span> <span class="String">&quot;and&quot;</span> <span class="String">&quot;!and&quot;</span> <span class="ConId">AssocLeft</span>
         <span class="Symbol">,</span><span class="VarId">binaryk</span> <span class="String">&quot;or&quot;</span> <span class="String">&quot;!or&quot;</span> <span class="ConId">AssocLeft</span><span class="Symbol">]]</span>
    <span class="Keyword">where</span>
      <span class="VarId">binary</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="VarId">binarycust</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="VarId">s</span>
      <span class="Comment">-- '*' is lexed as an id token rather than a symbol token, so</span>
      <span class="Comment">-- work around here</span>
      <span class="VarId">idHackBinary</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="VarId">binarycust</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="VarId">s</span>
      <span class="VarId">binaryk</span> <span class="Symbol">=</span> <span class="VarId">binarycust</span> <span class="Symbol">.</span> <span class="VarId">keyword</span>
      <span class="VarId">prefix</span> <span class="Symbol">=</span> <span class="VarId">unaryCust</span> <span class="ConId">Prefix</span> <span class="Symbol">.</span> <span class="VarId">symbol</span>
      <span class="VarId">prefixk</span> <span class="Symbol">=</span> <span class="VarId">unaryCust</span> <span class="ConId">Prefix</span> <span class="Symbol">.</span> <span class="VarId">keyword</span>
      <span class="VarId">postfixks</span> <span class="Symbol">=</span> <span class="VarId">unaryCust</span> <span class="ConId">Postfix</span> <span class="Symbol">.</span> <span class="VarId">mapM_</span> <span class="VarId">keyword</span>
      <span class="VarId">binarycust</span> <span class="VarId">opParse</span> <span class="VarId">t</span> <span class="Symbol">=</span>
        <span class="ConId">Infix</span> <span class="Symbol">$</span> <span class="VarId">try</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
             <span class="VarId">f</span> <span class="Symbol">&lt;-</span> <span class="ConId">FunCall</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">t</span> <span class="Symbol">&lt;$</span> <span class="VarId">opParse</span><span class="Symbol">)</span>
             <span class="VarId">return</span> <span class="Symbol">(\</span><span class="VarId">l</span> <span class="VarId">m</span> <span class="Symbol">-&gt;</span> <span class="VarId">f</span> <span class="Symbol">[</span><span class="VarId">l</span><span class="Symbol">,</span><span class="VarId">m</span><span class="Symbol">])</span>
      <span class="VarId">unaryCust</span> <span class="VarId">ctor</span> <span class="VarId">opParse</span> <span class="VarId">t</span> <span class="Symbol">=</span>
        <span class="VarId">ctor</span> <span class="Symbol">$</span> <span class="VarId">try</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
          <span class="VarId">f</span> <span class="Symbol">&lt;-</span> <span class="ConId">FunCall</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">t</span> <span class="Symbol">&lt;$</span> <span class="VarId">opParse</span><span class="Symbol">)</span>
          <span class="VarId">return</span> <span class="Symbol">(\</span><span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="VarId">f</span> <span class="Symbol">[</span><span class="VarId">l</span><span class="Symbol">])</span>
      <span class="Comment">-- hack - haven't worked out why parsec buildexpression parser won't</span>
      <span class="Comment">-- parse something like &quot;not not EXPR&quot; without parens so hack here</span>
      <span class="VarId">notNot</span> <span class="Symbol">=</span>
        <span class="ConId">Prefix</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
                      <span class="VarId">p1</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
                      <span class="VarId">keyword</span> <span class="String">&quot;not&quot;</span>
                      <span class="VarId">p2</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
                      <span class="VarId">keyword</span> <span class="String">&quot;not&quot;</span>
                      <span class="VarId">return</span> <span class="Symbol">(\</span><span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="ConId">FunCall</span> <span class="VarId">p1</span> <span class="String">&quot;!not&quot;</span>
                                      <span class="Symbol">[</span><span class="ConId">FunCall</span> <span class="VarId">p2</span> <span class="String">&quot;!not&quot;</span> <span class="Symbol">[</span><span class="VarId">l</span><span class="Symbol">]]))</span></pre></div></div></div></div
      ><div id="factor-parsers"
      ><h2
	>factor parsers</h2
	><p
	>I think the lookahead is used in an attempt to help the error messages.</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">scalarSubQuery</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">scalarSubQuery</span> <span class="Symbol">=</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">lookAhead</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;select&quot;</span>
                                               <span class="Symbol">&lt;|&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;with&quot;</span><span class="Symbol">))</span> <span class="Symbol">&gt;&gt;</span>
                 <span class="ConId">ScalarSubQuery</span>
                 <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                 <span class="Symbol">&lt;*&gt;</span> <span class="VarId">selectScalarExpr</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span></pre></div></div></div><p
	>in predicate - an identifier or row constructor followed by 'in' then a list of expressions or a subselect</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">inPredicateSuffix</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">inPredicateSuffix</span> <span class="VarId">e</span> <span class="Symbol">=</span>
  <span class="ConId">InPredicate</span>
  <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
  <span class="Symbol">&lt;*&gt;</span> <span class="VarId">return</span> <span class="VarId">e</span>
  <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="ConId">True</span> <span class="Symbol">(</span><span class="ConId">False</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;not&quot;</span><span class="Symbol">)</span>
  <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;in&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">parens</span> <span class="Symbol">((</span><span class="ConId">InSelect</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">selectScalarExpr</span><span class="Symbol">)</span>
                               <span class="Symbol">&lt;|&gt;</span>
                               <span class="Symbol">(</span><span class="ConId">InList</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span><span class="Symbol">)))</span></pre></div></div></div><p
	>row ctor: one of</p
	><ul
	><li
	  >row ()</li
	  ><li
	  >row (expr)</li
	  ><li
	  >row (expr, expr1, ...)</li
	  ><li
	  ><p
	    >(expr, expr2,...) [implicit (no row keyword) version, at least two elements must be present]</p
	    ></li
	  ><li
	  >(expr) parses to just expr rather than row(expr)</li
	  ><li
	  ><p
	    >and () is a syntax error.</p
	    ></li
	  ></ul
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">rowCtor</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">rowCtor</span> <span class="Symbol">=</span> <span class="ConId">FunCall</span>
          <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
          <span class="Symbol">&lt;*&gt;</span> <span class="VarId">return</span> <span class="String">&quot;!rowctor&quot;</span>
          <span class="Symbol">&lt;*&gt;</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
           <span class="VarId">keyword</span> <span class="String">&quot;row&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep</span> <span class="VarId">expr</span><span class="Symbol">)</span>
          <span class="Symbol">,</span><span class="VarId">parens</span> <span class="Symbol">$</span> <span class="VarId">commaSep2</span> <span class="VarId">expr</span><span class="Symbol">]</span>

<span class="Function">floatLit</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">floatLit</span> <span class="Symbol">=</span> <span class="ConId">FloatLit</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">float</span>

<span class="Function">integerLit</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">integerLit</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="Symbol">(</span><span class="ConId">IntegerLit</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">integer</span></pre></div></div></div><p
	>IntegerLit &lt;$&gt; pos &lt;*&gt; integer</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">caseScalarExpr</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">caseScalarExpr</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="VarId">keyword</span> <span class="String">&quot;case&quot;</span>
  <span class="VarId">choice</span> <span class="Symbol">[</span>
             <span class="VarId">try</span> <span class="Symbol">$</span> <span class="ConId">CaseSimple</span> <span class="VarId">p</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">expr</span>
                                <span class="Symbol">&lt;*&gt;</span> <span class="VarId">many</span> <span class="VarId">whenParse</span>
                                <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>
                                        <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span>
            <span class="Symbol">,</span><span class="ConId">Case</span> <span class="VarId">p</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">many</span> <span class="VarId">whenParse</span>
                    <span class="Symbol">&lt;*&gt;</span> <span class="VarId">tryOptionMaybe</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;else&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>
                            <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;end&quot;</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">whenParse</span> <span class="Symbol">=</span> <span class="Symbol">(,)</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;when&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span><span class="Symbol">)</span>
                    <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;then&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">expr</span><span class="Symbol">)</span>

<span class="Function">exists</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">exists</span> <span class="Symbol">=</span> <span class="ConId">Exists</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;exists&quot;</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">parens</span> <span class="VarId">selectScalarExpr</span>
</pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">booleanLit</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">booleanLit</span> <span class="Symbol">=</span> <span class="ConId">BooleanLit</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="ConId">True</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;true&quot;</span>
                                     <span class="Symbol">&lt;|&gt;</span> <span class="ConId">False</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;false&quot;</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">nullLit</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">nullLit</span> <span class="Symbol">=</span> <span class="ConId">NullLit</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;null&quot;</span>

<span class="Function">arrayLit</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">arrayLit</span> <span class="Symbol">=</span> <span class="ConId">FunCall</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;array&quot;</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">return</span> <span class="String">&quot;!arrayctor&quot;</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">squares</span> <span class="Symbol">(</span><span class="VarId">commaSep</span> <span class="VarId">expr</span><span class="Symbol">)</span>

<span class="Function">arraySubSuffix</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">arraySubSuffix</span> <span class="VarId">e</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">e</span> <span class="Keyword">of</span>
                     <span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="String">&quot;array&quot;</span> <span class="Symbol">-&gt;</span> <span class="VarId">fail</span> <span class="String">&quot;can't use array as \
                                                  \identifier name&quot;</span>
                     <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">FunCall</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span>
                                  <span class="Symbol">&lt;*&gt;</span> <span class="VarId">return</span> <span class="String">&quot;!arraysub&quot;</span>
                                  <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">((</span><span class="VarId">e</span><span class="Symbol">:)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">squares</span> <span class="Symbol">(</span><span class="VarId">commaSep1</span> <span class="VarId">expr</span><span class="Symbol">))</span>

<span class="Function">windowFnSuffix</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">windowFnSuffix</span> <span class="VarId">e</span> <span class="Symbol">=</span> <span class="ConId">WindowFn</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">return</span> <span class="VarId">e</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;over&quot;</span>
                        <span class="Symbol">*&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;(&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="VarId">partitionBy</span><span class="Symbol">))</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="VarId">orderBy1</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="ConId">Asc</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
                                            <span class="ConId">Asc</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;asc&quot;</span>
                                           <span class="Symbol">,</span><span class="ConId">Desc</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="String">&quot;desc&quot;</span><span class="Symbol">])</span>
                   <span class="Symbol">&lt;*&gt;</span> <span class="VarId">frm</span>
                   <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span>
  <span class="Keyword">where</span>
    <span class="VarId">orderBy1</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;order&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;by&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span>
    <span class="VarId">partitionBy</span> <span class="Symbol">=</span> <span class="VarId">keyword</span> <span class="String">&quot;partition&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;by&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">expr</span>
    <span class="VarId">frm</span> <span class="Symbol">=</span> <span class="VarId">option</span> <span class="ConId">FrameUnboundedPreceding</span> <span class="Symbol">$</span> <span class="VarId">choice</span>
                                         <span class="Symbol">$</span> <span class="VarId">map</span> <span class="Symbol">(\(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span> <span class="Symbol">&lt;$</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">ks</span> <span class="VarId">b</span><span class="Symbol">))</span> <span class="Symbol">[</span>
           <span class="Symbol">(</span><span class="ConId">FrameUnboundedPreceding</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="String">&quot;range&quot;</span><span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span><span class="Symbol">,</span><span class="String">&quot;preceding&quot;</span><span class="Symbol">])</span>
          <span class="Symbol">,(</span><span class="ConId">FrameUnboundedPreceding</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="String">&quot;range&quot;</span>
                                     <span class="Symbol">,</span><span class="String">&quot;between&quot;</span>
                                     <span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span>
                                     <span class="Symbol">,</span><span class="String">&quot;preceding&quot;</span>
                                     <span class="Symbol">,</span><span class="String">&quot;and&quot;</span>
                                     <span class="Symbol">,</span><span class="String">&quot;current&quot;</span>
                                     <span class="Symbol">,</span><span class="String">&quot;row&quot;</span><span class="Symbol">])</span>
          <span class="Symbol">,(</span><span class="ConId">FrameUnboundedFull</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="String">&quot;range&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;between&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;preceding&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;and&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;following&quot;</span><span class="Symbol">])</span>
          <span class="Symbol">,(</span><span class="ConId">FrameUnboundedFull</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="String">&quot;rows&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;between&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;preceding&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;and&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span>
                                <span class="Symbol">,</span><span class="String">&quot;following&quot;</span><span class="Symbol">])</span>
          <span class="Symbol">,(</span><span class="ConId">FrameRowsUnboundedPreceding</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="String">&quot;rows&quot;</span><span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span><span class="Symbol">,</span><span class="String">&quot;preceding&quot;</span><span class="Symbol">])</span>
          <span class="Symbol">,(</span><span class="ConId">FrameRowsUnboundedPreceding</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="String">&quot;rows&quot;</span>
                                         <span class="Symbol">,</span><span class="String">&quot;between&quot;</span>
                                         <span class="Symbol">,</span><span class="String">&quot;unbounded&quot;</span>
                                         <span class="Symbol">,</span><span class="String">&quot;preceding&quot;</span>
                                         <span class="Symbol">,</span><span class="String">&quot;and&quot;</span>
                                         <span class="Symbol">,</span><span class="String">&quot;current&quot;</span>
                                         <span class="Symbol">,</span><span class="String">&quot;row&quot;</span><span class="Symbol">])]</span>
    <span class="VarId">ks</span> <span class="Symbol">=</span> <span class="VarId">mapM</span> <span class="VarId">keyword</span>

<span class="Function">betweenSuffix</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">betweenSuffix</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
  <span class="VarId">keyword</span> <span class="String">&quot;between&quot;</span>
  <span class="VarId">b</span> <span class="Symbol">&lt;-</span> <span class="VarId">dodgyParseElement</span>
  <span class="VarId">keyword</span> <span class="String">&quot;and&quot;</span>
  <span class="VarId">c</span> <span class="Symbol">&lt;-</span> <span class="VarId">dodgyParseElement</span>
  <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">FunCall</span> <span class="VarId">p</span> <span class="String">&quot;!between&quot;</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">]</span>
             <span class="Comment">--can't use the full expression parser at this time</span>
             <span class="Comment">--because of a conflict between the operator 'and' and</span>
             <span class="Comment">--the 'and' part of a between</span>
  <span class="Keyword">where</span>
    <span class="VarId">dodgyParseElement</span> <span class="Symbol">=</span> <span class="VarId">factor</span></pre></div></div></div><p
	>From postgresql src/backend/parser/gram.y</p
	><pre
	><code
	  ><br
	     /> * We have two expression types: a_expr is the unrestricted kind, and
 * b_expr is a subset that must be used in some places to avoid shift/reduce
 * conflicts.  For example, we can't do BETWEEN as &quot;BETWEEN a_expr AND a_expr&quot;
 * because that use of AND conflicts with AND as a boolean operator.  So,
 * b_expr is used in BETWEEN and we remove boolean keywords from b_expr.
 *
 * Note that '(' a_expr ')' is a b_expr, so an unrestricted expression can
 * always be used by surrounding it with parens.
</code
	  ></pre
	><p
	>TODO: copy this approach here.</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">functionCallSuffix</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">functionCallSuffix</span> <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">fnName</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span> <span class="ConId">FunCall</span> <span class="VarId">p</span> <span class="VarId">fnName</span>
                <span class="Symbol">&lt;$&gt;</span> <span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">optional</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;all&quot;</span>
                                      <span class="Symbol">&lt;|&gt;</span> <span class="VarId">keyword</span> <span class="String">&quot;distinct&quot;</span><span class="Symbol">)</span>
                            <span class="Symbol">*&gt;</span> <span class="VarId">commaSep</span> <span class="VarId">expr</span><span class="Symbol">)</span>
<span class="Function">functionCallSuffix</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="VarId">fail</span> <span class="Symbol">$</span> <span class="String">&quot;cannot make functioncall from &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">s</span>

<span class="Function">castKeyword</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">castKeyword</span> <span class="Symbol">=</span> <span class="ConId">Cast</span>
              <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*</span> <span class="VarId">keyword</span> <span class="String">&quot;cast&quot;</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;(&quot;</span>
              <span class="Symbol">&lt;*&gt;</span> <span class="VarId">expr</span>
              <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">keyword</span> <span class="String">&quot;as&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">typeName</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span>

<span class="Function">castSuffix</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">castSuffix</span> <span class="VarId">ex</span> <span class="Symbol">=</span> <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span> <span class="ConId">Cast</span> <span class="VarId">p</span> <span class="VarId">ex</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;::&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">typeName</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">substring</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">substring</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
            <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
            <span class="VarId">keyword</span> <span class="String">&quot;substring&quot;</span>
            <span class="VarId">symbol</span> <span class="String">&quot;(&quot;</span>
            <span class="VarId">a</span> <span class="Symbol">&lt;-</span> <span class="VarId">expr</span>
            <span class="VarId">keyword</span> <span class="String">&quot;from&quot;</span>
            <span class="VarId">b</span> <span class="Symbol">&lt;-</span> <span class="VarId">expr</span>
            <span class="VarId">keyword</span> <span class="String">&quot;for&quot;</span>
            <span class="VarId">c</span> <span class="Symbol">&lt;-</span> <span class="VarId">expr</span>
            <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span>
            <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">FunCall</span> <span class="VarId">p</span> <span class="String">&quot;!substring&quot;</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">]</span>

<span class="Function">identifier</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">identifier</span> <span class="Symbol">=</span> <span class="ConId">Identifier</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">idString</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">splice</span><span class="Symbol">)</span>

<span class="Function">qualIdSuffix</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">qualIdSuffix</span> <span class="VarId">ex</span> <span class="Symbol">=</span> <span class="VarId">pos</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">\</span><span class="VarId">p</span> <span class="Symbol">-&gt;</span> <span class="ConId">QIdentifier</span> <span class="VarId">p</span> <span class="VarId">ex</span> <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;.&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">antiIdentifier</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">antiIdentifier</span> <span class="Symbol">=</span> <span class="ConId">Identifier</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">spliceD</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">antiIdentifier1</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">antiIdentifier1</span> <span class="Symbol">=</span> <span class="ConId">Identifier</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">ssplice</span>
                  <span class="Keyword">where</span>
                    <span class="VarId">ssplice</span> <span class="Symbol">=</span> <span class="Symbol">(\</span><span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;$i(&quot;</span> <span class="Symbol">++</span> <span class="VarId">s</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span>
                              <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;$i(&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span></pre></div></div></div><p
	>qualified names are parsed using &quot;.&quot; as an operator so they become FunCall nodes. But we don't want to parse any expression when we are expecting a qualified name only, so create a specialized parser just for that</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">qName</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">qName</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">i</span> <span class="Symbol">&lt;-</span> <span class="VarId">identifier</span>
  <span class="VarId">choice</span> <span class="Symbol">[</span><span class="Keyword">do</span>
           <span class="VarId">p</span> <span class="Symbol">&lt;-</span> <span class="VarId">pos</span>
           <span class="VarId">symbol</span> <span class="String">&quot;.&quot;</span>
           <span class="VarId">i1</span> <span class="Symbol">&lt;-</span> <span class="VarId">idString</span>
           <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">QIdentifier</span> <span class="VarId">p</span> <span class="VarId">i</span> <span class="VarId">i1</span> <span class="Comment">--FunCall p &quot;.&quot; [i,i1]</span>
         <span class="Symbol">,</span><span class="VarId">return</span> <span class="VarId">i</span><span class="Symbol">]</span></pre></div></div></div><hr
	 /></div
      ></div
    ><div id="utility-parsers"
    ><h1
      >Utility parsers</h1
      ><div id="tokeny-things"
      ><h2
	>tokeny things</h2
	><p
	>keyword has to not be immediately followed by letters or numbers (symbols and whitespace are ok) so we know that we aren't reading an identifier which happens to start with a complete keyword</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">keyword</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="Symbol">()</span>
<span class="Function">keyword</span> <span class="VarId">k</span> <span class="Symbol">=</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span>
                               <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                               <span class="ConId">IdStringTok</span> <span class="VarId">i</span> <span class="Symbol">|</span> <span class="VarId">lcase</span> <span class="VarId">k</span> <span class="Symbol">==</span> <span class="VarId">lcase</span> <span class="VarId">i</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="Symbol">()</span>
                               <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span>
                      <span class="Keyword">where</span>
                        <span class="VarId">lcase</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">toLower</span>

<span class="Function">idString</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">String</span>
<span class="Function">idString</span> <span class="Symbol">=</span>
    <span class="VarId">choice</span> <span class="Symbol">[(\</span><span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;$(&quot;</span> <span class="Symbol">++</span> <span class="VarId">l</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span>
            <span class="Symbol">&lt;$&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;$(&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span>
           <span class="Symbol">,</span><span class="VarId">ids</span>
           <span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">ids</span> <span class="Symbol">=</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span> <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                                     <span class="ConId">IdStringTok</span> <span class="String">&quot;not&quot;</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span>
                                     <span class="ConId">IdStringTok</span> <span class="VarId">i</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="VarId">i</span>
                                     <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span>

<span class="Function">spliceD</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">String</span>
<span class="Function">spliceD</span> <span class="Symbol">=</span> <span class="Symbol">(\</span><span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;$(&quot;</span> <span class="Symbol">++</span> <span class="VarId">x</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">splice</span>

<span class="Function">splice</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">String</span>
<span class="Function">splice</span> <span class="Symbol">=</span> <span class="VarId">symbol</span> <span class="String">&quot;$(&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span>

<span class="Function">symbol</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="Symbol">()</span>
<span class="Function">symbol</span> <span class="VarId">c</span> <span class="Symbol">=</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span> <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                                   <span class="ConId">SymbolTok</span> <span class="VarId">s</span> <span class="Symbol">|</span> <span class="VarId">c</span><span class="Symbol">==</span><span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="Symbol">()</span>
                                   <span class="VarId">_</span>           <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span>

<span class="Function">integer</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Integer</span>
<span class="Function">integer</span> <span class="Symbol">=</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span> <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                                    <span class="ConId">IntegerTok</span> <span class="VarId">n</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="VarId">n</span>
                                    <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span>

<span class="Function">liftPositionalArgTok</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Integer</span>
<span class="Function">liftPositionalArgTok</span> <span class="Symbol">=</span>
  <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span> <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                   <span class="ConId">PositionalArgTok</span> <span class="VarId">n</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="VarId">n</span>
                   <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">positionalArg</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">positionalArg</span> <span class="Symbol">=</span> <span class="ConId">PositionalArg</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">liftPositionalArgTok</span>

<span class="Function">antiScalarExpr</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">antiScalarExpr</span> <span class="Symbol">=</span> <span class="ConId">AntiScalarExpr</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">splice</span>

<span class="Function">placeholder</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">placeholder</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="ConId">Placeholder</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span><span class="Symbol">)</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;?&quot;</span>

<span class="Function">float</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Double</span>
<span class="Function">float</span> <span class="Symbol">=</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span> <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                                    <span class="ConId">FloatTok</span> <span class="VarId">n</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="VarId">n</span>
                                    <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span>

<span class="Function">liftStringTok</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">String</span>
<span class="Function">liftStringTok</span> <span class="Symbol">=</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span>
                  <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                           <span class="ConId">StringTok</span> <span class="VarId">_</span> <span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="VarId">s</span>
                           <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">stringLit</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">ScalarExpr</span>
<span class="Function">stringLit</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="ConId">StringLit</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">liftStringTok</span><span class="Symbol">)</span>
            <span class="Symbol">&lt;|&gt;</span>
            <span class="Symbol">(</span><span class="ConId">StringLit</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">pos</span> <span class="Symbol">&lt;*&gt;</span> <span class="VarId">ssplice</span><span class="Symbol">)</span>
             <span class="Keyword">where</span>
               <span class="VarId">ssplice</span> <span class="Symbol">=</span> <span class="Symbol">(\</span><span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;$s(&quot;</span> <span class="Symbol">++</span> <span class="VarId">s</span> <span class="Symbol">++</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span> <span class="Symbol">&lt;$&gt;</span>
                           <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;$s(&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span>

<span class="Function">stringN</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">String</span>
<span class="Function">stringN</span> <span class="Symbol">=</span> <span class="VarId">mytoken</span> <span class="Symbol">(\</span><span class="VarId">tok</span> <span class="Symbol">-&gt;</span>
                  <span class="Keyword">case</span> <span class="VarId">tok</span> <span class="Keyword">of</span>
                           <span class="ConId">StringTok</span> <span class="VarId">_</span> <span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="ConId">Just</span> <span class="VarId">s</span>
                           <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="ConId">Nothing</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">extrStr</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">extrStr</span> <span class="Symbol">(</span><span class="ConId">StringLit</span> <span class="VarId">_</span> <span class="VarId">s</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">s</span>
<span class="Function">extrStr</span> <span class="VarId">x</span> <span class="Symbol">=</span>
  <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;internal error: extrStr not supported for this type &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span></pre></div></div></div><p
	>== combinatory things</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">parens</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
       <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
<span class="Function">parens</span> <span class="Symbol">=</span> <span class="VarId">between</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;(&quot;</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;)&quot;</span><span class="Symbol">)</span>

<span class="Function">squares</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
       <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
<span class="Function">squares</span> <span class="Symbol">=</span> <span class="VarId">between</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;[&quot;</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;]&quot;</span><span class="Symbol">)</span>

<span class="Function">tryOptionMaybe</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Stream</span> <span class="VarId">s</span> <span class="VarId">m</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=&gt;</span>
             <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="Symbol">(</span><span class="ConId">Maybe</span> <span class="VarId">a</span><span class="Symbol">)</span>
<span class="Function">tryOptionMaybe</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">try</span> <span class="Symbol">(</span><span class="VarId">optionMaybe</span> <span class="VarId">p</span><span class="Symbol">)</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">return</span> <span class="ConId">Nothing</span>

<span class="Function">commaSep2</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
          <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">]</span>
<span class="Function">commaSep2</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">sepBy2</span> <span class="VarId">p</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;,&quot;</span><span class="Symbol">)</span>

<span class="Function">sepBy2</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Stream</span> <span class="VarId">s</span> <span class="VarId">m</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=&gt;</span>
          <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">b</span> <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">]</span>
<span class="Function">sepBy2</span> <span class="VarId">p</span> <span class="VarId">sep</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">p</span> <span class="Symbol">&lt;*</span> <span class="VarId">sep</span><span class="Symbol">)</span> <span class="Symbol">&lt;:&gt;</span> <span class="VarId">sepBy1</span> <span class="VarId">p</span> <span class="VarId">sep</span>

<span class="Function">commaSep</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
         <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">]</span>
<span class="Function">commaSep</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">sepBy</span> <span class="VarId">p</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;,&quot;</span><span class="Symbol">)</span>

<span class="Function">commaSep1</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
          <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">]</span>
<span class="Function">commaSep1</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="VarId">sepBy1</span> <span class="VarId">p</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;,&quot;</span><span class="Symbol">)</span></pre></div></div></div><p
	>pass a list of pairs of strings and values try each pair k,v in turn, if keyword k matches then return v doesn't really add a lot of value</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">matchAKeyword</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="VarId">a</span><span class="Symbol">)]</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
<span class="Function">matchAKeyword</span> <span class="Symbol">[]</span> <span class="Symbol">=</span> <span class="VarId">fail</span> <span class="String">&quot;no matches&quot;</span>
<span class="Function">matchAKeyword</span> <span class="Symbol">((</span><span class="VarId">k</span><span class="Symbol">,</span><span class="VarId">v</span><span class="Symbol">):</span><span class="VarId">kvs</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">v</span> <span class="Symbol">&lt;$</span> <span class="VarId">keyword</span> <span class="VarId">k</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">matchAKeyword</span> <span class="VarId">kvs</span></pre></div></div></div><p
	>parseOptionalSuffix</p
	><p
	>parse the start of something -&gt; parseResultA, then parse an optional suffix -&gt; parseResultB if this second parser succeeds, return fn2 parseResultA parseResultB else return fn1 parseResultA</p
	><p
	>e.g. parsing an identifier in a select list can be fieldName or fieldName as alias so we can pass * IdentifierCtor * identifier (returns aval) * AliasedIdentifierCtor * () - looks like a place holder, probably a crap idea * parser for (as b) (returns bval) as the args, which I like to ident like: parseOptionalSuffix IdentifierCtor identifierParser AliasedIdentifierCtor () asAliasParser and we get either * IdentifierCtor identifierValue or * AliasedIdentifierCtor identifierValue aliasValue as the result depending on whether the asAliasParser succeeds or not.</p
	><p
	>probably this concept already exists under a better name in parsing theory</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">optionalSuffix</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Stream</span> <span class="VarId">s</span> <span class="VarId">m</span> <span class="VarId">t2</span><span class="Symbol">)</span> <span class="Symbol">=&gt;</span>
                  <span class="Symbol">(</span><span class="VarId">t1</span> <span class="Symbol">-&gt;</span> <span class="VarId">b</span><span class="Symbol">)</span>
               <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">t1</span>
               <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="VarId">t1</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="VarId">b</span><span class="Symbol">)</span>
               <span class="Symbol">-&gt;</span> <span class="Symbol">()</span>
               <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">a</span>
               <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">b</span>
<span class="Function">optionalSuffix</span> <span class="VarId">c1</span> <span class="VarId">p1</span> <span class="VarId">c2</span> <span class="VarId">_</span> <span class="VarId">p2</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">p1</span>
  <span class="VarId">option</span> <span class="Symbol">(</span><span class="VarId">c1</span> <span class="VarId">x</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">c2</span> <span class="VarId">x</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">try</span> <span class="VarId">p2</span><span class="Symbol">)</span></pre></div></div></div><p
	>threadOptionalSuffix</p
	><p
	>parse the start of something -&gt; parseResultA, then parse an optional suffix, passing parseResultA to this parser -&gt; parseResultB return parseResultB is it succeeds, else return parseResultA</p
	><p
	>sort of like a suffix operator parser where the suffixisable part is parsed, then if the suffix is there it wraps the suffixisable part in an enclosing tree node.</p
	><p
	>parser1 -&gt; tree1 (parser2 tree1) -&gt; maybe tree2 tree2 isnothing ? tree1 : tree2</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">threadOptionalSuffix</span> <span class="Symbol">::</span> <span class="ConId">ParsecT</span> <span class="Symbol">[</span><span class="VarId">tok</span><span class="Symbol">]</span> <span class="VarId">st</span> <span class="ConId">Identity</span> <span class="VarId">a</span>
                     <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="ConId">GenParser</span> <span class="VarId">tok</span> <span class="VarId">st</span> <span class="VarId">a</span><span class="Symbol">)</span>
                     <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="Symbol">[</span><span class="VarId">tok</span><span class="Symbol">]</span> <span class="VarId">st</span> <span class="ConId">Identity</span> <span class="VarId">a</span>
<span class="Function">threadOptionalSuffix</span> <span class="VarId">p1</span> <span class="VarId">p2</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">p1</span>
  <span class="VarId">option</span> <span class="VarId">x</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="VarId">p2</span> <span class="VarId">x</span><span class="Symbol">)</span></pre></div></div></div><p
	>I'm pretty sure this is some standard monad operation but I don't know what. It's a bit like the maybe monad but when you get nothing it returns the previous result instead of nothing - if you take the parsing specific stuff out you get:</p
	><p
	>p1 :: (Monad m) =&gt; m b -&gt; (b -&gt; m (Maybe b)) -&gt; m b p1 = do x &lt;- p1 y &lt;- p2 x case y of Nothing -&gt; return x Just z -&gt; return z =====</p
	><p
	>like thread optional suffix, but we pass a list of suffixes in, not much of a shorthand</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">threadOptionalSuffixes</span> <span class="Symbol">::</span> <span class="ConId">ParsecT</span> <span class="Symbol">[</span><span class="VarId">tok</span><span class="Symbol">]</span> <span class="VarId">st</span> <span class="ConId">Identity</span> <span class="VarId">a</span>
                       <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="ConId">GenParser</span> <span class="VarId">tok</span> <span class="VarId">st</span> <span class="VarId">a</span><span class="Symbol">]</span>
                       <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="Symbol">[</span><span class="VarId">tok</span><span class="Symbol">]</span> <span class="VarId">st</span> <span class="ConId">Identity</span> <span class="VarId">a</span>
<span class="Function">threadOptionalSuffixes</span> <span class="VarId">p1</span> <span class="VarId">p2s</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">p1</span>
  <span class="VarId">option</span> <span class="VarId">x</span> <span class="Symbol">(</span><span class="VarId">try</span> <span class="Symbol">$</span> <span class="VarId">choice</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(\</span><span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="VarId">l</span> <span class="VarId">x</span><span class="Symbol">)</span> <span class="VarId">p2s</span><span class="Symbol">))</span></pre></div></div></div><p
	>couldn't work how to to perms so just did this hack instead e.g. a1,a2,b1,b2,a2,b3,b4 parses to ([a1,a2,a3],[b1,b2,b3,b4])</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">multiPerm</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Stream</span> <span class="VarId">s</span> <span class="VarId">m</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=&gt;</span>
               <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">a1</span>
            <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">a</span>
            <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="VarId">sep</span>
            <span class="Symbol">-&gt;</span> <span class="ConId">ParsecT</span> <span class="VarId">s</span> <span class="VarId">u</span> <span class="VarId">m</span> <span class="Symbol">([</span><span class="VarId">a1</span><span class="Symbol">],</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">])</span>

<span class="Function">multiPerm</span> <span class="VarId">p1</span> <span class="VarId">p2</span> <span class="VarId">sep</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="Symbol">(</span><span class="VarId">r1</span><span class="Symbol">,</span> <span class="VarId">r2</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">unzip</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">sepBy1</span> <span class="VarId">parseAorB</span> <span class="VarId">sep</span>
  <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">catMaybes</span> <span class="VarId">r1</span><span class="Symbol">,</span> <span class="VarId">catMaybes</span> <span class="VarId">r2</span><span class="Symbol">)</span>
  <span class="Keyword">where</span>
    <span class="VarId">parseAorB</span> <span class="Symbol">=</span> <span class="VarId">choice</span> <span class="Symbol">[</span>
                  <span class="Symbol">(\</span><span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="ConId">Just</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="ConId">Nothing</span><span class="Symbol">))</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">p1</span>
                 <span class="Symbol">,(\</span><span class="VarId">y</span> <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="ConId">Nothing</span><span class="Symbol">,</span> <span class="ConId">Just</span> <span class="VarId">y</span><span class="Symbol">))</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">p2</span><span class="Symbol">]</span></pre></div></div></div><p
	>== position stuff</p
	><p
	>simple wrapper for parsec source positions, probably not really useful</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">type</span> <span class="ConId">MySourcePos</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Int</span><span class="Symbol">,</span><span class="ConId">Int</span><span class="Symbol">)</span>

<span class="Function">toMySp</span> <span class="Symbol">::</span> <span class="ConId">SourcePos</span> <span class="Symbol">-&gt;</span> <span class="ConId">MySourcePos</span>
<span class="Function">toMySp</span> <span class="VarId">sp</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">sourceName</span> <span class="VarId">sp</span><span class="Symbol">,</span><span class="VarId">sourceLine</span> <span class="VarId">sp</span><span class="Symbol">,</span><span class="VarId">sourceColumn</span> <span class="VarId">sp</span><span class="Symbol">)</span></pre></div></div></div><p
	>parser combinator to return the current position as an ast annotation</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">pos</span> <span class="Symbol">::</span> <span class="ConId">SParser</span> <span class="ConId">Annotation</span>
<span class="Function">pos</span> <span class="Symbol">=</span>
  <span class="Symbol">(\</span><span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="VarId">emptyAnnotation</span> <span class="Symbol">{</span><span class="VarId">asrc</span><span class="Symbol">=</span><span class="ConId">Just</span> <span class="VarId">a</span><span class="Symbol">})</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">toMySp</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">getPosition</span></pre></div></div></div><p
	>== lexer stuff</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">mytoken</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Tok</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">SParser</span> <span class="VarId">a</span>
<span class="Function">mytoken</span> <span class="VarId">test</span>
  <span class="Symbol">=</span> <span class="VarId">token</span> <span class="VarId">showToken</span> <span class="VarId">posToken</span> <span class="VarId">testToken</span>
  <span class="Keyword">where</span>
  <span class="VarId">showToken</span> <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">tok</span><span class="Symbol">)</span>   <span class="Symbol">=</span> <span class="VarId">show</span> <span class="VarId">tok</span>
  <span class="VarId">posToken</span>  <span class="Symbol">(</span><span class="VarId">posi</span><span class="Symbol">,</span><span class="VarId">_</span><span class="Symbol">)</span>  <span class="Symbol">=</span> <span class="VarId">posi</span>
  <span class="VarId">testToken</span> <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">tok</span><span class="Symbol">)</span>   <span class="Symbol">=</span> <span class="VarId">test</span> <span class="VarId">tok</span></pre></div></div></div><hr
	 /><p
	>= fixup tree</p
	><p
	>this is where some generics code is used to transform the parse trees to alter the nodes used where it's too difficult to do whilst parsing. The only item at the moment that needs this treatment is the any/some/all construct which looks like this: expr operator [any|some|all] (expr)</p
	><p
	>This gets parsed as funcall operator [expr1,funcall [any|some|all] [expr2,...]] and we want to transform it to liftoperator operator any|some|all [expr1, expr2,...] not doing anything if the funcall name isn't any,some,all any other checks are left to the type checking stage (e.g. there can only be one expression in the expr2 part, and it must be an array or subselect, etc)</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">fixupTree</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span>
<span class="Function">fixupTree</span> <span class="Symbol">=</span>
    <span class="VarId">transformBi</span> <span class="Symbol">$</span> <span class="Symbol">\</span><span class="VarId">x</span> <span class="Symbol">-&gt;</span>
      <span class="Keyword">case</span> <span class="VarId">x</span> <span class="Keyword">of</span>
             <span class="ConId">FunCall</span> <span class="VarId">an</span> <span class="VarId">op</span> <span class="Symbol">(</span><span class="VarId">expr1</span><span class="Symbol">:</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="VarId">nm</span> <span class="VarId">expr2s</span><span class="Symbol">:</span><span class="VarId">expr3s</span><span class="Symbol">)</span>
               <span class="Symbol">|</span> <span class="VarId">isOperatorName</span> <span class="VarId">op</span>
                 <span class="Symbol">&amp;&amp;</span> <span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="Symbol">[</span><span class="String">&quot;any&quot;</span><span class="Symbol">,</span> <span class="String">&quot;some&quot;</span><span class="Symbol">,</span> <span class="String">&quot;all&quot;</span><span class="Symbol">]</span>
               <span class="Symbol">-&gt;</span> <span class="ConId">LiftOperator</span> <span class="VarId">an</span> <span class="VarId">op</span> <span class="VarId">flav</span> <span class="Symbol">(</span><span class="VarId">expr1</span><span class="Symbol">:</span><span class="VarId">expr2s</span> <span class="Symbol">++</span> <span class="VarId">expr3s</span><span class="Symbol">)</span>
                  <span class="Keyword">where</span> <span class="VarId">flav</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">toLower</span> <span class="VarId">nm</span><span class="Symbol">)</span> <span class="Keyword">of</span>
                                 <span class="String">&quot;any&quot;</span> <span class="Symbol">-&gt;</span> <span class="ConId">LiftAny</span>
                                 <span class="String">&quot;some&quot;</span> <span class="Symbol">-&gt;</span> <span class="ConId">LiftAny</span>
                                 <span class="String">&quot;all&quot;</span> <span class="Symbol">-&gt;</span> <span class="ConId">LiftAll</span>
                                 <span class="VarId">z</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;internal error in parsing \
                                              \lift transform: &quot;</span> <span class="Symbol">++</span> <span class="VarId">z</span>
             <span class="VarId">x1</span> <span class="Symbol">-&gt;</span> <span class="VarId">x1</span></pre></div></div></div><hr
	 /><p
	>Parse state not currently used. Use these placeholders to add some.</p
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">type</span> <span class="ConId">ParseState</span> <span class="Symbol">=</span> <span class="Symbol">()</span>

<span class="Function">startState</span> <span class="Symbol">::</span> <span class="Symbol">()</span>
<span class="Function">startState</span> <span class="Symbol">=</span> <span class="Symbol">()</span></pre></div></div></div></div
      ></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
