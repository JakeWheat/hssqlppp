<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Chaos2010</title
    ><link href="../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >Small hack transform and load the chaos sql into the database.</p
    ><p
    >ghc --make -threaded -XScopedTypeVariables -XDeriveDataTypeable -DPOSTGRES -cpp -pgmPcpphs -optP--cpp -idevel:src/lib:src/qq:src/postgresql:examples/chaos:examples/extensions/:examples/util/:tests/ --make examples/chaos/Chaos2010.lhs</p
    ><p
    >time examples/chaos/Chaos2010 sql &gt; chaos1.sql &amp;&amp; time examples/chaos/Chaos2010 clear &amp;&amp; time psql chaos -q --set ON_ERROR_STOP=on --file=chaos1.sql</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">import</span> <span class="ConId">System.Environment</span>
<span class="Keyword">import</span> <span class="ConId">System.Console.CmdArgs</span>
<span class="Keyword">import</span> <span class="ConId">System.IO</span>
<span class="Keyword">import</span> <span class="ConId">Control.Monad.Error</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">import</span> <span class="ConId">Data.Maybe</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics.Uniplate.Data</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Utils</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Catalog</span>
<span class="Keyword">import</span> <span class="Keyword">qualified</span> <span class="ConId">Database.HsSqlPpp.TypeChecker</span> <span class="Keyword">as</span> <span class="ConId">A</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.SqlTypes</span>

<span class="Keyword">import</span> <span class="Keyword">qualified</span> <span class="ConId">Database.HsSqlPpp.Parser</span> <span class="Keyword">as</span> <span class="ConId">P</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.PrettyPrinter</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.DatabaseLoader</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.DBUtils</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.DbmsCommon</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Chaos.ChaosExtensions</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Chaos.ChaosFiles</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.RoundTripTester</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">databaseName</span> <span class="Symbol">::</span> <span class="ConId">String</span>
<span class="Function">databaseName</span> <span class="Symbol">=</span> <span class="String">&quot;chaos&quot;</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">main</span> <span class="Symbol">::</span> <span class="ConId">IO</span><span class="Symbol">()</span>
<span class="Function">main</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">argv</span> <span class="Symbol">&lt;-</span> <span class="VarId">getArgs</span>
  <span class="Keyword">case</span> <span class="VarId">argv</span> <span class="Keyword">of</span>
    <span class="Symbol">[</span><span class="String">&quot;reset&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="VarId">reset</span>
    <span class="Symbol">[</span><span class="String">&quot;sql&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="VarId">sql</span>
    <span class="Symbol">[</span><span class="String">&quot;check&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="VarId">check</span>
    <span class="Symbol">[</span><span class="String">&quot;clear&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="VarId">withConn</span> <span class="Symbol">(</span><span class="String">&quot;dbname=&quot;</span> <span class="Symbol">++</span> <span class="VarId">databaseName</span><span class="Symbol">)</span> <span class="VarId">clearDB</span>
    <span class="Symbol">[</span><span class="String">&quot;test&quot;</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="VarId">rtt</span>
    <span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">putStrLn</span> <span class="Symbol">$</span> <span class="String">&quot;don't understand &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span></pre></div></div></div><hr
     /><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">reset</span> <span class="Symbol">::</span> <span class="ConId">IO</span> <span class="Symbol">()</span>
<span class="Function">reset</span> <span class="Symbol">=</span>
  <span class="VarId">withConn</span> <span class="Symbol">(</span><span class="String">&quot;dbname=&quot;</span> <span class="Symbol">++</span> <span class="VarId">databaseName</span><span class="Symbol">)</span> <span class="Symbol">$</span>
  <span class="VarId">flip</span> <span class="VarId">withTransaction</span> <span class="Symbol">$</span> <span class="Symbol">\</span><span class="VarId">conn</span> <span class="Symbol">-&gt;</span> <span class="VarId">wrapETs</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
  <span class="Comment">--clear the db and get the transformed ast</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">  <span class="VarId">liftIO</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
    <span class="VarId">hSetBuffering</span> <span class="VarId">stdout</span> <span class="ConId">NoBuffering</span>
    <span class="VarId">clearDB</span> <span class="VarId">conn</span>
  <span class="VarId">ast</span> <span class="Symbol">&lt;-</span> <span class="VarId">fmap</span> <span class="Symbol">(</span><span class="VarId">concat</span> <span class="Symbol">|&gt;</span> <span class="VarId">chaosExtensions</span><span class="Symbol">)</span>
           <span class="Symbol">$</span> <span class="VarId">mapM</span> <span class="Symbol">(\</span> <span class="VarId">f</span> <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="VarId">liftIO</span> <span class="Symbol">.</span> <span class="VarId">readInput</span><span class="Symbol">)</span> <span class="VarId">f</span>
                          <span class="Symbol">&gt;&gt;=</span> <span class="VarId">tsl</span> <span class="Symbol">.</span> <span class="ConId">P.</span><span class="VarId">parseSql</span> <span class="VarId">f</span><span class="Symbol">)</span>
                  <span class="VarId">chaosFiles</span>
  <span class="VarId">liftIO</span> <span class="Symbol">$</span> <span class="VarId">loadAst</span> <span class="VarId">conn</span> <span class="VarId">ast</span>
  <span class="VarId">return</span> <span class="Symbol">()</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">sql</span> <span class="Symbol">::</span> <span class="ConId">IO</span> <span class="Symbol">()</span>
<span class="Function">sql</span> <span class="Symbol">=</span> <span class="VarId">wrapETs</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
  <span class="VarId">ast</span> <span class="Symbol">&lt;-</span> <span class="VarId">fmap</span> <span class="Symbol">(</span><span class="VarId">concat</span> <span class="Symbol">|&gt;</span> <span class="VarId">chaosExtensions</span><span class="Symbol">)</span>
           <span class="Symbol">$</span> <span class="VarId">mapM</span> <span class="Symbol">(\</span> <span class="VarId">f</span> <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="VarId">liftIO</span> <span class="Symbol">.</span> <span class="VarId">readInput</span><span class="Symbol">)</span> <span class="VarId">f</span>
                          <span class="Symbol">&gt;&gt;=</span> <span class="VarId">tsl</span> <span class="Symbol">.</span> <span class="ConId">P.</span><span class="VarId">parseSql</span> <span class="VarId">f</span><span class="Symbol">)</span>
                  <span class="VarId">chaosFiles</span>
  <span class="VarId">liftIO</span> <span class="Symbol">$</span> <span class="VarId">putStrLn</span> <span class="Symbol">$</span> <span class="VarId">printSql</span> <span class="VarId">ast</span>
  <span class="VarId">return</span> <span class="Symbol">()</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">check</span> <span class="Symbol">::</span> <span class="ConId">IO</span> <span class="Symbol">()</span>
<span class="Function">check</span> <span class="Symbol">=</span> <span class="VarId">wrapETs</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
  <span class="Comment">--clear the db and get the transformed ast</span>
  <span class="VarId">ast</span> <span class="Symbol">&lt;-</span> <span class="VarId">fmap</span> <span class="Symbol">(</span><span class="VarId">concat</span> <span class="Symbol">|&gt;</span> <span class="VarId">chaosExtensions</span><span class="Symbol">)</span>
           <span class="Symbol">$</span> <span class="VarId">mapM</span> <span class="Symbol">(\</span> <span class="VarId">f</span> <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="VarId">liftIO</span> <span class="Symbol">.</span> <span class="VarId">readInput</span><span class="Symbol">)</span> <span class="VarId">f</span>
                          <span class="Symbol">&gt;&gt;=</span> <span class="VarId">tsl</span> <span class="Symbol">.</span> <span class="ConId">P.</span><span class="VarId">parseSql</span> <span class="VarId">f</span><span class="Symbol">)</span>
                  <span class="VarId">chaosFiles</span>
  <span class="VarId">mapM_</span> <span class="Symbol">(</span><span class="VarId">liftIO</span> <span class="Symbol">.</span> <span class="VarId">putStrLn</span><span class="Symbol">)</span> <span class="Symbol">$</span>
            <span class="Symbol">(</span><span class="ConId">A.</span><span class="VarId">typeCheck</span> <span class="VarId">defaultTemplate1Catalog</span> <span class="Symbol">|&gt;</span>
             <span class="VarId">snd</span> <span class="Symbol">|&gt;</span>
             <span class="VarId">getTypeErrors</span> <span class="Symbol">|&gt;</span>
             <span class="VarId">ppTypeErrors</span><span class="Symbol">)</span> <span class="VarId">ast</span>
  <span class="VarId">return</span> <span class="Symbol">()</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">-- | read a file as text, will read from stdin if filename is '-'.</span>
<span class="Function">readInput</span> <span class="Symbol">::</span> <span class="ConId">FilePath</span> <span class="Symbol">-&gt;</span> <span class="ConId">IO</span> <span class="ConId">String</span>
<span class="Function">readInput</span> <span class="VarId">f</span> <span class="Symbol">=</span>
  <span class="Keyword">case</span> <span class="VarId">f</span> <span class="Keyword">of</span>
             <span class="String">&quot;-&quot;</span> <span class="Symbol">-&gt;</span> <span class="VarId">getContents</span>
             <span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">length</span> <span class="VarId">f</span> <span class="Symbol">&gt;=</span> <span class="Number">2</span> <span class="Symbol">&amp;&amp;</span>
                 <span class="VarId">head</span> <span class="VarId">f</span> <span class="Symbol">==</span> <span class="Char">'&quot;'</span> <span class="Symbol">&amp;&amp;</span> <span class="VarId">last</span> <span class="VarId">f</span> <span class="Symbol">==</span> <span class="Char">'&quot;'</span>
                   <span class="Symbol">-&gt;</span> <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">drop</span> <span class="Number">1</span> <span class="Symbol">$</span> <span class="VarId">take</span> <span class="Symbol">(</span><span class="VarId">length</span> <span class="VarId">f</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">)</span> <span class="VarId">f</span>
               <span class="Symbol">|</span> <span class="VarId">otherwise</span> <span class="Symbol">-&gt;</span> <span class="VarId">readFile</span> <span class="VarId">f</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">-- | Pretty print list of type errors with optional source position</span>
<span class="Comment">--   in emacs readable format.</span>
<span class="Function">ppTypeErrors</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">Maybe</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Int</span><span class="Symbol">,</span><span class="ConId">Int</span><span class="Symbol">),</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">])]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">ppTypeErrors</span> <span class="VarId">tes</span> <span class="Symbol">=</span>
  <span class="VarId">map</span> <span class="VarId">showSpTe</span> <span class="VarId">tes</span>
  <span class="Keyword">where</span>
    <span class="VarId">showSpTe</span> <span class="Symbol">(</span><span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">fn</span><span class="Symbol">,</span><span class="VarId">l</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">),</span> <span class="VarId">e</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="VarId">fn</span> <span class="Symbol">++</span> <span class="String">&quot;:&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">l</span> <span class="Symbol">++</span> <span class="String">&quot;:&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">c</span> <span class="Symbol">++</span> <span class="String">&quot;:\n&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">e</span>
    <span class="VarId">showSpTe</span> <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">e</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="String">&quot;unknown:0:0:\n&quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">e</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">getTypeErrors</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[(</span><span class="ConId">Maybe</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Int</span><span class="Symbol">,</span><span class="ConId">Int</span><span class="Symbol">),</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">])]</span>
<span class="Function">getTypeErrors</span> <span class="VarId">es</span> <span class="Symbol">=</span>
  <span class="Keyword">let</span> <span class="Keyword">as</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="VarId">a</span><span class="Symbol">::</span><span class="ConId">Annotation</span> <span class="Symbol">|</span> <span class="VarId">a</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">es</span><span class="Symbol">]</span>
  <span class="Keyword">in</span> <span class="VarId">mapMaybe</span> <span class="VarId">getTes</span> <span class="Keyword">as</span>
  <span class="Keyword">where</span>
    <span class="VarId">getTes</span> <span class="Keyword">as</span> <span class="Symbol">=</span> <span class="Keyword">let</span> <span class="VarId">tes</span> <span class="Symbol">=</span> <span class="VarId">errs</span> <span class="Keyword">as</span>
                <span class="Keyword">in</span> <span class="Keyword">if</span> <span class="VarId">null</span> <span class="VarId">tes</span>
                   <span class="Keyword">then</span> <span class="ConId">Nothing</span>
                   <span class="Keyword">else</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="VarId">asrc</span> <span class="Keyword">as</span><span class="Symbol">,</span> <span class="VarId">tes</span><span class="Symbol">)</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">rtt</span> <span class="Symbol">::</span> <span class="ConId">IO</span><span class="Symbol">()</span>
<span class="Function">rtt</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">rt</span> <span class="Symbol">&lt;-</span> <span class="VarId">roundTripTest</span> <span class="VarId">chaosExtensions</span> <span class="VarId">databaseName</span> <span class="VarId">chaosFiles</span>
  <span class="VarId">putStrLn</span> <span class="Symbol">$</span> <span class="VarId">rtShowBrief</span> <span class="VarId">rt</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
