<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Wizards.sql transformed</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Comment">/*</span>
<span class="Comment">wizards</span>
<span class="Comment">=======</span>

<span class="Comment">the wizards have a bunch of possible upgrades from spells, and each</span>
<span class="Comment">has a spell book. In a way, they also form part of a larger entity -</span>
<span class="Comment">the army, which is the wizard and all his pieces, there is a strictly</span>
<span class="Comment">1-1 relationship between the wizards and the armies.</span>

<span class="Comment">*/</span>
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">wizards</span> <span class="Symbol">(</span>
  <span class="VarId">wizard_name</span> <span class="Type">text</span> <span class="Keyword">primary</span> <span class="Keyword">key</span><span class="Symbol">,</span>
  <span class="VarId">shadow_form</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span><span class="Symbol">,</span>
  <span class="VarId">magic_sword</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span><span class="Symbol">,</span>
  <span class="VarId">magic_knife</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span><span class="Symbol">,</span>
  <span class="VarId">magic_shield</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span><span class="Symbol">,</span>
  <span class="VarId">magic_wings</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span><span class="Symbol">,</span>
  <span class="VarId">magic_armour</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span><span class="Symbol">,</span>
  <span class="VarId">magic_bow</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span><span class="Symbol">,</span>
  <span class="VarId">computer_controlled</span> <span class="VarId">boolean</span><span class="Symbol">,</span>
  <span class="VarId">original_place</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="Comment">-- 0 &lt;= n &lt; num wizards</span>
  <span class="VarId">expired</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span>
<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;wizards&quot; [(&quot;wizard_name&quot;,ScalarType &quot;text&quot;),(&quot;shadow_form&quot;,ScalarType &quot;bool&quot;),(&quot;magic_sword&quot;,ScalarType &quot;bool&quot;),(&quot;magic_knife&quot;,ScalarType &quot;bool&quot;),(&quot;magic_shield&quot;,ScalarType &quot;bool&quot;),(&quot;magic_wings&quot;,ScalarType &quot;bool&quot;),(&quot;magic_armour&quot;,ScalarType &quot;bool&quot;),(&quot;magic_bow&quot;,ScalarType &quot;bool&quot;),(&quot;computer_controlled&quot;,ScalarType &quot;bool&quot;),(&quot;original_place&quot;,ScalarType &quot;int4&quot;),(&quot;expired&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">wizards</span> <span class="Symbol">(</span>
  <span class="VarId">wizard_name</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">primary</span> <span class="Keyword">key</span><span class="Symbol">,</span>
  <span class="VarId">shadow_form</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">magic_sword</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">magic_knife</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">magic_shield</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">magic_wings</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">magic_armour</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">magic_bow</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">computer_controlled</span> <span class="VarId">boolean</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">original_place</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">expired</span> <span class="VarId">boolean</span> <span class="Keyword">default</span> <span class="VarId">false</span> <span class="Keyword">not</span> <span class="VarId">null</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizards'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'wizards'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Comment">/*</span>

<span class="Comment">not sure this is the best way to implement wizards dying, rather than</span>
<span class="Comment">deleting their entries. wouldn't need to make a decision like this</span>
<span class="Comment">with temporal database support.</span>

<span class="Comment">*/</span>

<span class="Comment">/*create view live_wizards as</span>
<span class="Comment">  select *,</span>
<span class="Comment">         row_number() over(order by original_place) - 1 as place</span>
<span class="Comment">  from wizards where not expired;</span>
<span class="Comment">*/</span>

<span class="Comment">/*</span>
<span class="Comment">== spell books</span>
<span class="Comment">Wizard 'wizard_name' is able to cast spell 'spell_name'.</span>
<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">spell_books</span> <span class="Symbol">(</span>
  <span class="VarId">id</span> <span class="Type">serial</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
  <span class="VarId">wizard_name</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">wizards</span><span class="Symbol">,</span>
  <span class="VarId">spell_name</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">spells_mr</span>
<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;spell_books&quot; [(&quot;id&quot;,ScalarType &quot;int4&quot;),(&quot;wizard_name&quot;,ScalarType &quot;text&quot;),(&quot;spell_name&quot;,ScalarType &quot;text&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">spell_books</span> <span class="Symbol">(</span>
  <span class="VarId">id</span> <span class="Type">serial</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
  <span class="VarId">wizard_name</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">references</span> <span class="VarId">wizards</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span><span class="Symbol">,</span>
  <span class="VarId">spell_name</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">references</span> <span class="VarId">spells_mr</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="VarId">cascade</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_books'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'spell_books'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'no_spells_for_stiffs'</span><span class="Symbol">,</span>
  $$ <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">spell_books</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_no_spells_for_stiffs&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_no_spells_for_stiffs</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                         <span class="Keyword">from</span> <span class="Symbol">(</span><span class="VarId">spell_books</span>
                               <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span><span class="Symbol">)</span>
                         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_no_spells_for_stiffs'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;spell_books_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">spell_books_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_no_spells_for_stiffs</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint no_spells_for_stiffs'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_books_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">spell_books_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">spell_books</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">spell_books_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_books_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;wizards_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">wizards_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_no_spells_for_stiffs</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint no_spells_for_stiffs'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizards_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">wizards_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">wizards</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">wizards_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizards_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Wizards'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
