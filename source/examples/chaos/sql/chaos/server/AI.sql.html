<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >AI</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >/*</p
    ><p
    >================================================================================</p
    ><p
    >= ai</p
    ><p
    >For each stage we compile a list of possible actions using the valid_action views. These are then filtered to remove actions we don't want to run. At some places, the possible action list is reduced by keeping only the actions which are deemed vital (e.g. the wizard needs to run away, or a monster has a chance to attact a wizard). The remaining actions are possibly weighted and one is chosen at random.</p
    ><p
    >Choose spells by weighting them according to casting chance, some spells are never cast, and some will be further weighted by the board layout.</p
    ><p
    >When moving army, the general plan is to move the monsters closest to an enemy first.</p
    ><p
    >choose spell cast spell move pieces</p
    ><p
    >option 1: upgrade weight by probability don't cast one already have or a weaker one in same category armour - shield knife - sword shadow - wings</p
    ><p
    >decree et al: use: wizard with lots of bad guys, being threatened magic wood: if range of spells is a bit shit castle, wall, blob, fire, shadowwood - random disbelieve: cast when threatened by a hard creature, small chance otherwise subversion - hard creature nearby, when threatened raise dead - when can monsters: weight by chances, decide on imag weighted by chances</p
    ><p
    >assess: defensive: wizard under threat aggressive: choose a target to send everyone against</p
    ><p
    >casting: raise: hardest corpse in range decree: if threatened target monster or wizard, else target hardest wizard/monster on screen castle -next to, away from danger disbelieve - closest monster subvert - closest monster (or if tougher one next to closest monster?) monster - toward nearest threat wall - just randomly put about blob - want to grow safely, unless under threat then use aggresively fire - use aggressively shadow wood: use magic wood layout, bias in directions that have moving enemy pieces</p
    ><p
    >moving: if defensive move pieces starting with close</p
    ><p
    >The system for running the ai is to make an action available when the current wizard is an ai to continue the ai's turn. This will do one action, and move to the next phase if the ai has completed it's action. This api allows the client to control how and at what speed the ai's turns are run, we use this to run one ai action every half second so you can see what the ai is doing by watching the board change.</p
    ><p
    >TODO: --don't attack friendlies --don't cast, attack corpses --don't choose spells that can't work cast spells in sensible place weight choice by chance sometimes cast imag when unlikely disbelieve logic and tracking move phase: keep wizards out of danger always move into castles,wood move towards wood if near stay in castles, wood send monsters towards closest enemy always attack if can choose targets: favour wizards and hardest that likely to kill</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.AI'</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/*</p
    ><p
    >== main ai action</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_ai_continue</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'ai_continue'</span><span class="Symbol">);</span>
    <span class="Keyword">if</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'choose'</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">ai_choose_spell</span><span class="Symbol">();</span>
      <span class="Keyword">perform</span> <span class="VarId">action_next_phase</span><span class="Symbol">();</span>
    <span class="Keyword">elseif</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'cast'</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">ai_cast_spell</span><span class="Symbol">();</span>
    <span class="Keyword">elseif</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'move'</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">ai_move_pieces</span><span class="Symbol">();</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/*</p
    ><p
    >== spell choice</p
    ><p
    >First, eliminate all the useless target spells - those that have no target and those that can only be cast on a friendly or corpse.</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">current_wizard_target_spells</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">,</span><span class="Keyword">range</span> <span class="Keyword">from</span> <span class="VarId">spell_books</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
      <span class="Keyword">on</span> <span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">target_spells</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">current_wizard_square</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
    <span class="Keyword">on</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span><span class="VarId">current_wizard</span>
  <span class="Keyword">where</span> <span class="VarId">ptype</span><span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/*</p
    ><p
    >take all the target spells and create a list of spell names a squares that they can be cast on using the range and valid square types of each spell</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">castable_target_spells</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">,</span><span class="VarId">svs</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">svs</span><span class="Symbol">.</span><span class="VarId">y</span>
    <span class="Keyword">from</span> <span class="VarId">current_wizard_target_spells</span> <span class="VarId">cwts</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">spell_valid_squares</span> <span class="VarId">svs</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">target_spells</span> <span class="VarId">svst</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">board_ranges</span> <span class="VarId">br</span>
      <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">br</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">br</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_square</span><span class="Symbol">)</span>
        <span class="Keyword">and</span> <span class="VarId">br</span><span class="Symbol">.</span><span class="Keyword">range</span> <span class="Symbol">=</span> <span class="VarId">cwts</span><span class="Symbol">.</span><span class="VarId">range</span>
        <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">br</span><span class="Symbol">.</span><span class="VarId">tx</span><span class="Symbol">,</span> <span class="VarId">br</span><span class="Symbol">.</span><span class="VarId">ty</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">svs</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">svs</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/*</p
    ><p
    >eliminate the rows which have only corpses or friendlies on top</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">ai_useful_spells</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">spell_books</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
      <span class="Keyword">on</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">current_wizard</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">activate_spells</span>
  <span class="Keyword">union</span> <span class="VarId">all</span>
    <span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">castable_target_spells</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span>
                        <span class="Keyword">from</span> <span class="VarId">squares_valid_categories</span>
                        <span class="Keyword">where</span> <span class="VarId">category</span><span class="Symbol">=</span><span class="Char">'corpse-only'</span>
                      <span class="Keyword">union</span> <span class="VarId">all</span>
                      <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
                      <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
                      <span class="Keyword">on</span> <span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">allegiance</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">ai_choose_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">vspell_name</span> <span class="Type">text</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">vspell_name</span> <span class="VarId">spell_name</span>
    <span class="Keyword">from</span> <span class="VarId">ai_useful_spells</span>
    <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">random</span><span class="Symbol">()</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
  <span class="Keyword">if</span> <span class="VarId">vspell_name</span> <span class="VarId">is</span> <span class="Keyword">null</span> <span class="VarId">then</span>
    <span class="Comment">--skip choosing one</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
    <span class="Keyword">perform</span> <span class="VarId">action_choose_spell</span><span class="Symbol">(</span><span class="VarId">vspell_name</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/*</p
    ><p
    >== spell casting</p
    ><p
    >first filter out all the targets we don't want to cast on:</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">ai_filtered_target_spells</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">valid_target_actions</span>
  <span class="Keyword">where</span> <span class="VarId">action</span><span class="Symbol">=</span><span class="Char">'cast_target_spell'</span>
  <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">not</span> <span class="VarId">in</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
     <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top</span>
       <span class="Keyword">on</span> <span class="VarId">allegiance</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">,</span> <span class="Char">'dead'</span><span class="Symbol">));</span>

</pre></div></div></div><p
    >/* cast spells in a sensible place: dark power: don't choose a wizard with no creations pick enemy monsters that are close or wizards with lots of shit lightning, magic bolt: enemy wizard then closest monster raise dead: choose hardest corpse subversion: choose hardest enemy shadow wood: use magic tree layout fire: next to wizard or monster if can, else towards closest enemy blob: towards closest enemy in some space castle: next to wizard away from danger monster: towards closest enemy */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">ai_cast_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">p</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">valid_activate_actions</span>
            <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'cast_activate_spell'</span><span class="Symbol">)</span> <span class="VarId">then</span>
     <span class="Keyword">perform</span> <span class="VarId">action_cast_activate_spell</span><span class="Symbol">();</span>
  <span class="Keyword">elseif</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">ai_filtered_target_spells</span><span class="Symbol">)</span> <span class="VarId">then</span>
     <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">p</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">ai_filtered_target_spells</span>
         <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">random</span><span class="Symbol">()</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
     <span class="Keyword">perform</span> <span class="VarId">action_cast_target_spell</span><span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
  <span class="VarId">else</span>
    <span class="Keyword">perform</span> <span class="VarId">action_next_phase</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/*</p
    ><p
    >== move phase</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">ai_move_pieces</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">p</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Comment">--if no piece selected and none selectable, go to next phase</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span>
     <span class="Keyword">and</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">valid_target_actions</span>
            <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'select_piece_at_position'</span><span class="Symbol">)</span> <span class="VarId">then</span>
     <span class="Keyword">perform</span> <span class="VarId">action_next_phase</span><span class="Symbol">();</span>
     <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Comment">--if no piece selected try to select one</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span>
     <span class="Keyword">and</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">valid_target_actions</span>
            <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'select_piece_at_position'</span><span class="Symbol">)</span> <span class="VarId">then</span>
     <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">p</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">valid_target_actions</span>
       <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'select_piece_at_position'</span>
       <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">random</span><span class="Symbol">()</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
     <span class="Keyword">perform</span> <span class="VarId">action_select_piece_at_position</span><span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
     <span class="Comment">--check if it has been immediately unselected</span>
     <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span> <span class="VarId">then</span>
       <span class="VarId">return</span><span class="Symbol">;</span>
     <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">ai_move_selected_piece</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">ai_selected_piece_actions</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
  <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">valid_target_actions</span> <span class="VarId">a</span>
  <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top</span> <span class="VarId">p</span>
    <span class="Keyword">using</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span>
  <span class="Keyword">where</span> <span class="VarId">action</span> <span class="VarId">in</span><span class="Symbol">(</span><span class="Char">'walk'</span><span class="Symbol">,</span> <span class="Char">'fly'</span><span class="Symbol">)</span>
  <span class="Keyword">or</span> <span class="Symbol">((</span><span class="VarId">action</span> <span class="VarId">in</span><span class="Symbol">(</span><span class="Char">'attack'</span><span class="Symbol">,</span> <span class="Char">'ranged_attack'</span><span class="Symbol">)</span>
       <span class="Keyword">and</span> <span class="VarId">allegiance</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">,</span> <span class="Char">'dead'</span><span class="Symbol">)));</span>


</pre></div></div></div><p
    >/* rules: send monsters towards enemy always attack if can choose targets: wizards if can, then hardest creature */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">prefered_targets</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span><span class="Symbol">,</span>
  <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span> <span class="Keyword">then</span> <span class="Number">-500</span>
                <span class="Keyword">else</span> <span class="Number">20</span> <span class="Symbol">-</span> <span class="VarId">physical_defense</span>
  <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">preference</span>
<span class="Keyword">from</span> <span class="VarId">valid_target_actions</span>
<span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_mr</span>
<span class="Keyword">where</span> <span class="VarId">action</span> <span class="VarId">in</span><span class="Symbol">(</span><span class="Char">'attack'</span><span class="Symbol">,</span><span class="Char">'ranged_attack'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">closest_enemy_to_selected_piece</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">y</span>
  <span class="Keyword">from</span> <span class="VarId">selected_piece_attackable_squares</span> <span class="VarId">a</span>
  <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span> <span class="VarId">s</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span> <span class="VarId">s1</span>
    <span class="Keyword">using</span><span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span>
  <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">distance</span><span class="Symbol">(</span><span class="VarId">s1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">s1</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">select_best_move</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">action</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">ai_selected_piece_actions</span> <span class="VarId">a</span>
    <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">closest_enemy_to_selected_piece</span> <span class="VarId">e</span>
    <span class="Keyword">where</span> <span class="VarId">action</span> <span class="VarId">in</span><span class="Symbol">(</span><span class="Char">'walk'</span><span class="Symbol">,</span> <span class="Char">'fly'</span><span class="Symbol">)</span>
    <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">distance</span><span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">e</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">e</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">ai_move_selected_piece</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">record</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">ai_selected_piece_actions</span>
            <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'attack'</span>
            <span class="Keyword">or</span> <span class="Symbol">(</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'ranged_attack'</span>
                <span class="Keyword">and</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">move_phase</span><span class="Symbol">=</span><span class="Char">'ranged_attack'</span>
                <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">)))</span> <span class="VarId">then</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span> <span class="Keyword">from</span> <span class="VarId">prefered_targets</span>
      <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">preference</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
    <span class="Keyword">if</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'attack'</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">action_attack</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
    <span class="Keyword">elseif</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'ranged_attack'</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">action_ranged_attack</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
    <span class="VarId">else</span>
      <span class="Comment">--raise exception 'bad ai attack action: %', r.action;</span>
      <span class="Keyword">perform</span> <span class="VarId">action_cancel</span><span class="Symbol">();</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
    <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">ai_selected_piece_actions</span>
              <span class="Keyword">where</span> <span class="VarId">action</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'walk'</span><span class="Symbol">,</span><span class="Char">'fly'</span><span class="Symbol">))</span> <span class="VarId">then</span>
      <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">select_best_move</span><span class="Symbol">;</span>
      <span class="Keyword">if</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'walk'</span> <span class="VarId">then</span>
        <span class="Keyword">perform</span> <span class="VarId">action_walk</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
      <span class="Keyword">elseif</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'fly'</span> <span class="VarId">then</span>
        <span class="Keyword">perform</span> <span class="VarId">action_fly</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
      <span class="VarId">else</span>
        <span class="Keyword">perform</span> <span class="VarId">action_cancel</span><span class="Symbol">();</span>
      <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="VarId">else</span>
      <span class="Keyword">perform</span> <span class="VarId">action_cancel</span><span class="Symbol">();</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><div id="section"
    ><h2
      >/*</h2
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Comment">--select set_all_attributes_to_not_null();</span>
<span class="Comment">--select set_notifies_on_all_data_tables();</span>

</pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
