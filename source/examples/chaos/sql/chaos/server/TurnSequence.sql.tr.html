<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >TurnSequence.sql transformed</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Comment">/*</span>

<span class="Comment">turn sequence</span>
<span class="Comment">=============</span>

<span class="Comment">For the player, there are three phases: choose spell, cast spell, move</span>
<span class="Comment">pieces; but for the computer there are four phases, the extra one is</span>
<span class="Comment">the autonomous phase in between casting and moving. In this phase</span>
<span class="Comment">magic fire and gooey blob spread, castles may disappear, and wizards</span>
<span class="Comment">may receive a new spell from a magic tree.</span>

<span class="Comment">There are lots of constraints in this section. They're probably more</span>
<span class="Comment">useful as documentation.</span>

<span class="Comment">One big takeaway from working with all this constraints is that you</span>
<span class="Comment">really need deferred constraints or multiple updates for anything more</span>
<span class="Comment">than basic constraints.</span>

<span class="Comment">Some of this stuff makes more sense when looking at the actions.</span>

<span class="Comment">Everything here seems to be obscured under all the boilerplate,</span>
<span class="Comment">looking for a better way. Maybe some annotations and the ability to</span>
<span class="Comment">create a diagram (maybe even an interactive one?)</span>

<span class="Comment">== ddl</span>
<span class="Comment">*/</span>
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">);</span>

<span class="Comment">/*</span>
<span class="Comment">use this to simulate multiple updates:</span>
<span class="Comment">for a constraint which refers to multiple tables which get updated</span>
<span class="Comment">during an action_next_phase call, this will be set to true,</span>
<span class="Comment">false at all other times, so using this can defer constraint checking</span>
<span class="Comment">till the end of the action_next_phase call after all the relevant</span>
<span class="Comment">turn phase relvars have been updated. Don't forget to put</span>
<span class="Comment">in_next_phase_hack_table in the relvar list for the constraint.</span>

<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'in_next_phase_hack'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;in_next_phase_hack_table&quot; [(&quot;in_next_phase_hack&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">in_next_phase_hack_table</span> <span class="Symbol">(</span>
  <span class="VarId">in_next_phase_hack</span> <span class="VarId">boolean</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'in_next_phase_hack_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_in_next_phase_hack&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_in_next_phase_hack</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">in_next_phase_hack_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_in_next_phase_hack'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_in_next_phase_hack_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_in_next_phase_hack_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">in_next_phase_hack_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_in_next_phase_hack_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;in_next_phase_hack_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">in_next_phase_hack_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_in_next_phase_hack_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint in_next_phase_hack_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'in_next_phase_hack_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">in_next_phase_hack_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">in_next_phase_hack_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">in_next_phase_hack_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'in_next_phase_hack_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">in_next_phase_hack_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'in_next_phase_hack_table'</span><span class="Symbol">,</span> <span class="Char">'hack'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'creating_new_game'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;creating_new_game_table&quot; [(&quot;creating_new_game&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">creating_new_game_table</span> <span class="Symbol">(</span>
  <span class="VarId">creating_new_game</span> <span class="VarId">boolean</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'creating_new_game_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_creating_new_game&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_creating_new_game</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">creating_new_game_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_creating_new_game'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_creating_new_game_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_creating_new_game_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">creating_new_game_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_creating_new_game_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;creating_new_game_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">creating_new_game_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_creating_new_game_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint creating_new_game_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'creating_new_game_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">creating_new_game_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">creating_new_game_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">creating_new_game_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'creating_new_game_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">creating_new_game_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">true</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'creating_new_game_table'</span><span class="Symbol">,</span> <span class="Char">'hack'</span><span class="Symbol">);</span>

<span class="Comment">--Turn number, starts at 0 goes up 1 each full turn, just used to provide</span>
<span class="Comment">--info on how long the game has been going.</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'turn_number'</span><span class="Symbol">,</span> <span class="Char">'int'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;turn_number_table&quot; [(&quot;turn_number&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">turn_number_table</span> <span class="Symbol">(</span>
  <span class="VarId">turn_number</span> <span class="Type">int</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_number_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_turn_number&quot; [] (ScalarType &quot;int4&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_turn_number</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">int</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">turn_number_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_turn_number'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_turn_number_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_turn_number_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">turn_number_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_turn_number_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;turn_number_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">turn_number_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_turn_number_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint turn_number_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_number_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">turn_number_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">turn_number_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">turn_number_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_number_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'turn_number_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Comment">/*select create_update_transition_tuple_constraint(</span>
<span class="Comment">  'turn_number_table',</span>
<span class="Comment">  'turn_number_change_valid',</span>
<span class="Comment">  '(NEW.turn_number = OLD.turn_number + 1)');*/</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">no_deletes_inserts_except_new_game</span><span class="Symbol">(</span><span class="Char">'turn_number_table'</span><span class="Symbol">);</span>

<span class="Comment">/*</span>
<span class="Comment">turn phase</span>
<span class="Comment">must follow choose-cast-auto-move-choose-etc.</span>

<span class="Comment">wizard spell choices</span>
<span class="Comment">added row must be for current wizard, and in current wizard's spell book</span>
<span class="Comment">  in choose phase</span>
<span class="Comment">removed row must be for current wizard</span>
<span class="Comment">  in cast phase</span>

<span class="Comment">spell parts to cast</span>
<span class="Comment">pieces to move</span>
<span class="Comment">squares left to walk</span>

<span class="Comment">*/</span>

<span class="Comment">-- todo: use lag or lead window fn or something - make it a lot</span>
<span class="Comment">-- clearer?</span>
<span class="Comment">/*create view next_wizard as</span>
<span class="Comment">select wizard_name, new_wizard_name from</span>
<span class="Comment">  (select wizard_name as new_wizard_name, place</span>
<span class="Comment">     from live_wizards) as a inner join</span>
<span class="Comment">  (select wizard_name,</span>
<span class="Comment">     (place + 1) %</span>
<span class="Comment">       (select max(place) + 1 from live_wizards)</span>
<span class="Comment">      as old_place from live_wizards) as b</span>
<span class="Comment">  on (place = old_place);</span>
<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_turn_number_table_no_insert&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_turn_number_table_no_insert</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                     <span class="Keyword">from</span> <span class="VarId">creating_new_game_table</span>
                     <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">creating_new_game</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">))))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'insert on turn_number_table violates transition constraint turn_number_table_no_insert'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_turn_number_table_no_insert'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">turn_number_table_insert_transition_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">on</span> <span class="VarId">turn_number_table</span> <span class="Keyword">for</span> <span class="Keyword">row</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">check_turn_number_table_no_insert</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_number_table_insert_transition_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_turn_number_table_no_delete&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_turn_number_table_no_delete</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                     <span class="Keyword">from</span> <span class="VarId">creating_new_game_table</span>
                     <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">creating_new_game</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">))))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'delete on turn_number_table violates transition constraint turn_number_table_no_delete'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="Keyword">null</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_turn_number_table_no_delete'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">turn_number_table_delete_transition_trigger</span> <span class="Keyword">after</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">turn_number_table</span> <span class="Keyword">for</span> <span class="Keyword">row</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">check_turn_number_table_no_delete</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_number_table_delete_transition_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;next_wizard&quot; [ScalarType &quot;text&quot;] (ScalarType &quot;text&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">next_wizard</span><span class="Symbol">(</span><span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
  <span class="VarId">with</span>
    <span class="VarId">doubled</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">original_place</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span>
       <span class="Keyword">union</span> <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">original_place</span> <span class="Symbol">+</span> <span class="Number">10</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span><span class="Symbol">)</span>
   <span class="Symbol">,</span><span class="VarId">nexts</span> <span class="VarId">as</span>
       <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">lead</span><span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">)</span>
                            <span class="Keyword">over</span><span class="Symbol">(</span><span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">original_place</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">n</span>
          <span class="Keyword">from</span> <span class="VarId">doubled</span><span class="Symbol">)</span>
  <span class="Keyword">select</span> <span class="VarId">n</span> <span class="Keyword">from</span> <span class="VarId">nexts</span> <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> $<span class="Number">1</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*select next_wizard('Buddha');</span>
<span class="Comment">select next_wizard('Kong Fuzi');</span>
<span class="Comment">select next_wizard('Laozi');</span>
<span class="Comment">select next_wizard('Moshe');</span>
<span class="Comment">select next_wizard('Muhammad');</span>
<span class="Comment">select next_wizard('Shiva');</span>
<span class="Comment">select next_wizard('Yeshua');</span>
<span class="Comment">select next_wizard('Zarathushthra');</span>
<span class="Comment">*/</span>

<span class="Comment">--current wizard is the wizard who's turn it is to do stuff in current phase</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'next_wizard'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'current_wizard'</span><span class="Symbol">,</span> <span class="Char">'text'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;current_wizard_table&quot; [(&quot;current_wizard&quot;,ScalarType &quot;text&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">current_wizard_table</span> <span class="Symbol">(</span>
  <span class="VarId">current_wizard</span> <span class="Type">text</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'current_wizard_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_current_wizard&quot; [] (ScalarType &quot;text&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_current_wizard</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_current_wizard'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_current_wizard_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_current_wizard_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_current_wizard_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;current_wizard_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">current_wizard_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_current_wizard_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint current_wizard_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'current_wizard_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">current_wizard_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">current_wizard_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">current_wizard_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'current_wizard_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'current_wizard_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">alter</span> <span class="Keyword">table</span> <span class="VarId">current_wizard_table</span>
  <span class="Keyword">add</span> <span class="Keyword">constraint</span> <span class="VarId">current_wizard_fkey</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">wizards</span><span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">);</span>

<span class="Comment">-- could be no deletes, inserts - unless there is only one wizard left</span>
<span class="Comment">-- (to allow draws)</span>
<span class="Comment">--select no_deletes_inserts_except_new_game('current_wizard_table');</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Keyword">alter</span> <span class="Keyword">table</span> <span class="VarId">current_wizard_table</span> <span class="Keyword">add</span>  <span class="Keyword">constraint</span> <span class="VarId">current_wizard_fkey</span> <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">wizards</span> <span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">)</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="Keyword">cascade</span><span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'current_wizard_must_be_alive'</span><span class="Symbol">,</span>
  $$<span class="Symbol">(</span><span class="Keyword">select</span> <span class="Keyword">not</span> <span class="VarId">expired</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
     <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span> <span class="Keyword">on</span> <span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>

<span class="Comment">/*</span>
<span class="Comment">wizard field in most tables and views is named wizard_name</span>

<span class="Comment">instead of tediously writing out inner join blah on wizard_name =</span>
<span class="Comment">current_wizard use the following view to instead write natural inner</span>
<span class="Comment">join current_wizard . Not that much less tedious though.</span>

<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_current_wizard_must_be_alive&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_current_wizard_must_be_alive</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">expired</span><span class="Symbol">))</span>
            <span class="Keyword">from</span> <span class="Symbol">(</span><span class="VarId">current_wizard_table</span>
                  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span> <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span><span class="Symbol">)));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_current_wizard_must_be_alive'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;current_wizard_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">current_wizard_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_current_wizard_must_be_alive</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint current_wizard_must_be_alive'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_current_wizard_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint current_wizard_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'current_wizard_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;wizards_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">wizards_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_current_wizard_must_be_alive</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint current_wizard_must_be_alive'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_no_spells_for_stiffs</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint no_spells_for_stiffs'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_dead_wizard_army_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint dead_wizard_army_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizards_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;current_wizard&quot; [(&quot;wizard_name&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">current_wizard</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">current_wizard</span> <span class="Keyword">as</span> <span class="VarId">wizard_name</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>

<span class="Comment">-- could this be used for allegiance as well? To go more tutorial d,</span>
<span class="Comment">-- we want to try to only use natural joins in combination with</span>
<span class="Comment">-- renaming attributes</span>

<span class="Comment">-- turn phases</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'current_wizard'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateDomain (DomainType &quot;turn_phase_enum&quot;) (ScalarType &quot;text&quot;)]*/</span>
<span class="Keyword">create</span> <span class="Keyword">domain</span> <span class="VarId">turn_phase_enum</span> <span class="Keyword">as</span> <span class="VarId">text</span>
       <span class="Keyword">check</span> <span class="Symbol">(</span><span class="VarId">value</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'choose'</span><span class="Symbol">,</span> <span class="Char">'cast'</span><span class="Symbol">,</span> <span class="Char">'autonomous'</span><span class="Symbol">,</span> <span class="Char">'move'</span><span class="Symbol">));</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_enum'</span><span class="Symbol">,</span><span class="Char">'domain'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;next_turn_phase&quot; [ScalarType &quot;text&quot;] (ScalarType &quot;text&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">next_turn_phase</span><span class="Symbol">(</span><span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">case</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'choose'</span> <span class="Keyword">then</span> <span class="Char">'cast'</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'cast'</span> <span class="Keyword">then</span> <span class="Char">'autonomous'</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'autonomous'</span> <span class="Keyword">then</span> <span class="Char">'move'</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'move'</span> <span class="Keyword">then</span> <span class="Char">'choose'</span>
  <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">result</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'next_turn_phase'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'turn_phase'</span><span class="Symbol">,</span> <span class="Char">'turn_phase_enum'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;turn_phase_table&quot; [(&quot;turn_phase&quot;,DomainType &quot;turn_phase_enum&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">turn_phase_table</span> <span class="Symbol">(</span>
  <span class="VarId">turn_phase</span> <span class="VarId">turn_phase_enum</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_turn_phase&quot; [] (DomainType &quot;turn_phase_enum&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_turn_phase</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">turn_phase_enum</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_turn_phase'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_turn_phase_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_turn_phase_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_turn_phase_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;turn_phase_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">turn_phase_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_turn_phase_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint turn_phase_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">turn_phase_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">turn_phase_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">turn_phase_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'turn_phase_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>
<span class="Comment">/*select create_update_transition_tuple_constraint(</span>
<span class="Comment">  'turn_phase_table',</span>
<span class="Comment">  'turn_phase_change_valid',</span>
<span class="Comment">  'NEW.turn_phase = next_turn_phase(OLD.turn_phase)');*/</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">no_deletes_inserts_except_new_game</span><span class="Symbol">(</span><span class="Char">'turn_phase_table'</span><span class="Symbol">);</span>

<span class="Comment">-- not used anywhere atm??</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_turn_phase_table_no_insert&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_turn_phase_table_no_insert</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                     <span class="Keyword">from</span> <span class="VarId">creating_new_game_table</span>
                     <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">creating_new_game</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">))))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'insert on turn_phase_table violates transition constraint turn_phase_table_no_insert'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_turn_phase_table_no_insert'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">turn_phase_table_insert_transition_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">on</span> <span class="VarId">turn_phase_table</span> <span class="Keyword">for</span> <span class="Keyword">row</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">check_turn_phase_table_no_insert</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_insert_transition_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_turn_phase_table_no_delete&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_turn_phase_table_no_delete</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                     <span class="Keyword">from</span> <span class="VarId">creating_new_game_table</span>
                     <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">creating_new_game</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">))))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'delete on turn_phase_table violates transition constraint turn_phase_table_no_delete'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="Keyword">null</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_turn_phase_table_no_delete'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">turn_phase_table_delete_transition_trigger</span> <span class="Keyword">after</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">turn_phase_table</span> <span class="Keyword">for</span> <span class="Keyword">row</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">check_turn_phase_table_no_delete</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_delete_transition_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateComposite &quot;turn_pos&quot; [(&quot;turn_number&quot;,ScalarType &quot;int4&quot;),(&quot;turn_phase&quot;,DomainType &quot;turn_phase_enum&quot;),(&quot;current_wizard&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">type</span> <span class="VarId">turn_pos</span> <span class="Keyword">as</span> <span class="Symbol">(</span>
    <span class="VarId">turn_number</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="VarId">turn_phase</span> <span class="VarId">turn_phase_enum</span><span class="Symbol">,</span>
    <span class="VarId">current_wizard</span> <span class="VarId">text</span>
<span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_pos'</span><span class="Symbol">,</span><span class="Char">'type'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;get_current_turn_pos&quot; [] (NamedCompositeType &quot;turn_pos&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_current_turn_pos</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">turn_pos</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">turn_number</span><span class="Symbol">,</span> <span class="VarId">turn_phase</span><span class="Symbol">,</span> <span class="VarId">current_wizard</span><span class="Symbol">)::</span><span class="VarId">turn_pos</span>
    <span class="Keyword">from</span> <span class="VarId">turn_number_table</span>
    <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">turn_phase_table</span>
    <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>


<span class="Comment">/*</span>

<span class="Comment">Both spell casting and moving have a bunch of state local to each</span>
<span class="Comment">wizards turn in the that phase. Wizard spell choices is a piece of</span>
<span class="Comment">turn phase state which is constructed bit by bit in the choice phase</span>
<span class="Comment">then read in the cast phase, so this data lasts from the start of the</span>
<span class="Comment">choice phase to the end of the cast phase.</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_current_turn_pos'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create6nf</span> <span class="Symbol">(</span>$$

  <span class="VarId">wizard_spell_choices_mr</span> <span class="Symbol">(</span>
    <span class="VarId">wizard_name</span> <span class="Type">text</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
    <span class="VarId">spell_name</span> <span class="VarId">text</span>
  <span class="Symbol">);</span>

  <span class="VarId">wizard_spell_choices_imaginary</span> <span class="Symbol">:</span> <span class="VarId">wizard_spell_choices_mr</span> <span class="Symbol">(</span>
    <span class="VarId">imaginary</span> <span class="VarId">boolean</span> <span class="VarId">null</span>
  <span class="Symbol">);</span>

$$<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;wizard_spell_choices_mr&quot; [(&quot;wizard_name&quot;,ScalarType &quot;text&quot;),(&quot;spell_name&quot;,ScalarType &quot;text&quot;),(&quot;imaginary&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">wizard_spell_choices_mr</span> <span class="Symbol">(</span>
  <span class="VarId">wizard_name</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
  <span class="VarId">spell_name</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">imaginary</span> <span class="VarId">boolean</span> <span class="Keyword">null</span> <span class="VarId">null</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizard_spell_choices_mr'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateView &quot;wizard_spell_choices_mr_base&quot; [(&quot;wizard_name&quot;,ScalarType &quot;text&quot;),(&quot;spell_name&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizard_spell_choices_mr_base</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">spell_name</span>
    <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizard_spell_choices_mr_base'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateView &quot;wizard_spell_choices_imaginary&quot; [(&quot;wizard_name&quot;,ScalarType &quot;text&quot;),(&quot;spell_name&quot;,ScalarType &quot;text&quot;),(&quot;imaginary&quot;,ScalarType &quot;bool&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizard_spell_choices_imaginary</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">spell_name</span><span class="Symbol">,</span><span class="VarId">imaginary</span>
    <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">imaginary</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizard_spell_choices_imaginary'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'wizard_spell_choices_mr'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;wizard_spell_choices&quot; [(&quot;wizard_name&quot;,ScalarType &quot;text&quot;),(&quot;spell_name&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizard_spell_choices</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr_base</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizard_spell_choices'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'dead_wizard_no_spell'</span><span class="Symbol">,</span>
  $$ <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span>
    <span class="Keyword">where</span> <span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>

<span class="Comment">/*</span>

<span class="Comment">todo: add constraint to say imaginary must be set for monsters and</span>
<span class="Comment">must not be set for non-monsters</span>

<span class="Comment">*/</span>

<span class="Comment">--shortcut for current wizard's spell</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_dead_wizard_no_spell&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_dead_wizard_no_spell</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                         <span class="Keyword">from</span> <span class="Symbol">(</span><span class="VarId">wizard_spell_choices_mr</span>
                               <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span><span class="Symbol">)</span>
                         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_dead_wizard_no_spell'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;wizard_spell_choices_mr_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">wizard_spell_choices_mr_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_dead_wizard_no_spell</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint dead_wizard_no_spell'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizard_spell_choices_mr_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">wizard_spell_choices_mr_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">wizard_spell_choices_mr</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">wizard_spell_choices_mr_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizard_spell_choices_mr_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;wizards_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">wizards_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_dead_wizard_no_spell</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint dead_wizard_no_spell'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_no_spells_for_stiffs</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint no_spells_for_stiffs'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_dead_wizard_army_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint dead_wizard_army_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_current_wizard_must_be_alive</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint current_wizard_must_be_alive'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizards_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;current_wizard_spell&quot; [(&quot;spell_name&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">current_wizard_spell</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'current_wizard_spell'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;get_current_wizard_spell&quot; [] (ScalarType &quot;text&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_current_wizard_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*this really needs multiple updates</span>

<span class="Comment">--select add_foreign_key('wizard_spell_choices', array['wizard_name',</span>
<span class="Comment">--  'spell_name'], 'spell_books');</span>

<span class="Comment">the problem is that in the action_next_phase for the end of a wizards</span>
<span class="Comment">cast phase we want to delete the spell choice from this table, and</span>
<span class="Comment">also delete the spell from the wizards spell book. The code deletes</span>
<span class="Comment">the spell from the spell book first, but since the spell choice</span>
<span class="Comment">references the spell book table, the reference stops the delete.</span>

<span class="Comment">We can't use a conventional cascade delete since there may be multiple</span>
<span class="Comment">rows in the spell book for the same spell/wizard combo - this isn't a</span>
<span class="Comment">foreign key in sql sense.</span>

<span class="Comment">One alternative is to save the wizard and spell names in a variable so</span>
<span class="Comment">we can delete the spell choice first then the spell book entry, but</span>
<span class="Comment">that is pretty inelegant.</span>

<span class="Comment">We could do it properly with multiple updates, so simulate this by</span>
<span class="Comment">writing out the fk by hand and adding the in next phase hack.</span>

<span class="Comment">*/</span>
<span class="Comment">--select create_var('spell_choice_hack', 'boolean');</span>
<span class="Comment">--insert into spell_choice_hack_table values (false);</span>
<span class="Comment">--select set_relvar_type('spell_choice_hack_table', 'hack');</span>

<span class="Comment">/*select create_assertion('wizard_spell_choices_wizard_name_spell_name_fkey',</span>
<span class="Comment">$$((select spell_choice_hack from spell_choice_hack_table) or</span>
<span class="Comment">not exists(select wizard_name, spell_name from wizard_spell_choices</span>
<span class="Comment">  except</span>
<span class="Comment">select wizard_name, spell_name from spell_books))$$);</span>
<span class="Comment">*/</span>

<span class="Comment">/*</span>
<span class="Comment">if choose phase: only current and previous wizards may have a row</span>
<span class="Comment">if cast phase: only current and subsequent wizards may have a row</span>
<span class="Comment">this constraint really needs multiple updates.</span>
<span class="Comment">maybe using ctes or window fns would make this clearer?</span>
<span class="Comment">*/</span>
<span class="Comment">/*</span>
<span class="Comment">select create_assertion('chosen_spell_phase_valid',</span>
<span class="Comment">$$</span>
<span class="Comment">((select in_next_phase_hack from in_next_phase_hack_table) or</span>
<span class="Comment">(((select turn_phase='choose' from turn_phase_table) and</span>
<span class="Comment"> (select max(place) from wizard_spell_choices</span>
<span class="Comment">   natural inner join live_wizards) &lt;=</span>
<span class="Comment"> (select place from live_wizards</span>
<span class="Comment">   inner join current_wizard_table</span>
<span class="Comment">     on wizard_name = current_wizard))</span>
<span class="Comment">or</span>
<span class="Comment">((select turn_phase='cast' from turn_phase_table) and</span>
<span class="Comment"> (select min(place) from wizard_spell_choices</span>
<span class="Comment">    natural inner join live_wizards) &gt;=</span>
<span class="Comment">  (select place from live_wizards</span>
<span class="Comment">    inner join current_wizard_table</span>
<span class="Comment">      on wizard_name = current_wizard))</span>
<span class="Comment">or not exists(select 1 from wizard_spell_choices)</span>
<span class="Comment">))$$);</span>
<span class="Comment">*/</span>
<span class="Comment">/*select create_update_transition_tuple_constraint(</span>
<span class="Comment">  'wizard_spell_choices_mr',</span>
<span class="Comment">  'update_spell_choice_restricted',</span>
<span class="Comment">  $$(select turn_phase = 'choose' from turn_phase_table)</span>
<span class="Comment">    and (NEW.wizard_name = OLD.wizard_name)</span>
<span class="Comment">    and (select current_wizard = NEW.wizard_name from current_wizard_table)$$);</span>
<span class="Comment">select create_insert_transition_tuple_constraint(</span>
<span class="Comment">  'wizard_spell_choices_mr',</span>
<span class="Comment">  'insert_spell_choice_restricted',</span>
<span class="Comment">  $$(select turn_phase = 'choose' from turn_phase_table)</span>
<span class="Comment">    and (select current_wizard = NEW.wizard_name from current_wizard_table)$$);</span>
<span class="Comment">select create_delete_transition_tuple_constraint(</span>
<span class="Comment">  'wizard_spell_choices_mr',</span>
<span class="Comment">  'delete_spell_choice_restricted',</span>
<span class="Comment">  $$(select turn_phase in ('cast', 'choose') from turn_phase_table)$$);</span>
<span class="Comment">*/</span>

<span class="Comment">/*</span>

<span class="Comment">if wizard is skipping casting a spell then no tuple appears in this</span>
<span class="Comment">relvar for that wizard</span>

<span class="Comment">spellparts to cast is local to spell casting phase for each wizard</span>

<span class="Comment">current wizard has cast amount spell parts in this turn phase</span>

<span class="Comment">when entering spell cast phase, this is set to 0 if wizard has no</span>
<span class="Comment">spell or max number of casts otherwise</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_current_wizard_spell'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'spell_parts_to_cast'</span><span class="Symbol">,</span> <span class="Char">'int'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;spell_parts_to_cast_table&quot; [(&quot;spell_parts_to_cast&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">spell_parts_to_cast_table</span> <span class="Symbol">(</span>
  <span class="VarId">spell_parts_to_cast</span> <span class="Type">int</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_parts_to_cast_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_spell_parts_to_cast&quot; [] (ScalarType &quot;int4&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_spell_parts_to_cast</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">int</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">spell_parts_to_cast_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_spell_parts_to_cast'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_spell_parts_to_cast_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_spell_parts_to_cast_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">spell_parts_to_cast_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_spell_parts_to_cast_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;spell_parts_to_cast_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">spell_parts_to_cast_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_spell_parts_to_cast_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint spell_parts_to_cast_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_parts_to_cast_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">spell_parts_to_cast_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">spell_parts_to_cast_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">spell_parts_to_cast_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_parts_to_cast_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'spell_parts_to_cast_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'parts_to_cast_only'</span><span class="Symbol">,</span> $$
  <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'cast'</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span>
  <span class="Keyword">or</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">spell_parts_to_cast_table</span><span class="Symbol">))</span>$$<span class="Symbol">);</span>

<span class="Comment">/*</span>
<span class="Comment">If casting multipart spell, only check success on first part.</span>
<span class="Comment">Store whether current wizard's spell needs a success check here.</span>
<span class="Comment">make sure to reset it each next phase during cast phase</span>
<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_parts_to_cast_only&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_parts_to_cast_only</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'cast'</span><span class="Symbol">)</span>
             <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span> <span class="Keyword">or</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                                                       <span class="Keyword">from</span> <span class="VarId">spell_parts_to_cast_table</span><span class="Symbol">))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_parts_to_cast_only'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;turn_phase_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">turn_phase_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_parts_to_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint parts_to_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_turn_phase_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint turn_phase_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;spell_parts_to_cast_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">spell_parts_to_cast_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_parts_to_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint parts_to_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_spell_parts_to_cast_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint spell_parts_to_cast_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_parts_to_cast_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'cast_success_checked'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;cast_success_checked_table&quot; [(&quot;cast_success_checked&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">cast_success_checked_table</span> <span class="Symbol">(</span>
  <span class="VarId">cast_success_checked</span> <span class="VarId">boolean</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_success_checked_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_cast_success_checked&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_cast_success_checked</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_cast_success_checked'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_cast_success_checked_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_cast_success_checked_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_cast_success_checked_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;cast_success_checked_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_success_checked_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_success_checked_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_success_checked_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_success_checked_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">cast_success_checked_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">cast_success_checked_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">cast_success_checked_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_success_checked_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'cast_success_checked_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'cast_checked_cast_only'</span><span class="Symbol">,</span> $$
  <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'cast'</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span>
  <span class="Keyword">or</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">))</span>$$<span class="Symbol">);</span>


<span class="Comment">/*</span>

<span class="Comment">casting affecting alignment</span>

<span class="Comment">how does a successful or unsuccessful spell affect world alignment?</span>
<span class="Comment">do unsuccessful spells have any effect?</span>
<span class="Comment">does the current world alignment affect the effect?</span>
<span class="Comment">is there a limit to how much the alignment can change in a turn?</span>
<span class="Comment">is each spell's effect independent of what other spells are cast that turn?</span>

<span class="Comment">what about:</span>
<span class="Comment">  each spell can affect the world alignment</span>
<span class="Comment">  spell alignments don't add up, the result is taken by random</span>
<span class="Comment">    from one of the spells cast that turn</span>
<span class="Comment">  e.g.</span>
<span class="Comment">  0, -1, -4, 2, -1: five spells cast with alignments given</span>
<span class="Comment">    chose one of these at random, each with 1/5 chance</span>
<span class="Comment">    then adjust alignment by this (align/2 with probability for halfs?)</span>

<span class="Comment">current plan:</span>
<span class="Comment">only successful spells affect alignment</span>
<span class="Comment">keep track of all spells during cast phase</span>
<span class="Comment">sum up total alignment, divide by 2, each full number affects alignment</span>
<span class="Comment">the fractional part has probability to affect it</span>
<span class="Comment">maximum change is 2</span>

<span class="Comment">this means that law increases alignment by one and large law does it</span>
<span class="Comment">by two in the absence of any other spells.</span>

<span class="Comment">I'm pretty sure this is way out. Need to investigate the original</span>
<span class="Comment">chaos (shocking that I have no real idea), because this is pretty</span>
<span class="Comment">critical to the gameplay - the alignment changing too slowly or</span>
<span class="Comment">quickly will change the balance of things totally.</span>

<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_cast_checked_cast_only&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_cast_checked_cast_only</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'cast'</span><span class="Symbol">)</span>
             <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span> <span class="Keyword">or</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                                                       <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_cast_checked_cast_only'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;turn_phase_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">turn_phase_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_checked_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_checked_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_turn_phase_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint turn_phase_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_parts_to_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint parts_to_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;cast_success_checked_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">cast_success_checked_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_checked_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_checked_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_success_checked_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_success_checked_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_success_checked_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'cast_alignment'</span><span class="Symbol">,</span> <span class="Char">'integer'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;cast_alignment_table&quot; [(&quot;cast_alignment&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">cast_alignment_table</span> <span class="Symbol">(</span>
  <span class="VarId">cast_alignment</span> <span class="VarId">integer</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_alignment_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_cast_alignment&quot; [] (ScalarType &quot;int4&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_cast_alignment</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">integer</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">cast_alignment_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_cast_alignment'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_cast_alignment_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_cast_alignment_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">cast_alignment_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_cast_alignment_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;cast_alignment_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_alignment_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_alignment_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_alignment_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_alignment_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">cast_alignment_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">cast_alignment_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">cast_alignment_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_alignment_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'cast_alignment_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'cast_alignment_empty'</span><span class="Symbol">,</span>
  $$<span class="Symbol">((</span><span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'cast'</span><span class="Symbol">)</span> <span class="VarId">or</span>
  <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">cast_alignment_table</span><span class="Symbol">))</span>$$<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_cast_alignment_empty&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_cast_alignment_empty</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'cast'</span><span class="Symbol">)</span> <span class="Keyword">or</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                                                         <span class="Keyword">from</span> <span class="VarId">cast_alignment_table</span><span class="Symbol">))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_cast_alignment_empty'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;cast_alignment_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">cast_alignment_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_alignment_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_alignment_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_alignment_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_alignment_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'cast_alignment_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;turn_phase_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">turn_phase_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_alignment_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_alignment_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_turn_phase_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint turn_phase_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_parts_to_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint parts_to_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_checked_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_checked_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;adjust_world_alignment&quot; [] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">adjust_world_alignment</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">abs_change</span> <span class="Type">float</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">abs_change</span>
    <span class="VarId">least</span><span class="Symbol">(</span><span class="VarId">abs</span><span class="Symbol">(</span><span class="VarId">get_cast_alignment</span><span class="Symbol">())</span> <span class="Symbol">/</span> <span class="Number">2</span><span class="Symbol">,</span> <span class="Number">2</span><span class="Symbol">);</span>
  <span class="Keyword">update</span> <span class="VarId">world_alignment_table</span>
    <span class="Keyword">set</span> <span class="VarId">world_alignment</span> <span class="Symbol">=</span> <span class="VarId">world_alignment</span>
      <span class="Symbol">+</span> <span class="VarId">trunc</span><span class="Symbol">(</span><span class="VarId">abs_change</span><span class="Symbol">)</span> <span class="Symbol">*</span> <span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">get_cast_alignment</span><span class="Symbol">());</span>
  <span class="Comment">--get fractional part</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="VarId">random</span><span class="Symbol">()</span> <span class="Symbol">&lt;</span> <span class="VarId">abs_change</span> <span class="Symbol">-</span> <span class="VarId">trunc</span><span class="Symbol">(</span><span class="VarId">abs_change</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Keyword">update</span> <span class="VarId">world_alignment_table</span>
      <span class="Keyword">set</span> <span class="VarId">world_alignment</span> <span class="Symbol">=</span> <span class="VarId">world_alignment</span> <span class="Symbol">+</span>
        <span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">get_cast_alignment</span><span class="Symbol">());</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">update</span> <span class="VarId">cast_alignment_table</span> <span class="Keyword">set</span> <span class="VarId">cast_alignment</span> <span class="Symbol">=</span> <span class="Number">0</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*</span>

<span class="Comment">pieces moved and selected piece are local to move phase for each</span>
<span class="Comment">wizard</span>

<span class="Comment">Piece in this table from current wizard's army have moved</span>
<span class="Comment">in this turn.</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'adjust_world_alignment'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">pieces_moved</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">current_wizard_table</span><span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">),</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
    <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;pieces_moved&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">pieces_moved</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">references</span> <span class="VarId">current_wizard_table</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span><span class="Symbol">,</span>
  <span class="VarId">tag</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="VarId">cascade</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_moved'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'pieces_moved'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'pieces_moved_empty'</span><span class="Symbol">,</span>
  $$<span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'move'</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span>
     <span class="Keyword">or</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">pieces_moved</span><span class="Symbol">))</span>$$<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_pieces_moved_empty&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_pieces_moved_empty</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'move'</span><span class="Symbol">)</span>
             <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span> <span class="Keyword">or</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                                                       <span class="Keyword">from</span> <span class="VarId">pieces_moved</span><span class="Symbol">))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_pieces_moved_empty'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;turn_phase_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">turn_phase_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_pieces_moved_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint pieces_moved_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_turn_phase_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint turn_phase_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_parts_to_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint parts_to_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_checked_cast_only</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_checked_cast_only'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_cast_alignment_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint cast_alignment_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'turn_phase_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;pieces_moved_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">pieces_moved_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_pieces_moved_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint pieces_moved_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_moved_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">pieces_moved_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">pieces_moved</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">pieces_moved_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_moved_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateDomain (DomainType &quot;move_phase&quot;) (ScalarType &quot;text&quot;)]*/</span>
<span class="Keyword">create</span> <span class="Keyword">domain</span> <span class="VarId">move_phase</span> <span class="Keyword">as</span> <span class="VarId">text</span>
  <span class="Keyword">check</span> <span class="Symbol">(</span><span class="VarId">value</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'motion'</span><span class="Symbol">,</span> <span class="Char">'attack'</span><span class="Symbol">,</span> <span class="Char">'ranged_attack'</span><span class="Symbol">));</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'move_phase'</span><span class="Symbol">,</span><span class="Char">'domain'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">selected_piece</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">current_wizard_table</span><span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">),</span>
  <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">move_phase</span> <span class="VarId">move_phase</span><span class="Symbol">,</span>
  <span class="VarId">engaged</span> <span class="VarId">boolean</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span> <span class="Comment">-- 0 to 1 tuple when in move phase,</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;selected_piece&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;),(&quot;move_phase&quot;,DomainType &quot;move_phase&quot;),(&quot;engaged&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">selected_piece</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">references</span> <span class="VarId">current_wizard_table</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span><span class="Symbol">,</span>
  <span class="VarId">tag</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">move_phase</span> <span class="VarId">move_phase</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">engaged</span> <span class="VarId">boolean</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="VarId">cascade</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'selected_piece'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'selected_piece'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>
<span class="Comment">-- piece key from current wizards army, empty otherwise</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">restrict_cardinality</span><span class="Symbol">(</span><span class="Char">'selected_piece'</span><span class="Symbol">,</span> <span class="Number">1</span><span class="Symbol">);</span>


<span class="Comment">/*</span>

<span class="Comment">squares left to walk is local to the current moving piece during</span>
<span class="Comment">its walking phase, not used if piece is not a walker.</span>

<span class="Alert">TODO:</span><span class="Comment"> this doesn't take into account e.g. move of 3 squares, move</span>
<span class="Comment">diagonal, second diagonal move all move used up, can't do three</span>
<span class="Comment">diagonal moves.</span>

<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_selected_piece_card&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_selected_piece_card</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_selected_piece_card'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;selected_piece_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">selected_piece_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_selected_piece_card</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint selected_piece_card'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'selected_piece_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">selected_piece_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">selected_piece</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">selected_piece_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'selected_piece_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'remaining_walk'</span><span class="Symbol">,</span> <span class="Char">'int'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;remaining_walk_table&quot; [(&quot;remaining_walk&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">remaining_walk_table</span> <span class="Symbol">(</span>
  <span class="VarId">remaining_walk</span> <span class="Type">int</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'remaining_walk_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_remaining_walk&quot; [] (ScalarType &quot;int4&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_remaining_walk</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">int</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">remaining_walk_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_remaining_walk'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_remaining_walk_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_remaining_walk_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">remaining_walk_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_remaining_walk_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;remaining_walk_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">remaining_walk_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_remaining_walk_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint remaining_walk_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'remaining_walk_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">remaining_walk_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">remaining_walk_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">remaining_walk_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'remaining_walk_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'remaining_walk_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'remaining_walk_hack'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;remaining_walk_hack_table&quot; [(&quot;remaining_walk_hack&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">remaining_walk_hack_table</span> <span class="Symbol">(</span>
  <span class="VarId">remaining_walk_hack</span> <span class="VarId">boolean</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'remaining_walk_hack_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_remaining_walk_hack&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_remaining_walk_hack</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">remaining_walk_hack_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_remaining_walk_hack'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_remaining_walk_hack_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_remaining_walk_hack_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">remaining_walk_hack_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_remaining_walk_hack_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;remaining_walk_hack_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">remaining_walk_hack_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_remaining_walk_hack_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint remaining_walk_hack_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'remaining_walk_hack_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">remaining_walk_hack_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">remaining_walk_hack_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">remaining_walk_hack_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'remaining_walk_hack_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'remaining_walk_hack_table'</span><span class="Symbol">,</span> <span class="Char">'hack'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">remaining_walk_hack_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span>

<span class="Comment">/*select create_assertion('remaining_walk_only_motion',</span>
<span class="Comment">$$ ((not exists(select 1 from remaining_walk_table)) or</span>
<span class="Comment">   ((select creating_new_game from creating_new_game_table)</span>
<span class="Comment">    or (select remaining_walk_hack from remaining_walk_hack_table)</span>
<span class="Comment">    or (exists(select 1 from selected_piece)</span>
<span class="Comment">        and (select move_phase = 'motion' from selected_piece)</span>
<span class="Comment">        and exists (select 1 from creature_pieces</span>
<span class="Comment">                    natural inner join selected_piece)</span>
<span class="Comment">        and (select not flying from creature_pieces</span>
<span class="Comment">             natural inner join selected_piece))) $$);*/</span>

<span class="Comment">--this function is used to initialise the turn phase data.</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;init_turn_stuff&quot; [] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">init_turn_stuff</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Comment">--this should catch attempts to start a game</span>
  <span class="Comment">--which has already been started</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">turn_number_table</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'new game started when turn number table not empty'</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">turn_number_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">);</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">turn_phase_table</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'choose'</span><span class="Symbol">);</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">current_wizard_table</span>
    <span class="Keyword">select</span> <span class="VarId">wizard_name</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span> <span class="Comment">-- not sure why this is needed</span>
    <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">original_place</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*</span>

<span class="Comment">table to cache if the game is over: someone has one or it's a draw.</span>
<span class="Comment">(This also makes it possible to have a draw when there are wizards</span>
<span class="Comment">remaining.)</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'init_turn_stuff'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'game_completed'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;game_completed_table&quot; [(&quot;game_completed&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">game_completed_table</span> <span class="Symbol">(</span>
  <span class="VarId">game_completed</span> <span class="VarId">boolean</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'game_completed_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_game_completed&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_game_completed</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_game_completed'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_game_completed_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_game_completed_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_game_completed_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;game_completed_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">game_completed_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_game_completed_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint game_completed_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'game_completed_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">game_completed_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">game_completed_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">game_completed_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'game_completed_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'game_completed_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>
<span class="Comment">/*select create_assertion('game_completed_wizards',</span>
<span class="Comment">       $$(not exists(select 1 from game_completed_table)</span>
<span class="Comment">           or (select count(1) &lt;= 1 from live_wizards))$$);*/</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">game_completed</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">game_completed_table</span>
    <span class="Keyword">select</span> <span class="VarId">true</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;game_completed&quot; [] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">game_completed</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">game_completed_table</span>
  <span class="Keyword">select</span> <span class="VarId">true</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                          <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">)))</span>
  <span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'game_completed'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
