<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >NewGame</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >/* = new game == wizard starting positions Wizards start the game in positions set by how many wizards there are in a game:</p
    ><p
    >These figures are only valid iff there are 2-8 wizards and the board is 15 x 10.</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.NewGame'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">wizard_starting_positions</span> <span class="Symbol">(</span>
  <span class="VarId">wizard_count</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">place</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">y</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">wizard_count</span><span class="Symbol">,</span> <span class="VarId">place</span><span class="Symbol">),</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">wizard_count</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'wizard_starting_positions'</span><span class="Symbol">,</span> <span class="Char">'readonly'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'wizard_starting_positions_place_valid'</span><span class="Symbol">,</span>
  '<span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">wizard_starting_positions</span>
    <span class="Keyword">where</span> <span class="VarId">place</span> <span class="Symbol">&gt;=</span> <span class="VarId">wizard_count</span><span class="Symbol">)</span>'<span class="Symbol">);</span>

<span class="Keyword">copy</span> <span class="VarId">wizard_starting_positions</span> <span class="Symbol">(</span><span class="VarId">wizard_count</span><span class="Symbol">,</span> <span class="VarId">place</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="Keyword">stdin</span><span class="Symbol">;</span>
<span class="Number">2</span>	<span class="Number">0</span>	<span class="Number">1</span>	<span class="Number">4</span>
<span class="Number">2</span>	<span class="Number">1</span>	<span class="Number">13</span>	<span class="Number">4</span>
<span class="Number">3</span>	<span class="Number">0</span>	<span class="Number">7</span>	<span class="Number">1</span>
<span class="Number">3</span>	<span class="Number">1</span>	<span class="Number">1</span>	<span class="Number">8</span>
<span class="Number">3</span>	<span class="Number">2</span>	<span class="Number">13</span>	<span class="Number">8</span>
<span class="Number">4</span>	<span class="Number">0</span>	<span class="Number">1</span>	<span class="Number">1</span>
<span class="Number">4</span>	<span class="Number">1</span>	<span class="Number">13</span>	<span class="Number">1</span>
<span class="Number">4</span>	<span class="Number">2</span>	<span class="Number">1</span>	<span class="Number">8</span>
<span class="Number">4</span>	<span class="Number">3</span>	<span class="Number">13</span>	<span class="Number">8</span>
<span class="Number">5</span>	<span class="Number">0</span>	<span class="Number">7</span>	<span class="Number">0</span>
<span class="Number">5</span>	<span class="Number">1</span>	<span class="Number">0</span>	<span class="Number">3</span>
<span class="Number">5</span>	<span class="Number">2</span>	<span class="Number">14</span>	<span class="Number">3</span>
<span class="Number">5</span>	<span class="Number">3</span>	<span class="Number">3</span>	<span class="Number">9</span>
<span class="Number">5</span>	<span class="Number">4</span>	<span class="Number">11</span>	<span class="Number">9</span>
<span class="Number">6</span>	<span class="Number">0</span>	<span class="Number">7</span>	<span class="Number">0</span>
<span class="Number">6</span>	<span class="Number">1</span>	<span class="Number">0</span>	<span class="Number">1</span>
<span class="Number">6</span>	<span class="Number">2</span>	<span class="Number">14</span>	<span class="Number">1</span>
<span class="Number">6</span>	<span class="Number">3</span>	<span class="Number">0</span>	<span class="Number">8</span>
<span class="Number">6</span>	<span class="Number">4</span>	<span class="Number">14</span>	<span class="Number">8</span>
<span class="Number">6</span>	<span class="Number">5</span>	<span class="Number">7</span>	<span class="Number">9</span>
<span class="Number">7</span>	<span class="Number">0</span>	<span class="Number">7</span>	<span class="Number">0</span>
<span class="Number">7</span>	<span class="Number">1</span>	<span class="Number">1</span>	<span class="Number">1</span>
<span class="Number">7</span>	<span class="Number">2</span>	<span class="Number">13</span>	<span class="Number">1</span>
<span class="Number">7</span>	<span class="Number">3</span>	<span class="Number">0</span>	<span class="Number">6</span>
<span class="Number">7</span>	<span class="Number">4</span>	<span class="Number">14</span>	<span class="Number">6</span>
<span class="Number">7</span>	<span class="Number">5</span>	<span class="Number">4</span>	<span class="Number">9</span>
<span class="Number">7</span>	<span class="Number">6</span>	<span class="Number">10</span>	<span class="Number">9</span>
<span class="Number">8</span>	<span class="Number">0</span>	<span class="Number">0</span>	<span class="Number">0</span>
<span class="Number">8</span>	<span class="Number">1</span>	<span class="Number">7</span>	<span class="Number">0</span>
<span class="Number">8</span>	<span class="Number">2</span>	<span class="Number">14</span>	<span class="Number">0</span>
<span class="Number">8</span>	<span class="Number">3</span>	<span class="Number">0</span>	<span class="Number">4</span>
<span class="Number">8</span>	<span class="Number">4</span>	<span class="Number">14</span>	<span class="Number">4</span>
<span class="Number">8</span>	<span class="Number">5</span>	<span class="Number">0</span>	<span class="Number">9</span>
<span class="Number">8</span>	<span class="Number">6</span>	<span class="Number">7</span>	<span class="Number">9</span>
<span class="Number">8</span>	<span class="Number">7</span>	<span class="Number">14</span>	<span class="Number">9</span>
\<span class="Symbol">.</span>

</pre></div></div></div><p
    >/* == new game action */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">type</span> <span class="VarId">new_game_t</span> <span class="Keyword">as</span> <span class="Symbol">(</span>
  <span class="VarId">place</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">wizard_name</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">computer_controlled</span> <span class="VarId">boolean</span>
<span class="Symbol">);</span>
<span class="Comment">--select set_relvar_type('action_new_game_argument', 'stack');</span>

</pre></div></div></div><p
    >/<em
      >select create_assertion('action_new_game_argument_place_valid', '(select count(</em
      >) from action_new_game_argument where place &gt;= (select count(<em
      >) from action_new_game_argument)) = 0');</em
      >/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">spell_indexes_no_dis_turm</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">row_number</span><span class="Symbol">()</span> <span class="Keyword">over</span><span class="Symbol">()</span> <span class="Keyword">as</span> <span class="VarId">row_number</span><span class="Symbol">,</span><span class="VarId">spell_name</span>
    <span class="Keyword">from</span> <span class="VarId">spells_mr</span>
    <span class="Keyword">where</span> <span class="VarId">spell_name</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'disbelieve'</span><span class="Symbol">,</span> <span class="Char">'turmoil'</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/<em
      >insert into spell_indexes_no_dis_turm (spell_name) select spell_name from spells_mr where spell_name not in ('disbelieve', 'turmoil');</em
      >/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
    >/* row_number serial unique, spell_name text */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
    >/* new game action - fill in action_new_game_argument first</p
    ><p
    >we have all these init functions for each table, which naturally sit next to that table's definition, we then have to put them together here in the right order without missing any - looking for a better way to do this. at the very least we could tag the init functions and make sure they're all called. I wonder if transclusion could help here? What about situations where you have say 100 tables, and you want to reinitialized 20 of them, maybe a different non overlapping20 each time, so we don't just have one set of init functions? Not sure if these ideas are going anywhere.</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_new_game</span><span class="Symbol">(</span><span class="VarId">ar</span> <span class="VarId">new_game_t</span><span class="Symbol">[])</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">record</span><span class="Symbol">;</span>
  <span class="VarId">t</span> <span class="Type">int</span><span class="Symbol">;</span>
<span class="VarId">begin</span>

  <span class="Keyword">update</span> <span class="VarId">creating_new_game_table</span> <span class="Keyword">set</span> <span class="VarId">creating_new_game</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">;</span>
  <span class="Comment">--assert: all tables tagged data are in this delete list</span>
  <span class="Comment">--(only need base table of entities since these cascade)</span>
  <span class="Comment">-- tables are in order of dependencies so delete sequence works</span>

  <span class="Comment">-- clear data tables</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">action_history_mr</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">setval</span><span class="Symbol">(</span><span class="Char">'action_history_mr_id_seq'</span><span class="Symbol">,</span> <span class="Number">1</span><span class="Symbol">);</span>

  <span class="Comment">--turn data</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">cast_alignment_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">remaining_walk_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">pieces_moved</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">spell_parts_to_cast_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">turn_number_table</span><span class="Symbol">;</span>
  <span class="Comment">--piece data</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">spell_books</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">imaginary_pieces</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">pieces</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">wizards</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">board_size</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">world_alignment_table</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">disable_spreading_table</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">disable_spreading_table</span> <span class="Keyword">values</span><span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span>
  <span class="VarId">else</span>
    <span class="Keyword">update</span> <span class="VarId">disable_spreading_table</span>
       <span class="Keyword">set</span> <span class="VarId">disable_spreading</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Comment">--reset the overrides when starting new game</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">test_action_overrides</span><span class="Symbol">;</span>

  <span class="Comment">--assert: call init_ for each data table, make sure order is good</span>

  <span class="Keyword">perform</span> <span class="VarId">init_world_alignment</span><span class="Symbol">();</span>
  <span class="Keyword">perform</span> <span class="VarId">init_board_size</span><span class="Symbol">();</span>

  <span class="Comment">--create wizards</span>
  <span class="Comment">--  wizard table</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">wizards</span> <span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">computer_controlled</span><span class="Symbol">,</span> <span class="VarId">original_place</span><span class="Symbol">)</span>
    <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">computer_controlled</span><span class="Symbol">,</span> <span class="VarId">place</span>
      <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">ar</span><span class="Symbol">);</span>
  <span class="Comment">--  pieces</span>
  <span class="VarId">t</span> <span class="Symbol">:=</span> <span class="VarId">array_length</span><span class="Symbol">(</span><span class="VarId">ar</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">);</span> <span class="Comment">--(select count(*) from action_new_game_argument);</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">pieces</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">select</span> <span class="Char">'wizard'</span><span class="Symbol">,</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="Number">0</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span>
      <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">ar</span><span class="Symbol">)</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizard_starting_positions</span>
       <span class="Keyword">where</span> <span class="VarId">wizard_count</span> <span class="Symbol">=</span> <span class="VarId">t</span><span class="Symbol">;</span>
  <span class="Comment">--  spell books</span>
  <span class="Comment">--init spell book</span>
  <span class="Comment">-- disbelieve plus 19 {random spells not disbelieve or turmoil}</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">spell_books</span> <span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">)</span>
    <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="Char">'disbelieve'</span>
      <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">ar</span><span class="Symbol">);</span>

  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">spell_books</span> <span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">)</span>
    <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">spell_name</span>
      <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">ar</span><span class="Symbol">)</span>
      <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">line</span><span class="Symbol">,</span> <span class="VarId">spell_name</span>
                  <span class="Keyword">from</span> <span class="VarId">spell_indexes_no_dis_turm</span>
                  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">makeNRandoms</span><span class="Symbol">(</span><span class="VarId">t</span> <span class="Symbol">*</span> <span class="Number">19</span><span class="Symbol">,</span> <span class="Number">53</span><span class="Symbol">)</span>
                    <span class="Keyword">on</span> <span class="VarId">row_number</span> <span class="Symbol">=</span> <span class="VarId">num</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
      <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">line</span><span class="Symbol">/</span><span class="Number">19</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">place</span><span class="Symbol">;</span>
  <span class="Comment">--sanity check that bad boy</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">count</span><span class="Symbol">(</span><span class="VarId">spell_name</span><span class="Symbol">)</span>
                           <span class="Keyword">from</span> <span class="VarId">spell_books</span> <span class="Keyword">group</span> <span class="Keyword">by</span> <span class="VarId">wizard_name</span>
                          <span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span> <span class="Keyword">where</span> <span class="VarId">count</span> <span class="Symbol">&lt;&gt;</span> <span class="Number">20</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'miscount in initial spell books'</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Comment">--turn stuff</span>
  <span class="Keyword">perform</span> <span class="VarId">init_turn_stuff</span><span class="Symbol">();</span>

  </pre></div></div></div><p
    >/* data tables with no init because they are empty at start of game piece sub entities action_history and sub entities wizard spell choices, pieces to move, current moving piece */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Keyword">perform</span> <span class="VarId">add_history_new_game</span><span class="Symbol">();</span>

  <span class="Keyword">update</span> <span class="VarId">creating_new_game_table</span> <span class="Keyword">set</span> <span class="VarId">creating_new_game</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>

<span class="VarId">end</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
