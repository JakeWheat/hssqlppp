<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Pieces.sql transformed</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Comment">/*</span>
<span class="Comment">Pieces</span>
<span class="Comment">======</span>

<span class="Comment">piece natural keys</span>
<span class="Comment">------------------</span>

<span class="Comment">We use a three part natural key for pieces, consisting of the ptype</span>
<span class="Comment">from the piece prototypes table, the allegiance i.e. which wizard they</span>
<span class="Comment">belong to, and a number to distinguish between pieces with the same</span>
<span class="Comment">first two values, e.g. if a wizard casts two goblins. All pieces are</span>
<span class="Comment">owned by a wizard, with the exception of corpses, so we create an</span>
<span class="Comment">allegiance view which is all the wizard names plus dead.</span>

<span class="Comment">The numbers, called tags in the code, start at 0, and a piece is</span>
<span class="Comment">assigned the next number to make their key unique. We don't renumber,</span>
<span class="Comment">so there can be gaps when creatures die. The spell subversion can</span>
<span class="Comment">cause a piece to change allegiance, they are always be assigned a new</span>
<span class="Comment">tag when this happens. When a corpse is created, it is assigned a</span>
<span class="Comment">fresh tag - its allegiance is changed to dead and its ptype stays the</span>
<span class="Comment">same.</span>

<span class="Comment">relvars</span>
<span class="Comment">-------</span>

<span class="Comment">*/</span>
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">);</span>

<span class="Comment">--pieces are either a member of a particular wizard's army or</span>
<span class="Comment">-- they are dead, in which case they are not a member of</span>
<span class="Comment">-- any wizard's army</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;allegiances&quot; [(&quot;allegiance&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">allegiances</span> <span class="VarId">as</span>
   <span class="Keyword">select</span> <span class="VarId">wizard_name</span> <span class="Keyword">as</span> <span class="VarId">allegiance</span> <span class="Keyword">from</span> <span class="VarId">wizards</span>
     <span class="Keyword">where</span> <span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">false</span>
   <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'dead'</span> <span class="Keyword">as</span> <span class="VarId">allegiance</span><span class="Symbol">;</span>

<span class="Comment">/*</span>

<span class="Comment">I think all the ways stats can change from the prototypes are listed</span>
<span class="Comment">here:</span>
<span class="Comment">monster raised from the dead</span>
<span class="Comment">wizard with upgrade</span>

<span class="Comment">err... that's it.</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'allegiances'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">pieces</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">piece_prototypes_mr</span><span class="Symbol">,</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="Comment">-- references allegiances where wizard is not dead</span>
                     <span class="Comment">-- needs extended constraint support to 'fk' to view</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
<span class="Comment">--Piece is on the board at grid position 'x', 'y'.</span>
    <span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="VarId">y</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">primary</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span>
<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;pieces&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;),(&quot;x&quot;,ScalarType &quot;int4&quot;),(&quot;y&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">pieces</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">references</span> <span class="VarId">piece_prototypes_mr</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">tag</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">x</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">y</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="Keyword">primary</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'pieces'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Comment">-- piece must be on the board</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'piece_coordinates_valid'</span><span class="Symbol">,</span>
  ' <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
  <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">board_size</span>
  <span class="Keyword">where</span> <span class="VarId">x</span> <span class="Symbol">&gt;=</span> <span class="VarId">width</span> <span class="Keyword">or</span> <span class="VarId">y</span> <span class="Symbol">&gt;=</span> <span class="VarId">height</span><span class="Symbol">)</span>'<span class="Symbol">);</span>

<span class="Comment">--temporary constraint while 'fks' to non base relvars are buggy</span>
<span class="Comment">-- this won't be needed once the extension is done and the reference is</span>
<span class="Comment">-- added to the pieces table above</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_piece_coordinates_valid&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_piece_coordinates_valid</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                         <span class="Keyword">from</span> <span class="Symbol">(</span><span class="VarId">pieces</span>
                               <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">board_size</span><span class="Symbol">)</span>
                         <span class="Keyword">where</span> <span class="Symbol">((</span><span class="VarId">x</span> <span class="Symbol">&gt;=</span> <span class="VarId">width</span><span class="Symbol">)</span> <span class="Keyword">or</span> <span class="Symbol">(</span><span class="VarId">y</span> <span class="Symbol">&gt;=</span> <span class="VarId">height</span><span class="Symbol">)))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_piece_coordinates_valid'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;pieces_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">pieces_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_piece_coordinates_valid</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint piece_coordinates_valid'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">pieces_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">pieces</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">pieces_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;board_size_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">board_size_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_piece_coordinates_valid</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint piece_coordinates_valid'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_board_size_card</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint board_size_card'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'board_size_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'dead_wizard_army_empty'</span><span class="Symbol">,</span>
  $$ <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span>
    <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span><span class="Symbol">)</span>
    <span class="Keyword">where</span> <span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>

<span class="Comment">-- these is used in functions for</span>
<span class="Comment">-- parameters and local variables.</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_dead_wizard_army_empty&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_dead_wizard_army_empty</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
                         <span class="Keyword">from</span> <span class="Symbol">(</span><span class="VarId">pieces</span>
                               <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span> <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span><span class="Symbol">))</span>
                         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">))));</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_dead_wizard_army_empty'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;pieces_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">pieces_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_dead_wizard_army_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint dead_wizard_army_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_piece_coordinates_valid</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint piece_coordinates_valid'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;wizards_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">or</span> <span class="Keyword">replace</span> <span class="Keyword">function</span> <span class="VarId">wizards_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_dead_wizard_army_empty</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint dead_wizard_army_empty'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_no_spells_for_stiffs</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint no_spells_for_stiffs'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizards_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateComposite &quot;piece_key&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">type</span> <span class="VarId">piece_key</span> <span class="Keyword">as</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">tag</span> <span class="VarId">int</span>
<span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'piece_key'</span><span class="Symbol">,</span><span class="Char">'type'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateComposite &quot;pos&quot; [(&quot;x&quot;,ScalarType &quot;int4&quot;),(&quot;y&quot;,ScalarType &quot;int4&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">type</span> <span class="VarId">pos</span> <span class="Keyword">as</span> <span class="Symbol">(</span>
  <span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">y</span> <span class="VarId">int</span>
<span class="Symbol">);</span>

<span class="Comment">/*</span>

<span class="Comment">add two auxiliary tables to track imaginary monsters and raised</span>
<span class="Comment">monsters who are now undead</span>
<span class="Comment">(only monster pieces can be imaginary or raised).</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pos'</span><span class="Symbol">,</span><span class="Char">'type'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">imaginary_pieces</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="Comment">-- reference monster_prototypes (fk to view)</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
    <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;imaginary_pieces&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">imaginary_pieces</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">tag</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="VarId">cascade</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'imaginary_pieces'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'imaginary_pieces'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">crimes_against_nature</span><span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>  <span class="Comment">-- reference monster_prototypes (fk to view)</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
    <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;crimes_against_nature&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">crimes_against_nature</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="VarId">tag</span> <span class="Type">int</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span> <span class="Keyword">on</span> <span class="Keyword">update</span> <span class="Keyword">cascade</span> <span class="Keyword">on</span> <span class="Keyword">delete</span> <span class="VarId">cascade</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'crimes_against_nature'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'crimes_against_nature'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Comment">/*</span>

<span class="Comment">This is the auxiliary view which takes the base wizard stats, and</span>
<span class="Comment">adjusts them according to the upgrade spells that the wizard has</span>
<span class="Comment">active.</span>

<span class="Comment">We should try to apply the same null combo constraints that the</span>
<span class="Comment">piece_prototypes table has.</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;wizard_upgrade_stats&quot; [(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;),(&quot;x&quot;,ScalarType &quot;int4&quot;),(&quot;y&quot;,ScalarType &quot;int4&quot;),(&quot;imaginary&quot;,ScalarType &quot;bool&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizard_upgrade_stats</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="VarId">pp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span>
       <span class="VarId">allegiance</span><span class="Symbol">,</span>
       <span class="VarId">tag</span><span class="Symbol">,</span>
       <span class="VarId">x</span><span class="Symbol">,</span>
       <span class="VarId">y</span><span class="Symbol">,</span>
       <span class="VarId">false</span> <span class="Keyword">as</span> <span class="VarId">imaginary</span><span class="Symbol">,</span>
       <span class="VarId">magic_wings</span> <span class="Keyword">as</span> <span class="VarId">flying</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_wings</span> <span class="Keyword">then</span> <span class="Number">6</span>
            <span class="Keyword">when</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="Number">3</span>
            <span class="Keyword">else</span> <span class="VarId">speed</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">speed</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">agility</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">else</span> <span class="VarId">agility</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">agility</span><span class="Symbol">,</span>
       <span class="VarId">undead</span><span class="Symbol">,</span>
       <span class="VarId">ridable</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_bow</span> <span class="Keyword">then</span> <span class="Char">'projectile'</span>
            <span class="Keyword">else</span> <span class="VarId">null</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">ranged_weapon_type</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_bow</span> <span class="Keyword">then</span> <span class="Number">6</span>
            <span class="Keyword">else</span> <span class="VarId">null</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="Keyword">range</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_bow</span> <span class="Keyword">then</span> <span class="Number">6</span>
            <span class="Keyword">else</span> <span class="VarId">null</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">ranged_attack_strength</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_sword</span> <span class="Keyword">then</span> <span class="VarId">attack_strength</span> <span class="Symbol">+</span> <span class="Number">4</span>
            <span class="Keyword">when</span> <span class="VarId">magic_knife</span> <span class="Keyword">then</span> <span class="VarId">attack_strength</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">else</span> <span class="VarId">attack_strength</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">attack_strength</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_armour</span> <span class="Keyword">and</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">6</span>
            <span class="Keyword">when</span> <span class="VarId">magic_shield</span> <span class="Keyword">and</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">4</span>
            <span class="Keyword">when</span> <span class="VarId">magic_armour</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">4</span>
            <span class="Keyword">when</span> <span class="VarId">magic_shield</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">when</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">else</span> <span class="VarId">physical_defense</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">physical_defense</span><span class="Symbol">,</span>
       <span class="VarId">magic_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="VarId">p</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span>
    <span class="Keyword">on</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">piece_prototypes_mr</span> <span class="VarId">pp</span>
    <span class="Keyword">on</span> <span class="VarId">pp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span>
  <span class="Keyword">where</span> <span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>

<span class="Comment">/*</span>

<span class="Comment">This is the main piece information table, which mirrors the</span>
<span class="Comment">information in the piece_prototypes table for each actual piece, with</span>
<span class="Comment">modifications where needed.</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizard_upgrade_stats'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">pieces_mr</span> <span class="VarId">as</span>

<span class="Comment">-- first we do all the non wizard pieces, we only need to adjust the</span>
<span class="Comment">-- piece_prototype data by adding an imaginary attribute, and setting</span>
<span class="Comment">-- the undead attribute also for raised monsters.</span>

<span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span>
       <span class="VarId">allegiance</span><span class="Symbol">,</span>
       <span class="VarId">tag</span><span class="Symbol">,</span>
       <span class="VarId">x</span><span class="Symbol">,</span>
       <span class="VarId">y</span><span class="Symbol">,</span>
       <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">imaginary</span>
                <span class="Comment">-- this makes sure all the monster pieces have their</span>
                <span class="Comment">-- imaginary set to false if they aren't imaginary</span>
                <span class="Comment">-- and all non monster pieces have null for imaginary</span>
               <span class="Symbol">,</span><span class="Keyword">case</span> <span class="Keyword">when</span> <span class="Keyword">not</span> <span class="VarId">ridable</span> <span class="VarId">is</span> <span class="VarId">null</span>
                     <span class="Keyword">then</span> <span class="VarId">false</span>
                     <span class="Keyword">else</span> <span class="VarId">null</span>
                <span class="Keyword">end</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">imaginary</span><span class="Symbol">,</span>
       <span class="VarId">flying</span><span class="Symbol">,</span>
       <span class="VarId">speed</span><span class="Symbol">,</span>
       <span class="VarId">agility</span><span class="Symbol">,</span>
       <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">raised</span><span class="Symbol">,</span> <span class="VarId">undead</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">undead</span><span class="Symbol">,</span>
       <span class="VarId">ridable</span><span class="Symbol">,</span>
       <span class="VarId">ranged_weapon_type</span><span class="Symbol">,</span>
       <span class="Keyword">range</span><span class="Symbol">,</span>
       <span class="VarId">ranged_attack_strength</span><span class="Symbol">,</span>
       <span class="VarId">attack_strength</span><span class="Symbol">,</span>
       <span class="VarId">physical_defense</span><span class="Symbol">,</span>
       <span class="VarId">magic_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces</span>
  <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">piece_prototypes_mr</span>
  <span class="Keyword">natural</span> <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*,</span><span class="VarId">true</span> <span class="Keyword">as</span> <span class="VarId">imaginary</span>
                           <span class="Keyword">from</span> <span class="VarId">imaginary_pieces</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
  <span class="Keyword">natural</span> <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*,</span><span class="VarId">true</span> <span class="Keyword">as</span> <span class="VarId">raised</span>
                           <span class="Keyword">from</span> <span class="VarId">crimes_against_nature</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">b</span>
  <span class="Keyword">where</span> <span class="VarId">ptype</span> <span class="Symbol">&lt;&gt;</span> <span class="Char">'wizard'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Comment">-- then we add in the wizards, which need the more involved</span>
<span class="Comment">-- calculations in the wizard_upgrade_stats table.</span>
<span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">wizard_upgrade_stats</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_mr'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;creature_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">creature_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">flying</span><span class="Symbol">,</span><span class="VarId">speed</span><span class="Symbol">,</span><span class="VarId">agility</span>
    <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">flying</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">speed</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">agility</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'creature_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;monster_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">monster_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">flying</span><span class="Symbol">,</span><span class="VarId">speed</span><span class="Symbol">,</span><span class="VarId">agility</span><span class="Symbol">,</span>
    <span class="VarId">undead</span><span class="Symbol">,</span><span class="VarId">ridable</span><span class="Symbol">,</span><span class="VarId">imaginary</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">flying</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">speed</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">agility</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">undead</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">ridable</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'monster_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;dead_monster_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">dead_monster_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">monster_pieces</span>
    <span class="Keyword">where</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="Char">'dead'</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'dead_monster_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;attacking_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">attacking_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">attack_strength</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">attack_strength</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">allegiance</span> <span class="Symbol">&lt;&gt;</span> <span class="Char">'dead'</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'attacking_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;ranged_weapon_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">ranged_weapon_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">ranged_weapon_type</span><span class="Symbol">,</span><span class="Keyword">range</span><span class="Symbol">,</span><span class="VarId">ranged_attack_strength</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">ranged_weapon_type</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="Keyword">range</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">ranged_attack_strength</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'ranged_weapon_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;attackable_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">attackable_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">physical_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">physical_defense</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'attackable_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">magic_attackable_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">magic_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">magic_defense</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span>


<span class="Comment">/*</span>

<span class="Comment">Rules for multiple pieces on one square</span>

<span class="Comment">When multiple pieces occupy one square, one is considered to be 'on</span>
<span class="Comment">top'. This piece</span>
<span class="Comment">* is the one piece displayed in the UI currently</span>
<span class="Comment">* the piece upon which any spell cast on that square hits</span>
<span class="Comment">* the piece which is attacked when another piece attacks or range</span>
<span class="Comment">  attacks that square</span>

<span class="Comment">The options are:</span>

<span class="Comment">1 item</span>
<span class="Comment">any</span>
<span class="Comment">2 items</span>
<span class="Comment">creature, stiff : creature on top</span>
<span class="Comment">wizard, mountable monster: mountable monster on top</span>
<span class="Comment">wizard, box : box on top</span>
<span class="Comment">stiff, gooey blob : blob on top</span>
<span class="Comment">monster, gooey blob : blob on top</span>
<span class="Comment">3 items</span>
<span class="Comment">wizard, stiff, mountable monster : mountable on top</span>
<span class="Comment">stiff, monster, blob : blob on top</span>

<span class="Comment">Can these be made into actual constraints - doesn't seem to difficult</span>
<span class="Comment">now the extension system gives us some help with the triggers and</span>
<span class="Comment">stuff. could use some ctes and it might come out alright? or use a</span>
<span class="Comment">function to procedurally do part of it? want something that can be</span>
<span class="Comment">understood.</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateView &quot;magic_attackable_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">magic_attackable_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">magic_defense</span>
    <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">magic_defense</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'magic_attackable_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
