<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Pieces</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >/* Pieces ======</p
    ><div id="piece-natural-keys"
    ><h2
      >piece natural keys</h2
      ><p
      >We use a three part natural key for pieces, consisting of the ptype from the piece prototypes table, the allegiance i.e. which wizard they belong to, and a number to distinguish between pieces with the same first two values, e.g. if a wizard casts two goblins. All pieces are owned by a wizard, with the exception of corpses, so we create an allegiance view which is all the wizard names plus dead.</p
      ><p
      >The numbers, called tags in the code, start at 0, and a piece is assigned the next number to make their key unique. We don't renumber, so there can be gaps when creatures die. The spell subversion can cause a piece to change allegiance, they are always be assigned a new tag when this happens. When a corpse is created, it is assigned a fresh tag - its allegiance is changed to dead and its ptype stays the same.</p
      ></div
    ><div id="relvars"
    ><h2
      >relvars</h2
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Pieces'</span><span class="Symbol">);</span>

<span class="Comment">--pieces are either a member of a particular wizard's army or</span>
<span class="Comment">-- they are dead, in which case they are not a member of</span>
<span class="Comment">-- any wizard's army</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">allegiances</span> <span class="VarId">as</span>
   <span class="Keyword">select</span> <span class="VarId">wizard_name</span> <span class="Keyword">as</span> <span class="VarId">allegiance</span> <span class="Keyword">from</span> <span class="VarId">wizards</span>
     <span class="Keyword">where</span> <span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">false</span>
   <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'dead'</span> <span class="Keyword">as</span> <span class="VarId">allegiance</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >I think all the ways stats can change from the prototypes are listed here: monster raised from the dead wizard with upgrade</p
      ><p
      >err... that's it.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">pieces</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">piece_prototypes_mr</span><span class="Symbol">,</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="Comment">-- references allegiances where wizard is not dead</span>
                     <span class="Comment">-- needs extended constraint support to 'fk' to view</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
<span class="Comment">--Piece is on the board at grid position 'x', 'y'.</span>
    <span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="VarId">y</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">primary</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'pieces'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Comment">-- piece must be on the board</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'piece_coordinates_valid'</span><span class="Symbol">,</span>
  ' <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
  <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">board_size</span>
  <span class="Keyword">where</span> <span class="VarId">x</span> <span class="Symbol">&gt;=</span> <span class="VarId">width</span> <span class="Keyword">or</span> <span class="VarId">y</span> <span class="Symbol">&gt;=</span> <span class="VarId">height</span><span class="Symbol">)</span>'<span class="Symbol">);</span>

<span class="Comment">--temporary constraint while 'fks' to non base relvars are buggy</span>
<span class="Comment">-- this won't be needed once the extension is done and the reference is</span>
<span class="Comment">-- added to the pieces table above</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'dead_wizard_army_empty'</span><span class="Symbol">,</span>
  $$ <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span>
    <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span><span class="Symbol">)</span>
    <span class="Keyword">where</span> <span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>

<span class="Comment">-- these is used in functions for</span>
<span class="Comment">-- parameters and local variables.</span>
<span class="Keyword">create</span> <span class="Keyword">type</span> <span class="VarId">piece_key</span> <span class="Keyword">as</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">tag</span> <span class="VarId">int</span>
<span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">type</span> <span class="VarId">pos</span> <span class="Keyword">as</span> <span class="Symbol">(</span>
  <span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">y</span> <span class="VarId">int</span>
<span class="Symbol">);</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >add two auxiliary tables to track imaginary monsters and raised monsters who are now undead (only monster pieces can be imaginary or raised).</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">imaginary_pieces</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="Comment">-- reference monster_prototypes (fk to view)</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
    <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'imaginary_pieces'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">crimes_against_nature</span><span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>  <span class="Comment">-- reference monster_prototypes (fk to view)</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
    <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'crimes_against_nature'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >This is the auxiliary view which takes the base wizard stats, and adjusts them according to the upgrade spells that the wizard has active.</p
      ><p
      >We should try to apply the same null combo constraints that the piece_prototypes table has.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizard_upgrade_stats</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="VarId">pp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span>
       <span class="VarId">allegiance</span><span class="Symbol">,</span>
       <span class="VarId">tag</span><span class="Symbol">,</span>
       <span class="VarId">x</span><span class="Symbol">,</span>
       <span class="VarId">y</span><span class="Symbol">,</span>
       <span class="VarId">false</span> <span class="Keyword">as</span> <span class="VarId">imaginary</span><span class="Symbol">,</span>
       <span class="VarId">magic_wings</span> <span class="Keyword">as</span> <span class="VarId">flying</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_wings</span> <span class="Keyword">then</span> <span class="Number">6</span>
            <span class="Keyword">when</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="Number">3</span>
            <span class="Keyword">else</span> <span class="VarId">speed</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">speed</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">agility</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">else</span> <span class="VarId">agility</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">agility</span><span class="Symbol">,</span>
       <span class="VarId">undead</span><span class="Symbol">,</span>
       <span class="VarId">ridable</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_bow</span> <span class="Keyword">then</span> <span class="Char">'projectile'</span>
            <span class="Keyword">else</span> <span class="VarId">null</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">ranged_weapon_type</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_bow</span> <span class="Keyword">then</span> <span class="Number">6</span>
            <span class="Keyword">else</span> <span class="VarId">null</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="Keyword">range</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_bow</span> <span class="Keyword">then</span> <span class="Number">6</span>
            <span class="Keyword">else</span> <span class="VarId">null</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">ranged_attack_strength</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_sword</span> <span class="Keyword">then</span> <span class="VarId">attack_strength</span> <span class="Symbol">+</span> <span class="Number">4</span>
            <span class="Keyword">when</span> <span class="VarId">magic_knife</span> <span class="Keyword">then</span> <span class="VarId">attack_strength</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">else</span> <span class="VarId">attack_strength</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">attack_strength</span><span class="Symbol">,</span>
       <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">magic_armour</span> <span class="Keyword">and</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">6</span>
            <span class="Keyword">when</span> <span class="VarId">magic_shield</span> <span class="Keyword">and</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">4</span>
            <span class="Keyword">when</span> <span class="VarId">magic_armour</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">4</span>
            <span class="Keyword">when</span> <span class="VarId">magic_shield</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">when</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">physical_defense</span> <span class="Symbol">+</span> <span class="Number">2</span>
            <span class="Keyword">else</span> <span class="VarId">physical_defense</span>
       <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">physical_defense</span><span class="Symbol">,</span>
       <span class="VarId">magic_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="VarId">p</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span>
    <span class="Keyword">on</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">piece_prototypes_mr</span> <span class="VarId">pp</span>
    <span class="Keyword">on</span> <span class="VarId">pp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span>
  <span class="Keyword">where</span> <span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >This is the main piece information table, which mirrors the information in the piece_prototypes table for each actual piece, with modifications where needed.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">pieces_mr</span> <span class="VarId">as</span>

<span class="Comment">-- first we do all the non wizard pieces, we only need to adjust the</span>
<span class="Comment">-- piece_prototype data by adding an imaginary attribute, and setting</span>
<span class="Comment">-- the undead attribute also for raised monsters.</span>

<span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span>
       <span class="VarId">allegiance</span><span class="Symbol">,</span>
       <span class="VarId">tag</span><span class="Symbol">,</span>
       <span class="VarId">x</span><span class="Symbol">,</span>
       <span class="VarId">y</span><span class="Symbol">,</span>
       <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">imaginary</span>
                <span class="Comment">-- this makes sure all the monster pieces have their</span>
                <span class="Comment">-- imaginary set to false if they aren't imaginary</span>
                <span class="Comment">-- and all non monster pieces have null for imaginary</span>
               <span class="Symbol">,</span><span class="Keyword">case</span> <span class="Keyword">when</span> <span class="Keyword">not</span> <span class="VarId">ridable</span> <span class="VarId">is</span> <span class="VarId">null</span>
                     <span class="Keyword">then</span> <span class="VarId">false</span>
                     <span class="Keyword">else</span> <span class="VarId">null</span>
                <span class="Keyword">end</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">imaginary</span><span class="Symbol">,</span>
       <span class="VarId">flying</span><span class="Symbol">,</span>
       <span class="VarId">speed</span><span class="Symbol">,</span>
       <span class="VarId">agility</span><span class="Symbol">,</span>
       <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">raised</span><span class="Symbol">,</span> <span class="VarId">undead</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">undead</span><span class="Symbol">,</span>
       <span class="VarId">ridable</span><span class="Symbol">,</span>
       <span class="VarId">ranged_weapon_type</span><span class="Symbol">,</span>
       <span class="Keyword">range</span><span class="Symbol">,</span>
       <span class="VarId">ranged_attack_strength</span><span class="Symbol">,</span>
       <span class="VarId">attack_strength</span><span class="Symbol">,</span>
       <span class="VarId">physical_defense</span><span class="Symbol">,</span>
       <span class="VarId">magic_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces</span>
  <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">piece_prototypes_mr</span>
  <span class="Keyword">natural</span> <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*,</span><span class="VarId">true</span> <span class="Keyword">as</span> <span class="VarId">imaginary</span>
                           <span class="Keyword">from</span> <span class="VarId">imaginary_pieces</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
  <span class="Keyword">natural</span> <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*,</span><span class="VarId">true</span> <span class="Keyword">as</span> <span class="VarId">raised</span>
                           <span class="Keyword">from</span> <span class="VarId">crimes_against_nature</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">b</span>
  <span class="Keyword">where</span> <span class="VarId">ptype</span> <span class="Symbol">&lt;&gt;</span> <span class="Char">'wizard'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Comment">-- then we add in the wizards, which need the more involved</span>
<span class="Comment">-- calculations in the wizard_upgrade_stats table.</span>
<span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">wizard_upgrade_stats</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">creature_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">flying</span><span class="Symbol">,</span><span class="VarId">speed</span><span class="Symbol">,</span><span class="VarId">agility</span>
    <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">flying</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">speed</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">agility</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">monster_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">flying</span><span class="Symbol">,</span><span class="VarId">speed</span><span class="Symbol">,</span><span class="VarId">agility</span><span class="Symbol">,</span>
    <span class="VarId">undead</span><span class="Symbol">,</span><span class="VarId">ridable</span><span class="Symbol">,</span><span class="VarId">imaginary</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">flying</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">speed</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">agility</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">undead</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">ridable</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">dead_monster_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">monster_pieces</span>
    <span class="Keyword">where</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="Char">'dead'</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">attacking_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">attack_strength</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">attack_strength</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">allegiance</span> <span class="Symbol">&lt;&gt;</span> <span class="Char">'dead'</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">ranged_weapon_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">ranged_weapon_type</span><span class="Symbol">,</span><span class="Keyword">range</span><span class="Symbol">,</span><span class="VarId">ranged_attack_strength</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">ranged_weapon_type</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="Keyword">range</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">ranged_attack_strength</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">attackable_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">physical_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">physical_defense</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">magic_attackable_pieces</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">magic_defense</span>
  <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">magic_defense</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">;</span>


</pre></div></div></div><p
      >/*</p
      ><p
      >Rules for multiple pieces on one square</p
      ><p
      >When multiple pieces occupy one square, one is considered to be 'on top'. This piece * is the one piece displayed in the UI currently * the piece upon which any spell cast on that square hits * the piece which is attacked when another piece attacks or range attacks that square</p
      ><p
      >The options are:</p
      ><p
      >1 item any 2 items creature, stiff : creature on top wizard, mountable monster: mountable monster on top wizard, box : box on top stiff, gooey blob : blob on top monster, gooey blob : blob on top 3 items wizard, stiff, mountable monster : mountable on top stiff, monster, blob : blob on top</p
      ><p
      >Can these be made into actual constraints - doesn't seem to difficult now the extension system gives us some help with the triggers and stuff. could use some ctes and it might come out alright? or use a function to procedurally do part of it? want something that can be understood.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
