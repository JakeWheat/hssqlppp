<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >TurnSequence</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >/*</p
    ><div id="turn-sequence"
    ><h1
      >turn sequence</h1
      ><p
      >For the player, there are three phases: choose spell, cast spell, move pieces; but for the computer there are four phases, the extra one is the autonomous phase in between casting and moving. In this phase magic fire and gooey blob spread, castles may disappear, and wizards may receive a new spell from a magic tree.</p
      ><p
      >There are lots of constraints in this section. They're probably more useful as documentation.</p
      ><p
      >One big takeaway from working with all this constraints is that you really need deferred constraints or multiple updates for anything more than basic constraints.</p
      ><p
      >Some of this stuff makes more sense when looking at the actions.</p
      ><p
      >Everything here seems to be obscured under all the boilerplate, looking for a better way. Maybe some annotations and the ability to create a diagram (maybe even an interactive one?)</p
      ><p
      >== ddl */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.TurnSequence'</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/* use this to simulate multiple updates: for a constraint which refers to multiple tables which get updated during an action_next_phase call, this will be set to true, false at all other times, so using this can defer constraint checking till the end of the action_next_phase call after all the relevant turn phase relvars have been updated. Don't forget to put in_next_phase_hack_table in the relvar list for the constraint.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'in_next_phase_hack'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">in_next_phase_hack_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'in_next_phase_hack_table'</span><span class="Symbol">,</span> <span class="Char">'hack'</span><span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'creating_new_game'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">creating_new_game_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">true</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'creating_new_game_table'</span><span class="Symbol">,</span> <span class="Char">'hack'</span><span class="Symbol">);</span>

<span class="Comment">--Turn number, starts at 0 goes up 1 each full turn, just used to provide</span>
<span class="Comment">--info on how long the game has been going.</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'turn_number'</span><span class="Symbol">,</span> <span class="Char">'int'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'turn_number_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/<em
	>select create_update_transition_tuple_constraint( 'turn_number_table', 'turn_number_change_valid', '(NEW.turn_number = OLD.turn_number + 1)');</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">no_deletes_inserts_except_new_game</span><span class="Symbol">(</span><span class="Char">'turn_number_table'</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/* turn phase must follow choose-cast-auto-move-choose-etc.</p
      ><p
      >wizard spell choices added row must be for current wizard, and in current wizard's spell book in choose phase removed row must be for current wizard in cast phase</p
      ><p
      >spell parts to cast pieces to move squares left to walk</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Comment">-- todo: use lag or lead window fn or something - make it a lot</span>
<span class="Comment">-- clearer?</span>
</pre></div></div></div><p
      >/<em
	>create view next_wizard as select wizard_name, new_wizard_name from (select wizard_name as new_wizard_name, place from live_wizards) as a inner join (select wizard_name, (place + 1) % (select max(place) + 1 from live_wizards) as old_place from live_wizards) as b on (place = old_place);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">next_wizard</span><span class="Symbol">(</span><span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
  <span class="VarId">with</span>
    <span class="VarId">doubled</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">original_place</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span>
       <span class="Keyword">union</span> <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">original_place</span> <span class="Symbol">+</span> <span class="Number">10</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span><span class="Symbol">)</span>
   <span class="Symbol">,</span><span class="VarId">nexts</span> <span class="VarId">as</span>
       <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">lead</span><span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">)</span>
                            <span class="Keyword">over</span><span class="Symbol">(</span><span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">original_place</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">n</span>
          <span class="Keyword">from</span> <span class="VarId">doubled</span><span class="Symbol">)</span>
  <span class="Keyword">select</span> <span class="VarId">n</span> <span class="Keyword">from</span> <span class="VarId">nexts</span> <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> $<span class="Number">1</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/<em
	>select next_wizard('Buddha'); select next_wizard('Kong Fuzi'); select next_wizard('Laozi'); select next_wizard('Moshe'); select next_wizard('Muhammad'); select next_wizard('Shiva'); select next_wizard('Yeshua'); select next_wizard('Zarathushthra');</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Comment">--current wizard is the wizard who's turn it is to do stuff in current phase</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'current_wizard'</span><span class="Symbol">,</span> <span class="Char">'text'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'current_wizard_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">alter</span> <span class="Keyword">table</span> <span class="VarId">current_wizard_table</span>
  <span class="Keyword">add</span> <span class="Keyword">constraint</span> <span class="VarId">current_wizard_fkey</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">wizards</span><span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">);</span>

<span class="Comment">-- could be no deletes, inserts - unless there is only one wizard left</span>
<span class="Comment">-- (to allow draws)</span>
<span class="Comment">--select no_deletes_inserts_except_new_game('current_wizard_table');</span>

<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'current_wizard_must_be_alive'</span><span class="Symbol">,</span>
  $$<span class="Symbol">(</span><span class="Keyword">select</span> <span class="Keyword">not</span> <span class="VarId">expired</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
     <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span> <span class="Keyword">on</span> <span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>

</pre></div></div></div><p
      >/* wizard field in most tables and views is named wizard_name</p
      ><p
      >instead of tediously writing out inner join blah on wizard_name = current_wizard use the following view to instead write natural inner join current_wizard . Not that much less tedious though.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">current_wizard</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">current_wizard</span> <span class="Keyword">as</span> <span class="VarId">wizard_name</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>

<span class="Comment">-- could this be used for allegiance as well? To go more tutorial d,</span>
<span class="Comment">-- we want to try to only use natural joins in combination with</span>
<span class="Comment">-- renaming attributes</span>

<span class="Comment">-- turn phases</span>

<span class="Keyword">create</span> <span class="Keyword">domain</span> <span class="VarId">turn_phase_enum</span> <span class="Keyword">as</span> <span class="VarId">text</span>
       <span class="Keyword">check</span> <span class="Symbol">(</span><span class="VarId">value</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'choose'</span><span class="Symbol">,</span> <span class="Char">'cast'</span><span class="Symbol">,</span> <span class="Char">'autonomous'</span><span class="Symbol">,</span> <span class="Char">'move'</span><span class="Symbol">));</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">next_turn_phase</span><span class="Symbol">(</span><span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">case</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'choose'</span> <span class="Keyword">then</span> <span class="Char">'cast'</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'cast'</span> <span class="Keyword">then</span> <span class="Char">'autonomous'</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'autonomous'</span> <span class="Keyword">then</span> <span class="Char">'move'</span>
    <span class="Keyword">when</span> $<span class="Number">1</span><span class="Symbol">=</span><span class="Char">'move'</span> <span class="Keyword">then</span> <span class="Char">'choose'</span>
  <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">result</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span>

<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'turn_phase'</span><span class="Symbol">,</span> <span class="Char">'turn_phase_enum'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'turn_phase_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>
</pre></div></div></div><p
      >/<em
	>select create_update_transition_tuple_constraint( 'turn_phase_table', 'turn_phase_change_valid', 'NEW.turn_phase = next_turn_phase(OLD.turn_phase)');</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">no_deletes_inserts_except_new_game</span><span class="Symbol">(</span><span class="Char">'turn_phase_table'</span><span class="Symbol">);</span>

<span class="Comment">-- not used anywhere atm??</span>
<span class="Keyword">create</span> <span class="Keyword">type</span> <span class="VarId">turn_pos</span> <span class="Keyword">as</span> <span class="Symbol">(</span>
    <span class="VarId">turn_number</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="VarId">turn_phase</span> <span class="VarId">turn_phase_enum</span><span class="Symbol">,</span>
    <span class="VarId">current_wizard</span> <span class="VarId">text</span>
<span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_current_turn_pos</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">turn_pos</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">turn_number</span><span class="Symbol">,</span> <span class="VarId">turn_phase</span><span class="Symbol">,</span> <span class="VarId">current_wizard</span><span class="Symbol">)::</span><span class="VarId">turn_pos</span>
    <span class="Keyword">from</span> <span class="VarId">turn_number_table</span>
    <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">turn_phase_table</span>
    <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>


</pre></div></div></div><p
      >/*</p
      ><p
      >Both spell casting and moving have a bunch of state local to each wizards turn in the that phase. Wizard spell choices is a piece of turn phase state which is constructed bit by bit in the choice phase then read in the cast phase, so this data lasts from the start of the choice phase to the end of the cast phase.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">create6nf</span> <span class="Symbol">(</span>$$

  <span class="VarId">wizard_spell_choices_mr</span> <span class="Symbol">(</span>
    <span class="VarId">wizard_name</span> <span class="Type">text</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
    <span class="VarId">spell_name</span> <span class="VarId">text</span>
  <span class="Symbol">);</span>

  <span class="VarId">wizard_spell_choices_imaginary</span> <span class="Symbol">:</span> <span class="VarId">wizard_spell_choices_mr</span> <span class="Symbol">(</span>
    <span class="VarId">imaginary</span> <span class="VarId">boolean</span> <span class="VarId">null</span>
  <span class="Symbol">);</span>

$$<span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'wizard_spell_choices_mr'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizard_spell_choices</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr_base</span><span class="Symbol">;</span>

<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'dead_wizard_no_spell'</span><span class="Symbol">,</span>
  $$ <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span>
    <span class="Keyword">where</span> <span class="VarId">expired</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >todo: add constraint to say imaginary must be set for monsters and must not be set for non-monsters</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Comment">--shortcut for current wizard's spell</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">current_wizard_spell</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_current_wizard_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*this really needs multiple updates</p
      ><p
      >--select add_foreign_key('wizard_spell_choices', array['wizard_name', -- 'spell_name'], 'spell_books');</p
      ><p
      >the problem is that in the action_next_phase for the end of a wizards cast phase we want to delete the spell choice from this table, and also delete the spell from the wizards spell book. The code deletes the spell from the spell book first, but since the spell choice references the spell book table, the reference stops the delete.</p
      ><p
      >We can't use a conventional cascade delete since there may be multiple rows in the spell book for the same spell/wizard combo - this isn't a foreign key in sql sense.</p
      ><p
      >One alternative is to save the wizard and spell names in a variable so we can delete the spell choice first then the spell book entry, but that is pretty inelegant.</p
      ><p
      >We could do it properly with multiple updates, so simulate this by writing out the fk by hand and adding the in next phase hack.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Comment">--select create_var('spell_choice_hack', 'boolean');</span>
<span class="Comment">--insert into spell_choice_hack_table values (false);</span>
<span class="Comment">--select set_relvar_type('spell_choice_hack_table', 'hack');</span>

</pre></div></div></div><p
      >/<em
	>select create_assertion('wizard_spell_choices_wizard_name_spell_name_fkey', <br
	   /><span class="math"
	  >((<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    >, <em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >s</em
	      ></sub
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >p</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    >, <em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >b</em
	      ></sub
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >k</em
	    ><em
	    >s</em
	    >))</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

</pre></div></div></div><p
      >/* if choose phase: only current and previous wizards may have a row if cast phase: only current and subsequent wizards may have a row this constraint really needs multiple updates. maybe using ctes or window fns would make this clearer? */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/* select create_assertion('chosen_spell_phase_valid', <br
	 /><span class="math"
	>((<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  >)<em
	  >o</em
	  ><em
	  >r</em
	  >(((<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  > = ʹ<em
	  >c</em
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  >ʹ<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  >)<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >m</em
	  ><em
	  >a</em
	  ><em
	  >x</em
	  >(<em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  >)<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  >) &lt;  = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  > = <em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  >))<em
	  >o</em
	  ><em
	  >r</em
	  >((<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  > = ʹ<em
	  >c</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  >ʹ<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  >)<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >m</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  >(<em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  >)<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  >) &gt;  = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  > = <em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  >))<em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  >)))</span
	><br
	 />); */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/<em
	>select create_update_transition_tuple_constraint( 'wizard_spell_choices_mr', 'update_spell_choice_restricted', <br
	   /><span class="math"
	  >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    > = ʹ<em
	    >c</em
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    >ʹ<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >N</em
	    ><em
	    >E</em
	    ><em
	    >W</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    > = <em
	    >O</em
	    ><em
	    >L</em
	    ><em
	    >D</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    > = <em
	    >N</em
	    ><em
	    >E</em
	    ><em
	    >W</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)</span
	  ><br
	   />); select create_insert_transition_tuple_constraint( 'wizard_spell_choices_mr', 'insert_spell_choice_restricted', <br
	   /><span class="math"
	  >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    > = ʹ<em
	    >c</em
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    >ʹ<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    > = <em
	    >N</em
	    ><em
	    >E</em
	    ><em
	    >W</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)</span
	  ><br
	   />); select create_delete_transition_tuple_constraint( 'wizard_spell_choices_mr', 'delete_spell_choice_restricted', <br
	   /><span class="math"
	  >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    >(ʹ<em
	    >c</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    >ʹ, ʹ<em
	    >c</em
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    >ʹ)<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

</pre></div></div></div><p
      >/*</p
      ><p
      >if wizard is skipping casting a spell then no tuple appears in this relvar for that wizard</p
      ><p
      >spellparts to cast is local to spell casting phase for each wizard</p
      ><p
      >current wizard has cast amount spell parts in this turn phase</p
      ><p
      >when entering spell cast phase, this is set to 0 if wizard has no spell or max number of casts otherwise</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'spell_parts_to_cast'</span><span class="Symbol">,</span> <span class="Char">'int'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'spell_parts_to_cast_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'parts_to_cast_only'</span><span class="Symbol">,</span> $$
  <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'cast'</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span>
  <span class="Keyword">or</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">spell_parts_to_cast_table</span><span class="Symbol">))</span>$$<span class="Symbol">);</span>

</pre></div></div></div><p
      >/* If casting multipart spell, only check success on first part. Store whether current wizard's spell needs a success check here. make sure to reset it each next phase during cast phase */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'cast_success_checked'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'cast_success_checked_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'cast_checked_cast_only'</span><span class="Symbol">,</span> $$
  <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'cast'</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span>
  <span class="Keyword">or</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">))</span>$$<span class="Symbol">);</span>


</pre></div></div></div><p
      >/*</p
      ><p
      >casting affecting alignment</p
      ><p
      >how does a successful or unsuccessful spell affect world alignment? do unsuccessful spells have any effect? does the current world alignment affect the effect? is there a limit to how much the alignment can change in a turn? is each spell's effect independent of what other spells are cast that turn?</p
      ><p
      >what about: each spell can affect the world alignment spell alignments don't add up, the result is taken by random from one of the spells cast that turn e.g. 0, -1, -4, 2, -1: five spells cast with alignments given chose one of these at random, each with 1/5 chance then adjust alignment by this (align/2 with probability for halfs?)</p
      ><p
      >current plan: only successful spells affect alignment keep track of all spells during cast phase sum up total alignment, divide by 2, each full number affects alignment the fractional part has probability to affect it maximum change is 2</p
      ><p
      >this means that law increases alignment by one and large law does it by two in the absence of any other spells.</p
      ><p
      >I'm pretty sure this is way out. Need to investigate the original chaos (shocking that I have no real idea), because this is pretty critical to the gameplay - the alignment changing too slowly or quickly will change the balance of things totally.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'cast_alignment'</span><span class="Symbol">,</span> <span class="Char">'integer'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'cast_alignment_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'cast_alignment_empty'</span><span class="Symbol">,</span>
  $$<span class="Symbol">((</span><span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'cast'</span><span class="Symbol">)</span> <span class="VarId">or</span>
  <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">cast_alignment_table</span><span class="Symbol">))</span>$$<span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">adjust_world_alignment</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">abs_change</span> <span class="Type">float</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">abs_change</span>
    <span class="VarId">least</span><span class="Symbol">(</span><span class="VarId">abs</span><span class="Symbol">(</span><span class="VarId">get_cast_alignment</span><span class="Symbol">())</span> <span class="Symbol">/</span> <span class="Number">2</span><span class="Symbol">,</span> <span class="Number">2</span><span class="Symbol">);</span>
  <span class="Keyword">update</span> <span class="VarId">world_alignment_table</span>
    <span class="Keyword">set</span> <span class="VarId">world_alignment</span> <span class="Symbol">=</span> <span class="VarId">world_alignment</span>
      <span class="Symbol">+</span> <span class="VarId">trunc</span><span class="Symbol">(</span><span class="VarId">abs_change</span><span class="Symbol">)</span> <span class="Symbol">*</span> <span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">get_cast_alignment</span><span class="Symbol">());</span>
  <span class="Comment">--get fractional part</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="VarId">random</span><span class="Symbol">()</span> <span class="Symbol">&lt;</span> <span class="VarId">abs_change</span> <span class="Symbol">-</span> <span class="VarId">trunc</span><span class="Symbol">(</span><span class="VarId">abs_change</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Keyword">update</span> <span class="VarId">world_alignment_table</span>
      <span class="Keyword">set</span> <span class="VarId">world_alignment</span> <span class="Symbol">=</span> <span class="VarId">world_alignment</span> <span class="Symbol">+</span>
        <span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">get_cast_alignment</span><span class="Symbol">());</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">update</span> <span class="VarId">cast_alignment_table</span> <span class="Keyword">set</span> <span class="VarId">cast_alignment</span> <span class="Symbol">=</span> <span class="Number">0</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >pieces moved and selected piece are local to move phase for each wizard</p
      ><p
      >Piece in this table from current wizard's army have moved in this turn.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">pieces_moved</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">current_wizard_table</span><span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">),</span>
    <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
    <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'pieces_moved'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'pieces_moved_empty'</span><span class="Symbol">,</span>
  $$<span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'move'</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span>
     <span class="Keyword">or</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">pieces_moved</span><span class="Symbol">))</span>$$<span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">domain</span> <span class="VarId">move_phase</span> <span class="Keyword">as</span> <span class="VarId">text</span>
  <span class="Keyword">check</span> <span class="Symbol">(</span><span class="VarId">value</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'motion'</span><span class="Symbol">,</span> <span class="Char">'attack'</span><span class="Symbol">,</span> <span class="Char">'ranged_attack'</span><span class="Symbol">));</span>

<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">selected_piece</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span> <span class="Keyword">references</span> <span class="VarId">current_wizard_table</span><span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">),</span>
  <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">move_phase</span> <span class="VarId">move_phase</span><span class="Symbol">,</span>
  <span class="VarId">engaged</span> <span class="VarId">boolean</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span> <span class="Comment">-- 0 to 1 tuple when in move phase,</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'selected_piece'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>
<span class="Comment">-- piece key from current wizards army, empty otherwise</span>
<span class="Keyword">select</span> <span class="VarId">restrict_cardinality</span><span class="Symbol">(</span><span class="Char">'selected_piece'</span><span class="Symbol">,</span> <span class="Number">1</span><span class="Symbol">);</span>


</pre></div></div></div><p
      >/*</p
      ><p
      >squares left to walk is local to the current moving piece during its walking phase, not used if piece is not a walker.</p
      ><p
      >TODO: this doesn't take into account e.g. move of 3 squares, move diagonal, second diagonal move all move used up, can't do three diagonal moves.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'remaining_walk'</span><span class="Symbol">,</span> <span class="Char">'int'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'remaining_walk_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'remaining_walk_hack'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'remaining_walk_hack_table'</span><span class="Symbol">,</span> <span class="Char">'hack'</span><span class="Symbol">);</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">remaining_walk_hack_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/<em
	>select create_assertion('remaining_walk_only_motion', <br
	   /><span class="math"
	  >((<em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >m</em
	    ><em
	    >a</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >))<em
	    >o</em
	    ><em
	    >r</em
	    >((<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >e</em
	    ><em
	    >w</em
	    ><sub
	    ><em
	      >g</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >e</em
	    ><em
	    >w</em
	    ><sub
	    ><em
	      >g</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >m</em
	    ><em
	    >a</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >m</em
	    ><em
	    >a</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    >(<em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >m</em
	    ><em
	    >o</em
	    ><em
	    >v</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    > = ʹ<em
	    >m</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >i</em
	    ><em
	    >o</em
	    ><em
	    >n</em
	    >ʹ<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >s</em
	    ><em
	    >n</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >n</em
	    ><em
	    >e</em
	    ><em
	    >r</em
	    ><em
	    >j</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >f</em
	    ><em
	    >l</em
	    ><em
	    >y</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >s</em
	    ><em
	    >n</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >n</em
	    ><em
	    >e</em
	    ><em
	    >r</em
	    ><em
	    >j</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)))</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Comment">--this function is used to initialise the turn phase data.</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">init_turn_stuff</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Comment">--this should catch attempts to start a game</span>
  <span class="Comment">--which has already been started</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">turn_number_table</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'new game started when turn number table not empty'</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">turn_number_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">);</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">turn_phase_table</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'choose'</span><span class="Symbol">);</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">current_wizard_table</span>
    <span class="Keyword">select</span> <span class="VarId">wizard_name</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span> <span class="Comment">-- not sure why this is needed</span>
    <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">original_place</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >table to cache if the game is over: someone has one or it's a draw. (This also makes it possible to have a draw when there are wizards remaining.)</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'game_completed'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'game_completed_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>
</pre></div></div></div><p
      >/<em
	>select create_assertion('game_completed_wizards', <br
	   /><span class="math"
	  >(<em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >g</em
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >p</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >o</em
	    ><em
	    >u</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    >(1) &lt;  = 1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >l</em
	    ><em
	    >i</em
	    ><em
	    >v</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><em
	    >s</em
	    >))</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">game_completed</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">game_completed_table</span>
    <span class="Keyword">select</span> <span class="VarId">true</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>
</pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
