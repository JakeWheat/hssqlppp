<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >TurnSequence</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >/*</p
    ><div id="turn-sequence"
    ><h1
      >turn sequence</h1
      ><p
      >For the player, there are three phases: choose spell, cast spell, move pieces; but for the computer there are four phases, the extra one is the autonomous phase in between casting and moving. In this phase magic fire and gooey blob spread, castles may disappear, and wizards may receive a new spell from a magic tree.</p
      ><p
      >There are lots of constraints in this section. They're probably more useful as documentation.</p
      ><p
      >One big takeaway from working with all this constraints is that you really need deferred constraints or multiple updates for anything more than basic constraints.</p
      ><p
      >Some of this stuff makes more sense when looking at the actions.</p
      ><p
      >Everything here seems to be obscured under all the boilerplate, looking for a better way. Maybe some annotations and the ability to create a diagram (maybe even an interactive one?)</p
      ><p
      >== ddl */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
select module('Chaos.Server.TurnSequence');

</pre></div></div></div><p
      >/* use this to simulate multiple updates: for a constraint which refers to multiple tables which get updated during an action_next_phase call, this will be set to true, false at all other times, so using this can defer constraint checking till the end of the action_next_phase call after all the relevant turn phase relvars have been updated. Don't forget to put in_next_phase_hack_table in the relvar list for the constraint.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
select create_var('in_next_phase_hack', 'boolean');
insert into in_next_phase_hack_table values (false);
select set_relvar_type('in_next_phase_hack_table', 'hack');

select create_var('creating_new_game', 'boolean');
insert into creating_new_game_table values (true);
select set_relvar_type('creating_new_game_table', 'hack');

--Turn number, starts at 0 goes up 1 each full turn, just used to provide
--info on how long the game has been going.
select create_var('turn_number', 'int');
select set_relvar_type('turn_number_table', 'data');

</pre></div></div></div><p
      >/<em
	>select create_update_transition_tuple_constraint( 'turn_number_table', 'turn_number_change_valid', '(NEW.turn_number = OLD.turn_number + 1)');</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

select no_deletes_inserts_except_new_game('turn_number_table');

</pre></div></div></div><p
      >/* turn phase must follow choose-cast-auto-move-choose-etc.</p
      ><p
      >wizard spell choices added row must be for current wizard, and in current wizard's spell book in choose phase removed row must be for current wizard in cast phase</p
      ><p
      >spell parts to cast pieces to move squares left to walk</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

-- todo: use lag or lead window fn or something - make it a lot
-- clearer?
</pre></div></div></div><p
      >/<em
	>create view next_wizard as select wizard_name, new_wizard_name from (select wizard_name as new_wizard_name, place from live_wizards) as a inner join (select wizard_name, (place + 1) % (select max(place) + 1 from live_wizards) as old_place from live_wizards) as b on (place = old_place);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

create function next_wizard(text) returns text as $$
  with
    doubled as
      (select wizard_name,original_place from wizards where not expired
       union select wizard_name,original_place + 10 from wizards where not expired)
   ,nexts as
       (select wizard_name, lead(wizard_name)
                            over(order by original_place) as n
          from doubled)
  select n from nexts where wizard_name = $1 limit 1;

$$ language sql stable;

</pre></div></div></div><p
      >/<em
	>select next_wizard('Buddha'); select next_wizard('Kong Fuzi'); select next_wizard('Laozi'); select next_wizard('Moshe'); select next_wizard('Muhammad'); select next_wizard('Shiva'); select next_wizard('Yeshua'); select next_wizard('Zarathushthra');</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

--current wizard is the wizard who's turn it is to do stuff in current phase
select create_var('current_wizard', 'text');
select set_relvar_type('current_wizard_table', 'data');

alter table current_wizard_table
  add constraint current_wizard_fkey
  foreign key (current_wizard) references wizards(wizard_name);

-- could be no deletes, inserts - unless there is only one wizard left
-- (to allow draws)
--select no_deletes_inserts_except_new_game('current_wizard_table');

select create_assertion('current_wizard_must_be_alive',
  $$(select not expired from current_wizard_table
     inner join wizards on current_wizard = wizard_name)$$);

</pre></div></div></div><p
      >/* wizard field in most tables and views is named wizard_name</p
      ><p
      >instead of tediously writing out inner join blah on wizard_name = current_wizard use the following view to instead write natural inner join current_wizard . Not that much less tedious though.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

create view current_wizard as
  select current_wizard as wizard_name from current_wizard_table;

-- could this be used for allegiance as well? To go more tutorial d,
-- we want to try to only use natural joins in combination with
-- renaming attributes

-- turn phases

create domain turn_phase_enum as text
       check (value in ('choose', 'cast', 'autonomous', 'move'));

create function next_turn_phase(text) returns text as $$
  select case
    when $1='choose' then 'cast'
    when $1='cast' then 'autonomous'
    when $1='autonomous' then 'move'
    when $1='move' then 'choose'
  end as result
$$ language sql immutable;

select create_var('turn_phase', 'turn_phase_enum');
select set_relvar_type('turn_phase_table', 'data');
</pre></div></div></div><p
      >/<em
	>select create_update_transition_tuple_constraint( 'turn_phase_table', 'turn_phase_change_valid', 'NEW.turn_phase = next_turn_phase(OLD.turn_phase)');</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
select no_deletes_inserts_except_new_game('turn_phase_table');

-- not used anywhere atm??
create type turn_pos as (
    turn_number int,
    turn_phase turn_phase_enum,
    current_wizard text
);

create function get_current_turn_pos() returns turn_pos as $$
  select (turn_number, turn_phase, current_wizard)::turn_pos
    from turn_number_table
    cross join turn_phase_table
    cross join current_wizard_table;
$$ language sql stable;


</pre></div></div></div><p
      >/*</p
      ><p
      >Both spell casting and moving have a bunch of state local to each wizards turn in the that phase. Wizard spell choices is a piece of turn phase state which is constructed bit by bit in the choice phase then read in the cast phase, so this data lasts from the start of the choice phase to the end of the cast phase.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

select create6nf ($$

  wizard_spell_choices_mr (
    wizard_name text unique,
    spell_name text
  );

  wizard_spell_choices_imaginary : wizard_spell_choices_mr (
    imaginary boolean null
  );

$$);

select set_relvar_type('wizard_spell_choices_mr', 'data');

create view wizard_spell_choices as
  select * from wizard_spell_choices_mr_base;

select create_assertion('dead_wizard_no_spell',
  $$ not exists(select 1 from wizard_spell_choices_mr
    natural inner join wizards
    where expired = true)$$);

</pre></div></div></div><p
      >/*</p
      ><p
      >todo: add constraint to say imaginary must be set for monsters and must not be set for non-monsters</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

--shortcut for current wizard's spell
create view current_wizard_spell as
  select spell_name from wizard_spell_choices
    natural inner join current_wizard;

create function get_current_wizard_spell() returns text as $$
  select spell_name from current_wizard_spell;
$$ language sql stable;

</pre></div></div></div><p
      >/*this really needs multiple updates</p
      ><p
      >--select add_foreign_key('wizard_spell_choices', array['wizard_name', -- 'spell_name'], 'spell_books');</p
      ><p
      >the problem is that in the action_next_phase for the end of a wizards cast phase we want to delete the spell choice from this table, and also delete the spell from the wizards spell book. The code deletes the spell from the spell book first, but since the spell choice references the spell book table, the reference stops the delete.</p
      ><p
      >We can't use a conventional cascade delete since there may be multiple rows in the spell book for the same spell/wizard combo - this isn't a foreign key in sql sense.</p
      ><p
      >One alternative is to save the wizard and spell names in a variable so we can delete the spell choice first then the spell book entry, but that is pretty inelegant.</p
      ><p
      >We could do it properly with multiple updates, so simulate this by writing out the fk by hand and adding the in next phase hack.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
--select create_var('spell_choice_hack', 'boolean');
--insert into spell_choice_hack_table values (false);
--select set_relvar_type('spell_choice_hack_table', 'hack');

</pre></div></div></div><p
      >/<em
	>select create_assertion('wizard_spell_choices_wizard_name_spell_name_fkey', <br
	   /><span class="math"
	  >((<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    >, <em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >s</em
	      ></sub
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >p</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    >, <em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >p</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >l</em
	    ><sub
	    ><em
	      >b</em
	      ></sub
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >k</em
	    ><em
	    >s</em
	    >))</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

</pre></div></div></div><p
      >/* if choose phase: only current and previous wizards may have a row if cast phase: only current and subsequent wizards may have a row this constraint really needs multiple updates. maybe using ctes or window fns would make this clearer? */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/* select create_assertion('chosen_spell_phase_valid', <br
	 /><span class="math"
	>((<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  >)<em
	  >o</em
	  ><em
	  >r</em
	  >(((<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  > = ʹ<em
	  >c</em
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  >ʹ<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  >)<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >m</em
	  ><em
	  >a</em
	  ><em
	  >x</em
	  >(<em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  >)<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  >) &lt;  = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  > = <em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  >))<em
	  >o</em
	  ><em
	  >r</em
	  >((<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  > = ʹ<em
	  >c</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  >ʹ<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  >)<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >m</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  >(<em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  >)<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  >) &gt;  = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >p</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >v</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  > = <em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >w</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  >))<em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  >)))</span
	><br
	 />); */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/<em
	>select create_update_transition_tuple_constraint( 'wizard_spell_choices_mr', 'update_spell_choice_restricted', <br
	   /><span class="math"
	  >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    > = ʹ<em
	    >c</em
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    >ʹ<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >N</em
	    ><em
	    >E</em
	    ><em
	    >W</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    > = <em
	    >O</em
	    ><em
	    >L</em
	    ><em
	    >D</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    > = <em
	    >N</em
	    ><em
	    >E</em
	    ><em
	    >W</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)</span
	  ><br
	   />); select create_insert_transition_tuple_constraint( 'wizard_spell_choices_mr', 'insert_spell_choice_restricted', <br
	   /><span class="math"
	  >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    > = ʹ<em
	    >c</em
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    >ʹ<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    > = <em
	    >N</em
	    ><em
	    >E</em
	    ><em
	    >W</em
	    >. <em
	    >w</em
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)</span
	  ><br
	   />); select create_delete_transition_tuple_constraint( 'wizard_spell_choices_mr', 'delete_spell_choice_restricted', <br
	   /><span class="math"
	  >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    >(ʹ<em
	    >c</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    >ʹ, ʹ<em
	    >c</em
	    ><em
	    >h</em
	    ><em
	    >o</em
	    ><em
	    >o</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    >ʹ)<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >n</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

</pre></div></div></div><p
      >/*</p
      ><p
      >if wizard is skipping casting a spell then no tuple appears in this relvar for that wizard</p
      ><p
      >spellparts to cast is local to spell casting phase for each wizard</p
      ><p
      >current wizard has cast amount spell parts in this turn phase</p
      ><p
      >when entering spell cast phase, this is set to 0 if wizard has no spell or max number of casts otherwise</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

select create_var('spell_parts_to_cast', 'int');
select set_relvar_type('spell_parts_to_cast_table', 'data');

select create_assertion('parts_to_cast_only', $$
  ((select turn_phase = 'cast' from turn_phase_table)
  or not exists(select 1 from spell_parts_to_cast_table))$$);

</pre></div></div></div><p
      >/* If casting multipart spell, only check success on first part. Store whether current wizard's spell needs a success check here. make sure to reset it each next phase during cast phase */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

select create_var('cast_success_checked', 'boolean');
select set_relvar_type('cast_success_checked_table', 'data');

select create_assertion('cast_checked_cast_only', $$
  ((select turn_phase = 'cast' from turn_phase_table)
  or not exists(select 1 from cast_success_checked_table))$$);


</pre></div></div></div><p
      >/*</p
      ><p
      >casting affecting alignment</p
      ><p
      >how does a successful or unsuccessful spell affect world alignment? do unsuccessful spells have any effect? does the current world alignment affect the effect? is there a limit to how much the alignment can change in a turn? is each spell's effect independent of what other spells are cast that turn?</p
      ><p
      >what about: each spell can affect the world alignment spell alignments don't add up, the result is taken by random from one of the spells cast that turn e.g. 0, -1, -4, 2, -1: five spells cast with alignments given chose one of these at random, each with 1/5 chance then adjust alignment by this (align/2 with probability for halfs?)</p
      ><p
      >current plan: only successful spells affect alignment keep track of all spells during cast phase sum up total alignment, divide by 2, each full number affects alignment the fractional part has probability to affect it maximum change is 2</p
      ><p
      >this means that law increases alignment by one and large law does it by two in the absence of any other spells.</p
      ><p
      >I'm pretty sure this is way out. Need to investigate the original chaos (shocking that I have no real idea), because this is pretty critical to the gameplay - the alignment changing too slowly or quickly will change the balance of things totally.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
select create_var('cast_alignment', 'integer');
select set_relvar_type('cast_alignment_table', 'data');

select create_assertion('cast_alignment_empty',
  $$((get_turn_phase() = 'cast') or
  not exists(select 1 from cast_alignment_table))$$);

create function adjust_world_alignment() returns void as $$
declare
  abs_change float;
begin
  select into abs_change
    least(abs(get_cast_alignment()) / 2, 2);
  update world_alignment_table
    set world_alignment = world_alignment
      + trunc(abs_change) * sign(get_cast_alignment());
  --get fractional part
  if (random() &lt; abs_change - trunc(abs_change)) then
    update world_alignment_table
      set world_alignment = world_alignment +
        sign(get_cast_alignment());
  end if;
  update cast_alignment_table set cast_alignment = 0;
end;
$$ language plpgsql volatile;

</pre></div></div></div><p
      >/*</p
      ><p
      >pieces moved and selected piece are local to move phase for each wizard</p
      ><p
      >Piece in this table from current wizard's army have moved in this turn.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
create table pieces_moved (
    ptype text,
    allegiance text references current_wizard_table(current_wizard),
    tag int,
    unique (ptype,allegiance,tag),
    foreign key (ptype,allegiance,tag) references pieces
);
select set_relvar_type('pieces_moved', 'data');

select create_assertion('pieces_moved_empty',
  $$((select turn_phase = 'move' from turn_phase_table)
     or not exists (select 1 from pieces_moved))$$);

create domain move_phase as text
  check (value in ('motion', 'attack', 'ranged_attack'));

create table selected_piece (
  ptype text,
  allegiance text references current_wizard_table(current_wizard),
  tag int,
  move_phase move_phase,
  engaged boolean,
  unique (ptype,allegiance,tag),
  foreign key (ptype,allegiance,tag) references pieces
); -- 0 to 1 tuple when in move phase,
select set_relvar_type('selected_piece', 'data');
-- piece key from current wizards army, empty otherwise
select restrict_cardinality('selected_piece', 1);


</pre></div></div></div><p
      >/*</p
      ><p
      >squares left to walk is local to the current moving piece during its walking phase, not used if piece is not a walker.</p
      ><p
      >TODO: this doesn't take into account e.g. move of 3 squares, move diagonal, second diagonal move all move used up, can't do three diagonal moves.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
select create_var('remaining_walk', 'int');
select set_relvar_type('remaining_walk_table', 'data');
select create_var('remaining_walk_hack', 'boolean');
select set_relvar_type('remaining_walk_hack_table', 'hack');
insert into remaining_walk_hack_table values (false);

</pre></div></div></div><p
      >/<em
	>select create_assertion('remaining_walk_only_motion', <br
	   /><span class="math"
	  >((<em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >m</em
	    ><em
	    >a</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >))<em
	    >o</em
	    ><em
	    >r</em
	    >((<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >e</em
	    ><em
	    >w</em
	    ><sub
	    ><em
	      >g</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >n</em
	      ></sub
	    ><em
	    >e</em
	    ><em
	    >w</em
	    ><sub
	    ><em
	      >g</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >m</em
	    ><em
	    >a</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >m</em
	    ><em
	    >a</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >h</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >c</em
	    ><em
	    >k</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    >(<em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >m</em
	    ><em
	    >o</em
	    ><em
	    >v</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >h</em
	    ><em
	    >a</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    > = ʹ<em
	    >m</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >i</em
	    ><em
	    >o</em
	    ><em
	    >n</em
	    >ʹ<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >s</em
	    ><em
	    >n</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >n</em
	    ><em
	    >e</em
	    ><em
	    >r</em
	    ><em
	    >j</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)<em
	    >a</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >f</em
	    ><em
	    >l</em
	    ><em
	    >y</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >g</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    ><em
	    >s</em
	    ><em
	    >n</em
	    ><em
	    >a</em
	    ><em
	    >t</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >a</em
	    ><em
	    >l</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >n</em
	    ><em
	    >e</em
	    ><em
	    >r</em
	    ><em
	    >j</em
	    ><em
	    >o</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >p</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >e</em
	    >)))</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

--this function is used to initialise the turn phase data.
create function init_turn_stuff() returns void as $$
begin
  --this should catch attempts to start a game
  --which has already been started
  if exists(select 1 from turn_number_table) then
    raise exception 'new game started when turn number table not empty';
  end if;
  insert into turn_number_table values (0);
  insert into turn_phase_table
    values ('choose');
  insert into current_wizard_table
    select wizard_name from wizards where not expired -- not sure why this is needed
    order by original_place limit 1;
end;
$$ language plpgsql volatile;

</pre></div></div></div><p
      >/*</p
      ><p
      >table to cache if the game is over: someone has one or it's a draw. (This also makes it possible to have a draw when there are wizards remaining.)</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

select create_var('game_completed', 'boolean');
select set_relvar_type('game_completed_table', 'data');
</pre></div></div></div><p
      >/<em
	>select create_assertion('game_completed_wizards', <br
	   /><span class="math"
	  >(<em
	    >n</em
	    ><em
	    >o</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >x</em
	    ><em
	    >i</em
	    ><em
	    >s</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    >1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >g</em
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >c</em
	      ></sub
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >p</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >t</em
	      ></sub
	    ><em
	    >a</em
	    ><em
	    >b</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    >)<em
	    >o</em
	    ><em
	    >r</em
	    >(<em
	    >s</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >c</em
	    ><em
	    >o</em
	    ><em
	    >u</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    >(1) &lt;  = 1<em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >l</em
	    ><em
	    >i</em
	    ><em
	    >v</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >w</em
	      ></sub
	    ><em
	    >i</em
	    ><em
	    >z</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><em
	    >s</em
	    >))</span
	  ><br
	   />);</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

create function game_completed() returns void as $$
begin
  insert into game_completed_table
    select true where not exists (select 1 from game_completed_table);
end;
$$ language plpgsql volatile;
</pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
