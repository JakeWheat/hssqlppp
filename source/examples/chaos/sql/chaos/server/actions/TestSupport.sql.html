<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >TestSupport</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >/* Action test support ===================</p
    ><p
    >for testing purposes sometimes want to make a given nondeterministic action always fail or always succeed.</p
    ><p
    >The categories are: castle disappear gooey blob spread attack ranged attack resist: decree, lightning, subversion cast spell</p
    ><p
    >you have to set the override each time you want to override something</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

select module('Chaos.Server.Actions.TestSupport');

create domain random_test text check (value in
       ('disappear', 'spread', 'attack',
        'ranged_attack', 'resist', 'cast',
        'bonus','break_engaged'));

create table test_action_overrides (
  override random_test unique,
  setting bool
);
select set_relvar_type('test_action_overrides', 'data');

create function action_rig_action_success(poverride random_test,
       psetting boolean) returns void as $$
begin
  insert into test_action_overrides (override, setting)
    values (poverride, psetting);
end;
$$ language plpgsql volatile;

</pre></div></div></div><p
    >/* random numbers</p
    ><p
    >run all random tests through this, so that we can hook into them during testing.</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
create function check_random_success(t random_test, successPercentage int)
  returns boolean as $$
declare
  o boolean;
begin
  o := (select setting from test_action_overrides
       where override = t);
  if o is null then --normal random
    return (random() * 100) &lt; successPercentage;
  else --overriden
    delete from test_action_overrides
      where override = t;
    return o;
  end if;
end;
$$ language plpgsql volatile;

create function limit_chance(integer) returns integer as $$
  select greatest(10, least($1, 100));
$$ language sql immutable;
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
