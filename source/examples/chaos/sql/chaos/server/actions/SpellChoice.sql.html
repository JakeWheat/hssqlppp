<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >SpellChoice</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.SpellChoice'</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/* == spell choice</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_choose_spell</span><span class="Symbol">(</span><span class="VarId">vspell_name</span> <span class="Type">text</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">cw</span> <span class="Type">text</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Comment">--create the argumentless action name so we can check the action</span>
  <span class="Comment">--valid table</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'choose_'</span> <span class="Symbol">||</span> <span class="VarId">vspell_name</span> <span class="Symbol">||</span> <span class="Char">'_spell'</span><span class="Symbol">);</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">cw</span> <span class="VarId">current_wizard</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
  <span class="Comment">--do nothing if this is the same as the currently selected spell</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices</span>
        <span class="Keyword">where</span> <span class="VarId">wizard_name</span><span class="Symbol">=</span><span class="VarId">cw</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">vspell_name</span> <span class="VarId">then</span>
    <span class="Keyword">null</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
    <span class="Comment">--if wizard already has a chosen spell then remove it</span>
    <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span>
      <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">cw</span><span class="Symbol">;</span>
    <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">wizard_spell_choices_mr</span> <span class="Symbol">(</span><span class="VarId">wizard_name</span>
                                        <span class="Symbol">,</span><span class="VarId">spell_name</span>
                                        <span class="Symbol">,</span><span class="VarId">imaginary</span><span class="Symbol">)</span>
           <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">cw</span>
                  <span class="Symbol">,</span><span class="VarId">vspell_name</span>
                  <span class="Symbol">,</span><span class="Keyword">case</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">monster_spells</span>
                               <span class="Keyword">where</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="VarId">vspell_name</span><span class="Symbol">)</span>
                     <span class="Keyword">when</span> <span class="VarId">true</span> <span class="Keyword">then</span> <span class="VarId">false</span>
                     <span class="Keyword">else</span> <span class="VarId">null</span>
                   <span class="Keyword">end</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_choose_spell</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_choose_no_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'choose_no_spell'</span><span class="Symbol">);</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span> <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">get_current_wizard</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_set_imaginary</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'set_imaginary'</span><span class="Symbol">);</span>
  <span class="Keyword">update</span> <span class="VarId">wizard_spell_choices_mr</span>
    <span class="Keyword">set</span> <span class="VarId">imaginary</span> <span class="Symbol">=</span> <span class="VarId">true</span>
    <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">get_current_wizard</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_set_real</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'set_real'</span><span class="Symbol">);</span>
  <span class="Keyword">update</span> <span class="VarId">wizard_spell_choices_mr</span>
    <span class="Keyword">set</span> <span class="VarId">imaginary</span> <span class="Symbol">=</span> <span class="VarId">false</span>
    <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">get_current_wizard</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>
</pre></div></div></div><p
    >/* === internals generate the individual spell choice actions</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">generate_spell_choice_actions</span><span class="Symbol">();</span>
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
