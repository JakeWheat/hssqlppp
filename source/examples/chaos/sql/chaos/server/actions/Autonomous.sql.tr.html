<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Autonomous.sql transformed</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
</pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">);</span>

<span class="Comment">/*</span>
<span class="Comment">== autonomous</span>
<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;wizards_in_trees&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizards_in_trees</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
  <span class="Keyword">where</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span>
    <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
                  <span class="Keyword">where</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'magic_tree'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'wizards_in_trees'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;do_autonomous_phase&quot; [] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">do_autonomous_phase</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">r1</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Comment">--castles</span>
  <span class="Keyword">for</span> <span class="VarId">r</span> <span class="VarId">in</span> <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
    <span class="Keyword">where</span> <span class="VarId">ptype</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'magic_castle'</span><span class="Symbol">,</span> <span class="Char">'dark_citadel'</span><span class="Symbol">)</span> <span class="VarId">loop</span>
    <span class="Keyword">if</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'disappear'</span><span class="Symbol">,</span> <span class="Number">20</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">disintegrate</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
  <span class="Comment">--magic trees</span>
 <span class="Keyword">for</span> <span class="VarId">r</span> <span class="VarId">in</span> <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">wizards_in_trees</span> <span class="VarId">loop</span>
    <span class="Keyword">if</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'bonus'</span><span class="Symbol">,</span> <span class="Number">20</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r1</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span>
             <span class="Keyword">from</span> <span class="VarId">pieces</span>
             <span class="Keyword">where</span> <span class="VarId">ptype</span> <span class="Symbol">=</span><span class="Char">'magic_tree'</span>
               <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
                            <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span> <span class="Symbol">=</span> <span class="VarId">r</span><span class="Symbol">);</span>
      <span class="Keyword">perform</span> <span class="VarId">disintegrate</span><span class="Symbol">(</span><span class="VarId">r1</span><span class="Symbol">);</span>
      <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">spell_books</span> <span class="Symbol">(</span><span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">)</span>
      <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span>
       <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">spells_mr</span>
         <span class="Keyword">where</span> <span class="VarId">spell_name</span> <span class="Symbol">&lt;&gt;</span> <span class="Char">'disbelieve'</span>
          <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">random</span><span class="Symbol">()</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">));</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">do_spreading</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*</span>
<span class="Comment">can't find this function in the postgresql docs...?</span>
<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'do_autonomous_phase'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;array_contains&quot; [Pseudo AnyArray,Pseudo AnyElement] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">array_contains</span><span class="Symbol">(</span><span class="VarId">ar</span> <span class="VarId">anyarray</span><span class="Symbol">,</span> <span class="VarId">e</span> <span class="VarId">anyelement</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">i</span> <span class="Type">int</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="VarId">ar</span> <span class="Symbol">=</span> <span class="Char">'{}'</span> <span class="VarId">then</span>
    <span class="VarId">return</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">for</span> <span class="VarId">i</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="VarId">array_lower</span><span class="Symbol">(</span><span class="VarId">ar</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">))..(</span><span class="VarId">array_upper</span><span class="Symbol">(</span><span class="VarId">ar</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">))</span> <span class="VarId">loop</span>
    <span class="Keyword">if</span> <span class="VarId">ar</span><span class="Symbol">[</span><span class="VarId">i</span><span class="Symbol">]</span> <span class="Symbol">=</span> <span class="VarId">e</span> <span class="VarId">then</span>
      <span class="VarId">return</span> <span class="VarId">true</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
  <span class="VarId">return</span> <span class="VarId">false</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span>


<span class="Comment">/*</span>
<span class="Comment">rules:</span>
<span class="Comment">each piece has 10% chance of disappearing</span>
<span class="Comment">each piece has 20% chance of spawning a new piece</span>
<span class="Comment">each piece has 20% chance of spawning two new pieces</span>

<span class="Comment">can't spread to object squares</span>
<span class="Comment">can't spread to same allegiance squares</span>
<span class="Comment">blob spreading over wizard kills wizard</span>
<span class="Comment">blob spreading on monster leaves monster trapped until blob is killed/recedes</span>
<span class="Comment">fire spreading onto anything kills &amp; disintegrates it</span>

<span class="Comment">need hack to prevent blobs trying to spread which are owned by wizards</span>
<span class="Comment">killed previously during this spreading.  I think we need to keep</span>
<span class="Comment">track of these manually since the database won't let us read a</span>
<span class="Comment">partially updated wizards or pieces table during the transaction</span>

<span class="Comment">insert into spell_books (wizard_name,spell_name)</span>
<span class="Comment">  select wizard_name, 'magic_wood' from wizards</span>
<span class="Comment">  where not expired;</span>


<span class="Comment">insert into spell_books (wizard_name,spell_name)</span>
<span class="Comment">  select wizard_name, 'gooey_blob' from wizards</span>
<span class="Comment">  union</span>
<span class="Comment">  select wizard_name, 'magic_fire' from wizards;</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'array_contains'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">spreadable_squares</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">14</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">x</span>
    <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">9</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">y</span>
  <span class="VarId">except</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">object_piece_types</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spreadable_squares'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'disable_spreading'</span><span class="Symbol">,</span> <span class="Char">'boolean'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;disable_spreading_table&quot; [(&quot;disable_spreading&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">disable_spreading_table</span> <span class="Symbol">(</span>
  <span class="VarId">disable_spreading</span> <span class="VarId">boolean</span> <span class="Keyword">primary</span> <span class="VarId">key</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'disable_spreading_table'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;get_disable_spreading&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_disable_spreading</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">*</span>
    <span class="Keyword">from</span> <span class="VarId">disable_spreading_table</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'get_disable_spreading'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;check_con_disable_spreading_table_01_tuple&quot; [] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_con_disable_spreading_table_01_tuple</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">bool</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="VarId">return</span> <span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(*)</span>
             <span class="Keyword">from</span> <span class="VarId">disable_spreading_table</span><span class="Symbol">)</span> <span class="Symbol">&lt;=</span> <span class="Number">1</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_con_disable_spreading_table_01_tuple'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Comment">/*[CatCreateFunction FunName &quot;disable_spreading_table_constraint_trigger_operator&quot; [] (Pseudo Trigger) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">disable_spreading_table_constraint_trigger_operator</span> <span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Keyword">trigger</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="Symbol">(</span><span class="VarId">check_con_disable_spreading_table_01_tuple</span><span class="Symbol">()))</span> <span class="VarId">then</span>
       <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'update violates database constraint disable_spreading_table_01_tuple'</span><span class="Symbol">;</span>

  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="VarId">return</span> <span class="VarId">OLD</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'disable_spreading_table_constraint_trigger_operator'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">trigger</span> <span class="VarId">disable_spreading_table_constraint_trigger</span> <span class="Keyword">after</span> <span class="Keyword">insert</span> <span class="Keyword">or</span> <span class="Keyword">update</span> <span class="Keyword">or</span> <span class="Keyword">delete</span> <span class="Keyword">on</span> <span class="VarId">disable_spreading_table</span> <span class="Keyword">for</span> <span class="Keyword">statement</span> <span class="Keyword">execute</span> <span class="VarId">procedure</span> <span class="VarId">disable_spreading_table_constraint_trigger_operator</span><span class="Symbol">();</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'disable_spreading_table_constraint_trigger'</span><span class="Symbol">,</span><span class="Char">'trigger'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">disable_spreading_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'disable_spreading_table'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;do_spreading&quot; [] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">do_spreading</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">r1</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">p</span> <span class="VarId">pos</span><span class="Symbol">;</span>
  <span class="VarId">sp</span> <span class="VarId">record</span><span class="Symbol">;</span>
  <span class="VarId">i</span> <span class="Type">int</span><span class="Symbol">;</span>
  <span class="VarId">c</span> <span class="Type">int</span><span class="Symbol">;</span>
  <span class="VarId">tg</span> <span class="Type">int</span><span class="Symbol">;</span>
  <span class="VarId">killed_wizards</span> <span class="Type">text</span><span class="Symbol">[]</span> <span class="Symbol">=</span> <span class="Char">'{}'</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="VarId">get_disable_spreading</span><span class="Symbol">()</span> <span class="VarId">then</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">for</span> <span class="VarId">sp</span> <span class="VarId">in</span> <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
           <span class="Keyword">where</span> <span class="VarId">ptype</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'gooey_blob'</span><span class="Symbol">,</span> <span class="Char">'magic_fire'</span><span class="Symbol">)</span> <span class="VarId">loop</span>
    <span class="Comment">--raise notice 'check % e %', sp.allegiance, killed_wizards;</span>
    <span class="Keyword">if</span> <span class="VarId">array_contains</span><span class="Symbol">(</span><span class="VarId">killed_wizards</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Comment">--raise notice 'skip piece %', sp.allegiance;</span>
      <span class="Keyword">continue</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="VarId">c</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="VarId">random</span><span class="Symbol">()</span> <span class="Symbol">*</span> <span class="Number">100</span><span class="Symbol">)::</span><span class="VarId">Int</span><span class="Symbol">;</span>
    <span class="Keyword">if</span> <span class="VarId">c</span> <span class="Symbol">&lt;</span> <span class="Number">10</span> <span class="VarId">then</span>
      <span class="Comment">--recede</span>
      <span class="Keyword">perform</span> <span class="VarId">add_history_recede</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
      <span class="Keyword">perform</span> <span class="VarId">disintegrate</span><span class="Symbol">((</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">));</span>
    <span class="Keyword">elseif</span> <span class="VarId">c</span> <span class="Symbol">&lt;</span> <span class="Number">50</span> <span class="VarId">then</span>
      <span class="Keyword">for</span> <span class="VarId">i</span> <span class="VarId">in</span> <span class="Number">1</span><span class="Symbol">..(</span><span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">c</span> <span class="Symbol">&lt;</span> <span class="Number">30</span> <span class="Keyword">then</span> <span class="Number">1</span> <span class="Keyword">else</span> <span class="Number">2</span> <span class="Keyword">end</span><span class="Symbol">)</span> <span class="VarId">loop</span>
        <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">p</span> <span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">ty</span> <span class="Keyword">from</span> <span class="Symbol">(</span>
          <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">one_square_away</span><span class="Symbol">((</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">))</span>
          <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">spreadable_squares</span> <span class="VarId">s</span>
          <span class="VarId">except</span> <span class="Keyword">select</span> <span class="VarId">x</span> <span class="Keyword">as</span> <span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">as</span> <span class="VarId">ty</span>
                   <span class="Keyword">from</span> <span class="VarId">pieces</span>
                   <span class="Keyword">where</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
                     <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">random</span><span class="Symbol">()</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
        <span class="Keyword">if</span> <span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span> <span class="VarId">is</span> <span class="Keyword">null</span> <span class="Keyword">then</span> <span class="Keyword">continue</span><span class="Symbol">;</span> <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
        <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
               <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">)</span>
                 <span class="Keyword">and</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">)</span> <span class="VarId">then</span>
          <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r1</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
               <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">)</span>
                 <span class="Keyword">and</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>
          <span class="Keyword">if</span> <span class="VarId">r1</span><span class="Symbol">.</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span> <span class="VarId">then</span>
            <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'spread tried to get friendly piece'</span><span class="Symbol">;</span>
          <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
          <span class="VarId">killed_wizards</span> <span class="Symbol">:=</span> <span class="VarId">array_append</span><span class="Symbol">(</span><span class="VarId">killed_wizards</span><span class="Symbol">,</span> <span class="VarId">r1</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">);</span>
          <span class="Comment">--raise notice 'killed_wizards %', killed_wizards;</span>
          <span class="Keyword">perform</span> <span class="VarId">add_chinned_history</span><span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
          <span class="Keyword">perform</span> <span class="VarId">kill_piece</span><span class="Symbol">(</span><span class="VarId">r1</span><span class="Symbol">);</span>
        <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
        <span class="Comment">--magic fire removes all pieces</span>
        <span class="Keyword">for</span> <span class="VarId">r1</span> <span class="VarId">in</span> <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
            <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="VarId">loop</span>
          <span class="Keyword">if</span> <span class="VarId">r1</span><span class="Symbol">.</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span> <span class="VarId">then</span>
            <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'spread tried to get friendly piece'</span><span class="Symbol">;</span>
          <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
          <span class="Keyword">perform</span> <span class="VarId">disintegrate</span><span class="Symbol">(</span><span class="VarId">r1</span><span class="Symbol">);</span>
        <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
        <span class="Comment">--raise notice 'spreading %', sp.allegiance;</span>
        <span class="VarId">tg</span> <span class="Symbol">:=</span> <span class="VarId">create_object</span><span class="Symbol">(</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
        <span class="Keyword">perform</span> <span class="VarId">add_history_spread</span><span class="Symbol">((</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tg</span><span class="Symbol">));</span>
      <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'do_spreading'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.Autononmous'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
