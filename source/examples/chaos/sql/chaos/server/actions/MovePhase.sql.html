<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >MovePhase</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.MovePhase'</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/* == move Individual Piece move notes A piece may be 'selected' iff it can move or attack or has a ranged attack.</p
    ><p
    >Once a piece is selected it must first move, then attack, then ranged attack (skipping bits which don't apply).</p
    ><p
    >The piece can forfeit any part of this (and can choose to move only part of it's move if walking).</p
    ><p
    >The parts must be in this strict order.</p
    ><p
    >If a piece is unselected before it has moved or done anything then it remains able to move this turn otherwise its move is over for this turn.</p
    ><p
    >=== selection and subphase */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">select_piece</span><span class="Symbol">(</span><span class="VarId">pk</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">nextp</span> <span class="Type">text</span><span class="Symbol">;</span>
  <span class="VarId">p</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="VarId">nextp</span><span class="Symbol">:=</span> <span class="VarId">piece_next_subphase</span><span class="Symbol">(</span><span class="Char">'start'</span><span class="Symbol">,</span> <span class="VarId">false</span><span class="Symbol">,</span> <span class="Char">'none'</span><span class="Symbol">,</span> <span class="VarId">pk</span><span class="Symbol">);</span>
  <span class="Keyword">if</span> <span class="VarId">nextp</span> <span class="Symbol">=</span> <span class="Char">'end'</span> <span class="VarId">then</span>
    <span class="Comment">--nothing to do</span>
    <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">pieces_moved</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span>
     <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">pk</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">pk</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">pk</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">);</span>
    </pre></div></div></div><p
    >/<em
      >if not exists(select 1 from pieces_to_move) then perform action_next_phase(); end if;</em
      >/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">selected_piece</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">move_phase</span><span class="Symbol">,</span> <span class="VarId">engaged</span><span class="Symbol">)</span> <span class="VarId">values</span>
    <span class="Symbol">(</span><span class="VarId">pk</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">pk</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">pk</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">nextp</span><span class="Symbol">,</span> <span class="VarId">false</span><span class="Symbol">);</span>

  <span class="Keyword">if</span> <span class="VarId">nextp</span> <span class="Symbol">=</span> <span class="Char">'motion'</span> <span class="VarId">and</span>
       <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
              <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">creature_pieces</span>
              <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">flying</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">update</span> <span class="VarId">remaining_walk_hack_table</span>
      <span class="Keyword">set</span> <span class="VarId">remaining_walk_hack</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">;</span>
    <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">remaining_walk_table</span>
      <span class="Keyword">select</span> <span class="VarId">speed</span> <span class="Keyword">from</span> <span class="VarId">creature_pieces</span>
        <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
    <span class="Keyword">update</span> <span class="VarId">remaining_walk_hack_table</span>
      <span class="Keyword">set</span> <span class="VarId">remaining_walk_hack</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>
    <span class="Keyword">perform</span> <span class="VarId">check_engaged</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


<span class="Comment">--short cut for interface</span>
<span class="Comment">--this fails silently if the action is not valid</span>
<span class="Comment">-- which is totally inconsistent - </span><span class="Alert">TODO:</span><span class="Comment"> fix</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_select_piece_at_position</span><span class="Symbol">(</span><span class="VarId">vx</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">vy</span> <span class="Type">int</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'select_piece_at_position'</span><span class="Symbol">,</span> <span class="VarId">vx</span><span class="Symbol">,</span><span class="VarId">vy</span><span class="Symbol">);</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">selectable_pieces</span>
         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">vx</span><span class="Symbol">,</span><span class="VarId">vy</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">select_piece</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_unselect_piece</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'unselect_piece'</span><span class="Symbol">);</span>
  <span class="Comment">--remove piece from pieces to move</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">pieces_moved</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span><span class="Symbol">)</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">);</span>
  </pre></div></div></div><p
    >/<em
      >delete from pieces_to_move where (ptype, allegiance, tag) = (select ptype, allegiance, tag from selected_piece);</em
      >/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Comment">--empty selected piece, squares left_to_walk</span>
  <span class="Keyword">update</span> <span class="VarId">remaining_walk_hack_table</span>
    <span class="Keyword">set</span> <span class="VarId">remaining_walk_hack</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">remaining_walk_table</span><span class="Symbol">;</span>
  <span class="Keyword">update</span> <span class="VarId">remaining_walk_hack_table</span>
    <span class="Keyword">set</span> <span class="VarId">remaining_walk_hack</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="Comment">--if there are no more pieces that can be selected then move to next</span>
  <span class="Comment">--phase automatically, todo: take into account monsters in blob</span>
  </pre></div></div></div><p
    >/<em
      >if not exists(select 1 from pieces_to_move) then perform action_next_phase(); end if;</em
      >/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

  <span class="Comment">--insert history</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_cancel</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'cancel'</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">true</span><span class="Symbol">,</span><span class="Char">'none'</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>
</pre></div></div></div><p
    >/* ==== internals */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">skip_attack</span> <span class="VarId">boolean</span><span class="Symbol">,</span> <span class="VarId">phase_done</span> <span class="Type">text</span><span class="Symbol">)</span>
    <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">record</span><span class="Symbol">;</span>
  <span class="VarId">nextp</span> <span class="Type">text</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span><span class="Symbol">;</span>
  <span class="VarId">nextp</span> <span class="Symbol">:=</span> <span class="VarId">piece_next_subphase</span><span class="Symbol">((</span><span class="Keyword">select</span> <span class="VarId">move_phase</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">),</span>
             <span class="VarId">skip_attack</span><span class="Symbol">,</span> <span class="VarId">phase_done</span><span class="Symbol">,</span> <span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span><span class="Symbol">);</span>
  <span class="Keyword">if</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">move_phase</span> <span class="Symbol">=</span> <span class="Char">'motion'</span> <span class="VarId">then</span>
    <span class="Keyword">update</span> <span class="VarId">remaining_walk_hack_table</span>
      <span class="Keyword">set</span> <span class="VarId">remaining_walk_hack</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">;</span>
      <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">remaining_walk_table</span><span class="Symbol">;</span>
    <span class="Keyword">update</span> <span class="VarId">remaining_walk_hack_table</span>
      <span class="Keyword">set</span> <span class="VarId">remaining_walk_hack</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="VarId">nextp</span> <span class="Symbol">=</span> <span class="Char">'end'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">action_unselect_piece</span><span class="Symbol">();</span>
  <span class="VarId">else</span>
    <span class="Keyword">update</span> <span class="VarId">selected_piece</span> <span class="Keyword">set</span> <span class="VarId">move_phase</span> <span class="Symbol">=</span> <span class="VarId">nextp</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


</pre></div></div></div><p
    >/* === movement */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_walk</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">p</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'walk'</span><span class="Symbol">,</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">p</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">selected_piece_move_to</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_walked</span><span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
  <span class="Keyword">if</span> <span class="VarId">get_remaining_walk</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Number">0</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">,</span> <span class="Char">'motion'</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_fly</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">p</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'fly'</span><span class="Symbol">,</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">p</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">selected_piece_move_to</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_fly</span><span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">,</span> <span class="Char">'motion'</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/* === attacking */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_attack</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">ap</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">att</span> <span class="Type">int</span><span class="Symbol">;</span>
  <span class="VarId">def</span> <span class="Type">int</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'attack'</span><span class="Symbol">,</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>

  <span class="Comment">--if the attacker is a wizard with shadow form, they lose the shadow</span>
  <span class="Comment">--form when they attack</span>

  <span class="VarId">att</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">attack_strength</span>
         <span class="Keyword">from</span> <span class="VarId">attacking_pieces</span>
         <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">);</span>
  <span class="VarId">def</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">physical_defense</span>
         <span class="Keyword">from</span> <span class="VarId">attackable_pieces</span>
         <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top</span>
         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">));</span>

  <span class="Comment">--check for shadow form</span>

  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">ap</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span>
    <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="VarId">ap</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span> <span class="VarId">and</span>
     <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">wizards</span>
            <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">ap</span><span class="Symbol">.</span><span class="VarId">allegiance</span>
            <span class="Keyword">and</span> <span class="VarId">shadow_form</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">update</span> <span class="VarId">wizards</span>
      <span class="Keyword">set</span> <span class="VarId">shadow_form</span> <span class="Symbol">=</span> <span class="VarId">false</span>
      <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">ap</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span>
    <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>

  <span class="Keyword">perform</span> <span class="VarId">add_history_attack</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>


  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'attack'</span><span class="Symbol">,</span> <span class="VarId">greatest</span><span class="Symbol">((</span><span class="VarId">att</span> <span class="Symbol">-</span> <span class="VarId">def</span><span class="Symbol">)</span> <span class="Symbol">*</span> <span class="Number">10</span> <span class="Symbol">+</span> <span class="Number">50</span><span class="Symbol">,</span> <span class="Number">10</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Comment">--failure</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
    <span class="Keyword">perform</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">true</span><span class="Symbol">,</span> <span class="Char">'attack'</span><span class="Symbol">);</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">perform</span> <span class="VarId">add_history_chinned</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">kill_piece</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>

  <span class="Comment">--move to the square if mover and square empty</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">creature_prototypes</span>
              <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span>
     <span class="Keyword">and</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece_move_squares</span>
                <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">selected_piece_move_to</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">true</span><span class="Symbol">,</span> <span class="Char">'attack'</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_ranged_attack</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span>
    <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">att</span> <span class="Type">int</span><span class="Symbol">;</span>
  <span class="VarId">def</span> <span class="Type">int</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'ranged_attack'</span><span class="Symbol">,</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>

  <span class="VarId">att</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ranged_attack_strength</span>
         <span class="Keyword">from</span> <span class="VarId">ranged_weapon_pieces</span>
         <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">);</span>
  <span class="VarId">def</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">physical_defense</span>
         <span class="Keyword">from</span> <span class="VarId">attackable_pieces</span>
         <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top</span>
         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">));</span>

  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span>
    <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>

  <span class="Keyword">perform</span> <span class="VarId">add_history_ranged_attack</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>

  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'ranged_attack'</span><span class="Symbol">,</span> <span class="VarId">greatest</span><span class="Symbol">((</span><span class="VarId">att</span> <span class="Symbol">-</span> <span class="VarId">def</span><span class="Symbol">)</span> <span class="Symbol">*</span> <span class="Number">10</span> <span class="Symbol">+</span> <span class="Number">50</span><span class="Symbol">,</span> <span class="Number">10</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Comment">--failure</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
    <span class="Keyword">perform</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">,</span> <span class="Char">'ranged_attack'</span><span class="Symbol">);</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">perform</span> <span class="VarId">add_history_chinned</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">kill_piece</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">do_next_move_subphase</span><span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">,</span> <span class="Char">'ranged_attack'</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/* === internals</p
    ><p
    >subphase progression</p
    ><p
    >skip attack is used to tell this routine to skip the attack sub phase. this is if either the motion subphase was just cancelled, or if the piece attacked when it was in the motion subphase</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">piece_next_subphase</span><span class="Symbol">(</span>
  <span class="VarId">current_subphase</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="VarId">skip_attack</span> <span class="VarId">boolean</span><span class="Symbol">,</span> <span class="VarId">just_done</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="VarId">pk</span> <span class="VarId">piece_key</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="Type">text</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">record</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span><span class="Symbol">=</span><span class="VarId">pk</span><span class="Symbol">;</span>
  <span class="Keyword">if</span> <span class="VarId">current_subphase</span> <span class="Symbol">=</span> <span class="Char">'start'</span>
     <span class="Keyword">and</span> <span class="VarId">just_done</span><span class="Symbol">=</span><span class="Char">'none'</span>
     <span class="Keyword">and</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">creature_pieces</span>
                <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span> <span class="Symbol">=</span> <span class="VarId">pk</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="VarId">return</span> <span class="Char">'motion'</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">current_subphase</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'attack'</span><span class="Symbol">,</span><span class="Char">'ranged_attack'</span><span class="Symbol">)</span>
         <span class="Keyword">and</span> <span class="Keyword">not</span> <span class="VarId">skip_attack</span>
         <span class="Keyword">and</span> <span class="VarId">just_done</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'attack'</span><span class="Symbol">,</span> <span class="Char">'ranged_attack'</span><span class="Symbol">)</span>
         <span class="Keyword">and</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">attacking_pieces</span>
                <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span><span class="Symbol">=</span><span class="VarId">pk</span><span class="Symbol">)</span>
         <span class="Keyword">and</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">attackable_pieces</span> <span class="VarId">ap</span>
           <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">one_square_away</span><span class="Symbol">((</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">))</span>
           <span class="Keyword">where</span> <span class="VarId">allegiance</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="VarId">pk</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="Char">'dead'</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="VarId">return</span> <span class="Char">'attack'</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">current_subphase</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'ranged_attack'</span><span class="Symbol">)</span>
    <span class="Keyword">and</span> <span class="VarId">just_done</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'ranged_attack'</span><span class="Symbol">)</span>
    <span class="Keyword">and</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">ranged_weapon_pieces</span>
                <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span> <span class="Symbol">=</span> <span class="VarId">pk</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="VarId">return</span> <span class="Char">'ranged_attack'</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
    <span class="VarId">return</span> <span class="Char">'end'</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_chinned_history</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span>
      <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_chinned</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span>
      <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">selected_piece_move_to</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Comment">-- this is used to move a piece when it walks/flies and as part of a</span>
  <span class="Comment">-- successful attack to keep the logic for moving a wizard piece</span>
  <span class="Comment">-- along with his mount in one place</span>
  <span class="VarId">if</span>
     <span class="Comment">--this is a ridable monster</span>
     <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
       <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">monster_pieces</span>
       <span class="Keyword">where</span> <span class="VarId">ridable</span><span class="Symbol">)</span> <span class="VarId">and</span>
     <span class="Comment">--there is also a wizard on this square</span>
     <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
      <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
            <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span>
      <span class="Keyword">where</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span><span class="Symbol">)</span> <span class="VarId">then</span>
     <span class="Comment">-- move the wizard also</span>
    <span class="Keyword">update</span> <span class="VarId">pieces</span>
      <span class="Keyword">set</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">px</span><span class="Symbol">,</span>
          <span class="VarId">y</span> <span class="Symbol">=</span> <span class="VarId">py</span>
      <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span>
        <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span>
         <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
               <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
         <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span>
         <span class="Keyword">where</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">update</span> <span class="VarId">pieces</span>
    <span class="Keyword">set</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">px</span><span class="Symbol">,</span>
        <span class="VarId">y</span> <span class="Symbol">=</span> <span class="VarId">py</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">);</span>

  <span class="Comment">--todo: if diagonal, reduce by 1.5</span>
  <span class="Comment">-- the way chaos worked is that if you had 0.5 moves left,</span>
  <span class="Comment">-- you could walk a whole square, and if you had 0.5 or 1 move left</span>
  <span class="Comment">-- you could walk a diagonal</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">creature_pieces</span>
            <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span>
            <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">flying</span><span class="Symbol">)</span> <span class="VarId">and</span>
     <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">move_phase</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">)=</span><span class="Char">'motion'</span> <span class="VarId">then</span>
    <span class="Keyword">update</span> <span class="VarId">remaining_walk_table</span>
    <span class="Keyword">set</span> <span class="VarId">remaining_walk</span> <span class="Symbol">=</span> <span class="VarId">remaining_walk</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">;</span>
    <span class="Keyword">perform</span> <span class="VarId">check_engaged</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">selected_piece_adjacent_attacking_squares</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">one_square_away</span><span class="Symbol">((</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
                                 <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span><span class="Symbol">))</span>
  <span class="VarId">intersect</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
  <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_mr</span>
  <span class="Keyword">where</span> <span class="VarId">attack_strength</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="VarId">null</span>
    <span class="Keyword">and</span> <span class="VarId">allegiance</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="VarId">get_current_wizard</span><span class="Symbol">(),</span> <span class="Char">'dead'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_engaged</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">ag</span> <span class="Type">int</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece_adjacent_attacking_squares</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">ag</span> <span class="VarId">agility</span> <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
    <span class="Keyword">if</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'break_engaged'</span><span class="Symbol">,</span> <span class="VarId">ag</span> <span class="Symbol">*</span> <span class="Number">10</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">update</span> <span class="VarId">selected_piece</span> <span class="Keyword">set</span> <span class="VarId">engaged</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>
    <span class="VarId">else</span>
      <span class="Keyword">update</span> <span class="VarId">selected_piece</span> <span class="Keyword">set</span> <span class="VarId">engaged</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
    <span class="Keyword">update</span> <span class="VarId">selected_piece</span> <span class="Keyword">set</span> <span class="VarId">engaged</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
