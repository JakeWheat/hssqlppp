<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >NextPhase</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.NextPhase'</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/* == next phase</p
    ><p
    >next phase is the function to end a wizard's turn and move to the next one. It can be called implicitly by other actions as well as directly, e.g. once you've cast your spell, there's nothing you can do except end your turn so next_phase gets called automatically</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">create_var</span><span class="Symbol">(</span><span class="Char">'dont_nest_ai_next_phase'</span><span class="Symbol">,</span> <span class="Char">'bool'</span><span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'dont_nest_ai_next_phase_table'</span><span class="Symbol">,</span> <span class="Char">'hack'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_next_phase</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="Comment">--c int;</span>
  <span class="VarId">next_phase_again</span> <span class="VarId">boolean</span> <span class="Symbol">:=</span> <span class="VarId">false</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
</pre></div></div></div><p
    >/* === check for game completion */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Comment">--check for win or draw</span>
  <span class="Keyword">case</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span><span class="Symbol">)</span>
    <span class="Keyword">when</span> <span class="Number">1</span> <span class="Keyword">then</span> <span class="Comment">--someone has won</span>
      <span class="Keyword">perform</span> <span class="VarId">game_completed</span><span class="Symbol">();</span>
      <span class="Keyword">update</span> <span class="VarId">current_wizard_table</span> <span class="Keyword">set</span> <span class="VarId">current_wizard</span> <span class="Symbol">=</span>
        <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span><span class="Symbol">);</span>
      <span class="Keyword">perform</span> <span class="VarId">add_history_game_won</span><span class="Symbol">();</span>
      <span class="VarId">return</span><span class="Symbol">;</span>
    <span class="Keyword">when</span> <span class="Number">0</span> <span class="Keyword">then</span> <span class="Comment">--game is drawn</span>
      <span class="Keyword">perform</span> <span class="VarId">game_completed</span><span class="Symbol">();</span>
      <span class="Keyword">perform</span> <span class="VarId">add_history_game_drawn</span><span class="Symbol">();</span>
      <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
      <span class="VarId">return</span><span class="Symbol">;</span>
    <span class="VarId">else</span>
      <span class="Keyword">null</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">case</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/* === current wizard clean up phase</p
    ><p
    >If the user selects next phase when they have a spell to cast, then we want to call the usual skip spell action so as not to duplicate the work. But skip spell will call next_phase itself automatically and we don't want to do two next phases, so if there is a spell to be skipped, run that and don't run the rest of the next_phase function since it will be called via skip spell.</p
    ><p
    >this might be better if skip spell wasn't used for both explicitly and implicitly skipping</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
    <span class="Comment">-- if the current spell isn't completed, then skip it</span>
  <span class="Keyword">if</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'cast'</span>
     <span class="Keyword">and</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
                <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizard_spell_choices</span>
                  <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">skip_spell</span><span class="Symbol">();</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Comment">--multiple update hack to get round constraints</span>
  <span class="Keyword">update</span> <span class="VarId">in_next_phase_hack_table</span>
    <span class="Keyword">set</span> <span class="VarId">in_next_phase_hack</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">;</span>

  <span class="Comment">--complete current phase:</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="Char">'move'</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">pieces_moved</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/* === all wizards clean up phase</p
    ><p
    >clean up if this is the last wizard for this phase, then move to next phase, if this is autonomous, then do it and move to move phase this works because all the end phase stuff happens before the autonomous phase is run in this function, and all the setup runs after it is run.</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

  <span class="Keyword">if</span> <span class="VarId">is_last_wizard</span><span class="Symbol">()</span> <span class="VarId">then</span>
    <span class="Keyword">case</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span>
      <span class="Keyword">when</span> <span class="Char">'cast'</span> <span class="VarId">then</span>
        <span class="Comment">--clear the cast alignment which is used to adjust the world</span>
        <span class="Comment">--alignment when a spell is cast</span>
        <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">cast_alignment_table</span><span class="Symbol">;</span>
      <span class="Keyword">when</span> <span class="Char">'move'</span> <span class="VarId">then</span>
        <span class="Comment">--if this is the end of the move phase then we're on the next turn</span>
        <span class="Keyword">update</span> <span class="VarId">turn_number_table</span>
          <span class="Keyword">set</span> <span class="VarId">turn_number</span> <span class="Symbol">=</span> <span class="VarId">turn_number</span> <span class="Symbol">+</span> <span class="Number">1</span><span class="Symbol">;</span>
        <span class="Keyword">perform</span> <span class="VarId">add_history_new_turn</span><span class="Symbol">();</span>
      <span class="VarId">else</span>
        <span class="Keyword">null</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">case</span><span class="Symbol">;</span>
    <span class="Comment">--move to the next turn phase</span>
    <span class="Keyword">update</span> <span class="VarId">turn_phase_table</span>
      <span class="Keyword">set</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="VarId">next_turn_phase</span><span class="Symbol">(</span><span class="VarId">turn_phase</span><span class="Symbol">);</span>

    <span class="Keyword">if</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'autonomous'</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">do_autonomous_phase</span><span class="Symbol">();</span>
      <span class="Keyword">update</span> <span class="VarId">turn_phase_table</span>
        <span class="Keyword">set</span> <span class="VarId">turn_phase</span> <span class="Symbol">=</span> <span class="VarId">next_turn_phase</span><span class="Symbol">(</span><span class="VarId">turn_phase</span><span class="Symbol">);</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/* === init new current phase */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Comment">-- move to the next wizard, this is the meat of this function</span>
  <span class="Keyword">update</span> <span class="VarId">current_wizard_table</span>
    <span class="Keyword">set</span> <span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">next_wizard</span><span class="Symbol">(</span><span class="VarId">current_wizard</span><span class="Symbol">);</span>

  <span class="Comment">--initialise the spell for this phase</span>
  <span class="Keyword">if</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'cast'</span> <span class="VarId">then</span>
    <span class="Comment">--setup the cast alignment table if this is the start of the cast</span>
    <span class="Comment">--phases</span>
    <span class="Keyword">if</span> <span class="VarId">is_first_wizard</span><span class="Symbol">()</span> <span class="VarId">then</span>
      <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">cast_alignment_table</span> <span class="Keyword">values</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">);</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">spell_parts_to_cast_table</span>
        <span class="Keyword">select</span> <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">numb</span><span class="Symbol">,</span> <span class="Number">0</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="VarId">target_spells</span>
        <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">;</span>
      <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">cast_success_checked_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span>
    <span class="VarId">else</span>
      <span class="Comment">--skip to the next phase automatically</span>
      <span class="VarId">next_phase_again</span> <span class="Symbol">:=</span> <span class="VarId">true</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  </pre></div></div></div><p
    >/<em
      >elseif (select turn_phase = 'move' from turn_phase_table) then insert into pieces_to_move select ptype, allegiance, tag from moving_pieces inner join current_wizard_table on allegiance = current_wizard;</em
      >/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Comment">--finished our updates for this next phase</span>
  <span class="Keyword">update</span> <span class="VarId">in_next_phase_hack_table</span>
    <span class="Keyword">set</span> <span class="VarId">in_next_phase_hack</span> <span class="Symbol">=</span> <span class="VarId">false</span><span class="Symbol">;</span>

  <span class="Keyword">perform</span> <span class="VarId">add_history_wizard_up</span><span class="Symbol">();</span>
</pre></div></div></div><p
    >/* === continue */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Comment">--if there is nothing to do in the new current phase - continue to</span>
  <span class="Comment">--next phase automatically</span>
  <span class="Keyword">if</span> <span class="VarId">next_phase_again</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">action_next_phase</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/* === internals */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">is_last_wizard</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="VarId">with</span>
            <span class="VarId">uw</span> <span class="Keyword">as</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">original_place</span>
                   <span class="Keyword">from</span> <span class="VarId">wizards</span>
                   <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span><span class="Symbol">)</span>
  <span class="Keyword">select</span> <span class="VarId">original_place</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">max</span><span class="Symbol">(</span><span class="VarId">original_place</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="VarId">uw</span><span class="Symbol">)</span>
            <span class="Keyword">from</span> <span class="VarId">current_wizard</span>
            <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">uw</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">is_first_wizard</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
  <span class="VarId">with</span>
    <span class="VarId">uw</span> <span class="Keyword">as</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">original_place</span>
                   <span class="Keyword">from</span> <span class="VarId">wizards</span>
                   <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span><span class="Symbol">)</span>
  <span class="Keyword">select</span> <span class="VarId">original_place</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">min</span><span class="Symbol">(</span><span class="VarId">original_place</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="VarId">uw</span><span class="Symbol">)</span>
            <span class="Keyword">from</span> <span class="VarId">current_wizard</span>
            <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">uw</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
