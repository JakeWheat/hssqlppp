<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >SpellCast</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.SpellCast'</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/* == cast spells */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">skip_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_skipped</span><span class="Symbol">();</span>
  <span class="Keyword">perform</span> <span class="VarId">spend_current_wizard_spell</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_cast_target_spell</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">vspell_name</span> <span class="Type">text</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'cast_target_spell'</span><span class="Symbol">,</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_attempt_target_spell</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>

  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">check_spell_success</span><span class="Symbol">()</span> <span class="VarId">then</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">monster_spells</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">cast_monster_spell</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="VarId">else</span>

    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">vspell_name</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">;</span>
    <span class="Keyword">if</span> <span class="VarId">vspell_name</span> <span class="Symbol">=</span> <span class="Char">'disbelieve'</span> <span class="VarId">then</span>
      <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">cast_disbelieve</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">)</span> <span class="VarId">then</span>
        <span class="VarId">return</span><span class="Symbol">;</span>
      <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="Keyword">elseif</span> <span class="VarId">vspell_name</span> <span class="Symbol">=</span> <span class="Char">'subversion'</span> <span class="VarId">then</span>
      <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">cast_subversion</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">)</span> <span class="VarId">then</span>
        <span class="VarId">return</span><span class="Symbol">;</span>
      <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="Keyword">elseif</span> <span class="VarId">vspell_name</span> <span class="Symbol">=</span> <span class="Char">'raise_dead'</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">cast_raise_dead</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">elseif</span> <span class="VarId">vspell_name</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'decree'</span><span class="Symbol">,</span> <span class="Char">'justice'</span><span class="Symbol">,</span> <span class="Char">'vengeance'</span><span class="Symbol">,</span> <span class="Char">'dark_power'</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">cast_decree_spell</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">elseif</span> <span class="VarId">vspell_name</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'lightning'</span><span class="Symbol">,</span> <span class="Char">'magic_bolt'</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">cast_ballistic_spell</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">elseif</span> <span class="VarId">vspell_name</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'shadow_wood'</span><span class="Symbol">,</span>
      <span class="Char">'magic_fire'</span><span class="Symbol">,</span> <span class="Char">'gooey_blob'</span><span class="Symbol">,</span> <span class="Char">'wall'</span><span class="Symbol">,</span>
      <span class="Char">'magic_castle'</span><span class="Symbol">,</span> <span class="Char">'dark_citadel'</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">cast_object_spell</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
    <span class="VarId">else</span>
      <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'unrecognised target spell %'</span><span class="Symbol">,</span> <span class="VarId">vspell_name</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Comment">--todo: only update alignment once per spell</span>
  <span class="Keyword">perform</span> <span class="VarId">update_alignment_from_cast</span><span class="Symbol">();</span>

  <span class="Keyword">update</span> <span class="VarId">spell_parts_to_cast_table</span>
    <span class="Keyword">set</span> <span class="VarId">spell_parts_to_cast</span> <span class="Symbol">=</span> <span class="VarId">spell_parts_to_cast</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">;</span>
  <span class="Keyword">if</span> <span class="VarId">get_spell_parts_to_cast</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Number">0</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">spend_current_wizard_spell</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_cast_activate_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="Char">'cast_activate_spell'</span><span class="Symbol">);</span>
<span class="Comment">--  perform check_can_cast_spell_now();</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_attempt_activate_spell</span><span class="Symbol">();</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">check_spell_success</span><span class="Symbol">()</span> <span class="VarId">then</span>
    <span class="VarId">return</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Comment">--call the appropiate function to handle the spell</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">spell_category</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span> <span class="Keyword">from</span> <span class="VarId">spells_mr</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">action_cast_wizard_spell</span><span class="Symbol">(</span><span class="VarId">get_current_wizard</span><span class="Symbol">(),</span>
      <span class="VarId">get_current_wizard_spell</span><span class="Symbol">());</span>
  <span class="Keyword">elseif</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">spells_mr</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_spell</span>
      <span class="Keyword">where</span> <span class="VarId">spell_name</span> <span class="VarId">in</span><span class="Symbol">(</span><span class="Char">'law'</span><span class="Symbol">,</span> <span class="Char">'chaos'</span><span class="Symbol">,</span> <span class="Char">'large_law'</span><span class="Symbol">,</span>
      <span class="Char">'large_chaos'</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">cast_lawchaos</span><span class="Symbol">();</span>
  <span class="Keyword">elseif</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">=</span><span class="Char">'turmoil'</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">cast_turmoil</span><span class="Symbol">();</span>
  <span class="Keyword">elseif</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">=</span><span class="Char">'magic_wood'</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">cast_magic_wood</span><span class="Symbol">();</span>
  <span class="VarId">else</span>
    <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'unrecognised activate spell: %'</span><span class="Symbol">,</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">spell_name</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">update_alignment_from_cast</span><span class="Symbol">();</span>
  <span class="Keyword">perform</span> <span class="VarId">spend_current_wizard_spell</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


</pre></div></div></div><p
    >/* === internals</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">spend_current_wizard_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">cw</span> <span class="Type">text</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Comment">--remove current wizard's spell from spell book</span>
  <span class="Comment">--make sure we only remove one shot of the spell</span>
  <span class="Comment">--don't remove disbelieve</span>
  <span class="Comment">--update spell_choice_hack_table</span>
  <span class="Comment">--  set spell_choice_hack = true;</span>

  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">spell_parts_to_cast_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">cw</span> <span class="VarId">current_wizard</span>
    <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">spell_books</span> <span class="Keyword">where</span> <span class="VarId">id</span> <span class="Symbol">=</span>
    <span class="Symbol">(</span><span class="VarId">with</span>
      <span class="VarId">w</span> <span class="VarId">as</span>
        <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices</span>
         <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">cw</span> <span class="Keyword">and</span> <span class="VarId">spell_name</span> <span class="Symbol">!=</span> <span class="Char">'disbelieve'</span><span class="Symbol">)</span>
      <span class="Keyword">select</span> <span class="VarId">id</span> <span class="Keyword">from</span> <span class="VarId">w</span>
       <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">spell_books</span>
       <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">);</span>
  <span class="Comment">-- and wipe it from the wizard_spell_choices_table</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span>
    <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">cw</span><span class="Symbol">;</span>

  <span class="Comment">--update spell_choice_hack_table</span>
  <span class="Comment">--  set spell_choice_hack = false;</span>

  <span class="Comment">--auto move to next wizard</span>
  <span class="Keyword">perform</span> <span class="VarId">action_next_phase</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">spell_cast_chance</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">,</span> <span class="VarId">base_chance</span> <span class="Keyword">as</span> <span class="VarId">chance</span> <span class="VarId">from</span>
    <span class="Comment">--all spells if world is neutral, neutral spells unirregardless</span>
    <span class="Comment">-- of world alignment</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">,</span> <span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">alignment</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">salign</span><span class="Symbol">,</span> <span class="VarId">base_chance</span><span class="Symbol">,</span>
      <span class="Char">'neutral'</span> <span class="Keyword">as</span> <span class="VarId">alignment</span> <span class="Keyword">from</span> <span class="VarId">spells_mr</span>
    <span class="Keyword">union</span> <span class="VarId">all</span>
    <span class="Comment">--world alignment same as spell alignment</span>
    <span class="Comment">--  proportionately more easy</span>
    <span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">,</span> <span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">alignment</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">salign</span><span class="Symbol">,</span>
      <span class="VarId">limit_chance</span><span class="Symbol">(</span><span class="VarId">base_chance</span> <span class="Symbol">+</span> <span class="Symbol">(</span>@ <span class="VarId">get_world_alignment</span><span class="Symbol">())</span> <span class="Symbol">*</span> <span class="Number">10</span><span class="Symbol">),</span>
      <span class="Char">'same'</span> <span class="Keyword">as</span> <span class="VarId">alignment</span> <span class="Keyword">from</span> <span class="VarId">spells_mr</span>
    <span class="Keyword">union</span> <span class="VarId">all</span>
    <span class="Comment">--world alignment opposite, spell slightly harder</span>
    <span class="Keyword">select</span> <span class="VarId">spell_name</span><span class="Symbol">,</span> <span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">alignment</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">salign</span><span class="Symbol">,</span>
      <span class="VarId">limit_chance</span><span class="Symbol">(</span><span class="VarId">base_chance</span> <span class="Symbol">-</span> <span class="Number">10</span><span class="Symbol">),</span>
      <span class="Char">'opposite'</span> <span class="Keyword">as</span> <span class="VarId">alignment</span> <span class="Keyword">from</span> <span class="VarId">spells_mr</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
  <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">salign</span> <span class="Symbol">=</span> <span class="Number">0</span> <span class="Keyword">and</span> <span class="VarId">alignment</span> <span class="Symbol">=</span> <span class="Char">'neutral'</span><span class="Symbol">)</span> <span class="Comment">--neutral spells always</span>
                                               <span class="Comment">--same alignment</span>
    <span class="Keyword">or</span> <span class="Symbol">(</span><span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">get_world_alignment</span><span class="Symbol">())</span> <span class="Symbol">=</span> <span class="Number">0</span> <span class="Keyword">and</span> <span class="VarId">alignment</span> <span class="Symbol">=</span> <span class="Char">'neutral'</span><span class="Symbol">)</span>
    <span class="Keyword">or</span> <span class="Symbol">(</span><span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">get_world_alignment</span><span class="Symbol">())</span> <span class="Symbol">=</span> <span class="Number">1</span> <span class="Keyword">and</span> <span class="Comment">--world law</span>
          <span class="Symbol">((</span><span class="VarId">salign</span> <span class="Symbol">=</span> <span class="Number">1</span> <span class="Keyword">and</span> <span class="VarId">alignment</span> <span class="Symbol">=</span> <span class="Char">'same'</span><span class="Symbol">)</span> <span class="Comment">--law spells benefit</span>
            <span class="Keyword">or</span> <span class="VarId">salign</span> <span class="Symbol">=</span> <span class="Number">-1</span> <span class="Keyword">and</span> <span class="VarId">alignment</span> <span class="Symbol">=</span> <span class="Char">'opposite'</span><span class="Symbol">))</span>
    <span class="Keyword">or</span> <span class="Symbol">(</span><span class="VarId">sign</span><span class="Symbol">(</span><span class="VarId">get_world_alignment</span><span class="Symbol">())</span> <span class="Symbol">=</span> <span class="Number">-1</span> <span class="Keyword">and</span> <span class="Comment">-- world chaos</span>
          <span class="Symbol">((</span><span class="VarId">salign</span> <span class="Symbol">=</span> <span class="Number">-1</span> <span class="Keyword">and</span> <span class="VarId">alignment</span> <span class="Symbol">=</span> <span class="Char">'same'</span><span class="Symbol">)</span> <span class="Comment">--chaos spells benefit</span>
            <span class="Keyword">or</span> <span class="VarId">salign</span> <span class="Symbol">=</span> <span class="Number">1</span> <span class="Keyword">and</span> <span class="VarId">alignment</span> <span class="Symbol">=</span> <span class="Char">'opposite'</span><span class="Symbol">));</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">spell_cast_chance</span><span class="Symbol">(</span><span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="VarId">integer</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">chance</span> <span class="Keyword">from</span> <span class="VarId">spell_cast_chance</span> <span class="Keyword">where</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> $<span class="Number">1</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_cast_wizard_spell</span><span class="Symbol">(</span>
       <span class="VarId">pwizard_name</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="VarId">spell_name</span> <span class="Type">text</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Comment">--todo: update stats</span>
  <span class="Keyword">if</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="Char">'magic_armour'</span> <span class="VarId">then</span>
      <span class="Keyword">update</span> <span class="VarId">wizards</span>
        <span class="Keyword">set</span> <span class="VarId">magic_armour</span> <span class="Symbol">=</span> <span class="VarId">true</span>
        <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">pwizard_name</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="Char">'magic_shield'</span> <span class="VarId">then</span>
      <span class="Keyword">update</span> <span class="VarId">wizards</span>
        <span class="Keyword">set</span> <span class="VarId">magic_shield</span> <span class="Symbol">=</span> <span class="VarId">true</span>
        <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">pwizard_name</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="Char">'magic_knife'</span> <span class="VarId">then</span>
      <span class="Keyword">update</span> <span class="VarId">wizards</span>
        <span class="Keyword">set</span> <span class="VarId">magic_knife</span> <span class="Symbol">=</span> <span class="VarId">true</span>
        <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">pwizard_name</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="Char">'magic_sword'</span> <span class="VarId">then</span>
      <span class="Keyword">update</span> <span class="VarId">wizards</span>
        <span class="Keyword">set</span> <span class="VarId">magic_sword</span> <span class="Symbol">=</span> <span class="VarId">true</span>
        <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">pwizard_name</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="Char">'magic_bow'</span> <span class="VarId">then</span>
      <span class="Keyword">update</span> <span class="VarId">wizards</span>
        <span class="Keyword">set</span> <span class="VarId">magic_bow</span> <span class="Symbol">=</span> <span class="VarId">true</span>
        <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">pwizard_name</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="Char">'magic_wings'</span> <span class="VarId">then</span>
    <span class="Keyword">update</span> <span class="VarId">wizards</span> <span class="Keyword">set</span> <span class="VarId">magic_wings</span> <span class="Symbol">=</span> <span class="VarId">true</span>
      <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">pwizard_name</span><span class="Symbol">;</span>
  <span class="Keyword">elseif</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span> <span class="Char">'shadow_form'</span> <span class="VarId">then</span>
      <span class="Keyword">update</span> <span class="VarId">wizards</span>
        <span class="Keyword">set</span> <span class="VarId">shadow_form</span> <span class="Symbol">=</span> <span class="VarId">true</span>
        <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">pwizard_name</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
    <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'unrecognised wizard spell %'</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_lawchaos</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Comment">--don't need to do anything, the effect is</span>
  <span class="Comment">--restricted to the alignment effect which</span>
  <span class="Comment">--is handled in the same place for all spells</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_turmoil</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">record</span><span class="Symbol">;</span>
  <span class="VarId">s</span> <span class="VarId">record</span><span class="Symbol">;</span>
  <span class="VarId">tx</span> <span class="Type">int</span><span class="Symbol">;</span>
  <span class="VarId">ty</span> <span class="Type">int</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Comment">--algorithm: similar to the original chaos I think</span>
  <span class="Comment">-- run through each square in turn, starting at top</span>
  <span class="Comment">--left across top then along each row till you get to the</span>
  <span class="Comment">--bottom right</span>
  <span class="Comment">--move all the pieces in a square to a new random empty</span>
  <span class="Comment">--square at the time of the move (so if pieces on the</span>
  <span class="Comment">--same square as each other before turmoil is cast</span>
  <span class="Comment">--will still be on the same square as each other</span>
  <span class="Comment">--afterwoods. (since we do one square at a time we</span>
  <span class="Comment">-- won't get exact random distribution).</span>

  <span class="Comment">-- the for loop does actually save the full query</span>
  <span class="Comment">-- at the start so updates in the for loop are not</span>
  <span class="Comment">-- seen by the for loop so there is no risk of a</span>
  <span class="Comment">-- piece teleporting twice</span>
  <span class="Keyword">for</span> <span class="VarId">r</span> <span class="VarId">in</span> <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span> <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="VarId">loop</span>
    <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">into</span> <span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">ty</span>
    <span class="Keyword">from</span> <span class="VarId">squares_valid_categories</span>
      <span class="Keyword">where</span> <span class="VarId">category</span><span class="Symbol">=</span><span class="Char">'empty'</span> <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">random</span><span class="Symbol">()</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
    <span class="Keyword">update</span> <span class="VarId">pieces</span> <span class="Keyword">set</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">tx</span><span class="Symbol">,</span> <span class="VarId">y</span> <span class="Symbol">=</span> <span class="VarId">ty</span>
      <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
    <span class="Comment">--add histories</span>
</pre></div></div></div><p
    >/* for s in select ptype, allegiance, tag from pieces where x = tx and y = ty loop</p
    ><p
    >perform einsert(array['action_history', 'action_history_piece_teleport'], array['history_name', 'ptype', 'allegiance', 'tag'], array['piece teleport', s.ptype, s.allegiance, s.tag::text]); end loop;*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_decree_spell</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">m</span> <span class="Type">int</span><span class="Symbol">;</span>

<span class="VarId">begin</span>
  <span class="Comment">--if cast on wizard then success destroys all wizards objects</span>
  <span class="Comment">--else if cast on monster then success destroys monster</span>
  <span class="Comment">--get target magic defense</span>
  <span class="Comment">--todo: should this take into account the spell/attack?</span>
  <span class="VarId">m</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">magic_defense</span>
        <span class="Keyword">from</span> <span class="VarId">pieces_on_top_view</span>
        <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">magic_attackable_pieces</span>
        <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)=(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">));</span>

  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'resist'</span><span class="Symbol">,</span> <span class="VarId">m</span> <span class="Symbol">*</span> <span class="Number">10</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span>
      <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
      <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)=(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">if</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span> <span class="VarId">then</span>
      <span class="Keyword">for</span> <span class="VarId">r</span> <span class="VarId">in</span> <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
        <span class="Keyword">where</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">allegiance</span> <span class="Keyword">and</span> <span class="VarId">ptype</span> <span class="Symbol">!=</span> <span class="Char">'wizard'</span> <span class="VarId">loop</span>
        <span class="Keyword">perform</span> <span class="VarId">disintegrate</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
      <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
    <span class="VarId">else</span>
      <span class="Keyword">perform</span> <span class="VarId">disintegrate</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_ballistic_spell</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Comment">--todo: should factor in the attack strength?</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'resist'</span><span class="Symbol">,</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">physical_defense</span> <span class="Symbol">*</span> <span class="Number">10</span>
       <span class="Keyword">from</span> <span class="VarId">pieces_on_top_view</span>
       <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">)))</span> <span class="VarId">then</span>
    <span class="Comment">--need to added the chinned history before the</span>
    <span class="Comment">--piece is killed or we loose the allegiance</span>
    <span class="Comment">--need to add the spell successful before the</span>
     <span class="Comment">--chinned history or the order is wrong</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
    <span class="Keyword">perform</span> <span class="VarId">add_chinned_history</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span>
      <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
      <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">perform</span> <span class="VarId">kill_piece</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
  <span class="VarId">else</span>
    <span class="Comment">--spell didn't do any damage</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_raise_dead</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
  <span class="VarId">cw</span> <span class="Type">text</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">cw</span> <span class="VarId">current_wizard</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
  <span class="Comment">--turn dead creature on square to live undead</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span>
    <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">update</span> <span class="VarId">pieces</span>
    <span class="Keyword">set</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span>
        <span class="VarId">tag</span> <span class="Symbol">=</span> <span class="VarId">get_next_tag</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">cw</span><span class="Symbol">)</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span> <span class="Symbol">=</span> <span class="VarId">r</span>
    <span class="Keyword">returning</span> <span class="VarId">tag</span> <span class="Keyword">into</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">crimes_against_nature</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">cw</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_subversion</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
    <span class="Keyword">if</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'resist'</span><span class="Symbol">,</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">magic_defense</span> <span class="Symbol">*</span> <span class="Number">10</span>
        <span class="Keyword">from</span> <span class="VarId">pieces_on_top_view</span>
        <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">)))</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">perform</span> <span class="VarId">action_cast_failed</span><span class="Symbol">();</span>
    <span class="VarId">return</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
 <span class="Keyword">update</span> <span class="VarId">pieces</span>
    <span class="Keyword">set</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">current_wizard</span>
       <span class="Symbol">,</span><span class="VarId">tag</span> <span class="Symbol">=</span> <span class="VarId">get_next_tag</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">current_wizard</span><span class="Symbol">)</span>
    <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
    <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)::</span><span class="VarId">piece_key</span> <span class="Symbol">=</span> <span class="VarId">r</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">add_chinned_history</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
  <span class="VarId">return</span> <span class="VarId">true</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_disbelieve</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">imaginary</span> <span class="Keyword">from</span> <span class="VarId">pieces_on_top_view</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
    <span class="Keyword">perform</span> <span class="VarId">action_cast_failed</span><span class="Symbol">();</span>
    <span class="VarId">return</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span>
    <span class="Keyword">from</span> <span class="VarId">pieces_on_top</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">);</span>

  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
  <span class="Keyword">perform</span> <span class="VarId">add_chinned_history</span><span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">disintegrate</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">);</span>
  <span class="VarId">return</span> <span class="VarId">true</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_object_spell</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">create_object</span><span class="Symbol">(</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span>
     <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">summon_spells</span><span class="Symbol">),</span>
     <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_monster_spell</span><span class="Symbol">(</span><span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">y</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">cw</span> <span class="Type">text</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">cw</span> <span class="VarId">current_wizard</span>
    <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">create_monster</span><span class="Symbol">(</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_spell</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">summon_spells</span><span class="Symbol">),</span>
    <span class="VarId">cw</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">coalesce</span><span class="Symbol">((</span>
      <span class="Keyword">select</span> <span class="VarId">imaginary</span>
      <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_imaginary</span>
      <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">cw</span><span class="Symbol">),</span><span class="VarId">false</span><span class="Symbol">),</span> <span class="VarId">false</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_spell_success</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Comment">-- if already checked then return true</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">cast_success_checked</span>
    <span class="Keyword">from</span> <span class="VarId">cast_success_checked_table</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="VarId">return</span> <span class="VarId">true</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Comment">-- if imaginary monster then always succeed</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">imaginary</span><span class="Symbol">,</span> <span class="VarId">false</span><span class="Symbol">)</span>
    <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices_mr</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="VarId">return</span> <span class="VarId">true</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="Char">'cast'</span><span class="Symbol">,</span>
       <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">chance</span>
        <span class="Keyword">from</span> <span class="VarId">spell_cast_chance</span>
        <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">))</span> <span class="VarId">then</span>
     <span class="Keyword">perform</span> <span class="VarId">action_cast_failed</span><span class="Symbol">();</span>
     <span class="VarId">return</span> <span class="VarId">false</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
     <span class="Keyword">update</span> <span class="VarId">cast_success_checked_table</span>
       <span class="Keyword">set</span> <span class="VarId">cast_success_checked</span> <span class="Symbol">=</span> <span class="VarId">true</span><span class="Symbol">;</span>
     <span class="VarId">return</span> <span class="VarId">true</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">update_alignment_from_cast</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">update</span> <span class="VarId">cast_alignment_table</span>
    <span class="Keyword">set</span> <span class="VarId">cast_alignment</span> <span class="Symbol">=</span> <span class="VarId">cast_alignment</span> <span class="Symbol">+</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">alignment</span> <span class="Keyword">from</span> <span class="VarId">spells_mr</span>
        <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_spell</span><span class="Symbol">);</span>
  <span class="Keyword">perform</span> <span class="VarId">adjust_world_alignment</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_cast_failed</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_failed</span><span class="Symbol">();</span>
  <span class="Keyword">perform</span> <span class="VarId">spend_current_wizard_spell</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

  </pre></div></div></div><p
    >/* idea is to create a view with all the valid squares in it and to start with a square series of squares 1 square away from the wizard: XXX XWX XXX starting with the top left one, cast trees in the available squares then move to 2 squares away: XXXXX X...X X.W.X X...X XXXXX and keep going until we are at the range of the spell (if the view takes the range into account then we keep going to max(width of board, height of board) if this isn't too slow pos_in_square is used to track which square we are looking at e.g. at range one: 123 4W5 678 range two 12345 6...7 8.W.9 0...1 23456 (the 012346 on the second to last and last rows represent 10,11,12,13,14,15,16 */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_square_range</span><span class="Symbol">(</span><span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">y</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="Keyword">range</span> <span class="Type">int</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="Keyword">setof</span> <span class="VarId">pos</span> <span class="Keyword">as</span> $$
    <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span> <span class="VarId">from</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">generate_series</span><span class="Symbol">(</span>$<span class="Number">1</span> <span class="Symbol">-</span> $<span class="Number">3</span><span class="Symbol">,</span> $<span class="Number">1</span> <span class="Symbol">+</span> $<span class="Number">3</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">x</span><span class="Symbol">,</span>$<span class="Number">2</span> <span class="Symbol">-</span> $<span class="Number">3</span> <span class="Keyword">as</span> <span class="VarId">y</span>
     <span class="Keyword">union</span> <span class="Keyword">select</span> $<span class="Number">1</span> <span class="Symbol">-</span> $<span class="Number">3</span><span class="Symbol">,</span><span class="VarId">generate_series</span><span class="Symbol">(</span>$<span class="Number">2</span> <span class="Symbol">-</span> $<span class="Number">3</span> <span class="Symbol">+</span> <span class="Number">1</span><span class="Symbol">,</span> $<span class="Number">2</span> <span class="Symbol">+</span> $<span class="Number">3</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">)</span>
     <span class="Keyword">union</span> <span class="Keyword">select</span> $<span class="Number">1</span> <span class="Symbol">+</span> $<span class="Number">3</span><span class="Symbol">,</span><span class="VarId">generate_series</span><span class="Symbol">(</span>$<span class="Number">2</span> <span class="Symbol">-</span> $<span class="Number">3</span> <span class="Symbol">+</span> <span class="Number">1</span><span class="Symbol">,</span> $<span class="Number">2</span> <span class="Symbol">+</span> $<span class="Number">3</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">)</span>
     <span class="Keyword">union</span> <span class="Keyword">select</span>  <span class="VarId">generate_series</span><span class="Symbol">(</span>$<span class="Number">1</span> <span class="Symbol">-</span> $<span class="Number">3</span><span class="Symbol">,</span> $<span class="Number">1</span> <span class="Symbol">+</span> $<span class="Number">3</span><span class="Symbol">),</span>$<span class="Number">2</span> <span class="Symbol">+</span> $<span class="Number">3</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span>

<span class="Comment">--take into account range, line of sight,</span>
<span class="Comment">--atm only takes into account empty squares</span>
<span class="Comment">--and trees cannot be next to each other</span>

</pre></div></div></div><p
    >/* for some reason when this is set to return pos and not an array, when there are no results in the final select (x,y)::pos from sqs order by y,x limit 1; the return pos return some weird '(,)' which I don't know how to test for instead of returning null? it isn't null, and you can't do r.x on it if you assign it to a record since it doesn't have a field called x, and it won't assign to a var of type pos</p
    ><p
    >*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">next_tree_square</span><span class="Symbol">(</span><span class="VarId">available</span> <span class="VarId">pos</span><span class="Symbol">[],</span> <span class="VarId">added</span> <span class="VarId">pos</span><span class="Symbol">[])</span> <span class="Keyword">returns</span> <span class="VarId">pos</span><span class="Symbol">[]</span> <span class="Keyword">as</span> $$
  <span class="VarId">with</span>
           <span class="VarId">av</span> <span class="VarId">as</span>
             <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">p1</span><span class="Symbol">).</span><span class="VarId">x</span><span class="Symbol">,(</span><span class="VarId">p1</span><span class="Symbol">).</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span>$<span class="Number">1</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">p1</span><span class="Symbol">)</span>
          <span class="Symbol">,</span><span class="VarId">ad</span> <span class="VarId">as</span>
             <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">p2</span><span class="Symbol">).</span><span class="VarId">x</span><span class="Symbol">,(</span><span class="VarId">p2</span><span class="Symbol">).</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span>$<span class="Number">2</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">p2</span><span class="Symbol">)</span>
          <span class="Symbol">,</span><span class="VarId">adj_ad</span> <span class="VarId">as</span>
             <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">p3</span><span class="Symbol">).</span><span class="VarId">x</span><span class="Symbol">,(</span><span class="VarId">p3</span><span class="Symbol">).</span><span class="VarId">y</span>
                <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">one_square_away</span><span class="Symbol">((</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">))</span> <span class="Keyword">as</span> <span class="VarId">p3</span> <span class="Keyword">from</span> <span class="VarId">ad</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">p4</span><span class="Symbol">)</span>
          <span class="Symbol">,</span><span class="VarId">sqs</span> <span class="VarId">as</span>
            <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">av</span>
             <span class="VarId">except</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">adj_ad</span>
                     <span class="Keyword">union</span> <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">ad</span><span class="Symbol">))</span>
  <span class="Keyword">select</span> <span class="VarId">array_agg</span><span class="Symbol">((</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="VarId">sqs</span> <span class="Keyword">group</span> <span class="Keyword">by</span> <span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">x</span> <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">x</span> <span class="Keyword">limit</span> <span class="Number">1</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">cast_magic_wood</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="Keyword">range</span> <span class="Type">int</span><span class="Symbol">;</span>
  <span class="VarId">wpos</span> <span class="VarId">pos</span><span class="Symbol">;</span>
  <span class="VarId">cw</span> <span class="Type">text</span><span class="Symbol">;</span>
  <span class="VarId">added</span> <span class="VarId">pos</span><span class="Symbol">[];</span>
  <span class="VarId">bavail</span> <span class="VarId">pos</span><span class="Symbol">[]</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">array_agg</span><span class="Symbol">((</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span><span class="Symbol">)</span>
                    <span class="Keyword">from</span> <span class="VarId">squares_valid_categories</span>
                    <span class="Keyword">where</span> <span class="VarId">category</span> <span class="Symbol">=</span> <span class="Char">'empty_and_not_adjacent_to_tree'</span><span class="Symbol">);</span>
  <span class="VarId">avail</span> <span class="VarId">pos</span><span class="Symbol">[];</span>
  <span class="VarId">npos</span> <span class="VarId">pos</span><span class="Symbol">;</span>
  <span class="VarId">npos1</span> <span class="VarId">pos</span><span class="Symbol">[];</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">cw</span> <span class="VarId">current_wizard</span>
    <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span><span class="Symbol">;</span>
   <span class="VarId">wpos</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
            <span class="Keyword">where</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span> <span class="Keyword">and</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="VarId">cw</span><span class="Symbol">);</span>
  <span class="Keyword">range</span> <span class="Symbol">:=</span> <span class="Number">1</span><span class="Symbol">;</span>
  <span class="Comment">--raise notice 'here % % %', range, array_length(added,1), bavail;</span>
  <span class="Comment">-- get the list of squares to cast on</span>
  <span class="Comment">-- basically, we find the closest next available square</span>
  <span class="Comment">-- then loop until we have got 8 or run out of range</span>
  <span class="Comment">-- i'm sure this can be done with one 'with recursive' query.</span>
  <span class="Symbol">&lt;&lt;</span><span class="VarId">next_range</span><span class="Symbol">&gt;&gt;</span>
  <span class="Keyword">while</span> <span class="Keyword">range</span> <span class="Symbol">&lt;=</span> <span class="Number">15</span> <span class="Keyword">and</span> <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">array_length</span><span class="Symbol">(</span><span class="VarId">added</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">),</span><span class="Number">0</span><span class="Symbol">)</span> <span class="Symbol">&lt;</span> <span class="Number">8</span> <span class="VarId">loop</span>
    <span class="Comment">--raise notice 'do range %', range;</span>
    <span class="Comment">-- fix the range, get the set of available squares at that range</span>
    <span class="VarId">avail</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">array_agg</span><span class="Symbol">(((</span><span class="VarId">a</span><span class="Symbol">).</span><span class="VarId">x</span><span class="Symbol">,(</span><span class="VarId">a</span><span class="Symbol">).</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span><span class="Symbol">)</span>
              <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">bavail</span><span class="Symbol">)</span>
                    <span class="VarId">intersect</span>
                    <span class="Keyword">select</span> <span class="Symbol">*</span>
                    <span class="Keyword">from</span> <span class="VarId">get_square_range</span><span class="Symbol">(</span><span class="VarId">wpos</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">wpos</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="Keyword">range</span><span class="Symbol">))</span> <span class="Keyword">as</span> <span class="VarId">a</span><span class="Symbol">);</span>
    <span class="Comment">--raise notice 'avail: %', avail;</span>
    <span class="Symbol">&lt;&lt;</span><span class="VarId">this_range</span><span class="Symbol">&gt;&gt;</span>
    <span class="VarId">loop</span>
      <span class="Comment">--raise notice 'do another sq %', array_length(added,1);</span>
      <span class="Comment">-- loop adding one square at a time until there are no available suares at this range</span>
      <span class="VarId">npos1</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">next_tree_square</span><span class="Symbol">(</span><span class="VarId">avail</span><span class="Symbol">,</span> <span class="VarId">added</span><span class="Symbol">))</span> <span class="VarId">a</span><span class="Symbol">);</span>
      <span class="Comment">--raise notice 'next square %', npos1;</span>
      <span class="Keyword">if</span> <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">array_length</span><span class="Symbol">(</span><span class="VarId">npos1</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">),</span><span class="Number">0</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Number">0</span> <span class="VarId">then</span>
        <span class="Keyword">range</span> <span class="Symbol">:=</span> <span class="Keyword">range</span> <span class="Symbol">+</span> <span class="Number">1</span><span class="Symbol">;</span>
        <span class="Keyword">continue</span> <span class="VarId">next_range</span><span class="Symbol">;</span>
      <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
      <span class="Comment">--raise notice 'addinf %', npos1[1];</span>
      <span class="VarId">added</span> <span class="Symbol">:=</span> <span class="VarId">added</span> <span class="Symbol">||</span> <span class="Symbol">(</span><span class="VarId">npos1</span><span class="Symbol">[</span><span class="Number">1</span><span class="Symbol">].</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">npos1</span><span class="Symbol">[</span><span class="Number">1</span><span class="Symbol">].</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span><span class="Symbol">;</span>
      <span class="Keyword">if</span> <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">array_length</span><span class="Symbol">(</span><span class="VarId">added</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">),</span><span class="Number">0</span><span class="Symbol">)</span> <span class="Symbol">&gt;=</span> <span class="Number">8</span> <span class="VarId">then</span>
        <span class="VarId">exit</span> <span class="VarId">next_range</span><span class="Symbol">;</span>
      <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>
  <span class="Comment">-- got the cast positions, create the trees</span>
  <span class="Keyword">for</span> <span class="VarId">npos</span> <span class="VarId">in</span> <span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">).</span><span class="VarId">x</span><span class="Symbol">,(</span><span class="VarId">p</span><span class="Symbol">).</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">added</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">p</span> <span class="VarId">loop</span>
    <span class="Keyword">perform</span> <span class="VarId">create_object</span><span class="Symbol">(</span><span class="Char">'magic_tree'</span><span class="Symbol">,</span> <span class="VarId">cw</span><span class="Symbol">,</span> <span class="VarId">npos</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">npos</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">loop</span><span class="Symbol">;</span>

  <span class="Keyword">perform</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">();</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>
</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
