<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >SquaresValid.sql transformed</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Comment">/*</span>

<span class="Comment">Action validity</span>
<span class="Comment">===============</span>

<span class="Comment">All the updates in this database are via stored procs (um, functions</span>
<span class="Comment">in postgres, called actions here), which are simple and modular. Each</span>
<span class="Comment">'public' stored proc has precondition checks, which also double as a</span>
<span class="Comment">guide to what the ui can do, so they are exact preconditions. So this</span>
<span class="Comment">is seriously paranoid code - chaos is serious business.</span>

<span class="Comment">All these views need a rethink, its a massive mess.</span>

<span class="Comment">*/</span>
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">);</span>

<span class="Comment">/*</span>
<span class="Comment">pieces on top</span>
<span class="Comment">-------------</span>

<span class="Comment">The topmost piece on each square is the one you interact with most of</span>
<span class="Comment">the time, e.g. when selecting, attacking, etc.</span>

<span class="Comment">The exception to this rule is when you select a wizard that is in a</span>
<span class="Comment">magic tree or castle or mounted on a monster.</span>

<span class="Comment">The pieces_on_top view also determines what sprite is shown in a</span>
<span class="Comment">square in the ui</span>

<span class="Comment">*/</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;pieces_with_priorities&quot; [(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;),(&quot;x&quot;,ScalarType &quot;int4&quot;),(&quot;y&quot;,ScalarType &quot;int4&quot;),(&quot;sp&quot;,ScalarType &quot;int4&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">pieces_with_priorities</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span>
    <span class="VarId">case</span>
      <span class="Keyword">when</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="Char">'dead'</span> <span class="Keyword">then</span> <span class="Number">3</span>
      <span class="Keyword">when</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span> <span class="Keyword">then</span> <span class="Number">2</span>
      <span class="Keyword">when</span> <span class="VarId">ptype</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span> <span class="Keyword">from</span> <span class="VarId">monster_prototypes</span><span class="Symbol">)</span> <span class="Keyword">then</span> <span class="Number">1</span>
      <span class="Keyword">else</span> <span class="Number">0</span>
    <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">sp</span>
    <span class="Keyword">from</span> <span class="VarId">pieces</span><span class="Symbol">;</span>

<span class="Comment">--restrict this view taking only the top piece from each square to get</span>
<span class="Comment">--the final result</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_with_priorities'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;pieces_on_top&quot; [(&quot;x&quot;,ScalarType &quot;int4&quot;),(&quot;y&quot;,ScalarType &quot;int4&quot;),(&quot;ptype&quot;,ScalarType &quot;text&quot;),(&quot;allegiance&quot;,ScalarType &quot;text&quot;),(&quot;tag&quot;,ScalarType &quot;int4&quot;),(&quot;sp&quot;,ScalarType &quot;int4&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">pieces_on_top</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">sp</span> <span class="VarId">from</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">row_number</span><span class="Symbol">()</span> <span class="Keyword">over</span><span class="Symbol">(</span><span class="Keyword">partition</span> <span class="Keyword">by</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">sp</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">rn</span><span class="Symbol">,</span>
            <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">sp</span>
      <span class="Keyword">from</span> <span class="VarId">pieces_with_priorities</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">pwp</span> <span class="Keyword">where</span> <span class="VarId">rn</span> <span class="Symbol">=</span> <span class="Number">1</span><span class="Symbol">;</span>

<span class="Comment">--create a full view to help with updates</span>

<span class="Comment">-- question: why does pieces_view natural inner join pieces_on_top</span>
<span class="Comment">-- return too many rows?</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_on_top'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;pieces_on_top_view&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">pieces_on_top_view</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">p</span><span class="Symbol">.*</span> <span class="Keyword">from</span> <span class="VarId">pieces_mr</span> <span class="VarId">p</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top</span>
    <span class="Keyword">using</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">);</span>

<span class="Comment">/*</span>

<span class="Comment">internals</span>
<span class="Comment">---------</span>
<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'pieces_on_top_view'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;distance&quot; [ScalarType &quot;int4&quot;,ScalarType &quot;int4&quot;,ScalarType &quot;int4&quot;,ScalarType &quot;int4&quot;] (ScalarType &quot;float8&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">distance</span><span class="Symbol">(</span><span class="Type">int</span><span class="Symbol">,</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">float</span><span class="Symbol">(</span><span class="Number">24</span><span class="Symbol">)</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">point</span><span class="Symbol">(</span>$<span class="Number">1</span><span class="Symbol">,</span> $<span class="Number">2</span><span class="Symbol">)</span> <span class="Symbol">&lt;-&gt;</span> <span class="VarId">point</span><span class="Symbol">(</span>$<span class="Number">3</span><span class="Symbol">,</span> $<span class="Number">4</span><span class="Symbol">))::</span><span class="Type">float</span><span class="Symbol">(</span><span class="Number">24</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">result</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'distance'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;board_ranges&quot; [(&quot;x&quot;,ScalarType &quot;int4&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">board_ranges</span> <span class="VarId">as</span>
<span class="Comment">--iterate x,y over each square on board</span>
<span class="Comment">--  iterate d over 0 to 20</span>
<span class="Comment">--    iterate tx,ty over each square on board</span>
<span class="Comment">--      include x,y,d, tx, ty iff d(x,y,tx,ty) &lt; d</span>
<span class="Comment">--so: we include squares &lt;= to the range, not just squares at that</span>
<span class="Comment">--range</span>

  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">14</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">x</span>
                <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">9</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">y</span>
                <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span> <span class="Number">20</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">range</span>
                <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">14</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">tx</span>
                <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">9</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">ty</span>
  <span class="VarId">where</span>
    <span class="Comment">--we never need the centre square to be included</span>
    <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">!=</span> <span class="Symbol">(</span><span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">ty</span><span class="Symbol">)</span> <span class="VarId">and</span>
     <span class="Comment">--round to closest int</span>
    <span class="VarId">distance</span><span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">ty</span><span class="Symbol">)</span> <span class="Symbol">-</span> <span class="Number">0.5</span> <span class="Symbol">&lt;=</span> <span class="Keyword">range</span><span class="Symbol">;</span>
<span class="Comment">/*</span>
<span class="Comment">valid actions</span>
<span class="Comment">=============</span>

<span class="Comment">The end result: two relvars, one with x,y, to list all the valid</span>
<span class="Comment">actions at any time.</span>

<span class="Comment">*/</span>


<span class="Comment">-------------------------------------</span>
<span class="Comment">/*</span>
<span class="Comment">ideas:</span>

<span class="Comment">quite a complicated process, want to try to make it declarative rather</span>
<span class="Comment">than procedural and see if can make quick</span>

<span class="Comment">the result needs to be action_name,x,y</span>
<span class="Comment">where the action name is one of</span>
<span class="Comment">cast_target_spell</span>
<span class="Comment">select_piece</span>
<span class="Comment">walk</span>
<span class="Comment">fly</span>
<span class="Comment">attack</span>
<span class="Comment">ranged_attack</span>

<span class="Comment">in order to make it quick and also make it understandable, do a two</span>
<span class="Comment">stage process.</span>

<span class="Comment">In the first view, we collect together all the information from the</span>
<span class="Comment">pieces - their position and other attributes</span>

<span class="Comment">The in the second view, we combine the turn sequence information to</span>
<span class="Comment">get the final list of valid target squares.</span>

<span class="Comment">[update: exposing some intermediates which are used by the board</span>
<span class="Comment">sprites and ai]</span>

<span class="Comment">what do we need to collect in the first view?</span>
<span class="Comment">first categorize each square into one or more of the following:</span>
<span class="Comment">completely empty</span>
<span class="Comment">corpse only</span>
<span class="Comment">attackable piece on top</span>
<span class="Comment">adjacent to tree</span>
<span class="Comment">wizard</span>
<span class="Comment">mount_enter</span>

<span class="Comment">the we add all the extra information from the pieces information that</span>
<span class="Comment">will be used by the second view</span>

<span class="Comment">we can get the category of spell that can be cast on a square for</span>
<span class="Comment">cast_target_spell select_piece: need all pieces not in pieces_moved</span>
<span class="Comment">that are in the current wizard's army: so need to keep the</span>
<span class="Comment">ptype,allegiance and tag</span>

<span class="Comment">walk,fly: pretty straight forward</span>

<span class="Comment">attack,ranged attack: need the allegiance</span>

<span class="Comment">we need to be able to implement the</span>
<span class="Comment">following special cases:</span>

<span class="Comment">cannot select piece under blob: use attackable on top for selection</span>

<span class="Comment">dismount, exit: the wizard isn't the piece on top when he is on a</span>
<span class="Comment">mount or in a castle or tree - won't be in the attackable pieces</span>
<span class="Comment">squares which is what we're using to feed to selectable pieces, so add</span>
<span class="Comment">the wizard squares as extra category</span>

<span class="Comment">mount, enter: need to add these squares in as extra category, so we</span>
<span class="Comment">can add them to the walk/fly squares iff the selected piece is a</span>
<span class="Comment">wizard</span>

<span class="Comment">trees: monsters will attack any tree, wizards will move into an empty</span>
<span class="Comment">magic tree and attack occupied ones as well as shadow_trees</span>

<span class="Comment">undead: if a piece is undead, it can only be attacked by another</span>
<span class="Comment">undead creature or a magic weapon</span>

<span class="Comment">some spells can be cast on corpses as well as monsters/wizards, so we</span>
<span class="Comment">include corpses in the attackable on top category, and filter corpses</span>
<span class="Comment">where neccessary using the allegiance info.</span>

<span class="Comment">  */</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'board_ranges'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;one_square_away&quot; [NamedCompositeType &quot;pos&quot;] (SetOfType (NamedCompositeType &quot;pos&quot;)) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">one_square_away</span><span class="Symbol">(</span><span class="VarId">pos</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Keyword">setof</span> <span class="VarId">pos</span> <span class="Keyword">as</span> $$
               <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Number">-1</span> <span class="Keyword">as</span> <span class="VarId">x</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Number">-1</span> <span class="Keyword">as</span> <span class="VarId">y</span>
     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Number">-1</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span>
     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Number">-1</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Number">+1</span>
     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Number">-1</span>
     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Number">+1</span>
     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Number">+1</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Number">-1</span>
     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Number">+1</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span>
     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> $<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Number">+1</span><span class="Symbol">,</span>$<span class="Number">1</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Number">+1</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'one_square_away'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">squares_valid_categories</span> <span class="VarId">as</span>
  <span class="VarId">with</span>
    <span class="VarId">squares</span> <span class="Keyword">as</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">14</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">x</span>
                      <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">generate_series</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">9</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">y</span><span class="Symbol">)</span>
   <span class="Symbol">,</span><span class="VarId">sq1</span> <span class="VarId">as</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">unnest</span>
       <span class="Symbol">(</span><span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">ptype</span> <span class="VarId">is</span> <span class="Keyword">null</span> <span class="Keyword">then</span> <span class="Char">'{empty,empty_or_corpse_only}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span>
          <span class="VarId">else</span>
            <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">physical_defense</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">then</span> <span class="Char">'{attackable}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span>
                 <span class="Keyword">else</span> <span class="Char">'{}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span> <span class="Keyword">end</span> <span class="Symbol">||</span>
            <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">ridable</span> <span class="Keyword">or</span> <span class="VarId">ptype</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'magic_tree'</span><span class="Symbol">,</span><span class="Char">'magic_castle'</span><span class="Symbol">,</span><span class="Char">'dark_citadel'</span><span class="Symbol">)</span>
                   <span class="Keyword">then</span> <span class="Char">'{mount-enter}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span>
                 <span class="Keyword">else</span> <span class="Char">'{}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span> <span class="Keyword">end</span> <span class="Symbol">||</span>
            <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="Char">'dead'</span> <span class="Keyword">then</span> <span class="Char">'{corpse_only,empty_or_corpse_only}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span>
                 <span class="Keyword">else</span> <span class="Char">'{}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span> <span class="Keyword">end</span> <span class="Symbol">||</span>
            <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">ptype</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'magic_tree'</span><span class="Symbol">,</span> <span class="Char">'shadow_tree'</span><span class="Symbol">)</span> <span class="Keyword">then</span> <span class="Char">'{tree}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span>
                 <span class="Keyword">else</span> <span class="Char">'{}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span> <span class="Keyword">end</span> <span class="Symbol">||</span>
            <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">speed</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">then</span> <span class="Char">'{creature_on_top}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span>
                 <span class="Keyword">else</span> <span class="Char">'{}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span> <span class="Keyword">end</span> <span class="Symbol">||</span>
            <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">undead</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">then</span> <span class="Char">'{monster_on_top}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span>
                 <span class="Keyword">else</span> <span class="Char">'{}'</span><span class="Symbol">::</span><span class="Type">text</span><span class="Symbol">[]</span> <span class="VarId">end</span>
        <span class="Keyword">end</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">category</span><span class="Symbol">,</span>
         <span class="VarId">s</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">s</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">v</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">v</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">v</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">v</span><span class="Symbol">.</span><span class="VarId">undead</span><span class="Symbol">,</span><span class="VarId">v</span><span class="Symbol">.</span><span class="VarId">ridable</span>
      <span class="Keyword">from</span> <span class="VarId">squares</span> <span class="VarId">s</span>
      <span class="Keyword">natural</span> <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top_view</span> <span class="VarId">v</span><span class="Symbol">)</span>
   <span class="Symbol">,</span><span class="VarId">tree_pos</span> <span class="Keyword">as</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">sq1</span>
                 <span class="Keyword">where</span> <span class="VarId">category</span><span class="Symbol">=</span><span class="Char">'tree'</span><span class="Symbol">)</span>
   <span class="Symbol">,</span><span class="VarId">tree_adj</span> <span class="Keyword">as</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">).</span><span class="VarId">x</span><span class="Symbol">,(</span><span class="VarId">p</span><span class="Symbol">).</span><span class="VarId">y</span> <span class="VarId">from</span>
                    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">one_square_away</span><span class="Symbol">((</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">))</span> <span class="Keyword">as</span> <span class="VarId">p</span> <span class="Keyword">from</span> <span class="VarId">tree_pos</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span><span class="Symbol">)</span>
   <span class="Symbol">,</span><span class="VarId">wz</span> <span class="Keyword">as</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">)</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">sq1</span> <span class="Keyword">where</span> <span class="VarId">category</span> <span class="Keyword">not</span> <span class="VarId">in</span><span class="Symbol">(</span><span class="Char">'tree'</span><span class="Symbol">)</span>
  <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'empty_and_not_adjacent_to_tree'</span> <span class="Keyword">as</span> <span class="VarId">category</span>
                   <span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Keyword">null</span><span class="Symbol">,</span><span class="Keyword">null</span><span class="Symbol">,</span><span class="Keyword">null</span><span class="Symbol">,</span><span class="Keyword">null</span><span class="Symbol">,</span><span class="Keyword">null</span> <span class="Keyword">from</span> <span class="VarId">sq1</span>
            <span class="Keyword">where</span> <span class="VarId">category</span><span class="Symbol">=</span><span class="Char">'empty'</span>
              <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">tree_adj</span><span class="Symbol">)</span>
  <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'wizard'</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="Keyword">null</span><span class="Symbol">,</span><span class="Keyword">null</span> <span class="Keyword">from</span> <span class="VarId">wz</span><span class="Symbol">;</span>

<span class="Comment">---------------------------</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'squares_valid_categories'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;spell_valid_squares&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">spell_valid_squares</span> <span class="VarId">as</span>
 <span class="Keyword">select</span> <span class="VarId">category</span> <span class="Keyword">as</span> <span class="VarId">valid_square_category</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">squares_valid_categories</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'spell_valid_squares'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;current_wizard_spell_squares&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">current_wizard_spell_squares</span> <span class="VarId">as</span>
<span class="VarId">with</span>
   <span class="Comment">-- put together a relation with x,y position for the current wizard</span>
   <span class="Comment">-- and the range for his currently chosen spell</span>
   <span class="Comment">-- so we only get a row iff the current wizard has a target spell</span>
   <span class="Comment">-- chosen and it's the cast phase</span>
  <span class="VarId">cwsr</span> <span class="VarId">as</span>
       <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">,</span> <span class="Keyword">range</span><span class="Symbol">,</span> <span class="VarId">valid_square_category</span>
          <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
          <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizard_spell_choices</span>
            <span class="Keyword">on</span> <span class="VarId">current_wizard</span><span class="Symbol">=</span><span class="VarId">wizard_name</span>
          <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span>
            <span class="Keyword">on</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span> <span class="Keyword">and</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="VarId">current_wizard</span>
          <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">target_spells</span><span class="Symbol">)</span>
  <span class="Keyword">select</span> <span class="Keyword">distinct</span> <span class="VarId">svs</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">svs</span><span class="Symbol">.</span><span class="VarId">y</span>
    <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">valid_square_category</span> <span class="Keyword">from</span> <span class="VarId">cwsr</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">b</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">tx</span> <span class="Keyword">as</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">ty</span> <span class="Keyword">as</span> <span class="VarId">y</span>
                          <span class="Keyword">from</span> <span class="VarId">board_ranges</span>
                          <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Keyword">range</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Keyword">range</span> <span class="Keyword">from</span> <span class="VarId">cwsr</span><span class="Symbol">))</span> <span class="Keyword">as</span> <span class="VarId">a</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">spell_valid_squares</span> <span class="VarId">svs</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'current_wizard_spell_squares'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;selected_piece_move_squares&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">selected_piece_move_squares</span> <span class="VarId">as</span>
    <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span>
       <span class="Keyword">from</span> <span class="VarId">selected_piece</span> <span class="VarId">sp</span>
       <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">squares_valid_categories</span> <span class="VarId">svc</span>
       <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">category</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'empty'</span><span class="Symbol">,</span><span class="Char">'corpse_only'</span><span class="Symbol">)</span>
           <span class="Keyword">or</span> <span class="Symbol">(</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span>
               <span class="Keyword">and</span> <span class="Symbol">((</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">svc</span><span class="Symbol">.</span><span class="VarId">allegiance</span>
                     <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">svc</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'magic_castle'</span><span class="Symbol">,</span><span class="Char">'dark_citadel'</span><span class="Symbol">)</span>
                          <span class="Keyword">or</span> <span class="VarId">svc</span><span class="Symbol">.</span><span class="VarId">ridable</span><span class="Symbol">))</span>
                    <span class="Keyword">or</span> <span class="VarId">svc</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'magic_tree'</span><span class="Symbol">)));</span>
<span class="Comment">-- todo: fix for ranged/h-h</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'selected_piece_move_squares'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;is_equipped&quot; [ScalarType &quot;text&quot;] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">is_equipped</span><span class="Symbol">(</span><span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$

  <span class="Keyword">select</span> <span class="VarId">magic_sword</span> <span class="Keyword">or</span> <span class="VarId">magic_knife</span> <span class="Keyword">or</span> <span class="VarId">magic_bow</span>
    <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> $<span class="Number">1</span><span class="Symbol">;</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'is_equipped'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;selected_piece_attackable_squares&quot; [(&quot;action&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">selected_piece_attackable_squares</span> <span class="VarId">as</span>
  <span class="VarId">with</span>
    <span class="VarId">spp</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span>
              <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">flying</span><span class="Symbol">,</span><span class="VarId">false</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">flying</span><span class="Symbol">,</span>
              <span class="VarId">speed</span><span class="Symbol">,</span><span class="VarId">move_phase</span><span class="Symbol">,</span>
              <span class="Keyword">range</span><span class="Symbol">,</span>
              <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">undead</span><span class="Symbol">,</span><span class="VarId">false</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">undead</span>
         <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
         <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_mr</span><span class="Symbol">)</span>
   <span class="Symbol">,</span><span class="VarId">walk_range</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">one_square_away</span><span class="Symbol">((</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span> <span class="Keyword">from</span> <span class="VarId">spp</span><span class="Symbol">)))</span>
   <span class="Symbol">,</span><span class="VarId">attack_ranges</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">tx</span> <span class="Keyword">as</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">ty</span> <span class="Keyword">as</span> <span class="VarId">y</span>
       <span class="Keyword">from</span> <span class="VarId">board_ranges</span>
         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">flying</span> <span class="Keyword">and</span> <span class="VarId">move_phase</span><span class="Symbol">=</span><span class="Char">'motion'</span> <span class="Keyword">from</span> <span class="VarId">spp</span><span class="Symbol">)</span>
               <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Keyword">range</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">speed</span> <span class="Keyword">from</span> <span class="VarId">spp</span><span class="Symbol">)</span>
       <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">walk_range</span>
              <span class="Keyword">where</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">move_phase</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Char">'motion'</span><span class="Symbol">,</span><span class="Char">'attack'</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="VarId">spp</span><span class="Symbol">)))</span>
   <span class="Symbol">,</span><span class="VarId">shoot_ranges</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">tx</span> <span class="Keyword">as</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">ty</span> <span class="Keyword">as</span> <span class="VarId">y</span>
       <span class="Keyword">from</span> <span class="VarId">board_ranges</span>
         <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Keyword">range</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Keyword">range</span> <span class="Keyword">from</span> <span class="VarId">spp</span>
                              <span class="Keyword">where</span> <span class="Keyword">range</span> <span class="VarId">is</span> <span class="Keyword">not</span> <span class="Keyword">null</span><span class="Symbol">))</span>
   <span class="Symbol">,</span><span class="VarId">attackable_squares</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span>
       <span class="Keyword">from</span> <span class="VarId">squares_valid_categories</span> <span class="VarId">svc</span>
       <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">undead</span><span class="Symbol">,</span><span class="VarId">allegiance</span> <span class="Keyword">from</span> <span class="VarId">spp</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">spp</span>
       <span class="Keyword">where</span> <span class="VarId">category</span> <span class="Symbol">=</span> <span class="Char">'attackable'</span>
          <span class="Keyword">and</span> <span class="VarId">svc</span><span class="Symbol">.</span><span class="VarId">allegiance</span> <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="VarId">spp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="Char">'dead'</span><span class="Symbol">)</span>
          <span class="Keyword">and</span> <span class="Keyword">not</span> <span class="Symbol">((</span><span class="VarId">svc</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'magic_tree'</span><span class="Symbol">)</span>
                   <span class="Keyword">and</span> <span class="VarId">spp</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">)</span>
          <span class="Keyword">and</span> <span class="Symbol">(</span><span class="Keyword">not</span> <span class="VarId">coalesce</span><span class="Symbol">(</span><span class="VarId">svc</span><span class="Symbol">.</span><span class="VarId">undead</span><span class="Symbol">,</span><span class="VarId">false</span><span class="Symbol">)</span> <span class="Keyword">or</span> <span class="Symbol">(</span><span class="VarId">spp</span><span class="Symbol">.</span><span class="VarId">undead</span> <span class="VarId">or</span>
                                  <span class="Symbol">(</span><span class="VarId">spp</span><span class="Symbol">.</span><span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span>
                                   <span class="Keyword">and</span> <span class="VarId">is_equipped</span><span class="Symbol">(</span><span class="VarId">spp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">)))))</span>
    <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Char">'attack'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
         <span class="Comment">/*,svc.ptype,svc.allegiance, svc.undead,get_current_wizard(),</span>
<span class="Comment">         spp.ptype,spp.allegiance,spp.undead, is_equipped(spp.allegiance),</span>
<span class="Comment">         category*/</span>
    <span class="Keyword">from</span> <span class="VarId">attackable_squares</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">attack_ranges</span>
    <span class="Keyword">union</span> <span class="VarId">all</span>
    <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Char">'ranged_attack'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
    <span class="Keyword">from</span> <span class="VarId">attackable_squares</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">shoot_ranges</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'selected_piece_attackable_squares'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;selected_piece_move_squares_2&quot; [(&quot;action&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">selected_piece_move_squares_2</span> <span class="VarId">as</span>
<span class="VarId">with</span>
   <span class="VarId">spp</span> <span class="VarId">as</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">flying</span><span class="Symbol">,</span><span class="VarId">speed</span><span class="Symbol">,</span><span class="VarId">move_phase</span><span class="Symbol">,</span><span class="VarId">engaged</span> <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
     <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span><span class="Symbol">)</span>
  <span class="Symbol">,</span><span class="VarId">walk_range</span> <span class="VarId">as</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">one_square_away</span><span class="Symbol">((</span><span class="Keyword">select</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)::</span><span class="VarId">pos</span> <span class="Keyword">from</span> <span class="VarId">spp</span><span class="Symbol">))</span>
              <span class="Keyword">where</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Keyword">not</span> <span class="VarId">engaged</span> <span class="Keyword">from</span> <span class="VarId">spp</span><span class="Symbol">))</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Char">'walk'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
    <span class="Keyword">from</span> <span class="VarId">selected_piece_move_squares</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">walk_range</span>
    <span class="Keyword">where</span> <span class="VarId">get_remaining_walk</span><span class="Symbol">()</span> <span class="Symbol">&gt;</span> <span class="Number">0</span>
          <span class="Keyword">and</span> <span class="VarId">x</span> <span class="Keyword">between</span> <span class="Number">0</span> <span class="Keyword">and</span> <span class="Number">14</span>
          <span class="Keyword">and</span> <span class="VarId">y</span> <span class="Keyword">between</span> <span class="Number">0</span> <span class="Keyword">and</span> <span class="Number">9</span>
  <span class="Keyword">union</span> <span class="VarId">all</span>
  <span class="Keyword">select</span> <span class="VarId">tx</span> <span class="Keyword">as</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">ty</span> <span class="Keyword">as</span> <span class="VarId">y</span><span class="Symbol">,</span> <span class="Char">'fly'</span>
    <span class="Keyword">from</span> <span class="VarId">board_ranges</span> <span class="VarId">br</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">spp</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece_move_squares</span> <span class="VarId">vms</span>
      <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">br</span><span class="Symbol">.</span><span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">br</span><span class="Symbol">.</span><span class="VarId">ty</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">vms</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">vms</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">where</span> <span class="VarId">flying</span>
        <span class="Keyword">and</span> <span class="VarId">move_phase</span><span class="Symbol">=</span><span class="Char">'motion'</span>
        <span class="Keyword">and</span> <span class="Keyword">range</span> <span class="Symbol">=</span> <span class="VarId">speed</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'selected_piece_move_squares_2'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;selectable_pieces&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">selectable_pieces</span> <span class="VarId">as</span>
<span class="VarId">with</span>
   <span class="VarId">good_to_go</span> <span class="VarId">as</span>
     <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span>
      <span class="Keyword">where</span> <span class="VarId">turn_phase</span><span class="Symbol">=</span><span class="Char">'move'</span>
            <span class="Keyword">and</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">))</span>
  <span class="Symbol">,</span><span class="VarId">potnm</span> <span class="VarId">as</span>
     <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Number">1</span> <span class="Keyword">as</span> <span class="VarId">rn</span> <span class="Keyword">from</span> <span class="VarId">good_to_go</span>
      <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
      <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top</span>
        <span class="Keyword">on</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">current_wizard</span><span class="Symbol">)</span>
  <span class="Symbol">,</span><span class="VarId">wnm</span> <span class="VarId">as</span>
     <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Number">0</span> <span class="Keyword">as</span> <span class="VarId">rn</span> <span class="Keyword">from</span> <span class="VarId">good_to_go</span>
      <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
      <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span>
        <span class="Keyword">on</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span> <span class="Keyword">and</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">current_wizard</span><span class="Symbol">)</span>
  <span class="Symbol">,</span><span class="VarId">allnm</span> <span class="VarId">as</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">potnm</span>
                     <span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">wnm</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
       <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span>
             <span class="Keyword">not</span> <span class="VarId">in</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">pieces_moved</span><span class="Symbol">))</span>
<span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="VarId">from</span>
<span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">row_number</span><span class="Symbol">()</span> <span class="Keyword">over</span> <span class="Symbol">(</span><span class="Keyword">partition</span> <span class="Keyword">by</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">rn</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">rn</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span>
       <span class="Keyword">from</span> <span class="VarId">allnm</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">s</span> <span class="Keyword">where</span> <span class="VarId">rn</span> <span class="Symbol">=</span> <span class="Number">1</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'selectable_pieces'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;valid_target_actions&quot; [(&quot;action&quot;,ScalarType &quot;text&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">valid_target_actions</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="Symbol">(</span>
<span class="Comment">--target spells</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Char">'cast_target_spell'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
    <span class="Keyword">from</span> <span class="VarId">current_wizard_spell_squares</span>
<span class="Comment">--selecting a piece</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span> <span class="Keyword">from</span> <span class="Symbol">(</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="Char">'select_piece_at_position'</span><span class="Symbol">::</span> <span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">selectable_pieces</span>
<span class="Comment">--walking</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">selected_piece_move_squares_2</span>
<span class="Comment">--attacking</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span> <span class="Keyword">from</span> <span class="VarId">selected_piece_attackable_squares</span>
<span class="Symbol">)</span><span class="Keyword">as</span> <span class="VarId">s1</span>
<span class="Keyword">where</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()=</span><span class="Char">'move'</span>
<span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">s</span>
<span class="Keyword">where</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">);</span>

<span class="Comment">---------------------------------------------</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'valid_target_actions'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateView &quot;valid_activate_actions&quot; []]*/</span>
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">valid_activate_actions</span> <span class="VarId">as</span>
<span class="VarId">with</span>
  <span class="VarId">monster_spell</span> <span class="VarId">as</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
     <span class="Keyword">from</span> <span class="VarId">wizard_spell_choices</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">monster_spells</span><span class="Symbol">)</span>
  <span class="Symbol">,</span><span class="VarId">cast_phase</span> <span class="VarId">as</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span> <span class="Keyword">where</span> <span class="VarId">turn_phase</span><span class="Symbol">=</span><span class="Char">'cast'</span><span class="Symbol">)</span>
  <span class="Symbol">,</span><span class="VarId">choose_phase</span> <span class="VarId">as</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">turn_phase_table</span> <span class="Keyword">where</span> <span class="VarId">turn_phase</span><span class="Symbol">=</span><span class="Char">'choose'</span><span class="Symbol">)</span>
<span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="Symbol">(</span>
<span class="Comment">--next_phase - always valid</span>
<span class="Keyword">select</span> <span class="Char">'next_phase'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
<span class="Comment">--choose spell - need one for each spell, add programmatically</span>
<span class="Comment">--set imaginary</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'set_imaginary'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">monster_spell</span>
<span class="Comment">--set real</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'set_real'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">monster_spell</span>
<span class="Comment">--cast activate spell</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'cast_activate_spell'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">where</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
         <span class="Keyword">from</span> <span class="VarId">cast_phase</span>
         <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_spell</span>
         <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">activate_spells</span><span class="Symbol">)</span>
      <span class="Keyword">or</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span>
         <span class="Keyword">from</span> <span class="VarId">cast_phase</span>
         <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_spell</span>
         <span class="Keyword">where</span> <span class="VarId">spell_name</span> <span class="Symbol">=</span><span class="Char">'magic_wood'</span><span class="Symbol">)</span>
<span class="Comment">--skip spell ** why is this commented out? **</span>
<span class="Comment">--union all</span>
<span class="Comment">--select 'skip_spell'::text as action</span>
<span class="Comment">--  where get_turn_phase() = 'cast'</span>
<span class="Comment">--unselect</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'unselect_piece'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
<span class="Comment">--next subphase</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'cancel'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'choose_'</span> <span class="Symbol">||</span> <span class="VarId">spell_name</span> <span class="Symbol">||</span> <span class="Char">'_spell'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">choose_phase</span>
  <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">spell_books</span>
    <span class="Keyword">on</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">current_wizard</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'choose_no_spell'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span>
  <span class="Keyword">from</span> <span class="VarId">choose_phase</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'ai_continue'</span>
  <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span>
    <span class="Keyword">on</span> <span class="VarId">wizard_name</span> <span class="Symbol">=</span> <span class="VarId">current_wizard</span>
    <span class="Keyword">where</span> <span class="VarId">computer_controlled</span>
<span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
<span class="Keyword">where</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">);</span>

<span class="Comment">/*</span>
<span class="Comment">provide shortcut functions to check if an action can be run using</span>
<span class="Comment">these views</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'valid_activate_actions'</span><span class="Symbol">,</span><span class="Char">'view'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;check_can_run_action&quot; [ScalarType &quot;text&quot;] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="VarId">action_name</span> <span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">valid_activate_actions</span>
     <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="VarId">action_name</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'cannot run % here'</span><span class="Symbol">,</span> <span class="VarId">action_name</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_can_run_action'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;check_can_run_action&quot; [ScalarType &quot;text&quot;,ScalarType &quot;int4&quot;,ScalarType &quot;int4&quot;] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_can_run_action</span><span class="Symbol">(</span><span class="VarId">action_name</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">valid_target_actions</span>
     <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="VarId">action_name</span> <span class="Keyword">and</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">px</span><span class="Symbol">,</span><span class="VarId">py</span><span class="Symbol">))</span> <span class="VarId">then</span>
    <span class="Keyword">raise</span> <span class="Keyword">exception</span> <span class="Char">'cannot run % on %,% here'</span><span class="Symbol">,</span> <span class="VarId">action_name</span><span class="Symbol">,</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">stable</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_can_run_action'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.SquaresValid'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
