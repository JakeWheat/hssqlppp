<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >History</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div id="section"
    ><h1
      >/*</h1
      ><p
      >= history save a short description of each action completed during play</p
      ><p
      >TODO: create a detailed history that allows a game to be replayed then create a view to show the player visible log with some events removed and some combined. */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.History'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">domain</span> <span class="VarId">history_name_enum</span> <span class="Keyword">as</span> <span class="VarId">text</span>
       <span class="Keyword">check</span> <span class="Symbol">(</span><span class="VarId">value</span> <span class="VarId">in</span> <span class="Symbol">(</span>
                        <span class="Char">'spell_succeeded'</span>
                       <span class="Symbol">,</span><span class="Char">'spell_failed'</span>
                       <span class="Symbol">,</span><span class="Char">'chinned'</span>
                       <span class="Symbol">,</span><span class="Char">'shrugged_off'</span>
                       <span class="Symbol">,</span><span class="Char">'walked'</span>
                       <span class="Symbol">,</span><span class="Char">'fly'</span>
                       <span class="Symbol">,</span><span class="Char">'attack'</span>
                       <span class="Symbol">,</span><span class="Char">'ranged_attack'</span>
                       <span class="Symbol">,</span><span class="Char">'set_imaginary'</span>
                       <span class="Symbol">,</span><span class="Char">'set_real'</span>
                       <span class="Symbol">,</span><span class="Char">'game_won'</span>
                       <span class="Symbol">,</span><span class="Char">'game_drawn'</span>
                       <span class="Symbol">,</span><span class="Char">'spell_skipped'</span>
                       <span class="Symbol">,</span><span class="Char">'new_turn'</span>
                       <span class="Symbol">,</span><span class="Char">'wizard_up'</span>
                       <span class="Symbol">,</span><span class="Char">'choose_spell'</span>
                       <span class="Symbol">,</span><span class="Char">'spread'</span>
                       <span class="Symbol">,</span><span class="Char">'recede'</span>
                       <span class="Symbol">,</span><span class="Char">'disappear'</span>
                       <span class="Symbol">,</span><span class="Char">'new_game'</span>
                       <span class="Symbol">,</span><span class="Char">'attempt_target_spell'</span>
                       <span class="Symbol">));</span>

<span class="Keyword">select</span> <span class="VarId">create6nf</span> <span class="Symbol">(</span>$$

  <span class="VarId">action_history_mr</span> <span class="Symbol">(</span>
    <span class="VarId">id</span> <span class="Type">serial</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
    <span class="VarId">history_name</span> <span class="VarId">history_name_enum</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_allegiance</span> <span class="Symbol">:</span> <span class="VarId">action_history_mr</span><span class="Symbol">(</span>
    <span class="VarId">allegiance</span> <span class="VarId">text</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_source</span> <span class="Symbol">:</span> <span class="VarId">action_history_allegiance</span> <span class="Symbol">(</span>
    <span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="VarId">y</span> <span class="VarId">int</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_target</span> <span class="Symbol">:</span> <span class="VarId">action_history_source</span> <span class="Symbol">(</span>
    <span class="VarId">tx</span> <span class="Type">int</span><span class="Symbol">,</span>
    <span class="VarId">ty</span> <span class="VarId">int</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_piece</span> <span class="Symbol">:</span> <span class="VarId">action_history_allegiance</span> <span class="Symbol">(</span>
    <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
    <span class="VarId">tag</span> <span class="VarId">int</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_piece_source</span> <span class="Symbol">:</span> <span class="VarId">action_history_piece</span><span class="Symbol">,</span> <span class="VarId">action_history_source</span><span class="Symbol">;</span>

  <span class="VarId">action_history_piece_target</span> <span class="Symbol">:</span> <span class="VarId">action_history_piece</span><span class="Symbol">,</span> <span class="VarId">action_history_target</span><span class="Symbol">;</span>

  <span class="VarId">action_history_spell</span> <span class="Symbol">:</span> <span class="VarId">action_history_allegiance</span> <span class="Symbol">(</span>
    <span class="VarId">spell_name</span> <span class="VarId">text</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_spell_source</span> <span class="Symbol">:</span> <span class="VarId">action_history_spell</span><span class="Symbol">,</span> <span class="VarId">action_history_source</span><span class="Symbol">;</span>

  <span class="VarId">action_history_spell_target</span> <span class="Symbol">:</span> <span class="VarId">action_history_spell</span><span class="Symbol">,</span> <span class="VarId">action_history_target</span><span class="Symbol">;</span>

  <span class="VarId">action_history_num_wiz</span> <span class="Symbol">:</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span>
    <span class="VarId">num_wizards</span> <span class="Type">int</span> <span class="VarId">null</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_turn_num</span> <span class="Symbol">:</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span>
    <span class="VarId">turn_number</span> <span class="VarId">int</span>
  <span class="Symbol">);</span>

  <span class="VarId">action_history_turn_phase</span> <span class="Symbol">:</span> <span class="VarId">action_history_source</span> <span class="Symbol">(</span>
    <span class="VarId">turn_phase</span> <span class="VarId">turn_phase_enum</span>
  <span class="Symbol">);</span>

$$<span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'action_history_mr'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Comment">--Turns</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">get_current_wizard_pos</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="VarId">pos</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">current_wizard_table</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span>
      <span class="Keyword">on</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span> <span class="Keyword">and</span> <span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">current_wizard</span>
$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">stable</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_new_turn</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">turn_number</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'new_turn'</span><span class="Symbol">,</span> <span class="VarId">get_turn_number</span><span class="Symbol">());</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_wizard_up</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="VarId">w</span> <span class="Symbol">:=</span> <span class="VarId">get_current_wizard_pos</span><span class="Symbol">();</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">turn_phase</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'wizard_up'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span> <span class="VarId">get_turn_phase</span><span class="Symbol">(),</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_new_game</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">num_wizards</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'new_game'</span><span class="Symbol">,</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">count</span><span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="VarId">wizards</span><span class="Symbol">));</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_game_won</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="VarId">w</span> <span class="Symbol">:=</span> <span class="VarId">get_current_wizard_pos</span><span class="Symbol">();</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'game_won'</span><span class="Symbol">,</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">allegiance</span>
                         <span class="Keyword">from</span> <span class="VarId">pieces</span>
                         <span class="Keyword">where</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span><span class="Symbol">),</span>
                         <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_game_drawn</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'game_drawn'</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">--Choosing</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_choose_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="VarId">w</span> <span class="Symbol">:=</span> <span class="VarId">get_current_wizard_pos</span><span class="Symbol">();</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'choose_spell'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span> <span class="VarId">get_current_wizard_spell</span><span class="Symbol">(),</span>
            <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_set_imaginary</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'set_imaginary'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">());</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_set_real</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'set_real'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">());</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">--Casting</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_attempt_target_spell</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
    <span class="Keyword">where</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="VarId">get_current_wizard</span><span class="Symbol">()</span>
      <span class="Keyword">and</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">tx</span><span class="Symbol">,</span> <span class="VarId">ty</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'attempt_target_spell'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span>
            <span class="VarId">get_current_wizard_spell</span><span class="Symbol">(),</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="VarId">py</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_attempt_activate_spell</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
    <span class="Keyword">where</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="VarId">get_current_wizard</span><span class="Symbol">()</span>
      <span class="Keyword">and</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'attempt_target_spell'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span>
            <span class="VarId">get_current_wizard_spell</span><span class="Symbol">(),</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_spell_succeeded</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'spell_succeeded'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span> <span class="VarId">get_current_wizard_spell</span><span class="Symbol">());</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_spell_failed</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'spell_failed'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span> <span class="VarId">get_current_wizard_spell</span><span class="Symbol">());</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_spell_skipped</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'spell_skipped'</span><span class="Symbol">,</span> <span class="VarId">get_current_wizard</span><span class="Symbol">(),</span> <span class="VarId">get_current_wizard_spell</span><span class="Symbol">());</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">--chinned and shrugged off</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_chinned</span><span class="Symbol">(</span><span class="VarId">k</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">k</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'chinned'</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>

<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_shrugged_off</span><span class="Symbol">(</span><span class="VarId">k</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">k</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'shrugged_off'</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">--Autonomous</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_receive_spell</span><span class="Symbol">(</span><span class="VarId">pwizard_name</span> <span class="Type">text</span><span class="Symbol">,</span> <span class="VarId">pspell_name</span> <span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
    <span class="Keyword">where</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="VarId">pwizard_name</span>
      <span class="Keyword">and</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">spell_name</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'choose_spell'</span><span class="Symbol">,</span> <span class="VarId">pwizard_name</span><span class="Symbol">,</span> <span class="VarId">pspell_name</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_spread</span><span class="Symbol">(</span><span class="VarId">k</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">k</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'spread'</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_recede</span><span class="Symbol">(</span><span class="VarId">k</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">k</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'recede'</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_disappear</span><span class="Symbol">(</span><span class="VarId">k</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">k</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'disappear'</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


<span class="Comment">--Move</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_walked</span><span class="Symbol">(</span><span class="VarId">sx</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">sy</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
  <span class="VarId">k</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">k</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">k</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">tx</span><span class="Symbol">,</span> <span class="VarId">ty</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'walked'</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">sx</span><span class="Symbol">,</span> <span class="VarId">sy</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_fly</span><span class="Symbol">(</span><span class="VarId">sx</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">sy</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">w</span> <span class="VarId">pos</span><span class="Symbol">;</span>
  <span class="VarId">k</span> <span class="VarId">piece_key</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">k</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">w</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">k</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span> <span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">tx</span><span class="Symbol">,</span> <span class="VarId">ty</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'fly'</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">sx</span><span class="Symbol">,</span> <span class="VarId">sy</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_attack</span><span class="Symbol">(</span><span class="VarId">t</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">sp</span> <span class="VarId">record</span><span class="Symbol">;</span>
  <span class="VarId">tp</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">sp</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">tp</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">t</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">ty</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'attack'</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">tp</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">tp</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">add_history_ranged_attack</span><span class="Symbol">(</span><span class="VarId">t</span> <span class="VarId">piece_key</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">sp</span> <span class="VarId">record</span><span class="Symbol">;</span>
  <span class="VarId">tp</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">sp</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">selected_piece</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces</span><span class="Symbol">;</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">tp</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">t</span><span class="Symbol">;</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">action_history_mr</span> <span class="Symbol">(</span><span class="VarId">history_name</span><span class="Symbol">,</span> <span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">tx</span><span class="Symbol">,</span><span class="VarId">ty</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Char">'ranged_attack'</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">ptype</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">allegiance</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="VarId">tp</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">tp</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


</pre></div></div></div><p
      >/*</p
      ><p
      >create a view to hide the details which players shouldn't be able to see - this is the view that the ui should use: hide set real, imaginary hide spell received in tree</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
