<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >TestSupport.sql transformed</title
    ><link href="../../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Comment">/*</span>
<span class="Comment">Action test support</span>
<span class="Comment">===================</span>

<span class="Comment">for testing purposes sometimes want to make a given nondeterministic</span>
<span class="Comment">action always fail or always succeed.</span>

<span class="Comment">The categories are:</span>
<span class="Comment">castle disappear</span>
<span class="Comment">gooey blob spread</span>
<span class="Comment">attack</span>
<span class="Comment">ranged attack</span>
<span class="Comment">resist: decree, lightning, subversion</span>
<span class="Comment">cast spell</span>

<span class="Comment">you have to set the override each time you want to override something</span>

<span class="Comment">*/</span>

<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.TestSupport'</span><span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'Chaos.Server.Actions.TestSupport'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateDomain (DomainType &quot;random_test&quot;) (ScalarType &quot;text&quot;)]*/</span>
<span class="Keyword">create</span> <span class="Keyword">domain</span> <span class="VarId">random_test</span> <span class="Type">text</span> <span class="Keyword">check</span> <span class="Symbol">(</span><span class="VarId">value</span> <span class="VarId">in</span>
       <span class="Symbol">(</span><span class="Char">'disappear'</span><span class="Symbol">,</span> <span class="Char">'spread'</span><span class="Symbol">,</span> <span class="Char">'attack'</span><span class="Symbol">,</span>
        <span class="Char">'ranged_attack'</span><span class="Symbol">,</span> <span class="Char">'resist'</span><span class="Symbol">,</span> <span class="Char">'cast'</span><span class="Symbol">,</span>
        <span class="Char">'bonus'</span><span class="Symbol">,</span><span class="Char">'break_engaged'</span><span class="Symbol">));</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'random_test'</span><span class="Symbol">,</span><span class="Char">'domain'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.TestSupport'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><div class='UnusedSql'><pre class="sourceCode"><span class="Comment">-- replaced sql ------------------------</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">test_action_overrides</span> <span class="Symbol">(</span>
  <span class="VarId">override</span> <span class="VarId">random_test</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
  <span class="VarId">setting</span> <span class="VarId">bool</span>
<span class="Symbol">);</span></pre></div></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateTable &quot;test_action_overrides&quot; [(&quot;override&quot;,DomainType &quot;random_test&quot;),(&quot;setting&quot;,ScalarType &quot;bool&quot;)] [(&quot;tableoid&quot;,ScalarType &quot;oid&quot;),(&quot;cmax&quot;,ScalarType &quot;cid&quot;),(&quot;xmax&quot;,ScalarType &quot;xid&quot;),(&quot;cmin&quot;,ScalarType &quot;cid&quot;),(&quot;xmin&quot;,ScalarType &quot;xid&quot;),(&quot;ctid&quot;,ScalarType &quot;tid&quot;)]]*/</span>
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">test_action_overrides</span> <span class="Symbol">(</span>
  <span class="VarId">override</span> <span class="VarId">random_test</span> <span class="Keyword">not</span> <span class="Keyword">null</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
  <span class="VarId">setting</span> <span class="Type">bool</span> <span class="Keyword">not</span> <span class="VarId">null</span>
<span class="Symbol">);</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'test_action_overrides'</span><span class="Symbol">,</span><span class="Char">'table'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.TestSupport'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'test_action_overrides'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span></pre></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;action_rig_action_success&quot; [DomainType &quot;random_test&quot;,ScalarType &quot;bool&quot;] (Pseudo Void) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_rig_action_success</span><span class="Symbol">(</span><span class="VarId">poverride</span> <span class="VarId">random_test</span><span class="Symbol">,</span>
       <span class="VarId">psetting</span> <span class="VarId">boolean</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">test_action_overrides</span> <span class="Symbol">(</span><span class="VarId">override</span><span class="Symbol">,</span> <span class="VarId">setting</span><span class="Symbol">)</span>
    <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">poverride</span><span class="Symbol">,</span> <span class="VarId">psetting</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Comment">/*</span>
<span class="Comment">random numbers</span>

<span class="Comment">run all random tests through this, so that we can hook into them</span>
<span class="Comment">during testing.</span>

<span class="Comment">*/</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'action_rig_action_success'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.TestSupport'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Comment">/*[CatCreateFunction FunName &quot;check_random_success&quot; [DomainType &quot;random_test&quot;,ScalarType &quot;int4&quot;] (ScalarType &quot;bool&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">check_random_success</span><span class="Symbol">(</span><span class="VarId">t</span> <span class="VarId">random_test</span><span class="Symbol">,</span> <span class="VarId">successPercentage</span> <span class="Type">int</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="VarId">boolean</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">o</span> <span class="VarId">boolean</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="VarId">o</span> <span class="Symbol">:=</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">setting</span> <span class="Keyword">from</span> <span class="VarId">test_action_overrides</span>
       <span class="Keyword">where</span> <span class="VarId">override</span> <span class="Symbol">=</span> <span class="VarId">t</span><span class="Symbol">);</span>
  <span class="Keyword">if</span> <span class="VarId">o</span> <span class="VarId">is</span> <span class="Keyword">null</span> <span class="Keyword">then</span> <span class="Comment">--normal random</span>
    <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">random</span><span class="Symbol">()</span> <span class="Symbol">*</span> <span class="Number">100</span><span class="Symbol">)</span> <span class="Symbol">&lt;</span> <span class="VarId">successPercentage</span><span class="Symbol">;</span>
  <span class="Keyword">else</span> <span class="Comment">--overriden</span>
    <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">test_action_overrides</span>
      <span class="Keyword">where</span> <span class="VarId">override</span> <span class="Symbol">=</span> <span class="VarId">t</span><span class="Symbol">;</span>
    <span class="VarId">return</span> <span class="VarId">o</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'check_random_success'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.TestSupport'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><div class='SqlPostgresql'><pre class="sourceCode"><span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">limit_chance</span><span class="Symbol">(</span><span class="VarId">integer</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="VarId">integer</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">greatest</span><span class="Symbol">(</span><span class="Number">10</span><span class="Symbol">,</span> <span class="VarId">least</span><span class="Symbol">(</span>$<span class="Number">1</span><span class="Symbol">,</span> <span class="Number">100</span><span class="Symbol">));</span></pre></div><div class='SqlPostgresql'><div class='GeneratedSql'><pre class="sourceCode"><span class="Comment">-- generated sql ------------------------</span>
<span class="Comment">/*[CatCreateFunction FunName &quot;limit_chance&quot; [ScalarType &quot;int4&quot;] (ScalarType &quot;int4&quot;) False]*/</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">limit_chance</span> <span class="Symbol">(</span><span class="VarId">integer</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="VarId">integer</span> <span class="Keyword">as</span> $$
  <span class="Keyword">select</span> <span class="VarId">greatest</span><span class="Symbol">(</span><span class="Number">10</span><span class="Symbol">,</span><span class="VarId">least</span><span class="Symbol">(</span>$<span class="Number">1</span><span class="Symbol">,</span><span class="Number">100</span><span class="Symbol">));</span>

$$ <span class="Keyword">language</span> <span class="VarId">sql</span> <span class="Keyword">immutable</span><span class="Symbol">;</span>

<span class="Comment">/*([],[])*/</span>
<span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
<span class="VarId">values</span>
  <span class="Symbol">(</span><span class="Char">'limit_chance'</span><span class="Symbol">,</span><span class="Char">'function'</span><span class="Symbol">,</span><span class="Char">'Chaos.Server.Actions.TestSupport'</span><span class="Symbol">)</span>
<span class="Symbol">;</span></pre></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
