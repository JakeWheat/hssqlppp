<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >BoardWidget</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div id="section"
    ><h1
      >/*</h1
      ><p
      >= board widget</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Client.BoardWidget'</span><span class="Symbol">);</span>
</pre></div></div></div><p
      >/* == cursor position + ops</p
      ><p
      >The cursor is at position x,y</p
      ><p
      >The server code has no concept of the cursor. In the end, this has just made the code more complicated for no reason. */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">cursor_position</span> <span class="Symbol">(</span>
  <span class="VarId">x</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">y</span> <span class="VarId">int</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_assertion</span><span class="Symbol">(</span><span class="Char">'cursor_position_coordinates_valid'</span><span class="Symbol">,</span>
$$ <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">cursor_position</span>
  <span class="Keyword">cross</span> <span class="Keyword">join</span> <span class="VarId">board_size</span>
  <span class="Keyword">where</span> <span class="VarId">x</span> <span class="Symbol">&gt;=</span> <span class="VarId">width</span> <span class="Keyword">or</span> <span class="VarId">y</span> <span class="Symbol">&gt;=</span> <span class="VarId">height</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'cursor_position'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">select</span> <span class="VarId">restrict_cardinality</span><span class="Symbol">(</span><span class="Char">'cursor_position'</span><span class="Symbol">,</span> <span class="Char">'1'</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/* === actions cursor movement */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="VarId">px</span> <span class="Type">int</span><span class="Symbol">,</span> <span class="VarId">py</span> <span class="Type">int</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">update</span> <span class="VarId">cursor_position</span>
    <span class="Keyword">set</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">least</span><span class="Symbol">(</span><span class="VarId">greatest</span><span class="Symbol">(</span><span class="VarId">x</span> <span class="Symbol">+</span> <span class="VarId">px</span><span class="Symbol">,</span> <span class="Number">0</span><span class="Symbol">),</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">width</span> <span class="Keyword">from</span> <span class="VarId">board_size</span><span class="Symbol">)</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">),</span>
        <span class="VarId">y</span> <span class="Symbol">=</span> <span class="VarId">least</span><span class="Symbol">(</span><span class="VarId">greatest</span><span class="Symbol">(</span><span class="VarId">y</span> <span class="Symbol">+</span> <span class="VarId">py</span><span class="Symbol">,</span> <span class="Number">0</span><span class="Symbol">),</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">height</span> <span class="Keyword">from</span> <span class="VarId">board_size</span><span class="Symbol">)</span> <span class="Symbol">-</span> <span class="Number">1</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_move_cursor</span><span class="Symbol">(</span><span class="VarId">direction</span> <span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">case</span> <span class="VarId">direction</span>
  <span class="Keyword">when</span> <span class="Char">'up'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">-1</span><span class="Symbol">);</span>
  <span class="Keyword">when</span> <span class="Char">'down'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span> <span class="Number">1</span><span class="Symbol">);</span>
  <span class="Keyword">when</span> <span class="Char">'left'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">-1</span><span class="Symbol">,</span> <span class="Number">0</span><span class="Symbol">);</span>
  <span class="Keyword">when</span> <span class="Char">'right'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span> <span class="Number">0</span><span class="Symbol">);</span>
  <span class="Keyword">when</span> <span class="Char">'up-left'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">-1</span><span class="Symbol">,</span> <span class="Number">-1</span><span class="Symbol">);</span>
  <span class="Keyword">when</span> <span class="Char">'up-right'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span> <span class="Number">-1</span><span class="Symbol">);</span>
  <span class="Keyword">when</span> <span class="Char">'down-left'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">-1</span><span class="Symbol">,</span> <span class="Number">1</span><span class="Symbol">);</span>
  <span class="Keyword">when</span> <span class="Char">'down-right'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">safe_move_cursor</span><span class="Symbol">(</span><span class="Number">1</span><span class="Symbol">,</span> <span class="Number">1</span><span class="Symbol">);</span>
  <span class="VarId">else</span>
    <span class="Keyword">raise</span> <span class="VarId">exception</span>
      <span class="Char">'asked to move cursor in direction % which isn''t valid'</span><span class="Symbol">,</span>
      <span class="VarId">direction</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">case</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/* === internals When next phase is called, moved the cursor to that wizard */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_move_cursor_to_current_wizard</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
 <span class="VarId">p</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Comment">--don't move cursor during autonomous phase</span>
  <span class="Keyword">if</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">!=</span> <span class="Char">'autonomous'</span> <span class="VarId">then</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">p</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
         <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
         <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">current_wizard</span> <span class="Symbol">=</span> <span class="VarId">allegiance</span><span class="Symbol">)</span>
         <span class="Keyword">where</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span><span class="Symbol">;</span>
    <span class="Keyword">update</span> <span class="VarId">cursor_position</span> <span class="Keyword">set</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">p</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">init_cursor_position</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">cursor_position</span> <span class="Symbol">(</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="Number">0</span><span class="Symbol">,</span><span class="Number">0</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >the plan is to have a board_sprites view for the board widget. This contains all the sprites on the board (basically everything drawn on the board: piece sprites, cursor, highlights, etc.) all the board needs is x,y,sprite and order. The order is used to make sure overlapping sprites e.g. a piece, the cursor and a highlight, are drawn in the right order</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">


</pre></div></div></div><p
      >/* == piece sprites Want to produce a list of x,y,sprite rows for the pieces on top, the cursor, and the highlights for the currently available actions</p
      ><p
      >wizard sprites: look in the action history to find the most recent upgrade */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">wizard_sprites</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">sprite</span><span class="Symbol">,</span><span class="VarId">colour</span> <span class="VarId">from</span>
  <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">row_number</span><span class="Symbol">()</span> <span class="Keyword">over</span><span class="Symbol">(</span><span class="Keyword">partition</span> <span class="Keyword">by</span> <span class="VarId">wizard_name</span> <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">o</span> <span class="Keyword">desc</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">rn</span><span class="Symbol">,</span>
    <span class="VarId">wizard_name</span><span class="Symbol">,</span>
    <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">shadow_form</span> <span class="Keyword">then</span> <span class="VarId">sprite</span> <span class="Symbol">||</span> <span class="Char">'_shadow'</span>
         <span class="Keyword">else</span> <span class="VarId">sprite</span>
    <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">sprite</span><span class="Symbol">,</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">colour</span> <span class="VarId">from</span>
  <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">-1</span> <span class="Keyword">as</span> <span class="VarId">o</span><span class="Symbol">,</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">default_sprite</span> <span class="Keyword">as</span> <span class="VarId">sprite</span>
      <span class="Keyword">from</span> <span class="VarId">wizard_display_info</span>
    <span class="Keyword">union</span> <span class="VarId">all</span>
    <span class="Keyword">select</span> <span class="VarId">id</span> <span class="Keyword">as</span> <span class="VarId">o</span><span class="Symbol">,</span> <span class="VarId">allegiance</span> <span class="Keyword">as</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span>
      <span class="Char">'wizard_'</span> <span class="Symbol">||</span> <span class="VarId">spell_name</span>
      <span class="Keyword">from</span> <span class="VarId">action_history_mr</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">spells_mr</span>
      <span class="Keyword">where</span> <span class="VarId">spell_name</span> <span class="Symbol">!=</span> <span class="Char">'shadow_form'</span>
      <span class="Keyword">and</span> <span class="VarId">spell_category</span> <span class="Symbol">=</span> <span class="Char">'wizard'</span>
      <span class="Keyword">and</span> <span class="VarId">history_name</span> <span class="Symbol">=</span> <span class="Char">'spell_succeeded'</span>
      <span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
  <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizard_display_info</span> <span class="Keyword">as</span> <span class="VarId">w</span>
  <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">wizards</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">w</span> <span class="Keyword">where</span> <span class="VarId">rn</span> <span class="Symbol">=</span> <span class="Number">1</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >piece ptype-allegiance-tag is at x,y, allegiance colour is 'colour', sprite is 'sprite', sprite priority is sp.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">piece_sprite</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span>
    <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span> <span class="Keyword">then</span> <span class="VarId">w</span><span class="Symbol">.</span><span class="VarId">sprite</span>
         <span class="Keyword">when</span> <span class="VarId">allegiance</span><span class="Symbol">=</span><span class="Char">'dead'</span> <span class="Keyword">then</span> <span class="Char">'dead_'</span> <span class="Symbol">||</span> <span class="VarId">ptype</span>
         <span class="Keyword">else</span> <span class="VarId">ptype</span>
    <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">sprite</span><span class="Symbol">,</span>
    <span class="VarId">ac</span><span class="Symbol">.</span><span class="VarId">colour</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">allegiance</span>
  <span class="Keyword">from</span> <span class="VarId">pieces</span> <span class="VarId">p</span>
  <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="VarId">wizard_sprites</span> <span class="VarId">w</span>
    <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span> <span class="Keyword">and</span> <span class="VarId">ptype</span><span class="Symbol">=</span><span class="Char">'wizard'</span><span class="Symbol">)</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">allegiance_colours</span> <span class="VarId">ac</span>
    <span class="Keyword">using</span> <span class="Symbol">(</span><span class="VarId">allegiance</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/* == highlights */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">board_highlights</span> <span class="VarId">as</span>
<span class="Comment">-- include the squares for the selected spell</span>
<span class="Comment">-- when still in the choose phase, so the user can</span>
<span class="Comment">--see what squares are valid for their chosen spell</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Char">'highlight_cast_target_spell'</span> <span class="Keyword">as</span> <span class="VarId">sprite</span>
  <span class="Keyword">from</span> <span class="VarId">current_wizard_spell_squares</span>
  <span class="Keyword">where</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'choose'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="Char">'highlight_'</span> <span class="Symbol">||</span> <span class="VarId">action</span> <span class="Keyword">as</span> <span class="VarId">sprite</span>
  <span class="Keyword">from</span> <span class="VarId">valid_target_actions</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/* == animation</p
      ><p
      >we save a starting tick against each piece. Not really sure what the best way to do this, some options are:</p
      ><p
      >these are updated in the action_key_pressed and client_ai_continue fns</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">piece_starting_ticks</span> <span class="Symbol">(</span>
  <span class="VarId">ptype</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">allegiance</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">tag</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">start_tick</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="Keyword">unique</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">),</span>
  <span class="Keyword">foreign</span> <span class="Keyword">key</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">references</span> <span class="VarId">pieces</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'piece_starting_ticks'</span><span class="Symbol">,</span> <span class="Char">'data'</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">update_missing_startticks</span><span class="Symbol">()</span>
  <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">piece_starting_ticks</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">start_tick</span><span class="Symbol">)</span>
    <span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span> <span class="VarId">random</span><span class="Symbol">()*</span><span class="Number">2500</span> <span class="Keyword">from</span> <span class="VarId">pieces</span>
      <span class="Keyword">where</span> <span class="Symbol">(</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">)</span> <span class="Keyword">not</span> <span class="VarId">in</span>
        <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span>
        <span class="Keyword">from</span> <span class="VarId">piece_starting_ticks</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >== board sprites</p
      ><p
      >put the piece sprites, the highlight and the cursor together to give the full list of sprites</p
      ><p
      >split this up so the cursor movement isn't really laggy, just a hack - needs some more thought.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">board_sprites1_view</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span><span class="VarId">sprite</span><span class="Symbol">,</span><span class="VarId">colour</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">,</span>
    <span class="VarId">start_tick</span><span class="Symbol">,</span> <span class="VarId">animation_speed</span><span class="Symbol">,</span> <span class="VarId">selected</span> <span class="VarId">from</span>
    <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">ptype</span><span class="Symbol">,</span><span class="VarId">allegiance</span><span class="Symbol">,</span><span class="VarId">tag</span><span class="Symbol">,</span>
      <span class="VarId">sprite</span><span class="Symbol">,</span><span class="VarId">colour</span><span class="Symbol">,</span><span class="VarId">sp</span><span class="Symbol">,</span><span class="Number">0</span> <span class="Keyword">as</span> <span class="VarId">start_tick</span><span class="Symbol">,</span>
      <span class="Keyword">case</span> <span class="Keyword">when</span> <span class="Keyword">not</span> <span class="VarId">move_phase</span> <span class="VarId">is</span> <span class="Keyword">null</span> <span class="Keyword">then</span> <span class="VarId">true</span>
        <span class="Keyword">else</span> <span class="VarId">false</span>
      <span class="Keyword">end</span> <span class="Keyword">as</span> <span class="VarId">selected</span>
      <span class="Keyword">from</span> <span class="VarId">piece_sprite</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_on_top</span>
    <span class="Comment">--natural inner join piece_starting_ticks</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">sprites</span>
    <span class="Keyword">natural</span> <span class="Keyword">left</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span>
    <span class="Keyword">union</span> <span class="VarId">all</span>
    <span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="Char">''</span><span class="Symbol">,</span> <span class="Char">''</span><span class="Symbol">,</span> <span class="Number">-1</span><span class="Symbol">,</span> <span class="VarId">sprite</span><span class="Symbol">,</span> <span class="Char">'white'</span><span class="Symbol">,</span> <span class="Number">5</span><span class="Symbol">,</span><span class="Number">0</span><span class="Symbol">,</span><span class="VarId">false</span>
      <span class="Keyword">from</span> <span class="VarId">board_highlights</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
  <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">sprites</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span> <span class="Char">''</span><span class="Symbol">,</span> <span class="Char">''</span><span class="Symbol">,</span> <span class="Number">-1</span><span class="Symbol">,</span><span class="Char">'cursor'</span><span class="Symbol">,</span> <span class="Char">'white'</span><span class="Symbol">,</span> <span class="Number">6</span><span class="Symbol">,</span><span class="Number">0</span><span class="Symbol">,</span> <span class="VarId">animation_speed</span><span class="Symbol">,</span> <span class="VarId">false</span>
  <span class="Keyword">from</span> <span class="VarId">cursor_position</span>
  <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">sprites</span> <span class="Keyword">on</span> <span class="VarId">sprite</span><span class="Symbol">=</span><span class="Char">'cursor'</span>
  <span class="Keyword">order</span> <span class="Keyword">by</span> <span class="VarId">sp</span><span class="Symbol">;</span>


</pre></div></div></div><p
      >/<em
	>create table board_sprites1_cache as select</em
	> from board_sprites1_view; select set_relvar_type('board_sprites1_cache', 'data');</p
      ><p
      >create function update_board_sprites_cache() returns void as <br
	 /><span class="math"
	><em
	  >b</em
	  ><em
	  >e</em
	  ><em
	  >g</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  > -  - <em
	  >i</em
	  ><em
	  >f</em
	  ><em
	  >g</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >r</em
	    ></sub
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >g</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >()<em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  > -  - <em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  >;  -  - <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  >;  -  - <em
	  >r</em
	  ><em
	  >a</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  >ʹ<em
	  >u</em
	  ><em
	  >p</em
	  ><em
	  >d</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >b</em
	  ><em
	  >p</em
	  ><em
	  >c</em
	  >ʹ; <em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >r</em
	  ><em
	  >i</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  >1<sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  >; <em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >r</em
	  ><em
	  >i</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  >1<sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  > * <em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >r</em
	  ><em
	  >i</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  >1<sub
	  ><em
	    >v</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >e</em
	  ><em
	  >w</em
	  >; <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >; </span
	><br
	 /> language plpgsql volatile;</p
      ><p
      >create view board_sprites as select * from board_sprites1_cache union all select x,y, '', '', -1,'cursor', 'white', 6,0, animation_speed, false from cursor_position inner join sprites on sprite='cursor'; */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">



</pre></div></div></div><p
      >/* == effects</p
      ><p
      >two sorts of effects: beam and square</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/* create table board_square_effects ( id serial unique, subtype text, x1 int, y1 int, queuePos int ); select set_relvar_type('board_square_effects', 'data');</p
      ><p
      >create table board_beam_effects ( id serial unique, subtype text, x1 int, y1 int, x2 int, y2 int, queuePos int ); select set_relvar_type('board_beam_effects', 'data');</p
      ><p
      >create table board_sound_effects ( id serial unique, subtype text, sound_name text, queuePos int ); select set_relvar_type('board_sound_effects', 'data');</p
      ><p
      >create function get_running_effects() returns boolean as <br
	 /><span class="math"
	><em
	  >b</em
	  ><em
	  >e</em
	  ><em
	  >g</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >b</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >); <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >; </span
	><br
	 /> language plpgsql stable;</p
      ><p
      >create table history_sounds ( history_name text, sound_name text, unique (history_name,sound_name) ); select set_relvar_type('history_sounds', 'readonly');</p
      ><p
      >copy history_sounds (history_name,sound_name) from stdin; walked walk fly fly attack attack ranged_attack shoot game_drawn draw game_won win spell_failed fail spell_succeeded success shrugged_off shrugged_off wizard_up wizard_up new_game new_game chinned kill attempt_target_spell cast .</p
      ><p
      >create table history_no_visuals ( history_name text unique ); select set_relvar_type('history_no_visuals', 'readonly');</p
      ><p
      >copy history_no_visuals (history_name) from stdin; wizard_up new_turn new_game game_won game_drawn choose_spell set_imaginary set_real .</p
      ><p
      >select create_var('last_history_effect_id', 'int'); select set_relvar_type('last_history_effect_id_table', 'data');</p
      ><p
      >create function check_for_effects() returns void as <br
	 /><span class="math"
	><em
	  >b</em
	  ><em
	  >e</em
	  ><em
	  >g</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >u</em
	  ><em
	  >b</em
	  ><em
	  >t</em
	  ><em
	  >y</em
	  ><em
	  >p</em
	  ><em
	  >e</em
	  >, <em
	  >x</em
	  >1, <em
	  >y</em
	  >1, <em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  >)<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  >, <em
	  >c</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >x</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >x</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >, <em
	  >c</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >y</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >y</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >y</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >, <em
	  >i</em
	  ><em
	  >d</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >m</em
	    ></sub
	  ><em
	  >r</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >i</em
	  ><em
	  >d</em
	  > &gt; <em
	  >g</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >l</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >i</em
	    ></sub
	  ><em
	  >d</em
	  >()<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >y</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >o</em
	  ><sub
	  ><em
	    >v</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >u</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  >); <em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >b</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >u</em
	  ><em
	  >b</em
	  ><em
	  >t</em
	  ><em
	  >y</em
	  ><em
	  >p</em
	  ><em
	  >e</em
	  >, <em
	  >x</em
	  >1, <em
	  >y</em
	  >1, <em
	  >x</em
	  >2, <em
	  >y</em
	  >2, <em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  >)<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  >, <em
	  >x</em
	  >, <em
	  >y</em
	  >, <em
	  >t</em
	  ><em
	  >x</em
	  >, <em
	  >t</em
	  ><em
	  >y</em
	  >, <em
	  >i</em
	  ><em
	  >d</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >m</em
	    ></sub
	  ><em
	  >r</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >i</em
	  ><em
	  >d</em
	  > &gt; <em
	  >g</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >l</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >i</em
	    ></sub
	  ><em
	  >d</em
	  >()<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >y</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >t</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >t</em
	  ><em
	  >y</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >o</em
	  ><sub
	  ><em
	    >v</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >u</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  >); <em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >u</em
	  ><em
	  >b</em
	  ><em
	  >t</em
	  ><em
	  >y</em
	  ><em
	  >p</em
	  ><em
	  >e</em
	  >, <em
	  >s</em
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  >, <em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  >)<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  >, <em
	  >s</em
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  >, <em
	  >i</em
	  ><em
	  >d</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >m</em
	    ></sub
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >j</em
	  ><em
	  >o</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >g</em
	  ><em
	  >i</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  > = <em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >i</em
	  ><em
	  >d</em
	  > &gt; <em
	  >g</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >l</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >i</em
	    ></sub
	  ><em
	  >d</em
	  >() -  - <em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >c</em
	  ><em
	  >l</em
	  ><em
	  >u</em
	  ><em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><em
	  >s</em
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >f</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >c</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >p</em
	  ><em
	  >u</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >c</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >d</em
	  ><em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><em
	  >s</em
	  ><em
	  >c</em
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >p</em
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  >(<em
	  >h</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >n</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  > = ʹ<em
	  >w</em
	  ><em
	  >i</em
	  ><em
	  >z</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >u</em
	    ></sub
	  ><em
	  >p</em
	  >ʹ<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >p</em
	    ></sub
	  ><em
	  >h</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  > = ʹ<em
	  >c</em
	  ><em
	  >h</em
	  ><em
	  >o</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  >ʹ<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >c</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >c</em
	  ><em
	  >e</em
	  >(<em
	  >c</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >p</em
	  ><em
	  >u</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >d</em
	  >, <em
	  >f</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  >)); <em
	  >u</em
	  ><em
	  >p</em
	  ><em
	  >d</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >i</em
	    ></sub
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >t</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >b</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >i</em
	    ></sub
	  ><em
	  >d</em
	  > = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >m</em
	  ><em
	  >a</em
	  ><em
	  >x</em
	  >(<em
	  >i</em
	  ><em
	  >d</em
	  >)<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><sub
	  ><em
	    >h</em
	    ></sub
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >y</em
	  ><sub
	  ><em
	    >m</em
	    ></sub
	  ><em
	  >r</em
	  >); <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >; </span
	><br
	 /> language plpgsql volatile; */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/*</p
      ><p
      >call this function before reading the current effects table and it will leave those tables the same if the current effects are still playing, or it will clear the old effects and fill them with the next set of effects.</p
      ><p
      >call it after reading the current effects table to clear the current row of sounds, that way the sounds will only be returned to the ui once and thus will only be played once.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

</pre></div></div></div><p
      >/*create table current_effects ( ticks int, queuePos int ); select set_relvar_type('current_effects', 'data');</p
      ><p
      >select restrict_cardinality('current_effects', 1);*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

</pre></div></div></div><p
      >/<em
	>create view current_board_sound_effects as select</em
	> from board_sound_effects natural inner join current_effects;</p
      ><p
      >create view current_board_beam_effects as select * from board_beam_effects natural inner join current_effects;</p
      ><p
      >create view current_board_square_effects as select * from board_square_effects natural inner join current_effects; */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/<em
	>create function action_reset_current_effects() returns void as <br
	   /><span class="math"
	  ><em
	    >b</em
	    ><em
	    >e</em
	    ><em
	    >g</em
	    ><em
	    >i</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >b</em
	    ><em
	    >o</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >s</em
	      ></sub
	    ><em
	    >o</em
	    ><em
	    >u</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >e</em
	      ></sub
	    ><em
	    >f</em
	    ><em
	    >f</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >; <em
	    >d</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >b</em
	    ><em
	    >o</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >b</em
	      ></sub
	    ><em
	    >e</em
	    ><em
	    >a</em
	    ><em
	    >m</em
	    ><sub
	    ><em
	      >e</em
	      ></sub
	    ><em
	    >f</em
	    ><em
	    >f</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >; <em
	    >d</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >b</em
	    ><em
	    >o</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >d</em
	    ><sub
	    ><em
	      >s</em
	      ></sub
	    ><em
	    >q</em
	    ><em
	    >u</em
	    ><em
	    >a</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><sub
	    ><em
	      >e</em
	      ></sub
	    ><em
	    >f</em
	    ><em
	    >f</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >; <em
	    >d</em
	    ><em
	    >e</em
	    ><em
	    >l</em
	    ><em
	    >e</em
	    ><em
	    >t</em
	    ><em
	    >e</em
	    ><em
	    >f</em
	    ><em
	    >r</em
	    ><em
	    >o</em
	    ><em
	    >m</em
	    ><em
	    >c</em
	    ><em
	    >u</em
	    ><em
	    >r</em
	    ><em
	    >r</em
	    ><em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >t</em
	    ><sub
	    ><em
	      >e</em
	      ></sub
	    ><em
	    >f</em
	    ><em
	    >f</em
	    ><em
	    >e</em
	    ><em
	    >c</em
	    ><em
	    >t</em
	    ><em
	    >s</em
	    >; <em
	    >e</em
	    ><em
	    >n</em
	    ><em
	    >d</em
	    >; </span
	  ><br
	   /> language plpgsql volatile;</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div><p
      >/* create function action_update_effects_ticks(pticks int) returns void as <br
	 /><span class="math"
	><em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >w</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >E</em
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >o</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  >:  = <em
	  >f</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  >; <em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><em
	  >Q</em
	  ><em
	  >p</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  >; <em
	  >b</em
	  ><em
	  >e</em
	  ><em
	  >g</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >w</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >E</em
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >:  = <em
	  >t</em
	  ><em
	  >r</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  >; <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  >;  -  - <em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >w</em
	  ><em
	  >a</em
	  ><em
	  >y</em
	  ><em
	  >s</em
	  ><em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >a</em
	  ><em
	  >f</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >i</em
	  ><em
	  >r</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >m</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >y</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >d</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >b</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  > = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >); <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  >;  -  - <em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >e</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  ><em
	  >w</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >e</em
	  ><em
	  >d</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >w</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >w</em
	  ><em
	  >o</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >p</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><em
	  >s</em
	  > &gt; (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><em
	  >s</em
	  > + 6<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  > = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >); <em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >b</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  > = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >); <em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >w</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  > = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >); <em
	  >d</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >; <em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><em
	  >Q</em
	  ><em
	  >p</em
	  >:  = (<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >m</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  >(<em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  >)<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >i</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >b</em
	    ></sub
	  ><em
	  >e</em
	  ><em
	  >a</em
	  ><em
	  >m</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >u</em
	  ><em
	  >n</em
	  ><em
	  >i</em
	  ><em
	  >o</em
	  ><em
	  >n</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  ><em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >b</em
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >a</em
	  >); <em
	  >i</em
	  ><em
	  >f</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><em
	  >Q</em
	  ><em
	  >p</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >n</em
	  ><em
	  >u</em
	  ><em
	  >l</em
	  ><em
	  >l</em
	  ><em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><em
	  >Q</em
	  ><em
	  >p</em
	  > &lt;  &gt; 0<em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><em
	  >o</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><em
	  >s</em
	  >, <em
	  >q</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >P</em
	  ><em
	  >o</em
	  ><em
	  >s</em
	  >)<em
	  >v</em
	  ><em
	  >a</em
	  ><em
	  >l</em
	  ><em
	  >u</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  >(<em
	  >p</em
	  ><em
	  >t</em
	  ><em
	  >i</em
	  ><em
	  >c</em
	  ><em
	  >k</em
	  ><em
	  >s</em
	  >, <em
	  >n</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >t</em
	  ><em
	  >Q</em
	  ><em
	  >p</em
	  >); <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  >; <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  >; <em
	  >i</em
	  ><em
	  >f</em
	  ><em
	  >n</em
	  ><em
	  >o</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >x</em
	  ><em
	  >i</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >(<em
	  >s</em
	  ><em
	  >e</em
	  ><em
	  >l</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  >1<em
	  >f</em
	  ><em
	  >r</em
	  ><em
	  >o</em
	  ><em
	  >m</em
	  ><em
	  >c</em
	  ><em
	  >u</em
	  ><em
	  >r</em
	  ><em
	  >r</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >t</em
	  ><sub
	  ><em
	    >e</em
	    ></sub
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  >)<em
	  >a</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >w</em
	  ><em
	  >a</em
	  ><em
	  >s</em
	  ><em
	  >E</em
	  ><em
	  >f</em
	  ><em
	  >f</em
	  ><em
	  >e</em
	  ><em
	  >c</em
	  ><em
	  >t</em
	  ><em
	  >s</em
	  ><em
	  >t</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >p</em
	  ><em
	  >e</em
	  ><em
	  >r</em
	  ><em
	  >f</em
	  ><em
	  >o</em
	  ><em
	  >r</em
	  ><em
	  >m</em
	  ><em
	  >u</em
	  ><em
	  >p</em
	  ><em
	  >d</em
	  ><em
	  >a</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><sub
	  ><em
	    >b</em
	    ></sub
	  ><em
	  >o</em
	  ><em
	  >a</em
	  ><em
	  >r</em
	  ><em
	  >d</em
	  ><sub
	  ><em
	    >s</em
	    ></sub
	  ><em
	  >p</em
	  ><em
	  >r</em
	  ><em
	  >i</em
	  ><em
	  >t</em
	  ><em
	  >e</em
	  ><em
	  >s</em
	  ><sub
	  ><em
	    >c</em
	    ></sub
	  ><em
	  >a</em
	  ><em
	  >c</em
	  ><em
	  >h</em
	  ><em
	  >e</em
	  >(); <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  ><em
	  >i</em
	  ><em
	  >f</em
	  >; <em
	  >e</em
	  ><em
	  >n</em
	  ><em
	  >d</em
	  >; </span
	><br
	 /> language plpgsql volatile; */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_client_ai_continue</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  </pre></div></div></div><p
      >/<em
	>if get_running_effects() then return; end if;</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

  <span class="Keyword">perform</span> <span class="VarId">action_ai_continue</span><span class="Symbol">();</span>
  <span class="Keyword">perform</span> <span class="VarId">update_missing_startticks</span><span class="Symbol">();</span>
  <span class="Keyword">if</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">computer_controlled</span> <span class="Keyword">from</span> <span class="VarId">wizards</span>
      <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span> <span class="Keyword">on</span> <span class="VarId">wizard_name</span><span class="Symbol">=</span><span class="VarId">current_wizard</span><span class="Symbol">)</span>
     <span class="Keyword">and</span> <span class="VarId">get_turn_phase</span><span class="Symbol">()</span> <span class="Symbol">=</span> <span class="Char">'choose'</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">action_client_ai_continue</span><span class="Symbol">();</span>
  <span class="VarId">else</span>
    <span class="Comment">--perform check_for_effects();</span>
    <span class="Comment">--perform update_board_sprites_cache();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">computer_controlled</span> <span class="Keyword">from</span> <span class="VarId">wizards</span>
          <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
          <span class="Keyword">on</span> <span class="VarId">wizard_name</span><span class="Symbol">=</span><span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">action_move_cursor_to_current_wizard</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_client_ai_continue_if</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">valid_activate_actions</span>
            <span class="Keyword">where</span> <span class="VarId">action</span><span class="Symbol">=</span><span class="Char">'ai_continue'</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">action_client_ai_continue</span><span class="Symbol">();</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >================================================================================</p
      ><p
      >= info widget</p
      ><p
      >create a few views to help with the stuff shown in the info widget</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">piece_details</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">pieces_mr</span>
            <span class="Keyword">full</span> <span class="Keyword">outer</span> <span class="VarId">join</span>
      <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Char">'wizard'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">wtype</span><span class="Symbol">,*</span> <span class="Keyword">from</span> <span class="VarId">wizards</span> <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="VarId">expired</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
            <span class="Keyword">on</span> <span class="Symbol">(</span><span class="VarId">allegiance</span> <span class="Symbol">=</span> <span class="VarId">wizard_name</span> <span class="Keyword">and</span> <span class="VarId">ptype</span> <span class="Symbol">=</span> <span class="VarId">wtype</span><span class="Symbol">)</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">pieces_with_priorities</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">piece_sprite</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">cursor_piece_details</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">piece_details</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">cursor_position</span><span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">selected_piece_details</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">piece_details</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">selected_piece</span>
      <span class="Keyword">natural</span> <span class="Keyword">full</span> <span class="Keyword">outer</span> <span class="Keyword">join</span> <span class="VarId">remaining_walk_table</span><span class="Symbol">;</span>
</pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
