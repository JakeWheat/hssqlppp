<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >ClientNewGame</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >/*</p
    ><p
    >================================================================================</p
    ><p
    >== new game action */</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Client.ClientNewGame'</span><span class="Symbol">);</span>

</pre></div></div></div><p
    >/*create table action_client_new_game_argument ( place int unique, wizard_name text unique, sprite text unique references sprites, colour text unique, --references colours(name), computer_controlled boolean ); select set_relvar_type('action_client_new_game_argument', 'stack');</p
    ><p
    >select create_assertion('action_client_new_game_place_valid', '(select count(<em
      >) from action_client_new_game_argument where place &gt;= (select count(</em
      >) from action_client_new_game_argument)) = 0');*/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">client_new_game_t</span> <span class="Symbol">(</span>
  <span class="VarId">place</span> <span class="Type">int</span><span class="Symbol">,</span>
  <span class="VarId">wizard_name</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">sprite</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">colour</span> <span class="Type">text</span><span class="Symbol">,</span>
  <span class="VarId">computer_controlled</span> <span class="VarId">boolean</span>
<span class="Symbol">);</span>

<span class="Comment">--this calls server new game</span>
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_client_new_game</span><span class="Symbol">(</span><span class="VarId">a</span> <span class="VarId">client_new_game_t</span> <span class="Symbol">[])</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Comment">--assert: argument has between 2 and 8 active wizards</span>
  <span class="Comment">--delete from action_new_game_argument;</span>
  <span class="Comment">--delete from init_wizard_display_info_argument;</span>
  <span class="Comment">-- clear data tables</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">cursor_position</span><span class="Symbol">;</span>
  <span class="Keyword">delete</span> <span class="Keyword">from</span> <span class="VarId">wizard_display_info</span><span class="Symbol">;</span>

  <span class="Comment">--delete from last_history_effect_id_table;</span>
  <span class="Comment">--insert into last_history_effect_id_table values (-1);</span>
  <span class="Comment">--delete from board_square_effects;</span>
  <span class="Comment">--delete from board_beam_effects;</span>
  <span class="Comment">--delete from board_sound_effects;</span>
  <span class="Comment">--delete from current_effects;</span>

  <span class="Keyword">perform</span> <span class="VarId">action_new_game</span><span class="Symbol">(</span>
          <span class="Symbol">(</span><span class="VarId">with</span>
            <span class="VarId">s</span> <span class="VarId">as</span>
              <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">place</span><span class="Symbol">,</span><span class="VarId">wizard_name</span><span class="Symbol">,</span> <span class="VarId">computer_controlled</span>
               <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">))</span>
           <span class="Keyword">select</span> <span class="VarId">array_agg</span><span class="Symbol">((</span><span class="VarId">place</span><span class="Symbol">,</span><span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">computer_controlled</span><span class="Symbol">)::</span><span class="VarId">new_game_t</span><span class="Symbol">)</span>
             <span class="Keyword">from</span> <span class="VarId">s</span><span class="Symbol">));</span>

  <span class="Comment">--wizard display_info</span>
  </pre></div></div></div><p
    >/<em
      >delete from init_wizard_display_info_argument; insert into init_wizard_display_info_argument (wizard_name, sprite, colour) select wizard_name, sprite, colour from unnest(a);</em
      >/</p
    ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  <span class="Keyword">perform</span> <span class="VarId">init_wizard_display_info</span><span class="Symbol">(</span>
    <span class="Symbol">(</span><span class="Keyword">with</span> <span class="VarId">s</span> <span class="Keyword">as</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">sprite</span> <span class="Keyword">as</span> <span class="VarId">default_sprite</span><span class="Symbol">,</span><span class="VarId">colour</span> <span class="Keyword">from</span> <span class="VarId">unnest</span><span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">))</span>
     <span class="Keyword">select</span> <span class="VarId">array_agg</span><span class="Symbol">((</span><span class="VarId">wizard_name</span><span class="Symbol">,</span><span class="VarId">default_sprite</span><span class="Symbol">,</span><span class="VarId">colour</span><span class="Symbol">)::</span><span class="VarId">wizard_display_info</span><span class="Symbol">)</span>
     <span class="Keyword">from</span> <span class="VarId">s</span><span class="Symbol">));</span>

  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">spell_book_show_all_table</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">spell_book_show_all_table</span> <span class="Keyword">values</span> <span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">);</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>

  <span class="Comment">--perform update_board_sprites_cache();</span>
  <span class="Comment">--perform check_for_effects();</span>
  <span class="Keyword">perform</span> <span class="VarId">init_cursor_position</span><span class="Symbol">();</span>
<span class="VarId">end</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
    >/* select protect_readonly_relvars(); select set_notifies_on_all_data_tables(); */</p
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
