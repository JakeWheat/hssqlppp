<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >ClientActions</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div id="section"
    ><h1
      >/*</h1
      ><p
      >= actions */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">select</span> <span class="VarId">module</span><span class="Symbol">(</span><span class="Char">'Chaos.Client.ClientActions'</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/* == action valid views</p
      ><p
      >we add this view to cover the actions which are defined in the client to supplement the action valid views for the server actions define in the server. */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">client_valid_target_actions</span> <span class="VarId">as</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">valid_target_actions</span>
  <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">client_valid_activate_actions</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="Symbol">(</span>
  <span class="Keyword">select</span> <span class="Symbol">*</span> <span class="Keyword">from</span> <span class="VarId">valid_activate_actions</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_up'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_down'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_left'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_right'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_up_left'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_down_left'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_up_right'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'move_cursor_down_right'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'print_widget_info'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'refresh_windows'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'spell_book_show_all_update_on'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'spell_book_show_all_update_off'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'client_next_phase'</span>
<span class="Keyword">union</span> <span class="Keyword">all</span> <span class="Keyword">select</span> <span class="Char">'go'</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span>
  <span class="Keyword">where</span> <span class="Keyword">not</span> <span class="Keyword">exists</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">game_completed_table</span><span class="Symbol">);</span>

</pre></div></div></div><p
      >/* == key controls create a table to map gtk key descriptions to the names of the action functions which are called.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Comment">--select new_module('key_controls', 'client');</span>

<span class="Keyword">create</span> <span class="Keyword">table</span> <span class="VarId">key_control_settings</span> <span class="Symbol">(</span>
  <span class="VarId">key_code</span> <span class="Type">text</span> <span class="Keyword">unique</span><span class="Symbol">,</span>
  <span class="VarId">action_name</span> <span class="VarId">text</span>
<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">set_relvar_type</span><span class="Symbol">(</span><span class="Char">'key_control_settings'</span><span class="Symbol">,</span> <span class="Char">'readonly'</span><span class="Symbol">);</span>

<span class="Keyword">copy</span> <span class="VarId">key_control_settings</span><span class="Symbol">(</span><span class="VarId">key_code</span><span class="Symbol">,</span> <span class="VarId">action_name</span><span class="Symbol">)</span> <span class="Keyword">from</span> <span class="Keyword">stdin</span><span class="Symbol">;</span>
<span class="VarId">Up</span>	<span class="VarId">move_cursor_up</span>
<span class="VarId">KP_Up</span>	<span class="VarId">move_cursor_up</span>
<span class="VarId">Left</span>	<span class="VarId">move_cursor_left</span>
<span class="VarId">KP_Left</span>	<span class="VarId">move_cursor_left</span>
<span class="VarId">Right</span>	<span class="VarId">move_cursor_right</span>
<span class="VarId">KP_Right</span>	<span class="VarId">move_cursor_right</span>
<span class="VarId">Down</span>	<span class="VarId">move_cursor_down</span>
<span class="VarId">KP_Down</span>	<span class="VarId">move_cursor_down</span>
<span class="VarId">KP_Home</span>	<span class="VarId">move_cursor_up_left</span>
<span class="VarId">KP_Page_Up</span>	<span class="VarId">move_cursor_up_right</span>
<span class="VarId">KP_Page_Down</span>	<span class="VarId">move_cursor_down_right</span>
<span class="VarId">KP_End</span>	<span class="VarId">move_cursor_down_left</span>
<span class="VarId">End</span>	<span class="VarId">cancel</span>
<span class="VarId">F11</span>	<span class="VarId">print_widget_info</span>
<span class="VarId">F12</span>	<span class="VarId">refresh_widgets</span>
<span class="Number">0</span>	<span class="VarId">choose_no_spell</span>
<span class="VarId">Insert</span>	<span class="VarId">spell_book_show_all_update_on</span>
<span class="VarId">Delete</span>	<span class="VarId">spell_book_show_all_update_off</span>
<span class="VarId">space</span>	<span class="VarId">client_next_phase</span>
<span class="VarId">KP_Begin</span>	<span class="VarId">go</span>
<span class="VarId">Return</span>	<span class="VarId">go</span>
<span class="VarId">KP_5</span>	<span class="VarId">go</span>
<span class="VarId">y</span>	<span class="VarId">set_imaginary</span>
<span class="VarId">Y</span>	<span class="VarId">set_imaginary</span>
<span class="VarId">n</span>	<span class="VarId">set_real</span>
<span class="VarId">N</span>	<span class="VarId">set_real</span>
\<span class="Symbol">.</span>

</pre></div></div></div><p
      >/* == key press actions */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="VarId">client_action_name</span> <span class="Type">text</span><span class="Symbol">,</span>
                                              <span class="VarId">action_call</span> <span class="Type">text</span><span class="Symbol">)</span>
  <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">execute</span> $<span class="VarId">f</span>$
<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_</span>$<span class="VarId">f</span>$ <span class="Symbol">||</span> <span class="VarId">client_action_name</span> <span class="Symbol">||</span> $<span class="VarId">f</span>$<span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $<span class="VarId">a</span>$
<span class="VarId">begin</span>
  <span class="Keyword">perform</span> <span class="VarId">action_</span>$<span class="VarId">f</span>$ <span class="Symbol">||</span> <span class="VarId">action_call</span> <span class="Symbol">||</span> $<span class="VarId">f</span>$<span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$<span class="VarId">a</span>$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>$<span class="VarId">f</span>$<span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/* cursor movement action redirections, used to make sense but don't anymore - todo: split the move_cursor function into separate ones. */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_down'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'down'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_up'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'up'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_left'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'left'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_right'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'right'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_up_left'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'up-left'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_up_right'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'up-right'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_down_right'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'down-right'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'move_cursor_down_left'</span><span class="Symbol">,</span>
       $$<span class="VarId">move_cursor</span><span class="Symbol">(</span><span class="Char">'down-left'</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'spell_book_show_all_update_on'</span><span class="Symbol">,</span>
       $$<span class="VarId">spell_book_show_all_update</span><span class="Symbol">(</span><span class="VarId">true</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>
<span class="Keyword">select</span> <span class="VarId">create_client_action_wrapper</span><span class="Symbol">(</span><span class="Char">'spell_book_show_all_update_off'</span><span class="Symbol">,</span>
       $$<span class="VarId">spell_book_show_all_update</span><span class="Symbol">(</span><span class="VarId">false</span><span class="Symbol">)</span>$$<span class="Symbol">);</span>

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_key_pressed</span><span class="Symbol">(</span><span class="VarId">pkeycode</span> <span class="Type">text</span><span class="Symbol">)</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">a</span> <span class="Type">text</span><span class="Symbol">;</span>
  <span class="VarId">cursor_move</span> <span class="VarId">boolean</span> <span class="Symbol">:=</span> <span class="VarId">false</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
</pre></div></div></div><p
      >/* basic plan have a table with key code, and action name then a strategy of taking an action and a. deciding where to get the arguments b. deciding if it is allowed</p
      ><p
      >profiling progress: started out about 1 sec to run when using for loop, got rid of that, got it down to about 0.1 sec but this is for an unmatched keypress, need to be faster.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
  </pre></div></div></div><p
      >/<em
	>if get_running_effects() then return; end if;</em
	>/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">a</span> <span class="VarId">action_name</span> <span class="Keyword">from</span> <span class="VarId">key_control_settings</span> <span class="VarId">k</span>
    <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">client_valid_activate_actions</span> <span class="VarId">v</span>
      <span class="Keyword">on</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">action_name</span> <span class="Symbol">=</span> <span class="VarId">v</span><span class="Symbol">.</span><span class="VarId">action</span>
      <span class="Keyword">where</span> <span class="VarId">key_code</span> <span class="Symbol">=</span> <span class="VarId">pkeycode</span><span class="Symbol">;</span>
  <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">a</span> <span class="VarId">is</span> <span class="Keyword">null</span> <span class="VarId">then</span>
      <span class="Keyword">if</span> <span class="VarId">substr</span><span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="Number">0</span><span class="Symbol">,</span><span class="Number">11</span><span class="Symbol">)</span> <span class="Symbol">=</span>  <span class="Char">'move_cursor'</span> <span class="VarId">then</span>
        <span class="VarId">cursor_move</span> <span class="Symbol">:=</span> <span class="VarId">true</span><span class="Symbol">;</span>
      <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
      <span class="Keyword">execute</span> <span class="Char">'select action_'</span> <span class="Symbol">||</span> <span class="VarId">a</span> <span class="Symbol">||</span> <span class="Char">'();'</span><span class="Symbol">;</span>
  <span class="VarId">else</span>
    <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">a</span> <span class="VarId">action_name</span> <span class="Keyword">from</span> <span class="VarId">key_control_settings</span> <span class="VarId">k</span>
      <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">client_valid_target_actions</span> <span class="VarId">v</span>
        <span class="Keyword">on</span> <span class="VarId">k</span><span class="Symbol">.</span><span class="VarId">action_name</span> <span class="Symbol">=</span> <span class="VarId">v</span><span class="Symbol">.</span><span class="VarId">action</span>
      <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">cursor_position</span>
        <span class="Keyword">where</span> <span class="VarId">key_code</span> <span class="Symbol">=</span> <span class="VarId">pkeycode</span><span class="Symbol">;</span>
    <span class="Keyword">if</span> <span class="VarId">substr</span><span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="Number">0</span><span class="Symbol">,</span><span class="Number">11</span><span class="Symbol">)</span> <span class="Symbol">=</span>  <span class="Char">'move_cursor'</span> <span class="VarId">then</span>
      <span class="VarId">cursor_move</span> <span class="Symbol">:=</span> <span class="VarId">true</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
    <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="VarId">a</span> <span class="VarId">is</span> <span class="Keyword">null</span> <span class="VarId">then</span>
      <span class="Keyword">execute</span> <span class="Char">'select action_'</span> <span class="Symbol">||</span> <span class="VarId">a</span> <span class="Symbol">||</span>
              <span class="Char">'('</span> <span class="Symbol">||</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">x</span> <span class="Keyword">from</span> <span class="VarId">cursor_position</span><span class="Symbol">)</span> <span class="Symbol">||</span>
              <span class="Char">', '</span> <span class="Symbol">||</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">y</span> <span class="Keyword">from</span> <span class="VarId">cursor_position</span><span class="Symbol">)</span> <span class="Symbol">||</span> <span class="Char">');'</span><span class="Symbol">;</span>
    <span class="VarId">else</span>
      <span class="Keyword">null</span><span class="Symbol">;</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Comment">--perform update_missing_startticks();</span>
  <span class="Comment">--perform check_for_effects();</span>
  <span class="Comment">--if not cursor_move then</span>
  <span class="Comment">--  perform update_board_sprites_cache();</span>
  <span class="Comment">--end if;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/* === spell choice */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">


  <span class="Keyword">insert</span> <span class="Keyword">into</span> <span class="VarId">key_control_settings</span><span class="Symbol">(</span><span class="VarId">key_code</span><span class="Symbol">,</span> <span class="VarId">action_name</span><span class="Symbol">)</span>
    <span class="Keyword">select</span> <span class="Keyword">key</span><span class="Symbol">,</span> <span class="Char">'choose_'</span> <span class="Symbol">||</span> <span class="VarId">spell_name</span> <span class="Symbol">||</span> <span class="Char">'_spell'</span>
    <span class="Keyword">from</span> <span class="VarId">spell_keys</span><span class="Symbol">;</span>


</pre></div></div></div><p
      >/*</p
      ><p
      >================================================================================</p
      ><p
      >== turn phases */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_client_next_phase</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">begin</span>
  <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">valid_activate_actions</span>
            <span class="Keyword">where</span> <span class="VarId">action</span><span class="Symbol">=</span><span class="Char">'ai_continue'</span><span class="Symbol">)</span> <span class="VarId">then</span>
    <span class="Keyword">perform</span> <span class="VarId">action_client_ai_continue</span><span class="Symbol">();</span>
  <span class="VarId">else</span>
    <span class="Keyword">perform</span> <span class="VarId">action_next_phase</span><span class="Symbol">();</span>
    <span class="Keyword">if</span> <span class="Keyword">not</span> <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">computer_controlled</span> <span class="Keyword">from</span> <span class="VarId">wizards</span>
            <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">current_wizard_table</span>
            <span class="Keyword">on</span> <span class="VarId">wizard_name</span><span class="Symbol">=</span><span class="VarId">current_wizard</span><span class="Symbol">)</span> <span class="VarId">then</span>
      <span class="Keyword">perform</span> <span class="VarId">action_move_cursor_to_current_wizard</span><span class="Symbol">();</span>
    <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
  <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>

</pre></div></div></div></div
    ><div id="section-1"
    ><h1
      >/*</h1
      ><p
      >== cursor/go actions */</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">

<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_cast_target_spell_at_cursor</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">pos</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span> <span class="Keyword">from</span> <span class="VarId">cursor_position</span><span class="Symbol">;</span>
  <span class="Keyword">perform</span> <span class="VarId">action_cast_target_spell</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


<span class="Keyword">create</span> <span class="Keyword">function</span> <span class="VarId">action_go</span><span class="Symbol">()</span> <span class="Keyword">returns</span> <span class="Type">void</span> <span class="Keyword">as</span> $$
<span class="VarId">declare</span>
  <span class="VarId">r</span> <span class="VarId">record</span><span class="Symbol">;</span>
<span class="VarId">begin</span>
  <span class="Keyword">select</span> <span class="Keyword">into</span> <span class="VarId">r</span> <span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">y</span><span class="Symbol">,</span><span class="VarId">action</span> <span class="Keyword">from</span> <span class="VarId">cursor_position</span>
    <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="Keyword">join</span> <span class="VarId">client_valid_target_actions</span><span class="Symbol">;</span>
  <span class="VarId">case</span>
      <span class="Keyword">when</span> <span class="VarId">r</span> <span class="VarId">is</span> <span class="VarId">null</span>
        <span class="VarId">then</span>
        <span class="Keyword">if</span> <span class="Keyword">exists</span><span class="Symbol">(</span><span class="Keyword">select</span> <span class="Number">1</span> <span class="Keyword">from</span> <span class="VarId">client_valid_activate_actions</span>
                  <span class="Keyword">where</span> <span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'cast_activate_spell'</span><span class="Symbol">)</span> <span class="VarId">then</span>
          <span class="Keyword">perform</span> <span class="VarId">action_cast_activate_spell</span><span class="Symbol">();</span>
        <span class="Keyword">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
      <span class="Keyword">when</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'cast_target_spell'</span>
        <span class="Keyword">then</span> <span class="Keyword">perform</span> <span class="VarId">action_cast_target_spell</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
      <span class="Keyword">when</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'select_piece_at_position'</span>
        <span class="Keyword">then</span> <span class="Keyword">perform</span> <span class="VarId">action_select_piece_at_position</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
      <span class="Keyword">when</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'walk'</span>
        <span class="Keyword">then</span> <span class="Keyword">perform</span> <span class="VarId">action_walk</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
      <span class="Keyword">when</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'fly'</span>
        <span class="Keyword">then</span> <span class="Keyword">perform</span> <span class="VarId">action_fly</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
      <span class="Keyword">when</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'attack'</span>
        <span class="Keyword">then</span> <span class="Keyword">perform</span> <span class="VarId">action_attack</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>
      <span class="Keyword">when</span> <span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">action</span> <span class="Symbol">=</span> <span class="Char">'ranged_attack'</span>
        <span class="Keyword">then</span> <span class="Keyword">perform</span> <span class="VarId">action_ranged_attack</span><span class="Symbol">(</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">x</span><span class="Symbol">,</span><span class="VarId">r</span><span class="Symbol">.</span><span class="VarId">y</span><span class="Symbol">);</span>

  <span class="Keyword">end</span> <span class="Keyword">case</span><span class="Symbol">;</span>
<span class="Keyword">end</span><span class="Symbol">;</span>
$$ <span class="Keyword">language</span> <span class="VarId">plpgsql</span> <span class="Keyword">volatile</span><span class="Symbol">;</span>


</pre></div></div></div></div
    ><div id="section-2"
    ><h1
      >/*</h1
      ><p
      >== prompt</p
      ><p
      >use the action valid views to provide the user with information on what their options are.</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">action_instructions</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="Char">'cast_target_spell'</span><span class="Symbol">::</span><span class="Type">text</span> <span class="Keyword">as</span> <span class="VarId">action</span><span class="Symbol">,</span>
       <span class="Char">'Cast spell: Select a square to cast '</span> <span class="Symbol">||</span>
        <span class="VarId">get_current_wizard_spell</span><span class="Symbol">()</span> <span class="Symbol">||</span> <span class="Char">' on'</span> <span class="Keyword">as</span> <span class="VarId">help</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'select_piece_at_position'</span><span class="Symbol">,</span>
       <span class="Char">'Select: choose a piece to move by selecting its square'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'walk'</span><span class="Symbol">,</span>
       <span class="Char">'Walk: select a square to move piece to'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'fly'</span><span class="Symbol">,</span>
       <span class="Char">'Fly: select a square to move piece to'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'attack'</span><span class="Symbol">,</span>
       <span class="Char">'Attack: select a square to attack that piece'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'ranged_attack'</span><span class="Symbol">,</span>
       <span class="Char">'Ranged attack: select a square to attack that piece'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'next_phase'</span><span class="Symbol">,</span>
       <span class="Char">'Next phase: press space to finish this wizard''s turn'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'set_imaginary'</span><span class="Symbol">,</span>
       <span class="Char">'Press y to cast an imaginary monster'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'set_real'</span><span class="Symbol">,</span>
       <span class="Char">'Press n to cast a real monster'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'cast_activate_spell'</span><span class="Symbol">,</span>
       <span class="Char">'Cast: Press enter to cast '</span> <span class="Symbol">||</span> <span class="VarId">get_current_wizard_spell</span><span class="Symbol">()</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'cancel'</span><span class="Symbol">,</span>
       <span class="Char">'Cancel: press End to cancel move/attack/ranged attack'</span>
<span class="Keyword">union</span> <span class="VarId">all</span>
<span class="Keyword">select</span> <span class="Char">'choose_disbelieve_spell'</span><span class="Symbol">,</span>
       <span class="Char">'Press a key from the spell book to choose that spell to cast'</span>
<span class="Symbol">;</span>

<span class="Keyword">create</span> <span class="Keyword">view</span> <span class="VarId">prompt</span> <span class="VarId">as</span>
<span class="Keyword">select</span> <span class="VarId">action</span><span class="Symbol">,</span> <span class="VarId">help</span>
  <span class="Keyword">from</span> <span class="VarId">action_instructions</span>
  <span class="Keyword">natural</span> <span class="Keyword">inner</span> <span class="VarId">join</span>
  <span class="Symbol">(</span><span class="Keyword">select</span> <span class="VarId">action</span> <span class="Keyword">from</span> <span class="VarId">client_valid_target_actions</span>
   <span class="Keyword">union</span> <span class="VarId">all</span>
   <span class="Keyword">select</span> <span class="VarId">action</span> <span class="Keyword">from</span> <span class="VarId">client_valid_activate_actions</span><span class="Symbol">)</span> <span class="Keyword">as</span> <span class="VarId">a</span><span class="Symbol">;</span>

</pre></div></div></div><p
      >/*</p
      ><p
      >TODO: improve these messages, maybe add in relevant sprites inline, draw lines onto the playing board, be more specific e.g. the help for enter could say exactly what options are available, next phase is context specific (e.g. next phase to decline to move pieces which haven't moved, or to not use additional shots of the currently casting spell, or if no parts have been cast, to say cancel spell cast, cancel also more specific.</p
      ><p
      >TODO: in addition to this help, want to make available a &quot;why can't I do this&quot; facility, which explains why a particular action can't be run at this time (for target actions, why a particular action can't be run at this time on this square).</p
      ><p
      >New idea: state what activate action is available or// state what target actions are available for some square and state what target action will run on the current square</p
      ><p
      >also: for squares with no valid action, try to provide a message guessing what the user might want to run on that square and explain why they can't: need to work through some examples to see how obvious these messages will be to create</p
      ><p
      >*/</p
      ><div class='sourceCode'><div class='literate'><div class='sql'><pre class="sourceCode">
</pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
