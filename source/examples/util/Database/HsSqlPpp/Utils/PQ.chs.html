<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >PQ</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
</pre></div></div></div><p
    >{-</p
    ><p
    >simple wrapper around libpq, focused on supporting copy from stdin/ to stdout</p
    ><p
    >-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">

</pre></div></div></div><p
    >{-# LANGUAGE ForeignFunctionInterface #-}</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Utils.PQ</span> <span class="Keyword">where</span>

<span class="Preproc">#include</span> <span class="String">&lt;stdio.h&gt;</span>
<span class="Preproc">#include</span> <span class="String">&lt;stdlib.h&gt;</span>
<span class="Preproc">#include</span> <span class="String">&lt;string.h&gt;</span>
<span class="Preproc">#include</span> <span class="String">&lt;errno.h&gt;</span>
<span class="Preproc">#include</span> <span class="String">&lt;sys/time.h&gt;</span>
<span class="Preproc">#include</span> <span class="String">&lt;postgresql/libpq-fe.h&gt;</span>

<span class="Keyword">import</span> <span class="ConId">Foreign</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.C2HS</span>

<span class="Symbol">{#</span><span class="VarId">enum</span> <span class="ConId">ConnStatusType</span> <span class="Symbol">{}</span> <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">)#}</span>
<span class="Symbol">{#</span><span class="VarId">enum</span> <span class="ConId">ExecStatusType</span> <span class="Symbol">{}</span> <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">)#}</span>

<span class="Symbol">{#</span><span class="VarId">pointer</span> <span class="Symbol">*</span><span class="ConId">PGconn</span> <span class="Keyword">as</span> <span class="Symbol">^</span> <span class="Keyword">newtype</span><span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">pointer</span> <span class="Symbol">*</span><span class="ConId">PGresult</span> <span class="Keyword">as</span> <span class="Symbol">^</span> <span class="Keyword">newtype</span><span class="Symbol">#}</span>

<span class="Function">makePGConn</span> <span class="Symbol">::</span> <span class="ConId">Ptr</span> <span class="Symbol">()</span> <span class="Symbol">-&gt;</span> <span class="ConId">PGconn</span>
<span class="Function">makePGConn</span> <span class="VarId">p</span> <span class="Symbol">=</span> <span class="ConId">PGconn</span> <span class="Symbol">(</span><span class="VarId">castPtr</span> <span class="VarId">p</span><span class="Symbol">)</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQconnectdb</span> <span class="Keyword">as</span> <span class="VarId">pqConnectdb</span>
   <span class="Symbol">{</span><span class="VarId">withCString</span><span class="Symbol">*</span> <span class="Symbol">`</span><span class="ConId">String'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span> <span class="VarId">id</span> <span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQfinish</span> <span class="Keyword">as</span> <span class="VarId">pqFinish</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`()</span>' <span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQstatus</span> <span class="Keyword">as</span> <span class="VarId">pqStatus</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">ConnStatusType'</span> <span class="VarId">cToEnum</span><span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQerrorMessage</span> <span class="Keyword">as</span> <span class="VarId">pqErrorMessage</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">String'</span> <span class="VarId">peekCString</span><span class="Symbol">*</span> <span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQexec</span> <span class="Keyword">as</span> <span class="VarId">pqExec</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span>
   <span class="Symbol">,</span><span class="VarId">withCString</span><span class="Symbol">*</span> <span class="Symbol">`</span><span class="ConId">String'</span>
   <span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">PGresult'</span> <span class="VarId">id</span> <span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQclear</span> <span class="Keyword">as</span> <span class="VarId">pqClear</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGresult'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`()</span>' <span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQresultStatus</span> <span class="Keyword">as</span> <span class="VarId">pqResultStatus</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGresult'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">ExecStatusType'</span> <span class="VarId">cToEnum</span> <span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQresStatus</span> <span class="Keyword">as</span> <span class="VarId">pqResStatus</span>
   <span class="Symbol">{</span><span class="VarId">cFromEnum</span> <span class="Symbol">`</span><span class="ConId">ExecStatusType'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">String'</span> <span class="VarId">peekCString</span><span class="Symbol">*</span> <span class="Symbol">#}</span>

<span class="Symbol">{#</span><span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQresultErrorMessage</span> <span class="Keyword">as</span> <span class="VarId">pqResultErrorMessage</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGresult'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">String'</span> <span class="VarId">peekCString</span><span class="Symbol">*</span> <span class="Symbol">#}</span>


<span class="Symbol">{#</span> <span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQputCopyData</span> <span class="Keyword">as</span> <span class="VarId">pqPutCopyData</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span>
   <span class="Symbol">,</span><span class="VarId">withCString</span><span class="Symbol">*</span> <span class="Symbol">`</span><span class="ConId">String'</span>
   <span class="Symbol">,`</span><span class="ConId">Int'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">Int'</span> <span class="Symbol">#}</span>

<span class="Symbol">{#</span> <span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQputCopyEnd</span> <span class="Keyword">as</span> <span class="VarId">pqPutCopyEnd</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span>
   <span class="Symbol">,</span><span class="VarId">withMCString</span><span class="Symbol">*</span> <span class="Symbol">`</span><span class="ConId">Maybe</span> <span class="ConId">String'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">Int'</span> <span class="Symbol">#}</span>

<span class="Function">withMCString</span> <span class="Symbol">::</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="Symbol">(</span><span class="ConId">CString</span> <span class="Symbol">-&gt;</span> <span class="ConId">IO</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">IO</span> <span class="VarId">a</span>
<span class="Function">withMCString</span> <span class="VarId">m</span> <span class="VarId">f</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="Keyword">case</span> <span class="VarId">m</span> <span class="Keyword">of</span>
    <span class="ConId">Nothing</span> <span class="Symbol">-&gt;</span> <span class="VarId">f</span> <span class="VarId">nullPtr</span>
    <span class="ConId">Just</span> <span class="VarId">s</span> <span class="Symbol">-&gt;</span> <span class="VarId">withCString</span> <span class="VarId">s</span> <span class="VarId">f</span>

<span class="Symbol">{#</span> <span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQgetCopyData</span> <span class="Keyword">as</span> <span class="VarId">pqGetCopyData</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span>
   <span class="Symbol">,</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">Ptr</span> <span class="Symbol">(</span><span class="ConId">Ptr</span> <span class="ConId">CChar</span><span class="Symbol">)</span>'
   <span class="Symbol">,`</span><span class="ConId">Int'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">Int'</span> <span class="Symbol">#}</span>

<span class="Symbol">{#</span> <span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQgetResult</span> <span class="Keyword">as</span> <span class="VarId">pqGetResult</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">PGconn'</span><span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`</span><span class="ConId">Maybe</span> <span class="ConId">PGresult'</span> <span class="VarId">mPGresult</span> <span class="Symbol">#}</span>

<span class="Function">mPGresult</span> <span class="Symbol">::</span> <span class="ConId">PGresult</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">PGresult</span>
<span class="Function">mPGresult</span> <span class="VarId">p</span><span class="Symbol">@(</span><span class="ConId">PGresult</span> <span class="VarId">x</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Keyword">if</span> <span class="VarId">x</span> <span class="Symbol">==</span> <span class="VarId">nullPtr</span>
                 <span class="Keyword">then</span> <span class="ConId">Nothing</span>
                 <span class="Keyword">else</span> <span class="ConId">Just</span> <span class="VarId">p</span>

<span class="Symbol">{#</span> <span class="VarId">fun</span> <span class="VarId">unsafe</span> <span class="ConId">PQfreemem</span> <span class="Keyword">as</span> <span class="VarId">pqFreemem</span>
   <span class="Symbol">{</span><span class="VarId">id</span> <span class="Symbol">`</span><span class="ConId">Ptr</span> <span class="Symbol">()</span>'<span class="Symbol">}</span> <span class="Symbol">-&gt;</span> <span class="Symbol">`()</span>' <span class="Symbol">#}</span>

</pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
