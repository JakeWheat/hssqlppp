<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >DatabaseLoader</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >This code is an example to demonstrate loading a sql file, parsing it, running a transform on the ast, then loading the result straight into PostgreSQL.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Utils.DatabaseLoader</span>
    <span class="Symbol">(</span><span class="VarId">loadAst</span>
    <span class="Symbol">,</span><span class="VarId">loadAstN</span>
    <span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Debug.Trace</span>
<span class="Keyword">import</span> <span class="Keyword">qualified</span> <span class="ConId">Database.HDBC.PostgreSQL</span> <span class="Keyword">as</span> <span class="ConId">Pg</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.PrettyPrinter</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Ast</span> <span class="Keyword">as</span> <span class="ConId">Ast</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.DbmsCommon</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.PQH</span></pre></div></div></div><p
    >Small hack to use pg lib to do copy from stdin</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">data</span> <span class="ConId">HackStatement</span> <span class="Symbol">=</span> <span class="ConId">Regular</span> <span class="ConId">Statement</span>
                   <span class="Symbol">|</span> <span class="ConId">CopyHack</span> <span class="ConId">Statement</span> <span class="ConId">Statement</span>
                     <span class="Keyword">deriving</span> <span class="ConId">Show</span>

<span class="Function">hackStatements</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">HackStatement</span><span class="Symbol">]</span>
<span class="Function">hackStatements</span> <span class="Symbol">(</span><span class="VarId">st1</span><span class="Symbol">@(</span><span class="ConId">Copy</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="ConId">Stdin</span><span class="Symbol">)</span> <span class="Symbol">:</span>
                <span class="VarId">st2</span><span class="Symbol">@(</span><span class="ConId">CopyData</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">:</span>
                <span class="VarId">sts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="ConId">CopyHack</span> <span class="VarId">st1</span> <span class="VarId">st2</span> <span class="Symbol">:</span> <span class="VarId">hackStatements</span> <span class="VarId">sts</span>
<span class="Function">hackStatements</span> <span class="Symbol">(</span><span class="VarId">st</span> <span class="Symbol">:</span> <span class="VarId">sts</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="ConId">Regular</span> <span class="VarId">st</span> <span class="Symbol">:</span> <span class="VarId">hackStatements</span> <span class="VarId">sts</span>
<span class="Function">hackStatements</span> <span class="Symbol">[]</span> <span class="Symbol">=</span> <span class="Symbol">[]</span></pre></div></div></div><p
    >The main routine, which takes an AST and loads it into a database using HDBC.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">loadAst</span> <span class="Symbol">::</span> <span class="ConId">Pg.Connection</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">IO</span> <span class="Symbol">()</span>
<span class="Function">loadAst</span> <span class="VarId">c</span> <span class="VarId">ast</span> <span class="Symbol">=</span>
  <span class="Comment">{-withConn (&quot;dbname=&quot; ++ dbName) $ \conn -&gt;</span>
<span class="Comment">    withTransaction conn $ \c1 -&gt; do-}</span>
       <span class="VarId">mapM_</span> <span class="Symbol">(</span><span class="VarId">loadStatement</span> <span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">hackStatements</span> <span class="VarId">ast</span>
  <span class="Keyword">where</span>
    <span class="VarId">loadStatement</span> <span class="VarId">conn</span> <span class="Symbol">(</span><span class="ConId">Regular</span> <span class="VarId">st</span><span class="Symbol">)</span> <span class="Symbol">=</span>
      <span class="VarId">runSqlCommand</span> <span class="VarId">conn</span> <span class="Symbol">$</span> <span class="VarId">printSql</span> <span class="Symbol">[</span><span class="VarId">st</span><span class="Symbol">]</span>
                           <span class="Comment">{-let a = printSql [st]</span>
<span class="Comment">                           in trace a $ a -}</span>
    <span class="VarId">loadStatement</span> <span class="VarId">conn</span> <span class="Symbol">(</span><span class="ConId">CopyHack</span> <span class="VarId">cpSt</span> <span class="Symbol">(</span><span class="ConId">CopyData</span> <span class="VarId">_</span> <span class="VarId">s</span><span class="Symbol">))</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="Keyword">let</span> <span class="VarId">c1</span> <span class="Symbol">=</span> <span class="VarId">connToPqConn</span> <span class="VarId">conn</span>
      <span class="VarId">r</span> <span class="Symbol">&lt;-</span> <span class="VarId">exec</span> <span class="VarId">c1</span> <span class="Symbol">$</span> <span class="VarId">printSql</span> <span class="Symbol">[</span><span class="VarId">cpSt</span><span class="Symbol">]</span>
      <span class="VarId">r2</span> <span class="Symbol">&lt;-</span> <span class="VarId">putCopyStringData</span> <span class="VarId">c1</span> <span class="Symbol">(</span><span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">error</span> <span class="Symbol">.</span> <span class="VarId">show</span><span class="Symbol">)</span> <span class="VarId">id</span> <span class="VarId">r</span><span class="Symbol">)</span> <span class="VarId">s</span>
      <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">error</span> <span class="Symbol">.</span> <span class="VarId">show</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">const</span> <span class="Symbol">$</span> <span class="VarId">return</span> <span class="Symbol">())</span> <span class="VarId">r2</span>
    <span class="VarId">loadStatement</span> <span class="VarId">_</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;got bad copy hack: &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">loadAstN</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">IO</span> <span class="Symbol">()</span>
<span class="Function">loadAstN</span> <span class="VarId">dbName</span> <span class="VarId">ast</span> <span class="Symbol">=</span>
  <span class="VarId">withConn</span> <span class="Symbol">(</span><span class="String">&quot;dbname=&quot;</span> <span class="Symbol">++</span> <span class="VarId">dbName</span><span class="Symbol">)</span>
    <span class="Symbol">$</span> <span class="VarId">flip</span> <span class="VarId">withTransaction</span>
      <span class="Symbol">$</span> <span class="VarId">flip</span> <span class="VarId">loadAst</span> <span class="VarId">ast</span></pre></div></div></div><p
    >todo: change the hack so that we can create a hdbc-postgresql connection out of a PGconn, this will be much less invasive to hdbc-postgresql</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">connToPqConn</span> <span class="Symbol">::</span> <span class="ConId">Pg.Connection</span> <span class="Symbol">-&gt;</span> <span class="ConId">PGconn</span>
<span class="Function">connToPqConn</span> <span class="Symbol">=</span> <span class="VarId">makePGConn</span> <span class="Symbol">.</span> <span class="ConId">Pg.</span><span class="VarId">pgConn</span></pre></div></div></div><p
    >diff for hdbc-postgresql-2.2.3.1 to add the ability to get the PGconn ptr out of a hdbc-postgresql connection</p
    ><p
    >diff -ru HDBC-postgresql-2.2.3.1/Database/HDBC/PostgreSQL/Connection.hsc HDBC-postgresql-2.2.3.1-mangled//Database/HDBC/PostgreSQL/Connection.hsc --- HDBC-postgresql-2.2.3.1/Database/HDBC/PostgreSQL/Connection.hsc 2010-05-06 20:14:54.000000000 +0100 +++ HDBC-postgresql-2.2.3.1-mangled//Database/HDBC/PostgreSQL/Connection.hsc 2010-05-06 20:03:09.000000000 +0100 @@ -20,7 +20,7 @@ -}</p
    ><p
    >module Database.HDBC.PostgreSQL.Connection - (connectPostgreSQL, Impl.Connection()) + (connectPostgreSQL, Impl.Connection(), Impl.pgConn) where</p
    ><p
    >import Database.HDBC @@ -55,13 +55,14 @@ wrappedptr &lt;- wrapconn ptr nullPtr fptr &lt;- newForeignPtr pqfinishptr wrappedptr case status of - #{const CONNECTION_OK} -&gt; mkConn args fptr + #{const CONNECTION<em
      >OK} -&gt; mkConn args fptr (castPtr ptr) +</em
      > -&gt; raiseError &quot;connectPostgreSQL&quot; status ptr</p
    ><p
    >-- FIXME: environment vars may have changed, should use pgsql enquiries -- for clone. -mkConn :: String -&gt; Conn -&gt; IO Impl.Connection -mkConn args conn = withConn conn $ +mkConn :: String -&gt; Conn -&gt; Ptr () -&gt; IO Impl.Connection +mkConn args conn c1 = withConn conn $  -&gt; do children &lt;- newMVar [] begin_transaction conn children @@ -83,7 +84,9 @@ Impl.dbServerVer = show serverver, Impl.dbTransactionSupport = True, Impl.getTables = fgetTables conn children, - Impl.describeTable = fdescribeTable conn children} + Impl.describeTable = fdescribeTable conn children, + Impl.pgConn = c1 + } quickQuery rconn &quot;SET client_encoding TO utf8;&quot; [] return rconn</p
    ><p
    >diff -ru HDBC-postgresql-2.2.3.1/Database/HDBC/PostgreSQL/ConnectionImpl.hs HDBC-postgresql-2.2.3.1-mangled//Database/HDBC/PostgreSQL/ConnectionImpl.hs --- HDBC-postgresql-2.2.3.1/Database/HDBC/PostgreSQL/ConnectionImpl.hs 2010-05-06 20:14:54.000000000 +0100 +++ HDBC-postgresql-2.2.3.1-mangled//Database/HDBC/PostgreSQL/ConnectionImpl.hs 2010-05-06 20:01:40.000000000 +0100 @@ -20,6 +20,7 @@</p
    ><p
    >import qualified Database.HDBC.Types as Types import Database.HDBC.ColTypes as ColTypes +import Foreign</p
    ><p
    >data Connection = Connection { @@ -37,7 +38,8 @@ dbServerVer :: String, dbTransactionSupport :: Bool, getTables :: IO [String], - describeTable :: String -&gt; IO [(String, ColTypes.SqlColDesc)] + describeTable :: String -&gt; IO [(String, ColTypes.SqlColDesc)], + pgConn :: Ptr () }</p
    ><p
    >instance Types.IConnection Connection where diff -ru HDBC-postgresql-2.2.3.1/Database/HDBC/PostgreSQL.hs HDBC-postgresql-2.2.3.1-mangled//Database/HDBC/PostgreSQL.hs --- HDBC-postgresql-2.2.3.1/Database/HDBC/PostgreSQL.hs 2010-05-06 20:14:54.000000000 +0100 +++ HDBC-postgresql-2.2.3.1-mangled//Database/HDBC/PostgreSQL.hs 2010-05-06 20:02:45.000000000 +0100 @@ -63,7 +63,7 @@ module Database.HDBC.PostgreSQL ( -- * Connecting to Databases - connectPostgreSQL, Connection, + connectPostgreSQL, Connection, pgConn, -- * PostgreSQL Error Codes -- -- |When an @SqlError@ is thrown, the field @seState@ is set to one of the following @@ -73,5 +73,5 @@</p
    ><p
    >where</p
    ><p
    >-import Database.HDBC.PostgreSQL.Connection(connectPostgreSQL, Connection()) +import Database.HDBC.PostgreSQL.Connection(connectPostgreSQL, Connection(), pgConn) import Database.HDBC.PostgreSQL.ErrorCodes</p
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
