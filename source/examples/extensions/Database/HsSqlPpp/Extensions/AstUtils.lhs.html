<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >AstUtils</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >This is the start of some code to support ast transforms where we need some information that might come from the type checker, only we want to support sql which doesn't type check until after the transformations have been made.</p
    ><p
    >At the moment, it supports a function to list the create function, view and table statements from an ast, and another funtion to take an arbitrary ast fragment and list the tables it references, either directly, or via views and functions. This is to support adding a constraint of an arbitrary expression, we need to know which tables to attach the implementation trigger to. Will be expanded and more docs added.</p
    ><p
    >TODO: add test for recursive function, to make sure this code catches it and quits.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Extensions.AstUtils</span>
    <span class="Symbol">(</span><span class="VarId">getAstInfo</span>
    <span class="Symbol">,</span><span class="VarId">getReferencedTableList</span>
    <span class="Symbol">,</span><span class="VarId">replaceSourcePos</span>
    <span class="Symbol">,</span><span class="VarId">replaceSourcePos1</span><span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Data.Generics.Uniplate.Data</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics</span>
<span class="Keyword">import</span> <span class="ConId">Data.List</span>
<span class="Keyword">import</span> <span class="ConId">Data.Maybe</span>
<span class="Comment">--import Debug.Trace</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Ast</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>

<span class="Keyword">data</span> <span class="ConId">AstInfo</span> <span class="Symbol">=</span> <span class="ConId">AstInfo</span> <span class="Symbol">{</span>
     <span class="VarId">functions</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Statement</span><span class="Symbol">)]</span>
    <span class="Symbol">,</span><span class="VarId">views</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Statement</span><span class="Symbol">)]</span>
    <span class="Symbol">,</span><span class="VarId">tables</span> <span class="Symbol">::</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Statement</span><span class="Symbol">)]</span>
    <span class="Symbol">}</span>

<span class="Function">getAstInfo</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">AstInfo</span>
<span class="Function">getAstInfo</span> <span class="VarId">ast</span> <span class="Symbol">=</span> <span class="ConId">AstInfo</span> <span class="Symbol">(</span><span class="VarId">listFunctions</span> <span class="VarId">ast</span><span class="Symbol">)</span>
                         <span class="Symbol">(</span><span class="VarId">listViews</span> <span class="VarId">ast</span><span class="Symbol">)</span>
                         <span class="Symbol">(</span><span class="VarId">listTables</span> <span class="VarId">ast</span><span class="Symbol">)</span>

<span class="Comment">-- won't need this wrapper when the recursion loop detection logic</span>
<span class="Comment">-- is in place</span>
<span class="Function">getReferencedTableList</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="ConId">AstInfo</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">getReferencedTableList</span> <span class="VarId">asti</span> <span class="VarId">a</span> <span class="Symbol">=</span>
    <span class="VarId">nub</span> <span class="Symbol">$</span> <span class="VarId">getReferencedTableListI</span> <span class="VarId">asti</span> <span class="VarId">a</span>

<span class="Function">getReferencedTableListI</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="ConId">AstInfo</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">getReferencedTableListI</span> <span class="VarId">asti</span> <span class="VarId">a</span> <span class="Symbol">=</span>
        <span class="VarId">doTables</span>
        <span class="Symbol">++</span> <span class="VarId">doViews</span>
        <span class="Symbol">++</span> <span class="VarId">doFunctions</span>
    <span class="Keyword">where</span>
      <span class="VarId">doTables</span> <span class="Symbol">=</span> <span class="VarId">trefs</span> <span class="Symbol">`</span><span class="VarId">intersect</span><span class="Symbol">`</span> <span class="VarId">map</span> <span class="VarId">fst</span> <span class="Symbol">(</span><span class="VarId">tables</span> <span class="VarId">asti</span><span class="Symbol">)</span>
      <span class="VarId">doViews</span> <span class="Symbol">=</span> <span class="Keyword">let</span> <span class="VarId">vdefs</span> <span class="Symbol">=</span> <span class="VarId">filter</span> <span class="Symbol">((`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">trefs</span><span class="Symbol">)</span> <span class="Symbol">.</span> <span class="VarId">fst</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">views</span> <span class="VarId">asti</span>
                <span class="Keyword">in</span> <span class="VarId">concatMap</span> <span class="Symbol">(</span><span class="VarId">getReferencedTableList</span> <span class="VarId">asti</span> <span class="Symbol">.</span> <span class="VarId">snd</span><span class="Symbol">)</span> <span class="VarId">vdefs</span>
      <span class="VarId">doFunctions</span> <span class="Symbol">=</span> <span class="Keyword">let</span> <span class="VarId">fdefs</span> <span class="Symbol">=</span> <span class="VarId">filter</span> <span class="Symbol">((`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">funrefs</span><span class="Symbol">)</span> <span class="Symbol">.</span> <span class="VarId">fst</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">functions</span> <span class="VarId">asti</span>
                    <span class="Keyword">in</span> <span class="VarId">concatMap</span> <span class="Symbol">(</span><span class="VarId">getReferencedTableList</span> <span class="VarId">asti</span> <span class="Symbol">.</span> <span class="VarId">snd</span><span class="Symbol">)</span> <span class="VarId">fdefs</span>
      <span class="VarId">trefs</span> <span class="Symbol">=</span> <span class="VarId">getTrefs</span> <span class="VarId">a</span>
      <span class="VarId">funrefs</span> <span class="Symbol">=</span> <span class="VarId">getFunctionRefs</span> <span class="VarId">a</span>

<span class="Function">getTrefs</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">getTrefs</span> <span class="VarId">ast</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="VarId">getName</span> <span class="VarId">tbl</span><span class="Symbol">|</span> <span class="ConId">Tref</span> <span class="VarId">_</span> <span class="VarId">tbl</span> <span class="VarId">_</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">]</span>

<span class="Function">getName</span> <span class="Symbol">::</span> <span class="ConId">ScalarExpr</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">getName</span> <span class="Symbol">(</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">i</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">i</span>
<span class="Function">getName</span> <span class="Symbol">(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="String">&quot;.&quot;</span> <span class="Symbol">[</span><span class="VarId">_</span><span class="Symbol">,</span><span class="ConId">Identifier</span> <span class="VarId">_</span> <span class="VarId">i</span><span class="Symbol">])</span> <span class="Symbol">=</span> <span class="VarId">i</span>
<span class="Function">getName</span> <span class="Symbol">(</span><span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="String">&quot;.&quot;</span> <span class="Symbol">[</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">a</span><span class="Symbol">])</span> <span class="Symbol">=</span> <span class="VarId">getName</span> <span class="VarId">a</span>
<span class="Function">getName</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;internal error getName called on: &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">x</span>

<span class="Comment">-- this is wrong because we don't take into account function overloading</span>
<span class="Function">getFunctionRefs</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">getFunctionRefs</span> <span class="VarId">ast</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="VarId">fn</span><span class="Symbol">|</span> <span class="ConId">FunCall</span> <span class="VarId">_</span> <span class="VarId">fn</span> <span class="VarId">_</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">]</span>

<span class="Function">listFunctions</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Statement</span><span class="Symbol">)]</span>
<span class="Function">listFunctions</span> <span class="VarId">ast</span> <span class="Symbol">=</span>
  <span class="Symbol">[(</span><span class="VarId">fn</span><span class="Symbol">,</span><span class="VarId">f</span><span class="Symbol">)</span> <span class="Symbol">|</span> <span class="VarId">f</span><span class="Symbol">@(</span><span class="ConId">CreateFunction</span> <span class="VarId">_</span> <span class="VarId">fn</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">]</span>

<span class="Function">listViews</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Statement</span><span class="Symbol">)]</span>
<span class="Function">listViews</span> <span class="VarId">ast</span> <span class="Symbol">=</span>
  <span class="Symbol">[(</span><span class="VarId">vn</span><span class="Symbol">,</span><span class="VarId">v</span><span class="Symbol">)</span> <span class="Symbol">|</span> <span class="VarId">v</span><span class="Symbol">@(</span><span class="ConId">CreateView</span> <span class="VarId">_</span> <span class="VarId">vn</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">]</span>

<span class="Function">listTables</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span>  <span class="Symbol">-&gt;</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Statement</span><span class="Symbol">)]</span>
<span class="Function">listTables</span> <span class="VarId">ast</span> <span class="Symbol">=</span>
  <span class="Symbol">[(</span><span class="VarId">tn</span><span class="Symbol">,</span><span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">|</span> <span class="VarId">t</span><span class="Symbol">@(</span><span class="ConId">CreateTable</span>  <span class="VarId">_</span> <span class="VarId">tn</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">]</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">replaceSourcePos1</span> <span class="Symbol">::</span> <span class="ConId">Statement</span> <span class="Symbol">-&gt;</span> <span class="ConId">Statement</span> <span class="Symbol">-&gt;</span> <span class="ConId">Statement</span>
<span class="Function">replaceSourcePos1</span> <span class="VarId">st</span> <span class="VarId">st1</span> <span class="Symbol">=</span> <span class="VarId">head</span> <span class="Symbol">$</span> <span class="VarId">replaceSourcePos</span> <span class="VarId">st</span> <span class="Symbol">[</span><span class="VarId">st1</span><span class="Symbol">]</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">replaceSourcePos</span> <span class="Symbol">::</span> <span class="ConId">Statement</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span>
<span class="Function">replaceSourcePos</span> <span class="VarId">st</span> <span class="Symbol">=</span>
    <span class="VarId">map</span> <span class="Symbol">(</span><span class="VarId">adjSp</span> <span class="VarId">gsp</span><span class="Symbol">)</span>
    <span class="Keyword">where</span>
      <span class="VarId">gsp</span> <span class="Symbol">::</span> <span class="ConId">SourcePosition</span>
      <span class="VarId">gsp</span> <span class="Symbol">=</span> <span class="VarId">fromMaybe</span> <span class="Symbol">(</span><span class="String">&quot;unknown&quot;</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">,</span><span class="Number">1</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">asrc</span> <span class="Symbol">$</span> <span class="VarId">getAnnotation</span> <span class="VarId">st</span>
      <span class="VarId">adjSp</span> <span class="VarId">sp1</span> <span class="Symbol">=</span> <span class="VarId">updateAnnotation</span> <span class="Symbol">(\</span><span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span> <span class="Symbol">{</span><span class="VarId">asrc</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="VarId">sp1</span><span class="Symbol">})</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
