<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >TransitionConstraints</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><div id="transition-constraints"
    ><h1
      >transition constraints</h1
      ><p
      >quickly hacked together. at the moment only supports constraints involving a single tuple at a time from a single table. Separate functions to create a constraint for updates, inserts and deletes.</p
      ><p
      >I'm still not sure transition constraints like this are useful. Something better might be regular constraints on temporal relations.</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE QuasiQuotes, ScopedTypeVariables #-}</span>

<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Extensions.TransitionConstraints</span>
    <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Data.Generics</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics.Uniplate.Data</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Ast</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parser</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Extensions.ExtensionsUtils</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.SqlQuote</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Extensions.AstUtils</span></pre></div></div></div><div id="examples"
      ><h2
	>examples</h2
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">transitionConstraintExamples</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">ExtensionTest</span><span class="Symbol">]</span>
<span class="Function">transitionConstraintExamples</span> <span class="Symbol">=</span> <span class="Symbol">[</span>
   <span class="ConId">ExtensionTest</span> <span class="String">&quot;TransitionConstraint insert&quot;</span>
    <span class="VarId">transitionConstraints</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>

     <span class="VarId">select</span> <span class="VarId">create_insert_transition_tuple_constraint</span><span class="Symbol">(</span>
        '<span class="VarId">relvar'</span><span class="Symbol">,</span> '<span class="VarId">relvar_insert'</span><span class="Symbol">,</span> '<span class="ConId">NEW.</span><span class="VarId">x</span><span class="Symbol">&gt;</span><span class="Number">10</span>'<span class="Symbol">);</span>

     <span class="Symbol">|]</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>

     <span class="VarId">create</span> <span class="VarId">function</span> <span class="VarId">check_relvar_insert</span><span class="Symbol">()</span> <span class="VarId">returns</span> <span class="VarId">trigger</span> <span class="Keyword">as</span> <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span>
     <span class="VarId">begin</span>
       <span class="Keyword">if</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="ConId">NEW.</span><span class="VarId">x</span><span class="Symbol">&gt;</span><span class="Number">10</span><span class="Symbol">)</span> <span class="Keyword">then</span>
           <span class="VarId">raise</span> <span class="VarId">exception</span> '<span class="VarId">insert</span> <span class="VarId">on</span> <span class="VarId">relvar</span> <span class="VarId">violates</span> <span class="VarId">transition</span> <span class="VarId">constraint</span> <span class="VarId">relvar_insert'</span><span class="Symbol">;</span>
       <span class="VarId">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
       <span class="VarId">return</span> <span class="ConId">OLD</span><span class="Symbol">;</span>
     <span class="VarId">end</span><span class="Symbol">;</span>
     <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span> <span class="VarId">language</span> <span class="VarId">plpgsql</span> <span class="VarId">volatile</span><span class="Symbol">;</span>

     <span class="VarId">create</span> <span class="VarId">trigger</span> <span class="VarId">relvar_insert_transition_trigger</span>
       <span class="VarId">after</span> <span class="VarId">insert</span> <span class="VarId">on</span> <span class="VarId">relvar</span>
       <span class="VarId">for</span> <span class="VarId">each</span> <span class="VarId">row</span>
       <span class="VarId">execute</span> <span class="VarId">procedure</span> <span class="VarId">check_relvar_insert</span><span class="Symbol">();</span>

     <span class="Symbol">|]</span>
  <span class="Symbol">,</span><span class="ConId">ExtensionTest</span> <span class="String">&quot;TransitionConstraint update&quot;</span>
    <span class="VarId">transitionConstraints</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>

     <span class="VarId">select</span> <span class="VarId">create_update_transition_tuple_constraint</span><span class="Symbol">(</span>
        '<span class="VarId">relvar'</span><span class="Symbol">,</span> '<span class="VarId">relvar_update'</span><span class="Symbol">,</span> '<span class="ConId">NEW.</span><span class="VarId">x</span><span class="Symbol">=</span><span class="ConId">OLD.</span><span class="VarId">y'</span><span class="Symbol">);</span>

     <span class="Symbol">|]</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>

     <span class="VarId">create</span> <span class="VarId">function</span> <span class="VarId">check_relvar_update</span><span class="Symbol">()</span> <span class="VarId">returns</span> <span class="VarId">trigger</span> <span class="Keyword">as</span> <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span>
     <span class="VarId">begin</span>
       <span class="Keyword">if</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="ConId">NEW.</span><span class="VarId">x</span><span class="Symbol">=</span><span class="ConId">OLD.</span><span class="VarId">y</span><span class="Symbol">)</span> <span class="Keyword">then</span>
           <span class="VarId">raise</span> <span class="VarId">exception</span> '<span class="VarId">update</span> <span class="VarId">on</span> <span class="VarId">relvar</span> <span class="VarId">violates</span> <span class="VarId">transition</span> <span class="VarId">constraint</span> <span class="VarId">relvar_update'</span><span class="Symbol">;</span>
       <span class="VarId">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
       <span class="VarId">return</span> <span class="ConId">OLD</span><span class="Symbol">;</span>
     <span class="VarId">end</span><span class="Symbol">;</span>
     <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span> <span class="VarId">language</span> <span class="VarId">plpgsql</span> <span class="VarId">volatile</span><span class="Symbol">;</span>

     <span class="VarId">create</span> <span class="VarId">trigger</span> <span class="VarId">relvar_update_transition_trigger</span>
       <span class="VarId">after</span> <span class="VarId">update</span> <span class="VarId">on</span> <span class="VarId">relvar</span>
       <span class="VarId">for</span> <span class="VarId">each</span> <span class="VarId">row</span>
       <span class="VarId">execute</span> <span class="VarId">procedure</span> <span class="VarId">check_relvar_update</span><span class="Symbol">();</span>

     <span class="Symbol">|]</span>
  <span class="Symbol">,</span><span class="ConId">ExtensionTest</span> <span class="String">&quot;TransitionConstraint delete&quot;</span>
    <span class="VarId">transitionConstraints</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>

     <span class="VarId">select</span> <span class="VarId">create_delete_transition_tuple_constraint</span><span class="Symbol">(</span>
        '<span class="VarId">relvar'</span><span class="Symbol">,</span> '<span class="VarId">relvar_delete'</span><span class="Symbol">,</span> '<span class="ConId">OLD.</span><span class="VarId">y</span> <span class="Symbol">&gt;</span> <span class="Number">0</span>'<span class="Symbol">);</span>

     <span class="Symbol">|]</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>

     <span class="VarId">create</span> <span class="VarId">function</span> <span class="VarId">check_relvar_delete</span><span class="Symbol">()</span> <span class="VarId">returns</span> <span class="VarId">trigger</span> <span class="Keyword">as</span> <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span>
     <span class="VarId">begin</span>
       <span class="Keyword">if</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="ConId">OLD.</span><span class="VarId">y</span> <span class="Symbol">&gt;</span> <span class="Number">0</span><span class="Symbol">)</span> <span class="Keyword">then</span>
           <span class="VarId">raise</span> <span class="VarId">exception</span> '<span class="VarId">delete</span> <span class="VarId">on</span> <span class="VarId">relvar</span> <span class="VarId">violates</span> <span class="VarId">transition</span> <span class="VarId">constraint</span> <span class="VarId">relvar_delete'</span><span class="Symbol">;</span>
       <span class="VarId">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
       <span class="VarId">return</span> <span class="VarId">null</span><span class="Symbol">;</span>
     <span class="VarId">end</span><span class="Symbol">;</span>
     <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span> <span class="VarId">language</span> <span class="VarId">plpgsql</span> <span class="VarId">volatile</span><span class="Symbol">;</span>

     <span class="VarId">create</span> <span class="VarId">trigger</span> <span class="VarId">relvar_delete_transition_trigger</span>
       <span class="VarId">after</span> <span class="VarId">delete</span> <span class="VarId">on</span> <span class="VarId">relvar</span>
       <span class="VarId">for</span> <span class="VarId">each</span> <span class="VarId">row</span>
       <span class="VarId">execute</span> <span class="VarId">procedure</span> <span class="VarId">check_relvar_delete</span><span class="Symbol">();</span>

     <span class="Symbol">|]</span>
  <span class="Symbol">]</span></pre></div></div></div></div
      ><div id="implementation"
      ><h2
	>implementation</h2
	><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">transitionConstraints</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="VarId">a</span>
<span class="Function">transitionConstraints</span> <span class="Symbol">=</span>
    <span class="VarId">transformBi</span> <span class="Symbol">$</span> <span class="Symbol">\</span><span class="VarId">x</span> <span class="Symbol">-&gt;</span>
      <span class="Keyword">case</span> <span class="VarId">x</span> <span class="Keyword">of</span>
        <span class="VarId">s</span><span class="Symbol">@[$</span><span class="VarId">sqlStmt</span><span class="Symbol">|</span> <span class="VarId">select</span> <span class="Symbol">$(</span><span class="VarId">fn</span><span class="Symbol">)($</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">tablename</span><span class="Symbol">)</span>
                               <span class="Symbol">,$</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">constraintname</span><span class="Symbol">)</span>
                               <span class="Symbol">,$</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">expressiontext</span><span class="Symbol">));|]</span> <span class="Symbol">:</span> <span class="VarId">tl</span>
            <span class="Symbol">|</span> <span class="VarId">fn</span> <span class="Symbol">==</span> <span class="String">&quot;create_insert_transition_tuple_constraint&quot;</span> <span class="Symbol">-&gt;</span>
                 <span class="VarId">replaceSourcePos</span> <span class="VarId">s</span> <span class="Symbol">(</span>
                 <span class="VarId">gen</span> <span class="ConId">TInsert</span> <span class="VarId">tablename</span> <span class="VarId">constraintname</span> <span class="VarId">expressiontext</span><span class="Symbol">)</span> <span class="Symbol">++</span> <span class="VarId">tl</span>
            <span class="Symbol">|</span> <span class="VarId">fn</span> <span class="Symbol">==</span> <span class="String">&quot;create_update_transition_tuple_constraint&quot;</span> <span class="Symbol">-&gt;</span>
                 <span class="VarId">replaceSourcePos</span> <span class="VarId">s</span> <span class="Symbol">(</span>
                 <span class="VarId">gen</span> <span class="ConId">TUpdate</span> <span class="VarId">tablename</span> <span class="VarId">constraintname</span> <span class="VarId">expressiontext</span><span class="Symbol">)</span> <span class="Symbol">++</span> <span class="VarId">tl</span>
            <span class="Symbol">|</span> <span class="VarId">fn</span> <span class="Symbol">==</span> <span class="String">&quot;create_delete_transition_tuple_constraint&quot;</span> <span class="Symbol">-&gt;</span>
                 <span class="VarId">replaceSourcePos</span> <span class="VarId">s</span> <span class="Symbol">(</span>
                 <span class="VarId">gen</span> <span class="ConId">TDelete</span> <span class="VarId">tablename</span> <span class="VarId">constraintname</span> <span class="VarId">expressiontext</span><span class="Symbol">)</span> <span class="Symbol">++</span> <span class="VarId">tl</span>
        <span class="VarId">x1</span> <span class="Symbol">-&gt;</span> <span class="VarId">x1</span>
    <span class="Keyword">where</span>
      <span class="VarId">gen</span> <span class="Symbol">::</span> <span class="ConId">TriggerEvent</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span>
      <span class="VarId">gen</span> <span class="VarId">tct</span> <span class="VarId">tablename</span> <span class="VarId">constraintName</span> <span class="VarId">expressionText</span> <span class="Symbol">=</span>
          <span class="Keyword">let</span> <span class="VarId">spliceFnName</span> <span class="Symbol">=</span> <span class="String">&quot;check_&quot;</span> <span class="Symbol">++</span> <span class="VarId">constraintName</span>
              <span class="VarId">ttname</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">tct</span> <span class="Keyword">of</span>
                          <span class="ConId">TInsert</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;insert&quot;</span>
                          <span class="ConId">TUpdate</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;update&quot;</span>
                          <span class="ConId">TDelete</span> <span class="Symbol">-&gt;</span> <span class="String">&quot;delete&quot;</span>
              <span class="VarId">spliceErrMsg</span> <span class="Symbol">=</span> <span class="VarId">ttname</span> <span class="Symbol">++</span> <span class="String">&quot; on &quot;</span> <span class="Symbol">++</span> <span class="VarId">tablename</span> <span class="Symbol">++</span>
                       <span class="String">&quot; violates transition constraint &quot;</span> <span class="Symbol">++</span> <span class="VarId">constraintName</span>
              <span class="VarId">spliceTriggerName</span> <span class="Symbol">=</span> <span class="VarId">tablename</span> <span class="Symbol">++</span> <span class="String">&quot;_&quot;</span> <span class="Symbol">++</span> <span class="VarId">ttname</span> <span class="Symbol">++</span> <span class="String">&quot;_transition_trigger&quot;</span>
              <span class="VarId">ret</span> <span class="Symbol">=</span> <span class="Keyword">if</span> <span class="VarId">tct</span> <span class="Symbol">==</span> <span class="ConId">TDelete</span>
                    <span class="Keyword">then</span> <span class="Symbol">[$</span><span class="VarId">sqlExpr</span><span class="Symbol">|</span> <span class="VarId">null</span> <span class="Symbol">|]</span>
                    <span class="Keyword">else</span> <span class="Symbol">[$</span><span class="VarId">sqlExpr</span><span class="Symbol">|</span> <span class="ConId">OLD</span> <span class="Symbol">|]</span>
              <span class="VarId">expr</span> <span class="Symbol">=</span> <span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">error</span> <span class="Symbol">.</span> <span class="VarId">show</span><span class="Symbol">)</span> <span class="VarId">id</span>
                            <span class="Symbol">$</span> <span class="VarId">parseScalarExpr</span> <span class="String">&quot;&quot;</span> <span class="VarId">expressionText</span>
          <span class="Keyword">in</span> <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
      <span class="VarId">create</span> <span class="VarId">function</span> <span class="Symbol">$(</span><span class="VarId">spliceFnName</span><span class="Symbol">)()</span> <span class="VarId">returns</span> <span class="VarId">trigger</span> <span class="Keyword">as</span> <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span>
      <span class="VarId">begin</span>
        <span class="Keyword">if</span> <span class="VarId">not</span> <span class="Symbol">(</span> <span class="Symbol">$(</span><span class="VarId">expr</span><span class="Symbol">))</span> <span class="Keyword">then</span>
            <span class="VarId">raise</span> <span class="VarId">exception</span> '<span class="Symbol">$(</span><span class="VarId">spliceErrMsg</span><span class="Symbol">)</span>'<span class="Symbol">;</span>
        <span class="VarId">end</span> <span class="Keyword">if</span><span class="Symbol">;</span>
        <span class="VarId">return</span> <span class="Symbol">$(</span><span class="VarId">ret</span><span class="Symbol">);</span>
      <span class="VarId">end</span><span class="Symbol">;</span>
      <span class="Symbol">$</span><span class="VarId">a</span><span class="Symbol">$</span> <span class="VarId">language</span> <span class="VarId">plpgsql</span> <span class="VarId">volatile</span><span class="Symbol">;</span>

      <span class="VarId">create</span> <span class="VarId">trigger</span> <span class="Symbol">$(</span><span class="VarId">spliceTriggerName</span><span class="Symbol">)</span>
        <span class="VarId">after</span> <span class="Symbol">$(</span><span class="VarId">tct</span><span class="Symbol">)</span> <span class="VarId">on</span> <span class="Symbol">$(</span><span class="VarId">tablename</span><span class="Symbol">)</span>
        <span class="VarId">for</span> <span class="VarId">each</span> <span class="VarId">row</span>
        <span class="VarId">execute</span> <span class="VarId">procedure</span> <span class="Symbol">$(</span><span class="VarId">spliceFnName</span><span class="Symbol">)();</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">                           <span class="Symbol">|]</span></pre></div></div></div></div
      ></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
