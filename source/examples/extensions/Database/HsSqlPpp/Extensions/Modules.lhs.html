<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >Modules</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >Currently, just some notes.</p
    ><p
    >Extension to implement a module system:</p
    ><p
    >initial syntax is new_module - which adds the module and then adds everything following to that module until a new new_module is hit. Just use . separated names, no explicit hierarchy for now.</p
    ><p
    >then, add public export lists, get these in a catalog</p
    ><p
    >then add import lists (can only import whole modules, no qualification for now - no namespace control so names still have to be unique), get these in a catalog</p
    ><p
    >then, add a check to run on a type-checked ast, which makes sure only access is consistent with export and import lists</p
    ><p
    >then, add facility to explicitly list what is used from which import</p
    ><p
    >put default catalog in module</p
    ><p
    >work on namespacing and qualification?</p
    ><p
    >match haskell style of one module per file in right folder location?</p
    ><p
    >enforce directed graph of module dependencies</p
    ><p
    >use some idea of interface files for modules?</p
    ><p
    >rough idea from dylan: create multiple export lists for each module with names so you can import the appropriate export you want to use, have this optional so if you only use one export list you don't have to name it, and if you import without specifying the export list name, you get the first one in the file by default. This way, e.g., we can export stuff for the other sql modules to use, but not for clients connecting to the database, and simulate a friend-type relationship between modules. Maybe also add an implicit export which exports everything?</p
    ><p
    >take a bit further, e.g. for the '6nf' thing, could create a namespace control which says, this table is accessible only by the following views, then create rules on the views, so we have physical implementation independence and the table with the nulls is completely hidden, without having to create a separate module.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE QuasiQuotes, ScopedTypeVariables #-}</span>

<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Extensions.Modules</span>
    <span class="Symbol">(</span><span class="VarId">modules</span>
    <span class="Symbol">,</span><span class="VarId">modulesExample</span><span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Data.Generics.Uniplate.Data</span>
<span class="Keyword">import</span> <span class="ConId">Control.Monad.State</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Ast</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.SqlQuote</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Extensions.ExtensionsUtils</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Extensions.AstUtils</span>

<span class="Function">modulesExample</span> <span class="Symbol">::</span> <span class="ConId">ExtensionTest</span>
<span class="Function">modulesExample</span> <span class="Symbol">=</span>
  <span class="ConId">ExtensionTest</span>
    <span class="String">&quot;modules&quot;</span>
    <span class="VarId">modules</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span> <span class="VarId">select</span> <span class="Keyword">module</span><span class="Symbol">(</span>'<span class="ConId">Chaos.Server.Metadata'</span><span class="Symbol">);</span>
     <span class="VarId">create</span> <span class="VarId">table</span> <span class="VarId">t1</span> <span class="Symbol">(</span>
       <span class="VarId">a</span> <span class="VarId">text</span>
     <span class="Symbol">);</span>
     <span class="VarId">select</span> <span class="Number">2</span><span class="Symbol">;</span>
     <span class="Symbol">|]</span>
    <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>
     <span class="VarId">create</span> <span class="VarId">table</span> <span class="VarId">modules</span> <span class="Symbol">(</span>
       <span class="VarId">module_name</span> <span class="VarId">text</span><span class="Symbol">,</span>
       <span class="VarId">module_order</span> <span class="VarId">serial</span>
     <span class="Symbol">);</span>
     <span class="VarId">create</span> <span class="VarId">table</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span>
       <span class="VarId">object_name</span> <span class="VarId">text</span><span class="Symbol">,</span>
       <span class="VarId">object_type</span> <span class="VarId">text</span><span class="Symbol">,</span>
       <span class="VarId">module_name</span> <span class="VarId">text</span>
     <span class="Symbol">);</span>
     <span class="VarId">insert</span> <span class="VarId">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span> <span class="VarId">values</span> <span class="Symbol">(</span>'<span class="ConId">Chaos.Server.Metadata'</span><span class="Symbol">);</span>
     <span class="VarId">create</span> <span class="VarId">table</span> <span class="VarId">t1</span> <span class="Symbol">(</span>
       <span class="VarId">a</span> <span class="VarId">text</span>
     <span class="Symbol">);</span>
     <span class="VarId">insert</span> <span class="VarId">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
            <span class="VarId">values</span> <span class="Symbol">(</span>'<span class="VarId">t1'</span><span class="Symbol">,</span>'<span class="VarId">table'</span><span class="Symbol">,</span>'<span class="ConId">Chaos.Server.Metadata'</span><span class="Symbol">);</span>
     <span class="VarId">select</span> <span class="Number">2</span><span class="Symbol">;</span>
     <span class="Symbol">|]</span>

<span class="Function">modules</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Statement</span><span class="Symbol">]</span>
<span class="Function">modules</span> <span class="VarId">st</span> <span class="Symbol">=</span>
    <span class="Symbol">(</span><span class="VarId">replaceSourcePos</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">st</span><span class="Symbol">)</span> <span class="Symbol">[$</span><span class="VarId">sqlStmts</span><span class="Symbol">|</span>
     <span class="VarId">create</span> <span class="VarId">table</span> <span class="VarId">modules</span> <span class="Symbol">(</span>
      <span class="VarId">module_name</span> <span class="VarId">text</span><span class="Symbol">,</span>
      <span class="VarId">module_order</span> <span class="VarId">serial</span>
    <span class="Symbol">);</span>
    <span class="VarId">create</span> <span class="VarId">table</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span>
      <span class="VarId">object_name</span> <span class="VarId">text</span><span class="Symbol">,</span>
      <span class="VarId">object_type</span> <span class="VarId">text</span><span class="Symbol">,</span>
      <span class="VarId">module_name</span> <span class="VarId">text</span>
    <span class="Symbol">);</span> <span class="Symbol">|])</span>
    <span class="Symbol">++</span> <span class="VarId">reverse</span> <span class="Symbol">(((\</span><span class="VarId">f</span> <span class="Symbol">-&gt;</span> <span class="VarId">evalState</span> <span class="Symbol">(</span><span class="VarId">transformBiM</span> <span class="VarId">f</span> <span class="Symbol">(</span><span class="VarId">reverse</span> <span class="VarId">st</span><span class="Symbol">))</span> <span class="String">&quot;no_module&quot;</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="Symbol">\</span><span class="VarId">x</span> <span class="Symbol">-&gt;</span>
            <span class="Keyword">case</span> <span class="VarId">x</span> <span class="Keyword">of</span>
               <span class="VarId">s</span><span class="Symbol">@[$</span><span class="VarId">sqlStmt</span><span class="Symbol">|</span> <span class="VarId">select</span> <span class="Keyword">module</span><span class="Symbol">($</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">modname</span><span class="Symbol">));</span> <span class="Symbol">|]</span> <span class="Symbol">:</span> <span class="VarId">tl</span>
                   <span class="Symbol">-&gt;</span> <span class="Keyword">do</span>
                      <span class="VarId">put</span> <span class="VarId">modname</span>
                      <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">replaceSourcePos1</span> <span class="VarId">s</span> <span class="Symbol">[$</span><span class="VarId">sqlStmt</span><span class="Symbol">|</span>
                                <span class="VarId">insert</span> <span class="VarId">into</span> <span class="VarId">modules</span> <span class="Symbol">(</span><span class="VarId">module_name</span><span class="Symbol">)</span>
                                <span class="VarId">values</span> <span class="Symbol">($</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">modname</span><span class="Symbol">));|]</span> <span class="Symbol">:</span> <span class="VarId">tl</span>
               <span class="VarId">s</span><span class="Symbol">@(</span><span class="ConId">CreateTable</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">:</span> <span class="VarId">tl</span> <span class="Symbol">-&gt;</span> <span class="VarId">insertIt</span> <span class="VarId">s</span> <span class="VarId">tl</span> <span class="VarId">n</span> <span class="String">&quot;table&quot;</span>
               <span class="VarId">s</span><span class="Symbol">@(</span><span class="ConId">CreateView</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">:</span> <span class="VarId">tl</span> <span class="Symbol">-&gt;</span> <span class="VarId">insertIt</span> <span class="VarId">s</span> <span class="VarId">tl</span> <span class="VarId">n</span> <span class="String">&quot;view&quot;</span>
               <span class="VarId">s</span><span class="Symbol">@(</span><span class="ConId">CreateType</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">:</span> <span class="VarId">tl</span> <span class="Symbol">-&gt;</span> <span class="VarId">insertIt</span> <span class="VarId">s</span> <span class="VarId">tl</span> <span class="VarId">n</span> <span class="String">&quot;type&quot;</span>
               <span class="VarId">s</span><span class="Symbol">@(</span><span class="ConId">CreateFunction</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">:</span> <span class="VarId">tl</span> <span class="Symbol">-&gt;</span> <span class="VarId">insertIt</span> <span class="VarId">s</span> <span class="VarId">tl</span> <span class="VarId">n</span> <span class="String">&quot;function&quot;</span>
               <span class="VarId">s</span><span class="Symbol">@(</span><span class="ConId">CreateTrigger</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">:</span> <span class="VarId">tl</span> <span class="Symbol">-&gt;</span> <span class="VarId">insertIt</span> <span class="VarId">s</span> <span class="VarId">tl</span> <span class="VarId">n</span> <span class="String">&quot;trigger&quot;</span>
               <span class="VarId">s</span><span class="Symbol">@(</span><span class="ConId">CreateDomain</span> <span class="VarId">_</span> <span class="VarId">n</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">)</span> <span class="Symbol">:</span> <span class="VarId">tl</span> <span class="Symbol">-&gt;</span> <span class="VarId">insertIt</span> <span class="VarId">s</span> <span class="VarId">tl</span> <span class="VarId">n</span> <span class="String">&quot;domain&quot;</span>
               <span class="VarId">x1</span> <span class="Symbol">-&gt;</span> <span class="VarId">return</span> <span class="VarId">x1</span><span class="Symbol">))</span>
    <span class="Keyword">where</span>
      <span class="VarId">insertIt</span> <span class="VarId">s</span> <span class="VarId">tl</span> <span class="VarId">nm</span> <span class="VarId">ty</span><span class="Symbol">=</span> <span class="Keyword">do</span>
         <span class="VarId">m</span> <span class="Symbol">&lt;-</span> <span class="VarId">get</span>
         <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">replaceSourcePos1</span> <span class="VarId">s</span> <span class="Symbol">([$</span><span class="VarId">sqlStmt</span><span class="Symbol">|</span>
                   <span class="VarId">insert</span> <span class="VarId">into</span> <span class="VarId">all_module_objects</span> <span class="Symbol">(</span><span class="VarId">object_name</span><span class="Symbol">,</span><span class="VarId">object_type</span><span class="Symbol">,</span><span class="VarId">module_name</span><span class="Symbol">)</span>
                   <span class="VarId">values</span> <span class="Symbol">($</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">nm</span><span class="Symbol">),$</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">ty</span><span class="Symbol">),</span> <span class="Symbol">$</span><span class="VarId">s</span><span class="Symbol">(</span><span class="VarId">m</span><span class="Symbol">));|])</span> <span class="Symbol">:</span> <span class="VarId">s</span> <span class="Symbol">:</span> <span class="VarId">tl</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
