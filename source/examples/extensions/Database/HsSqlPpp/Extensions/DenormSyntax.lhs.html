<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >DenormSyntax</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >File to parse the denormalized6nf syntax</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE QuasiQuotes, DeriveDataTypeable #-}</span>
<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Extensions.DenormSyntax</span>
    <span class="Symbol">(</span><span class="ConId">D6nfStatement</span><span class="Symbol">(..)</span>
    <span class="Symbol">,</span><span class="VarId">parseD6nf</span>
    <span class="Symbol">,</span><span class="VarId">denormParseTests</span>
    <span class="Symbol">)</span><span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Text.Parsec</span> <span class="Keyword">hiding</span><span class="Symbol">(</span><span class="VarId">many</span><span class="Symbol">,</span> <span class="VarId">optional</span><span class="Symbol">,</span> <span class="Symbol">(&lt;|&gt;),</span> <span class="VarId">string</span><span class="Symbol">)</span>
<span class="Comment">--import Text.Parsec.Expr</span>
<span class="Keyword">import</span> <span class="ConId">Text.Parsec.String</span>
<span class="Comment">--import Text.Parsec.Perm</span>
<span class="Keyword">import</span> <span class="ConId">Test.HUnit</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework.Providers.HUnit</span>
<span class="Keyword">import</span> <span class="ConId">Control.Applicative</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics</span>
<span class="Comment">--import Control.Monad.Identity</span>
<span class="Comment">--import Control.Monad.Error</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Ast</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.AstInternals.AstAnti</span> <span class="Symbol">(</span><span class="VarId">attributeDef</span><span class="Symbol">)</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parsing.ParserInternal</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parsing.Lexer</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Here</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Utils</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>

<span class="Keyword">data</span> <span class="ConId">D6nfStatement</span> <span class="Symbol">=</span> <span class="ConId">DTable</span> <span class="ConId">String</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Symbol">[</span><span class="ConId">AttributeDef</span><span class="Symbol">]</span>
                   <span class="Symbol">|</span> <span class="ConId">MutualExclusion</span> <span class="ConId">String</span> <span class="ConId">String</span>
                     <span class="Keyword">deriving</span> <span class="Symbol">(</span><span class="ConId">Eq</span><span class="Symbol">,</span><span class="ConId">Show</span><span class="Symbol">,</span><span class="ConId">Typeable</span><span class="Symbol">,</span><span class="ConId">Data</span><span class="Symbol">)</span>
</pre></div></div></div><div id="tests"
    ><h1
      >tests</h1
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">data</span> <span class="ConId">ParseTest</span> <span class="Symbol">=</span> <span class="ConId">ParseTest</span> <span class="ConId">String</span> <span class="Symbol">(</span><span class="ConId">Either</span> <span class="ConId">String</span> <span class="Symbol">[</span><span class="ConId">D6nfStatement</span><span class="Symbol">])</span>

<span class="Function">tests</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">ParseTest</span><span class="Symbol">]</span>
<span class="Function">tests</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="ConId">ParseTest</span> <span class="Symbol">[$</span><span class="VarId">here</span><span class="Symbol">|</span>
        <span class="VarId">pieces</span> <span class="Symbol">(</span>
          <span class="VarId">ptype</span> <span class="VarId">text</span> <span class="VarId">primary</span> <span class="VarId">key</span>
        <span class="Symbol">);</span>
        <span class="Symbol">|]</span> <span class="Symbol">$</span> <span class="ConId">Right</span> <span class="Symbol">[</span> <span class="ConId">DTable</span> <span class="String">&quot;pieces&quot;</span> <span class="Symbol">[]</span>
                       <span class="Symbol">[</span><span class="ConId">AttributeDef</span> <span class="VarId">ea</span>
                        <span class="String">&quot;ptype&quot;</span>
                        <span class="Symbol">(</span><span class="ConId">SimpleTypeName</span> <span class="VarId">ea</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)</span>
                        <span class="ConId">Nothing</span>
                        <span class="Symbol">[</span><span class="ConId">RowPrimaryKeyConstraint</span> <span class="VarId">ea</span> <span class="String">&quot;&quot;</span><span class="Symbol">]]]</span>
         <span class="Symbol">,</span><span class="ConId">ParseTest</span> <span class="Symbol">[$</span><span class="VarId">here</span><span class="Symbol">|</span>
        <span class="VarId">creatures</span> <span class="Symbol">:</span> <span class="VarId">pieces</span> <span class="Symbol">(</span>
          <span class="VarId">speed</span> <span class="VarId">int</span><span class="Symbol">,</span>
          <span class="VarId">agility</span> <span class="VarId">int</span>
        <span class="Symbol">);</span>
        <span class="Symbol">|]</span> <span class="Symbol">$</span> <span class="ConId">Right</span> <span class="Symbol">[</span> <span class="ConId">DTable</span> <span class="String">&quot;creatures&quot;</span> <span class="Symbol">[</span><span class="String">&quot;pieces&quot;</span><span class="Symbol">]</span>
                       <span class="Symbol">[</span><span class="ConId">AttributeDef</span> <span class="VarId">ea</span> <span class="String">&quot;speed&quot;</span>
                        <span class="Symbol">(</span><span class="ConId">SimpleTypeName</span> <span class="VarId">ea</span> <span class="String">&quot;int&quot;</span><span class="Symbol">)</span> <span class="ConId">Nothing</span> <span class="Symbol">[]</span>
                       <span class="Symbol">,</span><span class="ConId">AttributeDef</span> <span class="VarId">ea</span> <span class="String">&quot;agility&quot;</span>
                        <span class="Symbol">(</span><span class="ConId">SimpleTypeName</span> <span class="VarId">ea</span> <span class="String">&quot;int&quot;</span><span class="Symbol">)</span> <span class="ConId">Nothing</span> <span class="Symbol">[]]]</span>
         <span class="Symbol">,</span><span class="ConId">ParseTest</span> <span class="Symbol">[$</span><span class="VarId">here</span><span class="Symbol">|</span>
        <span class="VarId">mutually_exclusive</span><span class="Symbol">(</span><span class="VarId">attackers</span><span class="Symbol">,</span><span class="VarId">creatures</span><span class="Symbol">);</span>
        <span class="Symbol">|]</span> <span class="Symbol">$</span> <span class="ConId">Right</span> <span class="Symbol">[</span> <span class="ConId">MutualExclusion</span> <span class="String">&quot;attackers&quot;</span> <span class="String">&quot;creatures&quot;</span><span class="Symbol">]</span>

         <span class="Symbol">,</span><span class="ConId">ParseTest</span> <span class="Symbol">[$</span><span class="VarId">here</span><span class="Symbol">|</span>
        <span class="VarId">monsters</span> <span class="Symbol">:</span> <span class="VarId">creatures</span><span class="Symbol">,</span> <span class="VarId">attackers</span> <span class="Symbol">(</span>
          <span class="VarId">resistance</span> <span class="VarId">int</span><span class="Symbol">,</span>
          <span class="VarId">armour</span> <span class="VarId">int</span>
        <span class="Symbol">);</span>
        <span class="Symbol">|]</span> <span class="Symbol">$</span> <span class="ConId">Right</span> <span class="Symbol">[</span> <span class="ConId">DTable</span> <span class="String">&quot;monsters&quot;</span> <span class="Symbol">[</span><span class="String">&quot;creatures&quot;</span><span class="Symbol">,</span> <span class="String">&quot;attackers&quot;</span><span class="Symbol">]</span>
                       <span class="Symbol">[</span><span class="ConId">AttributeDef</span> <span class="VarId">ea</span> <span class="String">&quot;resistance&quot;</span>
                        <span class="Symbol">(</span><span class="ConId">SimpleTypeName</span> <span class="VarId">ea</span> <span class="String">&quot;int&quot;</span><span class="Symbol">)</span> <span class="ConId">Nothing</span> <span class="Symbol">[]</span>
                       <span class="Symbol">,</span><span class="ConId">AttributeDef</span> <span class="VarId">ea</span> <span class="String">&quot;armour&quot;</span>
                        <span class="Symbol">(</span><span class="ConId">SimpleTypeName</span> <span class="VarId">ea</span> <span class="String">&quot;int&quot;</span><span class="Symbol">)</span> <span class="ConId">Nothing</span> <span class="Symbol">[]]]</span>
         <span class="Symbol">,</span><span class="ConId">ParseTest</span> <span class="Symbol">[$</span><span class="VarId">here</span><span class="Symbol">|</span>
        <span class="VarId">attacking_creatures</span> <span class="Symbol">:</span> <span class="VarId">pieces</span><span class="Symbol">,</span><span class="VarId">attackers</span><span class="Symbol">;</span>
        <span class="Symbol">|]</span> <span class="Symbol">$</span> <span class="ConId">Right</span> <span class="Symbol">[</span> <span class="ConId">DTable</span> <span class="String">&quot;attacking_creatures&quot;</span> <span class="Symbol">[</span><span class="String">&quot;pieces&quot;</span><span class="Symbol">,</span><span class="String">&quot;attackers&quot;</span><span class="Symbol">]</span> <span class="Symbol">[]]</span>
        <span class="Symbol">]</span>

<span class="Function">denormParseTests</span> <span class="Symbol">::</span> <span class="ConId">Test.Framework.Test</span>
<span class="Function">denormParseTests</span> <span class="Symbol">=</span> <span class="VarId">testGroup</span> <span class="String">&quot;d6nf parsing&quot;</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">parseTestConv</span> <span class="VarId">tests</span>

<span class="Function">parseTestConv</span> <span class="Symbol">::</span> <span class="ConId">ParseTest</span> <span class="Symbol">-&gt;</span> <span class="ConId">Test.Framework.Test</span>
<span class="Function">parseTestConv</span> <span class="Symbol">(</span><span class="ConId">ParseTest</span> <span class="VarId">s</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="VarId">testCase</span> <span class="VarId">s</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
    <span class="Keyword">let</span> <span class="VarId">t1</span> <span class="Symbol">=</span> <span class="VarId">parseD6nf</span> <span class="String">&quot;&quot;</span> <span class="Number">1</span> <span class="Number">1</span> <span class="VarId">s</span>
    <span class="VarId">assertEqual</span> <span class="String">&quot;&quot;</span> <span class="VarId">t</span> <span class="Symbol">(</span><span class="VarId">resetAnnotations</span> <span class="VarId">t1</span><span class="Symbol">)</span></pre></div></div></div><hr
       /></div
    ><div id="parsing-code"
    ><h1
      >parsing code</h1
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">type</span> <span class="ConId">MyParser</span> <span class="Symbol">=</span> <span class="ConId">GenParser</span> <span class="ConId">Token</span> <span class="ConId">ParseState</span>

<span class="Keyword">type</span> <span class="ConId">ParseState</span> <span class="Symbol">=</span> <span class="Symbol">()</span>

<span class="Function">startState</span> <span class="Symbol">::</span> <span class="Symbol">()</span>
<span class="Function">startState</span> <span class="Symbol">=</span> <span class="Symbol">()</span>

<span class="Function">parseD6nf</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Int</span> <span class="Symbol">-&gt;</span> <span class="ConId">Int</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">String</span> <span class="Symbol">[</span><span class="ConId">D6nfStatement</span><span class="Symbol">]</span>
<span class="Function">parseD6nf</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
    <span class="VarId">toks</span> <span class="Symbol">&lt;-</span> <span class="VarId">tsl</span> <span class="Symbol">$</span> <span class="VarId">lexSqlTextWithPosition</span> <span class="VarId">f</span> <span class="VarId">l</span> <span class="VarId">c</span> <span class="VarId">s</span>
    <span class="VarId">tsl</span> <span class="Symbol">$</span> <span class="VarId">runParser</span> <span class="VarId">statements</span> <span class="VarId">startState</span> <span class="String">&quot;&quot;</span> <span class="VarId">toks</span>

<span class="Function">statements</span> <span class="Symbol">::</span> <span class="ConId">MyParser</span> <span class="Symbol">[</span><span class="ConId">D6nfStatement</span><span class="Symbol">]</span>
<span class="Function">statements</span> <span class="Symbol">=</span> <span class="VarId">many1</span> <span class="VarId">statement</span>

<span class="Function">statement</span> <span class="Symbol">::</span> <span class="ConId">MyParser</span> <span class="ConId">D6nfStatement</span>
<span class="Function">statement</span> <span class="Symbol">=</span> <span class="VarId">mutualExclusion</span> <span class="Symbol">&lt;|&gt;</span> <span class="VarId">dTable</span>

<span class="Function">dTable</span> <span class="Symbol">::</span> <span class="ConId">MyParser</span> <span class="ConId">D6nfStatement</span>
<span class="Function">dTable</span> <span class="Symbol">=</span> <span class="ConId">DTable</span>
         <span class="Symbol">&lt;$&gt;</span> <span class="VarId">idString</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;:&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">commaSep1</span> <span class="VarId">idString</span><span class="Symbol">)</span>
         <span class="Symbol">&lt;*&gt;</span> <span class="VarId">option</span> <span class="Symbol">[]</span>
                     <span class="Symbol">(</span><span class="VarId">parens</span> <span class="Symbol">(</span><span class="VarId">commaSep</span>
                             <span class="Symbol">(</span><span class="VarId">attributeDef</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">tableAttribute</span><span class="Symbol">)))</span>
             <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span>

<span class="Function">mutualExclusion</span> <span class="Symbol">::</span> <span class="ConId">MyParser</span> <span class="ConId">D6nfStatement</span>
<span class="Function">mutualExclusion</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">keyword</span> <span class="String">&quot;mutually_exclusive&quot;</span>
  <span class="VarId">parens</span> <span class="Symbol">(</span><span class="ConId">MutualExclusion</span>
          <span class="Symbol">&lt;$&gt;</span> <span class="VarId">idString</span>
          <span class="Symbol">&lt;*&gt;</span> <span class="Symbol">(</span><span class="VarId">symbol</span> <span class="String">&quot;,&quot;</span> <span class="Symbol">*&gt;</span> <span class="VarId">idString</span><span class="Symbol">))</span> <span class="Symbol">&lt;*</span> <span class="VarId">symbol</span> <span class="String">&quot;;&quot;</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">ea</span> <span class="Symbol">::</span> <span class="ConId">Annotation</span>
<span class="Function">ea</span> <span class="Symbol">=</span> <span class="VarId">emptyAnnotation</span></pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
