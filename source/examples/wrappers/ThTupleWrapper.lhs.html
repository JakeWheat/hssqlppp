<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >ThTupleWrapper</title
    ><link href="../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../index.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >Template Haskell code to return database queries as lists of tuples.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE TemplateHaskell #-}</span>

<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Examples.Wrappers.ThTupleWrapper</span>
    <span class="Symbol">(</span><span class="VarId">withConn</span>
    <span class="Symbol">,</span><span class="VarId">sqlQuery</span>
    <span class="Symbol">,</span><span class="ConId">IConnection</span><span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Language.Haskell.TH</span>
<span class="Keyword">import</span> <span class="ConId">Data.Maybe</span>
<span class="Keyword">import</span> <span class="ConId">Control.Applicative</span>
<span class="Keyword">import</span> <span class="ConId">Control.Monad.Error</span>
<span class="Keyword">import</span> <span class="ConId">Database.HDBC</span>
<span class="Keyword">import</span> <span class="ConId">System.IO.Unsafe</span>
<span class="Keyword">import</span> <span class="ConId">Data.IORef</span>
<span class="Comment">-- the select relation from the library returns strings, but</span>
<span class="Comment">-- we want the completely pointless wrapper which gives us sqlvalues,</span>
<span class="Comment">-- which we can cast better</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.DbmsCommon</span> <span class="Keyword">hiding</span> <span class="Symbol">(</span><span class="VarId">selectRelation</span><span class="Symbol">)</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Examples.Wrappers.SelectRelation</span>
<span class="Keyword">import</span> <span class="Keyword">qualified</span> <span class="ConId">Database.HsSqlPpp.SqlTypes</span> <span class="Keyword">as</span> <span class="ConId">Sql</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Catalog</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.TypeChecker</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parser</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Utils</span>

<span class="Function">sqlQuery</span><span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="ConId">Exp</span>
<span class="Function">sqlQuery</span> <span class="VarId">dbName</span> <span class="VarId">sqlStr</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="Symbol">(</span><span class="ConId">StatementHaskellType</span> <span class="VarId">inA</span> <span class="VarId">outA</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">liftStType</span>
  <span class="Keyword">let</span> <span class="VarId">cnName</span> <span class="Symbol">=</span> <span class="VarId">mkName</span> <span class="String">&quot;cn&quot;</span>
  <span class="VarId">argNames</span> <span class="Symbol">&lt;-</span> <span class="VarId">getNNewNames</span> <span class="String">&quot;a&quot;</span> <span class="Symbol">$</span> <span class="VarId">length</span> <span class="VarId">inA</span>
  <span class="VarId">lamE</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">varP</span> <span class="Symbol">(</span><span class="VarId">cnName</span> <span class="Symbol">:</span> <span class="VarId">argNames</span><span class="Symbol">))</span>
    <span class="Symbol">[|</span> <span class="VarId">selectRelation</span> <span class="Symbol">$(</span><span class="VarId">varE</span> <span class="VarId">cnName</span><span class="Symbol">)</span> <span class="VarId">sqlStr</span>
                      <span class="Symbol">$(</span><span class="ConId">ListE</span> <span class="Symbol">&lt;$&gt;</span> <span class="VarId">zipWithM</span> <span class="VarId">toSqlIt</span> <span class="VarId">argNames</span> <span class="VarId">inA</span><span class="Symbol">)</span> <span class="Symbol">&gt;&gt;=</span>
       <span class="VarId">return</span> <span class="Symbol">.</span> <span class="VarId">map</span> <span class="Symbol">$(</span><span class="VarId">mapTupleFromSql</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">snd</span> <span class="VarId">outA</span><span class="Symbol">)|]</span>

  <span class="Keyword">where</span>
    <span class="VarId">liftStType</span> <span class="Symbol">::</span> <span class="ConId">Q</span> <span class="ConId">StatementHaskellType</span>
    <span class="VarId">liftStType</span> <span class="Symbol">=</span> <span class="VarId">runIO</span> <span class="VarId">stType</span> <span class="Symbol">&gt;&gt;=</span> <span class="Symbol">(</span><span class="VarId">either</span> <span class="Symbol">(</span><span class="VarId">error</span> <span class="Symbol">.</span> <span class="VarId">show</span><span class="Symbol">)</span> <span class="VarId">toH</span><span class="Symbol">)</span>

    <span class="VarId">stType</span> <span class="Symbol">::</span> <span class="ConId">IO</span> <span class="Symbol">(</span><span class="ConId">Either</span> <span class="ConId">String</span> <span class="ConId">StatementType</span><span class="Symbol">)</span>
    <span class="VarId">stType</span> <span class="Symbol">=</span> <span class="VarId">runErrorT</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
      <span class="VarId">cat</span> <span class="Symbol">&lt;-</span> <span class="VarId">getCat</span>
      <span class="VarId">tsl</span> <span class="Symbol">(</span><span class="VarId">getStatementType</span> <span class="VarId">cat</span> <span class="VarId">sqlStr</span><span class="Symbol">)</span>

    <span class="VarId">getCat</span> <span class="Symbol">::</span> <span class="ConId">ErrorT</span> <span class="ConId">String</span> <span class="ConId">IO</span> <span class="ConId">Catalog</span>
    <span class="VarId">getCat</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="Comment">-- bad code to avoid reading the catalog multiple times</span>
      <span class="VarId">c1</span> <span class="Symbol">&lt;-</span> <span class="VarId">liftIO</span> <span class="Symbol">$</span> <span class="VarId">readIORef</span> <span class="VarId">globalCachedCatalog</span>
      <span class="Keyword">case</span> <span class="VarId">c1</span> <span class="Keyword">of</span>
        <span class="ConId">Just</span> <span class="VarId">c</span> <span class="Symbol">-&gt;</span> <span class="VarId">return</span> <span class="VarId">c</span>
        <span class="ConId">Nothing</span> <span class="Symbol">-&gt;</span> <span class="Keyword">do</span>
                   <span class="VarId">c</span> <span class="Symbol">&lt;-</span> <span class="VarId">liftIO</span> <span class="Symbol">(</span><span class="VarId">readCatalogFromDatabase</span> <span class="VarId">dbName</span><span class="Symbol">)</span> <span class="Symbol">&gt;&gt;=</span>
                          <span class="Symbol">(</span><span class="VarId">tsl</span> <span class="Symbol">.</span> <span class="VarId">updateCatalog</span> <span class="VarId">defaultCatalog</span><span class="Symbol">)</span>
                   <span class="VarId">liftIO</span> <span class="Symbol">$</span> <span class="VarId">writeIORef</span> <span class="VarId">globalCachedCatalog</span> <span class="Symbol">(</span><span class="ConId">Just</span> <span class="VarId">c</span><span class="Symbol">)</span>
                   <span class="VarId">return</span> <span class="VarId">c</span>

    <span class="Comment">-- lambda which does [SqlValue] -&gt; (T1, T2, ...)</span>
    <span class="VarId">mapTupleFromSql</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Type</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="ConId">Exp</span>
    <span class="VarId">mapTupleFromSql</span> <span class="VarId">outT</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="VarId">retNames</span> <span class="Symbol">&lt;-</span> <span class="VarId">getNNewNames</span> <span class="String">&quot;r&quot;</span> <span class="Symbol">$</span> <span class="VarId">length</span> <span class="VarId">outT</span>
      <span class="VarId">lamE</span> <span class="Symbol">[</span><span class="VarId">listP</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">varP</span> <span class="VarId">retNames</span><span class="Symbol">)]</span>
        <span class="Symbol">(</span><span class="VarId">tupE</span> <span class="Symbol">$</span> <span class="VarId">zipWith</span> <span class="VarId">fromSqlIt</span> <span class="VarId">retNames</span> <span class="VarId">outT</span><span class="Symbol">)</span>

    <span class="VarId">toSqlIt</span> <span class="Symbol">::</span> <span class="ConId">Name</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="ConId">Exp</span>
    <span class="VarId">toSqlIt</span> <span class="VarId">n</span> <span class="VarId">t</span> <span class="Symbol">=</span> <span class="Symbol">[|</span> <span class="VarId">toSql</span> <span class="Symbol">$(</span><span class="VarId">castName</span> <span class="VarId">n</span> <span class="VarId">t</span><span class="Symbol">)|]</span>

    <span class="VarId">fromSqlIt</span> <span class="Symbol">::</span> <span class="ConId">Name</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="ConId">Exp</span>
    <span class="VarId">fromSqlIt</span> <span class="VarId">n</span> <span class="VarId">t</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
      <span class="VarId">n1</span> <span class="Symbol">&lt;-</span> <span class="Symbol">[|</span> <span class="VarId">fromSql</span> <span class="Symbol">$(</span><span class="VarId">varE</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="Symbol">|]</span>
      <span class="VarId">cast</span> <span class="VarId">n1</span> <span class="VarId">t</span>

    <span class="VarId">cast</span> <span class="Symbol">::</span> <span class="ConId">Exp</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="ConId">Exp</span>
    <span class="VarId">cast</span> <span class="VarId">e</span> <span class="Symbol">=</span> <span class="VarId">return</span> <span class="Symbol">.</span> <span class="ConId">SigE</span> <span class="VarId">e</span>

    <span class="VarId">castName</span> <span class="Symbol">::</span> <span class="ConId">Name</span> <span class="Symbol">-&gt;</span> <span class="ConId">Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="ConId">Exp</span>
    <span class="VarId">castName</span> <span class="Symbol">=</span> <span class="VarId">cast</span> <span class="Symbol">.</span> <span class="ConId">VarE</span>

    <span class="VarId">getNNewNames</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Int</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="Symbol">[</span><span class="ConId">Name</span><span class="Symbol">]</span>
    <span class="VarId">getNNewNames</span> <span class="VarId">i</span> <span class="VarId">n</span> <span class="Symbol">=</span> <span class="VarId">forM</span> <span class="Symbol">[</span><span class="Number">1</span><span class="Symbol">..</span><span class="VarId">n</span><span class="Symbol">]</span> <span class="Symbol">$</span> <span class="VarId">const</span> <span class="Symbol">$</span> <span class="VarId">newName</span> <span class="VarId">i</span></pre></div></div></div><p
    >evil hack to avoid reading the catalog from the database for each call to sqlStmt. Atm this means that you can only read the catalog from one database at compile time, but this should be an easy fix if too limiting. TODO: make this change, in case the catalog ends up being cached in ghci meaning if you change the database whilst developing in emacs it will go wrong</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">globalCachedCatalog</span> <span class="Symbol">::</span> <span class="ConId">IORef</span> <span class="Symbol">(</span><span class="ConId">Maybe</span> <span class="ConId">Catalog</span><span class="Symbol">)</span>
<span class="Comment">{-# NOINLINE globalCachedCatalog #-}</span>
<span class="Function">globalCachedCatalog</span> <span class="Symbol">=</span> <span class="VarId">unsafePerformIO</span> <span class="Symbol">(</span><span class="VarId">newIORef</span> <span class="ConId">Nothing</span><span class="Symbol">)</span></pre></div></div></div><hr
     /><div id="sql-parsing-and-typechecking"
    ><h2
      >sql parsing and typechecking</h2
      ><p
      >This is the demonstration of using the type checker to get the information needed.</p
      ><p
      >Get the input and output types for a parameterized sql statement:</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">getStatementType</span> <span class="Symbol">::</span> <span class="ConId">Catalog</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="ConId">String</span> <span class="ConId">StatementType</span>
<span class="Function">getStatementType</span> <span class="VarId">cat</span> <span class="VarId">sql</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
    <span class="VarId">ast</span> <span class="Symbol">&lt;-</span> <span class="VarId">tsl</span> <span class="Symbol">$</span> <span class="VarId">parseSql</span> <span class="String">&quot;&quot;</span> <span class="VarId">sql</span>
    <span class="Keyword">let</span> <span class="Symbol">(</span><span class="VarId">_</span><span class="Symbol">,</span><span class="VarId">aast</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">typeCheck</span> <span class="VarId">cat</span> <span class="VarId">ast</span>
    <span class="Keyword">let</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="VarId">getTopLevelInfos</span> <span class="VarId">aast</span>
    <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">fromJust</span> <span class="Symbol">$</span> <span class="VarId">head</span> <span class="VarId">a</span></pre></div></div></div><p
      >convert sql statement type to equivalent with sql types replaced with haskell equivalents - HDBC knows how to convert the actual values using toSql and fromSql as long as we add in the appropriate casts</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">data</span> <span class="ConId">StatementHaskellType</span> <span class="Symbol">=</span> <span class="ConId">StatementHaskellType</span> <span class="Symbol">[</span><span class="ConId">Type</span><span class="Symbol">]</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span><span class="ConId">Type</span><span class="Symbol">)]</span>

<span class="Function">toH</span> <span class="Symbol">::</span> <span class="ConId">StatementType</span> <span class="Symbol">-&gt;</span> <span class="ConId">Q</span> <span class="ConId">StatementHaskellType</span>
<span class="Function">toH</span> <span class="Symbol">(</span><span class="ConId">StatementType</span> <span class="VarId">i</span> <span class="VarId">o</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">ih</span> <span class="Symbol">&lt;-</span> <span class="VarId">mapM</span> <span class="VarId">sqlTypeToHaskell</span> <span class="VarId">i</span>
  <span class="VarId">oht</span> <span class="Symbol">&lt;-</span> <span class="VarId">mapM</span> <span class="Symbol">(</span><span class="VarId">sqlTypeToHaskell</span> <span class="Symbol">.</span> <span class="VarId">snd</span><span class="Symbol">)</span> <span class="VarId">o</span>
  <span class="VarId">return</span> <span class="Symbol">$</span> <span class="ConId">StatementHaskellType</span> <span class="VarId">ih</span> <span class="Symbol">$</span> <span class="VarId">zip</span> <span class="Symbol">(</span><span class="VarId">map</span> <span class="VarId">fst</span> <span class="VarId">o</span><span class="Symbol">)</span> <span class="VarId">oht</span>
  <span class="Keyword">where</span>
    <span class="VarId">sqlTypeToHaskell</span> <span class="Symbol">::</span> <span class="ConId">Sql.Type</span> <span class="Symbol">-&gt;</span> <span class="ConId">TypeQ</span>
    <span class="VarId">sqlTypeToHaskell</span> <span class="VarId">t</span> <span class="Symbol">=</span>
      <span class="Keyword">case</span> <span class="VarId">t</span> <span class="Keyword">of</span>
        <span class="ConId">Sql.ScalarType</span> <span class="String">&quot;text&quot;</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">t</span><span class="Symbol">|</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">|]</span>
        <span class="ConId">Sql.ScalarType</span> <span class="String">&quot;int4&quot;</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">t</span><span class="Symbol">|</span> <span class="ConId">Maybe</span> <span class="ConId">Int</span> <span class="Symbol">|]</span>
        <span class="ConId">Sql.ScalarType</span> <span class="String">&quot;int8&quot;</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">t</span><span class="Symbol">|</span> <span class="ConId">Maybe</span> <span class="ConId">Int</span> <span class="Symbol">|]</span>
        <span class="ConId">Sql.ScalarType</span> <span class="String">&quot;bool&quot;</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">t</span><span class="Symbol">|</span> <span class="ConId">Maybe</span> <span class="ConId">Bool</span> <span class="Symbol">|]</span>
        <span class="ConId">Sql.DomainType</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="VarId">t</span><span class="Symbol">|</span> <span class="ConId">Maybe</span> <span class="ConId">String</span> <span class="Symbol">|]</span>
        <span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">x</span></pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/31/11 20:00:52, hssqlppp-0.3.0</div
    ></body
  ></html
>
