<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >ParameterizedStatementTests</title
    ><link href="../../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >Tests for the infrastructure to create type safe access to databases - the information needed is gathered during typechecking and exposed in the StatementType annotation, so these are really just a subset of the type checking tests.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Tests.ParameterizedStatementTests</span> <span class="Symbol">(</span><span class="VarId">parameterizedStatementTests</span><span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Test.HUnit</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework.Providers.HUnit</span>
<span class="Comment">--import Debug.Trace</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics.Uniplate.Data</span>


<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.SqlTypes</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parser</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.TypeChecker</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Catalog</span>

<span class="Keyword">data</span> <span class="ConId">Item</span> <span class="Symbol">=</span> <span class="ConId">Group</span> <span class="ConId">String</span> <span class="Symbol">[</span><span class="ConId">Item</span><span class="Symbol">]</span>
          <span class="Symbol">|</span> <span class="ConId">Statements</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,</span> <span class="Symbol">[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">],</span> <span class="ConId">Maybe</span> <span class="ConId">StatementType</span><span class="Symbol">)]</span>

<span class="Function">parameterizedStatementTests</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Test.Framework.Test</span><span class="Symbol">]</span>
<span class="Function">parameterizedStatementTests</span> <span class="Symbol">=</span> <span class="VarId">itemToTft</span> <span class="VarId">testData</span>

<span class="Function">testData</span> <span class="Symbol">::</span> <span class="ConId">Item</span>
<span class="Function">testData</span> <span class="Symbol">=</span>
  <span class="ConId">Group</span> <span class="String">&quot;parameterized statement tests&quot;</span> <span class="Symbol">[</span>
    <span class="ConId">Group</span> <span class="String">&quot;simple selects&quot;</span> <span class="Symbol">[</span> <span class="ConId">Statements</span> <span class="Symbol">[</span>
       <span class="Symbol">(</span><span class="String">&quot;select test();&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateFunction</span> <span class="ConId">FunName</span> <span class="String">&quot;test&quot;</span> <span class="Symbol">[]</span> <span class="Symbol">(</span><span class="ConId">Pseudo</span> <span class="ConId">Void</span><span class="Symbol">)</span> <span class="ConId">False</span><span class="Symbol">]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([],[]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;select adnum,adbin from pg_attrdef;&quot;</span>
       <span class="Symbol">,[]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([],[(</span><span class="String">&quot;adnum&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;int2&quot;</span><span class="Symbol">)</span>
            <span class="Symbol">,(</span><span class="String">&quot;adbin&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;select adnum,adbin from pg_attrdef where oid= ?;&quot;</span>
       <span class="Symbol">,[]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([</span><span class="ConId">ScalarType</span> <span class="String">&quot;oid&quot;</span><span class="Symbol">],[(</span><span class="String">&quot;adnum&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;int2&quot;</span><span class="Symbol">)</span>
                            <span class="Symbol">,(</span><span class="String">&quot;adbin&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;select count(1) from pg_attrdef;&quot;</span>
       <span class="Symbol">,[]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([],[(</span><span class="String">&quot;count&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;int8&quot;</span><span class="Symbol">)]))</span>
       <span class="Comment">{-,(&quot;select test($1);&quot;</span>
<span class="Comment">       ,[CatCreateFunction FunName &quot;test&quot; [ScalarType &quot;int4&quot;] (ScalarType &quot;text&quot;) False]</span>
<span class="Comment">       ,StatementType [ScalarType &quot;int4&quot;] [(&quot;test&quot;,ScalarType &quot;text&quot;)])</span>
<span class="Comment">      ,-}</span>
      <span class="Symbol">,(</span><span class="String">&quot;select test(?);&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateFunction</span> <span class="ConId">FunName</span> <span class="String">&quot;test&quot;</span> <span class="Symbol">[</span><span class="ConId">ScalarType</span> <span class="String">&quot;int4&quot;</span><span class="Symbol">]</span> <span class="Symbol">(</span><span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)</span> <span class="ConId">False</span><span class="Symbol">]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([</span><span class="ConId">ScalarType</span> <span class="String">&quot;int4&quot;</span><span class="Symbol">],[(</span><span class="String">&quot;test&quot;</span><span class="Symbol">,</span><span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]))</span>
       <span class="Symbol">]</span>
    <span class="Symbol">]</span>
   <span class="Symbol">,</span><span class="ConId">Group</span> <span class="String">&quot;simple dml&quot;</span> <span class="Symbol">[</span> <span class="ConId">Statements</span> <span class="Symbol">[</span>
       <span class="Symbol">(</span><span class="String">&quot;insert into testt values (1, 'test');&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateTable</span> <span class="String">&quot;testt&quot;</span> <span class="Symbol">[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]</span> <span class="Symbol">[]]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([],[]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;insert into testt (c1,c2) values (?, ?);&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateTable</span> <span class="String">&quot;testt&quot;</span> <span class="Symbol">[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]</span> <span class="Symbol">[]]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([</span><span class="VarId">typeInt</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">],[]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;insert into testt (c1,c2) values (1, 'test') returning c1;&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateTable</span> <span class="String">&quot;testt&quot;</span> <span class="Symbol">[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]</span> <span class="Symbol">[]]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([],[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span><span class="VarId">typeInt</span><span class="Symbol">)]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;insert into testt (c1,c2) values (?, ?) returning c1 as d1, c2;&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateTable</span> <span class="String">&quot;testt&quot;</span> <span class="Symbol">[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]</span> <span class="Symbol">[]]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([</span><span class="VarId">typeInt</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">],[(</span><span class="String">&quot;d1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                      <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]))</span>
      <span class="Comment">{-,(&quot;insert into testt (c1,c2) values (?, ?) returning *;&quot;</span>
<span class="Comment">       ,[CatCreateTable &quot;testt&quot; [(&quot;c1&quot;, typeInt)</span>
<span class="Comment">                                ,(&quot;c2&quot;, ScalarType &quot;text&quot;)] []]</span>
<span class="Comment">       ,StatementType [typeInt, ScalarType &quot;text&quot;] [(&quot;c1&quot;, typeInt)</span>
<span class="Comment">                                                   ,(&quot;c2&quot;, ScalarType &quot;text&quot;)])-}</span>
      <span class="Symbol">,(</span><span class="String">&quot;update testt set c1= ?,c2= ? where c1= ? returning c2;&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateTable</span> <span class="String">&quot;testt&quot;</span> <span class="Symbol">[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]</span> <span class="Symbol">[]]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([</span><span class="VarId">typeInt</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">],[(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;update testt set (c1,c2) = (?,?);&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateTable</span> <span class="String">&quot;testt&quot;</span> <span class="Symbol">[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]</span> <span class="Symbol">[]]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([</span><span class="VarId">typeInt</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">],[]))</span>
      <span class="Symbol">,(</span><span class="String">&quot;delete from blah where c1= ? returning c2;&quot;</span>
       <span class="Symbol">,[</span><span class="ConId">CatCreateTable</span> <span class="String">&quot;blah&quot;</span> <span class="Symbol">[(</span><span class="String">&quot;c1&quot;</span><span class="Symbol">,</span> <span class="VarId">typeInt</span><span class="Symbol">)</span>
                                <span class="Symbol">,(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]</span> <span class="Symbol">[]]</span>
       <span class="Symbol">,</span><span class="ConId">Just</span> <span class="Symbol">([</span><span class="VarId">typeInt</span><span class="Symbol">],[(</span><span class="String">&quot;c2&quot;</span><span class="Symbol">,</span> <span class="ConId">ScalarType</span> <span class="String">&quot;text&quot;</span><span class="Symbol">)]))</span>
      <span class="Symbol">]</span>
    <span class="Symbol">]</span>
   <span class="Symbol">]</span></pre></div></div></div><pre
    ><code
      ><br
	 />select a,b from c where d=e group by f having  g=h orderby i limit j offset k;
select function(a,b);
insert into a (b,c) values (d,e) returning f,g
update a set b=c,d=e where f=g returning h,i
delete from t where a=b returning c,d

rough list of grammar elements to possibly add inference support to:

where top level - &gt;maybeboolexpr
having
limit, offset
values for table literal or insert
set clause
rowsetclause
onexpr, joinon?
windowfn
liftoperator
selectitem?
castexpression
caseexpression
funcall
inpredicate

  TODO: add support in each of these places for position args only when
        doing typecheckPS
        do typecheck error if come across ? when not doing typecheckPS
        make sure ? fails type check if not in a valid place in the ast
</code
      ></pre
    ><hr
     /><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">testStatementType</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">CatalogUpdate</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">StatementType</span> <span class="Symbol">-&gt;</span> <span class="ConId">Test.Framework.Test</span>
<span class="Function">testStatementType</span> <span class="VarId">src</span> <span class="VarId">eu</span> <span class="VarId">st</span> <span class="Symbol">=</span> <span class="VarId">testCase</span> <span class="Symbol">(</span><span class="String">&quot;typecheck &quot;</span> <span class="Symbol">++</span> <span class="VarId">src</span><span class="Symbol">)</span> <span class="Symbol">$</span>
  <span class="Keyword">let</span> <span class="VarId">ast</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">parseSql</span> <span class="String">&quot;&quot;</span> <span class="VarId">src</span> <span class="Keyword">of</span>
                              <span class="ConId">Left</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">e</span>
                              <span class="ConId">Right</span> <span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="VarId">l</span>
  <span class="Keyword">in</span> <span class="Keyword">case</span> <span class="VarId">typeCheckPS</span> <span class="VarId">makeCat</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">ast</span><span class="Symbol">)</span> <span class="Keyword">of</span>
       <span class="ConId">Left</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">e</span>
       <span class="ConId">Right</span> <span class="VarId">aast</span> <span class="Symbol">-&gt;</span> <span class="Comment">--trace (ppShow aast) $</span>
                     <span class="Keyword">let</span> <span class="VarId">is</span> <span class="Symbol">=</span> <span class="VarId">getTopLevelInfo</span> <span class="VarId">aast</span>
                         <span class="VarId">er</span> <span class="Symbol">=</span> <span class="VarId">getTypeErrors</span> <span class="VarId">aast</span>
                     <span class="Keyword">in</span> <span class="Keyword">case</span> <span class="VarId">is</span> <span class="Keyword">of</span>
                                <span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">not</span> <span class="Symbol">(</span><span class="VarId">null</span> <span class="VarId">er</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">assertFailure</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">er</span>
                                <span class="VarId">is1</span> <span class="Symbol">-&gt;</span> <span class="VarId">assertEqual</span> <span class="Symbol">(</span><span class="String">&quot;typecheck &quot;</span> <span class="Symbol">++</span> <span class="VarId">src</span><span class="Symbol">)</span> <span class="VarId">st</span> <span class="VarId">is1</span>
                                <span class="Comment">-- _ -&gt; assertFailure (&quot;expected onne statementinfo, got &quot; ++ show is)</span>
  <span class="Keyword">where</span>
    <span class="VarId">getTypeErrors</span> <span class="Symbol">::</span> <span class="ConId">Data</span> <span class="VarId">a</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span>
    <span class="VarId">getTypeErrors</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="VarId">t</span> <span class="Symbol">|</span> <span class="VarId">t</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">a</span><span class="Symbol">]</span>
    <span class="VarId">getTopLevelInfo</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="VarId">stType</span> <span class="Symbol">$</span> <span class="VarId">getAnnotation</span> <span class="VarId">a</span>
    <span class="VarId">makeCat</span> <span class="Symbol">=</span> <span class="Keyword">case</span> <span class="VarId">updateCatalog</span> <span class="VarId">defaultTemplate1Catalog</span> <span class="VarId">eu</span> <span class="Keyword">of</span>
                        <span class="ConId">Left</span> <span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">x</span>
                        <span class="ConId">Right</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">e</span>

<span class="Function">itemToTft</span> <span class="Symbol">::</span> <span class="ConId">Item</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Test.Framework.Test</span><span class="Symbol">]</span>
<span class="Function">itemToTft</span> <span class="Symbol">(</span><span class="ConId">Statements</span> <span class="VarId">es</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="Symbol">(\(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">testStatementType</span> <span class="VarId">a</span> <span class="VarId">b</span> <span class="VarId">c</span><span class="Symbol">)</span> <span class="VarId">es</span>
<span class="Function">itemToTft</span> <span class="Symbol">(</span><span class="ConId">Group</span> <span class="VarId">s</span> <span class="VarId">is</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="VarId">testGroup</span> <span class="VarId">s</span> <span class="Symbol">$</span> <span class="VarId">concatMap</span> <span class="VarId">itemToTft</span> <span class="VarId">is</span><span class="Symbol">]</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
