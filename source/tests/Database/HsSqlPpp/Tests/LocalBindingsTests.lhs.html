<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >LocalBindingsTests</title
    ><link href="../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >Local bindings tests: test updating the local bindings</p
    ><p
    >This code contains most of the join lookup code.</p
    ><p
    >New plan:</p
    ><p
    >Write tests against the local bindings module for the full variety of behaviour</p
    ><p
    >local bindings are updated by * tref (or table reference in an update/insert/delete) * parameter in function * declaration in function block * implicit integer loop var in for loop * set explicit record type in for loop/ assignment to record type * for constraints in create table, create domain * funcall &quot;.&quot;</p
    ><p
    >Write tests to quickly check each bit of code which uses these using the full typechecking: update: sets, where, returning select: tref -&gt; select list, where, group by, order by join: out to tref, into on expression implicit variable in for loop record type in for loop record type in assignment record type in select into delete where and returning block declarations constraints in create table, create domain parameters in function body statementlist: pass on record updates? insert: columns?, returning</p
    ><hr
     /><p
    >Tests for the local bindings lookup code, which is a bit convoluted in places, particularly for joins.</p
    ><p
    >The tests are also quite convoluted, but the main simplification to try to make them understandable is that we load a bunch of localbindingupdates, then we just check the entire lookup values that tell us what each identifier or star expansion returns, rather than looking individual items up and checking the results.</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE ScopedTypeVariables #-}</span>

<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Tests.LocalBindingsTests</span> <span class="Symbol">(</span><span class="VarId">localBindingsTests</span><span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Test.HUnit</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework.Providers.HUnit</span>
<span class="Comment">--import Debug.Trace</span>
<span class="Keyword">import</span> <span class="ConId">Control.Monad</span>
<span class="Keyword">import</span> <span class="ConId">Control.Monad.Error</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.AstInternals.TypeChecking.LocalBindingsInternal</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.SqlTypes</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Catalog</span>

<span class="Keyword">data</span> <span class="ConId">Item</span> <span class="Symbol">=</span> <span class="ConId">Group</span> <span class="ConId">String</span> <span class="Symbol">[</span><span class="ConId">Item</span><span class="Symbol">]</span>
          <span class="Symbol">|</span> <span class="ConId">Item</span> <span class="Symbol">[(</span><span class="ConId">String</span>
                  <span class="Symbol">,[</span><span class="ConId">LocalBindingsUpdate</span><span class="Symbol">]</span>
                  <span class="Symbol">,</span><span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">[</span><span class="ConId">LocalBindingsLookup</span><span class="Symbol">])]</span>

<span class="Function">localBindingsTests</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Test.Framework.Test</span><span class="Symbol">]</span>
<span class="Function">localBindingsTests</span> <span class="Symbol">=</span> <span class="VarId">itemToTft</span> <span class="VarId">testData</span>

<span class="Function">testData</span> <span class="Symbol">::</span> <span class="ConId">Item</span>
<span class="Function">testData</span> <span class="Symbol">=</span> <span class="ConId">Group</span> <span class="String">&quot;local bindings tests&quot;</span> <span class="Symbol">[</span> <span class="Comment">{-Item [</span>
<span class="Comment">  (&quot;test empty&quot;, [LBIds &quot;source1&quot; Nothing []]</span>
<span class="Comment">  ,Right [LocalBindingsLookup [] []])</span>
<span class="Comment"> ,(&quot;test lbids no cor&quot;, [LBIds &quot;source1&quot; Nothing [(&quot;a&quot;, typeInt)</span>
<span class="Comment">                                                 ,(&quot;b&quot;, typeBool)]]</span>
<span class="Comment">  ,Right [LocalBindingsLookup [</span>
<span class="Comment">           ((&quot;a&quot;), Right (&quot;source1&quot;, [&quot;a&quot;], typeInt))</span>
<span class="Comment">          ,((&quot;b&quot;), Right (&quot;source1&quot;, [&quot;b&quot;], typeBool))</span>
<span class="Comment">          ]</span>
<span class="Comment">          []])</span>
<span class="Comment"> ,(&quot;test lbids cor&quot;, [LBIds &quot;source1&quot; (Just &quot;c&quot;) [(&quot;a&quot;, typeInt)</span>
<span class="Comment">                                                 ,(&quot;b&quot;, typeBool)]]</span>
<span class="Comment">  ,Right [LocalBindingsLookup [</span>
<span class="Comment">           ((&quot;c&quot;), Right (&quot;source1&quot;, [&quot;c&quot;], CompositeType [(&quot;a&quot;, typeInt)</span>
<span class="Comment">                                                          ,(&quot;b&quot;, typeBool)]))</span>
<span class="Comment">          ,((&quot;a&quot;), Right (&quot;source1&quot;, [&quot;c&quot;,&quot;a&quot;], typeInt))</span>
<span class="Comment">          ,((&quot;b&quot;), Right (&quot;source1&quot;, [&quot;c&quot;,&quot;b&quot;], typeBool))]</span>
<span class="Comment">          []])</span>
<span class="Comment"> ,(&quot;test tref&quot;, [LBTref &quot;source2&quot; &quot;t1&quot;</span>
<span class="Comment">                        [(&quot;a&quot;, typeInt)</span>
<span class="Comment">                        ,(&quot;b&quot;, typeBool)]</span>
<span class="Comment">                        [(&quot;c&quot;, ScalarType &quot;text&quot;)</span>
<span class="Comment">                        ,(&quot;d&quot;, typeSmallInt)]</span>
<span class="Comment">                 ]</span>
<span class="Comment">  ,Right [LocalBindingsLookup [</span>
<span class="Comment">           ((&quot;t1&quot;), Right (&quot;source2&quot;, [&quot;t1&quot;], CompositeType [(&quot;a&quot;, typeInt)</span>
<span class="Comment">                                                            ,(&quot;b&quot;, typeBool)]))</span>
<span class="Comment">          ,((&quot;a&quot;), Right (&quot;source2&quot;, [&quot;t1&quot;,&quot;a&quot;], typeInt))</span>
<span class="Comment">          ,((&quot;b&quot;), Right (&quot;source2&quot;, [&quot;t1&quot;,&quot;b&quot;], typeBool))</span>
<span class="Comment">          ,((&quot;c&quot;), Right (&quot;source2&quot;, [&quot;t1&quot;,&quot;c&quot;], ScalarType &quot;text&quot;))</span>
<span class="Comment">          ,((&quot;d&quot;), Right (&quot;source2&quot;, [&quot;t1&quot;,&quot;d&quot;], typeSmallInt))]</span>
<span class="Comment">          (Right [(&quot;source2&quot;, [&quot;t1&quot;,&quot;a&quot;], typeInt)</span>
<span class="Comment">                 ,(&quot;source2&quot;, [&quot;t1&quot;,&quot;b&quot;], typeBool)])])</span></pre></div></div></div><p
    >TODO: test lbjointrefs cross join natural join using join - public and system attrs, ambiguous lookups join columns incompatible: natural and using variants three way join test</p
    ><p
    >sys columns are accessible qualified only in joins</p
    ><p
    >put . lookup logic into localbindings and test: id not found lbids using correlation name lbids using record type tref using correlation name jointref using t1 name, t2 name, alias</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"> <span class="Comment">{-,(&quot;test ids cor&quot;, [LBIds &quot;source1&quot; &quot;c&quot; [(&quot;a&quot;, typeInt)</span>
<span class="Comment">                                          ,(&quot;b&quot;, typeBool)]</span>
<span class="Comment">                                          [(&quot;ia&quot;, typeInt)</span>
<span class="Comment">                                          ,(&quot;ib&quot;, typeBool)]]</span>
<span class="Comment">  ,Right [LocalBindingsLookup [</span>
<span class="Comment">           ((&quot;&quot;, &quot;a&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;&quot;, &quot;b&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">          ,((&quot;&quot;, &quot;ia&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;ia&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;&quot;, &quot;ib&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;ib&quot;, typeBool))</span>
<span class="Comment">          ,((&quot;c&quot;, &quot;a&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c&quot;, &quot;b&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">          ,((&quot;c&quot;, &quot;ia&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;ia&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c&quot;, &quot;ib&quot;), Right (&quot;source1&quot;, &quot;c&quot;, &quot;ib&quot;, typeBool))</span>
<span class="Comment">          ]</span>
<span class="Comment">          [(&quot;&quot;, Right [</span>
<span class="Comment">                   (&quot;source1&quot;, &quot;c&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                  ,(&quot;source1&quot;, &quot;c&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">          ,(&quot;c&quot;, Right [</span>
<span class="Comment">                   (&quot;source1&quot;, &quot;c&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                  ,(&quot;source1&quot;, &quot;c&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">           ]])</span>

<span class="Comment"> ,(&quot;test parallel&quot;, [LBParallel</span>
<span class="Comment">    (LBIds &quot;source1&quot; &quot;c1&quot; [(&quot;a&quot;, typeInt)</span>
<span class="Comment">                        ,(&quot;b&quot;, typeBool)]</span>
<span class="Comment">                        [(&quot;ia&quot;, typeInt)</span>
<span class="Comment">                        ,(&quot;ib&quot;, typeBool)])</span>
<span class="Comment">    (LBIds &quot;source2&quot; &quot;c2&quot; [(&quot;a1&quot;, typeInt)</span>
<span class="Comment">                        ,(&quot;b&quot;, typeBool)]</span>
<span class="Comment">                        [(&quot;ia1&quot;, typeInt)</span>
<span class="Comment">                        ,(&quot;ib&quot;, typeBool)])]</span>
<span class="Comment">  ,Right [LocalBindingsLookup [</span>
<span class="Comment">           ((&quot;&quot;, &quot;a&quot;), Right (&quot;source1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;&quot;, &quot;ia&quot;), Right (&quot;source1&quot;, &quot;c1&quot;, &quot;ia&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c1&quot;, &quot;a&quot;), Right (&quot;source1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c1&quot;, &quot;b&quot;), Right (&quot;source1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">          ,((&quot;c1&quot;, &quot;ia&quot;), Right (&quot;source1&quot;, &quot;c1&quot;, &quot;ia&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c1&quot;, &quot;ib&quot;), Right (&quot;source1&quot;, &quot;c1&quot;, &quot;ib&quot;, typeBool))</span>
<span class="Comment">          ,((&quot;&quot;, &quot;a1&quot;), Right (&quot;source2&quot;, &quot;c2&quot;, &quot;a1&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;&quot;, &quot;ia1&quot;), Right (&quot;source2&quot;, &quot;c2&quot;, &quot;ia1&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c2&quot;, &quot;a1&quot;), Right (&quot;source2&quot;, &quot;c2&quot;, &quot;a1&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c2&quot;, &quot;b&quot;), Right (&quot;source2&quot;, &quot;c2&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">          ,((&quot;c2&quot;, &quot;ia1&quot;), Right (&quot;source2&quot;, &quot;c2&quot;, &quot;ia1&quot;, typeInt))</span>
<span class="Comment">          ,((&quot;c2&quot;, &quot;ib&quot;), Right (&quot;source2&quot;, &quot;c2&quot;, &quot;ib&quot;, typeBool))</span>
<span class="Comment">          ,((&quot;&quot;, &quot;b&quot;), Left [AmbiguousIdentifier &quot;b&quot;])</span>
<span class="Comment">          ,((&quot;&quot;, &quot;ib&quot;), Left [AmbiguousIdentifier &quot;ib&quot;])</span>
<span class="Comment">          ]</span>
<span class="Comment">          [(&quot;&quot;, Right [(&quot;source1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                      ,(&quot;source1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)</span>
<span class="Comment">                      ,(&quot;source2&quot;, &quot;c2&quot;, &quot;a1&quot;, typeInt)</span>
<span class="Comment">                      ,(&quot;source2&quot;, &quot;c2&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">          ,(&quot;c1&quot;, Right [(&quot;source1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                        ,(&quot;source1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">          ,(&quot;c2&quot;, Right [(&quot;source2&quot;, &quot;c2&quot;, &quot;a1&quot;, typeInt)</span>
<span class="Comment">                        ,(&quot;source2&quot;, &quot;c2&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">                  ]])</span>
<span class="Comment"> ,(&quot;test join 1&quot;, [LBJoinIds</span>
<span class="Comment">                   (LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;a&quot;, typeInt)] [(&quot;b&quot;, typeBool)])</span>
<span class="Comment">                   (LBIds &quot;s2&quot; &quot;c2&quot; [(&quot;c&quot;, typeInt)] [(&quot;d&quot;, typeBool)])</span>
<span class="Comment">                   (Right []) &quot;&quot;]</span>
<span class="Comment">  ,Right [LocalBindingsLookup</span>
<span class="Comment">           [((&quot;&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;d&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;d&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;d&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;d&quot;, typeBool))]</span>
<span class="Comment">           [(&quot;&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                       ,(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeInt)])</span>
<span class="Comment">           ,(&quot;c1&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)])</span>
<span class="Comment">           ,(&quot;c2&quot;, Right [(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeInt)])</span>
<span class="Comment">           ]])</span>

<span class="Comment"> ,(&quot;test natural join&quot;, [LBJoinIds</span>
<span class="Comment">                   (LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;a&quot;, typeInt), (&quot;b&quot;, typeBool)] [])</span>
<span class="Comment">                   (LBIds &quot;s2&quot; &quot;c2&quot; [(&quot;a&quot;, typeInt), (&quot;c&quot;, typeBool)] [])</span>
<span class="Comment">                   (Left ()) &quot;&quot;]</span>
<span class="Comment">  ,Right [LocalBindingsLookup</span>
<span class="Comment">           [((&quot;&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;a&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool))]</span>
<span class="Comment">           [(&quot;&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                       ,(&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)</span>
<span class="Comment">                       ,(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ,(&quot;c1&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                         ,(&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">           ,(&quot;c2&quot;, Right [(&quot;s2&quot;, &quot;c2&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                         ,(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ]])</span>

<span class="Comment"> ,(&quot;test natural join&quot;, [LBJoinIds</span>
<span class="Comment">                   (LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;b&quot;, typeBool),(&quot;a&quot;, typeInt)] [])</span>
<span class="Comment">                   (LBIds &quot;s2&quot; &quot;c2&quot; [(&quot;c&quot;, typeBool),(&quot;a&quot;, typeInt)] [])</span>
<span class="Comment">                   (Left ()) &quot;&quot;]</span>
<span class="Comment">  ,Right [LocalBindingsLookup</span>
<span class="Comment">           [((&quot;&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;a&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool))]</span>
<span class="Comment">           [(&quot;&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                       ,(&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)</span>
<span class="Comment">                       ,(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ,(&quot;c1&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                         ,(&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">           ,(&quot;c2&quot;, Right [(&quot;s2&quot;, &quot;c2&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                         ,(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ]])</span>

<span class="Comment"> ,(&quot;test using join&quot;, [LBJoinIds</span>
<span class="Comment">                   (LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;b&quot;, typeBool),(&quot;a&quot;, typeInt)] [])</span>
<span class="Comment">                   (LBIds &quot;s2&quot; &quot;c2&quot; [(&quot;c&quot;, typeBool),(&quot;a&quot;, typeInt)] [])</span>
<span class="Comment">                   (Right [&quot;a&quot;]) &quot;&quot;]</span>
<span class="Comment">  ,Right [LocalBindingsLookup</span>
<span class="Comment">           [((&quot;&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;a&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c1&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;c2&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool))]</span>
<span class="Comment">           [(&quot;&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                       ,(&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)</span>
<span class="Comment">                       ,(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ,(&quot;c1&quot;, Right [(&quot;s1&quot;, &quot;c1&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                         ,(&quot;s1&quot;, &quot;c1&quot;, &quot;b&quot;, typeBool)])</span>
<span class="Comment">           ,(&quot;c2&quot;, Right [(&quot;s2&quot;, &quot;c2&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                         ,(&quot;s2&quot;, &quot;c2&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ]])</span>

<span class="Comment"> ,(&quot;test join with alias&quot;, [LBJoinIds</span>
<span class="Comment">                   (LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;b&quot;, typeBool),(&quot;a&quot;, typeInt)] [])</span>
<span class="Comment">                   (LBIds &quot;s2&quot; &quot;c2&quot; [(&quot;c&quot;, typeBool),(&quot;a&quot;, typeInt)] [])</span>
<span class="Comment">                   (Right [&quot;a&quot;]) &quot;t3&quot;]</span>
<span class="Comment">  ,Right [LocalBindingsLookup</span>
<span class="Comment">           [((&quot;&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;t3&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;t3&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;t3&quot;, &quot;c&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;t3&quot;, &quot;a&quot;), Right (&quot;s1&quot;, &quot;t3&quot;, &quot;a&quot;, typeInt))</span>
<span class="Comment">           ,((&quot;t3&quot;, &quot;b&quot;), Right (&quot;s1&quot;, &quot;t3&quot;, &quot;b&quot;, typeBool))</span>
<span class="Comment">           ,((&quot;t3&quot;, &quot;c&quot;), Right (&quot;s2&quot;, &quot;t3&quot;, &quot;c&quot;, typeBool))]</span>
<span class="Comment">           [(&quot;&quot;, Right [(&quot;s1&quot;, &quot;t3&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                       ,(&quot;s1&quot;, &quot;t3&quot;, &quot;b&quot;, typeBool)</span>
<span class="Comment">                       ,(&quot;s2&quot;, &quot;t3&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ,(&quot;t3&quot;, Right [(&quot;s1&quot;, &quot;t3&quot;, &quot;a&quot;, typeInt)</span>
<span class="Comment">                         ,(&quot;s1&quot;, &quot;t3&quot;, &quot;b&quot;, typeBool)</span>
<span class="Comment">                         ,(&quot;s2&quot;, &quot;t3&quot;, &quot;c&quot;, typeBool)])</span>
<span class="Comment">           ]])</span>

<span class="Comment"> ,(&quot;test composite type expansion&quot;, [LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;r&quot;, NamedCompositeType &quot;pg_attrdef&quot;)] []]</span>
<span class="Comment">  ,ctExpand (NamedCompositeType &quot;pg_attrdef&quot;))</span>
<span class="Comment"> ,let t = CompositeType ctFields</span>
<span class="Comment">  in (&quot;test composite type expansion ct&quot;, [LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;r&quot;, t)] []]</span>
<span class="Comment">     ,ctExpand t)</span>
<span class="Comment"> ,let t = PgRecord $ Just $ NamedCompositeType &quot;pg_attrdef&quot;</span>
<span class="Comment">  in (&quot;test composite type expansion rec&quot;, [LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;r&quot;, t)] []]</span>
<span class="Comment">     ,ctExpand t)</span>
<span class="Comment"> ,let t = PgRecord $ Just $ CompositeType ctFields</span>
<span class="Comment">  in (&quot;test composite type expansion rec&quot;, [LBIds &quot;s1&quot; &quot;c1&quot; [(&quot;r&quot;, t)] []]</span>
<span class="Comment">     ,ctExpand t)-}</span></pre></div></div></div><pre
    ><code
      ><br
	 />  join update: join col type tests + incompatible, missing ol
? 4 layers no aliases
? 3 way with alias on inner1
non join field ambiguous name

joinids no common, no alias, no using list
  4 layers no aliases
  error missing field in join list
    imcompatible types
  non join field ambiguous name
  3 way join with alias on inner

chaos=# create view t as select * from (select 1 as a, 2 as a) b;
ERROR:  column &quot;a&quot; specified more than once

but

chaos=# select * from (select 1 as a, 2 as a) b;
 a | a
---+---
 1 | 2
(1 row)

chaos=# select b.* from (select 1 as a, 2 as a) b;
 a | a
---+---
 1 | 2
(1 row)
</code
      ></pre
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">  <span class="Symbol">]</span> <span class="Symbol">-}</span> <span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="Comment">{-ctFields = [(&quot;adrelid&quot;,ScalarType &quot;oid&quot;)</span>
<span class="Comment">               ,(&quot;adnum&quot;,ScalarType &quot;int2&quot;)</span>
<span class="Comment">               ,(&quot;adbin&quot;,ScalarType &quot;text&quot;)</span>
<span class="Comment">               ,(&quot;adsrc&quot;,ScalarType &quot;text&quot;)]</span>
<span class="Comment">    ctExpand t =</span>
<span class="Comment">       Right [LocalBindingsLookup</span>
<span class="Comment">           [((&quot;&quot;,&quot;r&quot;),Right (&quot;s1&quot;,&quot;c1&quot;,&quot;r&quot;,t))</span>
<span class="Comment">            ,((&quot;c1&quot;,&quot;r&quot;),Right (&quot;s1&quot;,&quot;c1&quot;,&quot;r&quot;,t))</span>
<span class="Comment">            ,((&quot;r&quot;,&quot;adrelid&quot;),Right (&quot;s1&quot;,&quot;r&quot;,&quot;adrelid&quot;,ScalarType &quot;oid&quot;))</span>
<span class="Comment">            ,((&quot;r&quot;,&quot;adnum&quot;),Right (&quot;s1&quot;,&quot;r&quot;,&quot;adnum&quot;,ScalarType &quot;int2&quot;))</span>
<span class="Comment">            ,((&quot;r&quot;,&quot;adbin&quot;),Right (&quot;s1&quot;,&quot;r&quot;,&quot;adbin&quot;,ScalarType &quot;text&quot;))</span>
<span class="Comment">            ,((&quot;r&quot;,&quot;adsrc&quot;),Right (&quot;s1&quot;,&quot;r&quot;,&quot;adsrc&quot;,ScalarType &quot;text&quot;))]</span>
<span class="Comment">           [(&quot;&quot;,Right [(&quot;s1&quot;,&quot;c1&quot;,&quot;r&quot;,t)])</span>
<span class="Comment">           ,(&quot;c1&quot;,Right [(&quot;s1&quot;,&quot;c1&quot;,&quot;r&quot;,t)])</span>
<span class="Comment">           ,(&quot;r&quot;,Right [(&quot;s1&quot;,&quot;r&quot;,&quot;adrelid&quot;,ScalarType &quot;oid&quot;)</span>
<span class="Comment">                       ,(&quot;s1&quot;,&quot;r&quot;,&quot;adnum&quot;,ScalarType &quot;int2&quot;)</span>
<span class="Comment">                       ,(&quot;s1&quot;,&quot;r&quot;,&quot;adbin&quot;,ScalarType &quot;text&quot;)</span>
<span class="Comment">                       ,(&quot;s1&quot;,&quot;r&quot;,&quot;adsrc&quot;,ScalarType &quot;text&quot;)])</span>
<span class="Comment">           ]]-}</span></pre></div></div></div><hr
     /><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">testLookups</span> <span class="Symbol">::</span> <span class="ConId">String</span>
            <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">LocalBindingsUpdate</span><span class="Symbol">]</span>
            <span class="Symbol">-&gt;</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">[</span><span class="ConId">LocalBindingsLookup</span><span class="Symbol">]</span>
            <span class="Symbol">-&gt;</span> <span class="ConId">Test.Framework.Test</span>
<span class="Function">testLookups</span> <span class="VarId">n</span> <span class="VarId">lbus</span> <span class="VarId">lkps</span> <span class="Symbol">=</span> <span class="VarId">testCase</span> <span class="VarId">n</span> <span class="Symbol">$</span> <span class="Keyword">do</span>
    <span class="Keyword">let</span> <span class="VarId">lkps1</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
                <span class="Symbol">(</span><span class="ConId">LocalBindings</span> <span class="VarId">_</span> <span class="VarId">lkpsx</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">foldM</span> <span class="Symbol">(</span><span class="VarId">flip</span> <span class="Symbol">$</span> <span class="VarId">lbUpdate</span> <span class="VarId">defaultTemplate1Catalog</span><span class="Symbol">)</span> <span class="VarId">emptyBindings</span> <span class="VarId">lbus</span>
                <span class="VarId">return</span> <span class="VarId">lkpsx</span>
    <span class="VarId">when</span> <span class="Symbol">(</span><span class="VarId">lkps</span> <span class="Symbol">/=</span> <span class="VarId">lkps1</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">liftIO</span> <span class="Symbol">$</span> <span class="VarId">putStrLn</span> <span class="Symbol">$</span> <span class="String">&quot;expected &quot;</span> <span class="Symbol">++</span> <span class="VarId">showRes</span> <span class="VarId">lkps</span>
                                        <span class="Symbol">++</span> <span class="String">&quot;\ngot: &quot;</span> <span class="Symbol">++</span> <span class="VarId">showRes</span> <span class="VarId">lkps1</span>
    <span class="VarId">liftIO</span> <span class="Symbol">$</span> <span class="VarId">assertEqual</span> <span class="Symbol">(</span><span class="String">&quot;check&quot;</span><span class="Symbol">)</span> <span class="VarId">lkps</span> <span class="VarId">lkps1</span>
    <span class="Keyword">where</span>
      <span class="VarId">showRes</span> <span class="Symbol">::</span> <span class="ConId">Either</span> <span class="Symbol">[</span><span class="ConId">TypeError</span><span class="Symbol">]</span> <span class="Symbol">[</span><span class="ConId">LocalBindingsLookup</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
      <span class="VarId">showRes</span> <span class="VarId">e</span> <span class="Symbol">=</span> <span class="VarId">either</span> <span class="VarId">show</span> <span class="VarId">showLkps</span> <span class="VarId">e</span>
      <span class="VarId">showLkps</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">LocalBindingsLookup</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
      <span class="VarId">showLkps</span> <span class="VarId">ls</span> <span class="Symbol">=</span> <span class="VarId">concatMap</span> <span class="VarId">ppLbls</span> <span class="VarId">ls</span>

<span class="Function">itemToTft</span> <span class="Symbol">::</span> <span class="ConId">Item</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Test.Framework.Test</span><span class="Symbol">]</span>
<span class="Function">itemToTft</span> <span class="Symbol">(</span><span class="ConId">Item</span> <span class="VarId">es</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="Symbol">(\(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">testLookups</span> <span class="VarId">a</span> <span class="VarId">b</span> <span class="VarId">c</span><span class="Symbol">)</span> <span class="VarId">es</span>
<span class="Function">itemToTft</span> <span class="Symbol">(</span><span class="ConId">Group</span> <span class="VarId">s</span> <span class="VarId">is</span><span class="Symbol">)</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="VarId">testGroup</span> <span class="VarId">s</span> <span class="Symbol">$</span> <span class="VarId">concatMap</span> <span class="VarId">itemToTft</span> <span class="VarId">is</span><span class="Symbol">]</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
