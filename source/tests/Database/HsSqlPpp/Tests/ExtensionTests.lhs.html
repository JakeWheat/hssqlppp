<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >ExtensionTests</title
    ><link href="../../../../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../../../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >Set of tests for the old chaosextensions, in the process of being replaced</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE RankNTypes,FlexibleContexts #-}</span>

<span class="Keyword">module</span> <span class="ConId">Database.HsSqlPpp.Tests.ExtensionTests</span> <span class="Symbol">(</span><span class="VarId">extensionTests</span><span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Test.HUnit</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework</span>
<span class="Keyword">import</span> <span class="ConId">Test.Framework.Providers.HUnit</span>
<span class="Comment">--import Debug.Trace</span>

<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Parser</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Annotation</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Examples.ChaosExtensions</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Ast</span>
<span class="Comment">--import Database.HsSqlPpp.PrettyPrinter.PrettyPrinter</span>

<span class="Function">extensionTests</span> <span class="Symbol">::</span> <span class="ConId">Test.Framework.Test</span>
<span class="Function">extensionTests</span> <span class="Symbol">=</span>
  <span class="VarId">testGroup</span> <span class="String">&quot;extensionTests&quot;</span> <span class="Symbol">(</span><span class="VarId">mapCheckExtension</span> <span class="Symbol">[</span>
    <span class="VarId">t</span> <span class="VarId">rewriteCreateVars</span>
      <span class="String">&quot;select create_var('varname','vartype');&quot;</span>
      <span class="String">&quot;create table varname_table (\n\
      \  varname vartype);\n\
      \create function get_varname() returns vartype as $a$\n\
      \  select * from varname_table;\n\
      \$a$ language sql stable;\n\
      \create function check_con_varname_table_varname_key() returns boolean as $a$\n\
      \begin\n\
      \  return true;\n\
      \end;\n\
      \$a$ language plpgsql stable;\n\
      \/*drop function if exists varname_table_constraint_trigger_operator();\n\
      \create function varname_table_constraint_trigger_operator() returns trigger as $a$\n\
      \begin\n\
      \  null;\n\
      \end;\n\
      \$a$ language plpgsql;*/\n\
      \create function check_con_varname_table_01_tuple() returns boolean as $a$\n\
      \begin\n\
      \  return true;\n\
      \end;\n\
      \$a$ language plpgsql stable;\n\
      \drop function if exists varname_table_constraint_trigger_operator();\n\
      \create function varname_table_constraint_trigger_operator() returns trigger as $a$\n\
      \begin\n\
      \  null;\n\
      \end;\n\
      \$a$ language plpgsql;&quot;</span>

   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">addReadonlyTriggers</span>
      <span class="String">&quot;select set_relvar_type('stuff','readonly');&quot;</span>
      <span class="String">&quot;create function check_stuff_d_readonly() returns trigger as $a$\n\
      \begin\n\
      \  if (not (false)) then\n\
      \    raise exception 'delete on base_relvar_metadata violates transition constraint base_relvar_metadata_d_readonly';\n\
      \  end if;\n\
      \return null;\n\
      \end;\n\
      \$a$ language plpgsql volatile;\n\
      \create function check_stuff_i_readonly() returns trigger as $a$\n\
      \begin\n\
      \  if (not (false)) then\n\
      \       raise exception 'delete on base_relvar_metadata violates transition constraint base_relvar_metadata_d_readonly';\n\
      \  end if;\n\
      \  return null;\n\
      \end;\n\
      \$a$ language plpgsql volatile;\n\
      \create function check_stuff_u_readonly() returns trigger as $a$\n\
      \begin\n\
      \  if (not (false)) then\n\
      \       raise exception 'delete on base_relvar_metadata violates transition constraint base_relvar_metadata_d_readonly';\n\
      \  end if;\n\
      \  return null;\n\
      \end;\n\
      \$a$ language plpgsql volatile;&quot;</span>

   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">createClientActionWrapper</span>
      <span class="String">&quot;select create_client_action_wrapper('actname', $$actcall()$$);&quot;</span>
      <span class="String">&quot;create function action_actname() returns void as $a$\n\
      \begin\n\
      \  perform action_actcall();\n\
      \end;\n\
      \$a$ language plpgsql;&quot;</span>
   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">createClientActionWrapper</span>
      <span class="String">&quot;select create_client_action_wrapper('actname', $$actcall('test')$$);&quot;</span>
      <span class="String">&quot;create function action_actname() returns void as $a$\n\
      \begin\n\
      \  perform action_actcall('test');\n\
      \end;\n\
      \$a$ language plpgsql;&quot;</span>
   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">addNotifyTriggers</span>
      <span class="String">&quot;select set_relvar_type('stuff','data');&quot;</span>
      <span class="String">&quot;create function stuff_changed() returns trigger as $a$\n\
      \begin\n\
      \  notify stuff;\n\
      \  return null;\n\
      \end;\n\
      \$a$ language plpgsql;&quot;</span>
   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">addConstraint</span>
      <span class="String">&quot;select add_constraint('name', 'true', array['t1', 't2']);&quot;</span>
      <span class="String">&quot;create function check_con_name() returns boolean as $a$\n\
      \begin\n\
      \  return true;\n\
      \end;\n\
      \$a$ language plpgsql stable;\n\
      \drop function if exists t1_constraint_trigger_operator();\n\
      \create function t1_constraint_trigger_operator() returns trigger as $a$\n\
      \begin\n\
      \  null;\n\
      \end;\n\
      \$a$ language plpgsql;\n\
      \drop function if exists t2_constraint_trigger_operator();\n\
      \create function t2_constraint_trigger_operator() returns trigger as $a$\n\
      \begin\n\
      \  null;\n\
      \end;\n\
      \$a$ language plpgsql;&quot;</span>
   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">addKey</span>
      <span class="String">&quot;select add_key('tbl', 'attr');&quot;</span>
      <span class="String">&quot;create function check_con_tbl_attr_key() returns boolean as $a$\n\
      \begin\n\
      \  return true;\n\
      \end;\n\
      \$a$ language plpgsql stable;\n\
      \/*drop function if exists tbl_constraint_trigger_operator();\n\
      \create function tbl_constraint_trigger_operator() returns trigger as $a$\n\
      \begin\n\
      \  null;\n\
      \end;\n\
      \$a$ language plpgsql;*/&quot;</span>
   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">addKey</span>
      <span class="String">&quot;select add_key('tbl', array['attr1','attr2']);&quot;</span>
      <span class="String">&quot;create function check_con_tbl_attr1_attr2_key() returns boolean as $a$\n\
      \begin\n\
      \  return true;\n\
      \end;\n\
      \$a$ language plpgsql stable;\n\
      \/*drop function if exists tbl_constraint_trigger_operator();\n\
      \create function tbl_constraint_trigger_operator() returns trigger as $a$\n\
      \begin\n\
      \  null;\n\
      \end;\n\
      \$a$ language plpgsql;*/&quot;</span>
   <span class="Symbol">,</span><span class="VarId">t</span> <span class="VarId">zeroOneTuple</span>
      <span class="String">&quot;select constrain_to_zero_or_one_tuple('tbl');&quot;</span>
      <span class="String">&quot;create function check_con_tbl_01_tuple() returns boolean as $a$\n\
      \begin\n\
      \  return true;\n\
      \end;\n\
      \$a$ language plpgsql stable;\n\
      \drop function if exists tbl_constraint_trigger_operator();\n\
      \create function tbl_constraint_trigger_operator() returns trigger as $a$\n\
      \begin\n\
      \  null;\n\
      \end;\n\
      \$a$ language plpgsql;&quot;</span>

<span class="Comment">-- add_foreign_key</span>
<span class="Comment">-- constrain zero one</span>
<span class="Comment">-- add constraint</span>

   <span class="Symbol">])</span>

  <span class="Keyword">where</span>
    <span class="VarId">t</span> <span class="VarId">a</span> <span class="VarId">b</span> <span class="VarId">c</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">)</span>
    <span class="VarId">mapCheckExtension</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="Symbol">(\(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">b</span><span class="Symbol">,</span><span class="VarId">c</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span>  <span class="VarId">checkExtension</span> <span class="VarId">a</span> <span class="VarId">b</span> <span class="VarId">c</span><span class="Symbol">)</span>
    <span class="VarId">checkExtension</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">StatementList</span> <span class="Symbol">-&gt;</span> <span class="ConId">StatementList</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Test.Framework.Test</span>
    <span class="VarId">checkExtension</span> <span class="VarId">f</span> <span class="VarId">stxt</span> <span class="VarId">ttxt</span> <span class="Symbol">=</span> <span class="VarId">testCase</span> <span class="Symbol">(</span><span class="String">&quot;check &quot;</span> <span class="Symbol">++</span> <span class="VarId">stxt</span><span class="Symbol">)</span> <span class="Symbol">$</span>
      <span class="Keyword">case</span> <span class="Symbol">(</span><span class="Keyword">do</span>
            <span class="VarId">sast</span> <span class="Symbol">&lt;-</span> <span class="VarId">parseSql</span> <span class="String">&quot;&quot;</span> <span class="VarId">stxt</span>
            <span class="Keyword">let</span> <span class="VarId">esast</span> <span class="Symbol">=</span> <span class="VarId">f</span> <span class="VarId">sast</span>
            <span class="Comment">--trace (printSql esast) $ return ()</span>
            <span class="VarId">tast</span> <span class="Symbol">&lt;-</span> <span class="VarId">parseSql</span> <span class="String">&quot;&quot;</span> <span class="VarId">ttxt</span>
            <span class="VarId">return</span> <span class="Symbol">(</span><span class="VarId">tast</span><span class="Symbol">,</span><span class="VarId">esast</span><span class="Symbol">))</span> <span class="Keyword">of</span>
        <span class="ConId">Left</span> <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">assertFailure</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">e</span>
        <span class="ConId">Right</span> <span class="Symbol">(</span><span class="VarId">ts</span><span class="Symbol">,</span><span class="VarId">es</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">assertEqual</span> <span class="String">&quot;&quot;</span> <span class="Symbol">(</span><span class="VarId">stripAnnotations</span> <span class="VarId">ts</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="VarId">stripAnnotations</span> <span class="VarId">es</span><span class="Symbol">)</span></pre></div></div></div><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
