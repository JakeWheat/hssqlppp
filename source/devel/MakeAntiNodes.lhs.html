<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
><head
  ><title
    >MakeAntiNodes</title
    ><link href="../../main.css" rel="stylesheet" type="text/css"
     /></head
  ><body
  ><div class="header"
    ><a href="../../index.txt.html"
      >HsSqlPpp-0.3.0</a
      ></div
    ><br
     /><br
     /><br
     /><p
    >The purpose of this code is to automatically generate a copy of the ast data structures from AstInternal.ag, and produce a new set of data types with some support for anti quotation nodes stuck in.</p
    ><p
    >Then, generate a transform which takes the new nodes and converts them to the original nodes, returning an error if an antinodes are in the tree.</p
    ><p
    >This code is seriously unreadable. Investigate using haskell-src-meta or something similar to parse and obtain template haskell ast, which can then use th, quasiquotation to make the pattern matching and code generation much clearer. If can get this working, use same approach for preprocessors examples for typesafe database access.</p
    ><p
    >The code is quite fragile and depends on the exact style (or lack of) of coding used in AstInternal.ag.</p
    ><p
    >Run this from ghci:</p
    ><p
    >change to the folder with the cabal file in run ghci enter: :set -isrc/lib:src/postgresql:examples/util :l &quot;devel/MakeAntiNodes.lhs&quot; writeAntiNodes</p
    ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Comment">{-# LANGUAGE QuasiQuotes #-}</span>
<span class="Keyword">module</span> <span class="ConId">MakeAntiNodes</span> <span class="Symbol">(</span><span class="VarId">writeAntiNodes</span><span class="Symbol">)</span> <span class="Keyword">where</span>

<span class="Keyword">import</span> <span class="ConId">Language.Haskell.Exts</span> <span class="Keyword">hiding</span> <span class="Symbol">(</span><span class="ConId">String</span><span class="Symbol">)</span>
<span class="Keyword">import</span> <span class="Keyword">qualified</span> <span class="ConId">Language.Haskell.Exts</span> <span class="Keyword">as</span> <span class="ConId">Exts</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics</span>
<span class="Keyword">import</span> <span class="ConId">Data.Generics.Uniplate.Data</span>
<span class="Keyword">import</span> <span class="ConId">Data.Char</span>
<span class="Keyword">import</span> <span class="ConId">Data.Maybe</span>
<span class="Keyword">import</span> <span class="ConId">Control.Monad</span>
<span class="Keyword">import</span> <span class="ConId">Data.List</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.Here</span>
<span class="Keyword">import</span> <span class="ConId">Database.HsSqlPpp.Utils.PPExpr</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">writeAntiNodes</span> <span class="Symbol">::</span> <span class="ConId">IO</span><span class="Symbol">()</span>
<span class="Function">writeAntiNodes</span> <span class="Symbol">=</span> <span class="VarId">makeAntiNodes</span> <span class="Symbol">&gt;&gt;=</span> <span class="VarId">writeFile</span> <span class="String">&quot;src/lib/Database/HsSqlPpp/AstInternals/AstAnti.hs&quot;</span></pre></div></div></div><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode">
<span class="Function">preamble</span> <span class="Symbol">::</span> <span class="ConId">String</span>
<span class="Function">preamble</span> <span class="Symbol">=</span> <span class="Symbol">[$</span><span class="VarId">here</span><span class="Symbol">|</span>
<span class="Comment">{-</span>
<span class="Comment">This file is autogenerated, to generate: load this file (MakeAntiNodes.lhs)</span>
<span class="Comment">into ghci and run:</span>

<span class="Comment">writeAntiNodes</span>

<span class="Comment">The path might need tweaking.</span>

<span class="Comment">-}</span>
<span class="Symbol">|]</span> <span class="Symbol">++</span> <span class="String">&quot;\n&quot;</span>

<span class="Function">nodesToAntificate</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span>
<span class="Function">nodesToAntificate</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="String">&quot;Expression&quot;</span><span class="Symbol">,</span> <span class="String">&quot;TriggerEvent&quot;</span><span class="Symbol">,</span> <span class="String">&quot;Statement&quot;</span><span class="Symbol">]</span>

<span class="Function">makeAntiNodes</span> <span class="Symbol">::</span> <span class="ConId">IO</span> <span class="ConId">String</span>
<span class="Function">makeAntiNodes</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">ast</span> <span class="Symbol">&lt;-</span> <span class="VarId">pf</span> <span class="String">&quot;src/lib/Database/HsSqlPpp/AstInternals/AstInternal.hs&quot;</span>
  <span class="Comment">--ast1 &lt;- pf &quot;Database/HsSqlPpp/AstInternals/AstAnti.hs&quot;</span>
  <span class="Comment">--trace (ppExpr ast) $ return ()</span>
  <span class="Comment">-- get the interesting declarations out</span>
  <span class="Keyword">let</span> <span class="VarId">ndecls</span> <span class="Symbol">=</span> <span class="Symbol">[(</span><span class="VarId">n</span><span class="Symbol">,</span><span class="VarId">d</span><span class="Symbol">)</span> <span class="Symbol">|</span> <span class="VarId">d</span><span class="Symbol">@(</span><span class="ConId">DataDecl</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">,</span>
               <span class="VarId">not</span> <span class="Symbol">(</span><span class="VarId">isGeneratedName</span> <span class="VarId">n</span><span class="Symbol">)]</span>
              <span class="Symbol">++</span> <span class="Symbol">[(</span><span class="VarId">n</span><span class="Symbol">,</span><span class="VarId">d</span><span class="Symbol">)</span> <span class="Symbol">|</span> <span class="VarId">d</span><span class="Symbol">@(</span><span class="ConId">TypeDecl</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">,</span>
                  <span class="VarId">not</span> <span class="Symbol">(</span><span class="VarId">isGeneratedName</span> <span class="VarId">n</span><span class="Symbol">)]</span>
  <span class="Comment">--mapM_ putStrLn $ map fst ndecls</span>
  <span class="Keyword">let</span> <span class="VarId">decls</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">snd</span> <span class="VarId">ndecls</span>
  <span class="Comment">-- create the conversion functions</span>
  <span class="Keyword">let</span> <span class="VarId">convs</span> <span class="Symbol">=</span> <span class="VarId">concatMap</span> <span class="Symbol">(</span><span class="VarId">makeConvertor</span> <span class="Symbol">$</span> <span class="VarId">map</span> <span class="VarId">fst</span> <span class="VarId">ndecls</span><span class="Symbol">)</span> <span class="VarId">decls</span>
  <span class="Comment">-- add the anti parts and return</span>
  <span class="VarId">return</span> <span class="Symbol">$</span> <span class="VarId">preamble</span> <span class="Symbol">++</span>
           <span class="VarId">prettyPrint</span>
            <span class="Symbol">(</span><span class="VarId">makeModule</span> <span class="Symbol">(</span><span class="VarId">exports</span> <span class="VarId">ast</span><span class="Symbol">)</span>
                       <span class="Symbol">(</span><span class="VarId">publicConversions</span>
                        <span class="Symbol">++</span> <span class="VarId">addAntis</span> <span class="VarId">decls</span>
                        <span class="Symbol">++</span> <span class="VarId">addAntis</span> <span class="VarId">convs</span><span class="Symbol">))</span>
  <span class="Keyword">where</span>
    <span class="Comment">-- todo: match the exact uuagc generated names here</span>
    <span class="VarId">isGeneratedName</span> <span class="VarId">n</span> <span class="Symbol">=</span> <span class="Char">'_'</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">n</span> <span class="Symbol">||</span> <span class="VarId">n</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="Symbol">[</span><span class="String">&quot;Root&quot;</span><span class="Symbol">,</span> <span class="String">&quot;ExpressionRoot&quot;</span><span class="Symbol">,</span> <span class="String">&quot;ParamName&quot;</span><span class="Symbol">]</span>

<span class="Function">pf</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">IO</span> <span class="ConId">Module</span>
<span class="Function">pf</span> <span class="VarId">f</span> <span class="Symbol">=</span> <span class="Keyword">do</span>
  <span class="VarId">x</span> <span class="Symbol">&lt;-</span> <span class="VarId">parseFileWithMode</span> <span class="VarId">pm</span> <span class="VarId">f</span>
  <span class="Keyword">case</span> <span class="VarId">x</span> <span class="Keyword">of</span>
        <span class="ConId">ParseOk</span> <span class="VarId">ast</span> <span class="Symbol">-&gt;</span> <span class="VarId">return</span> <span class="VarId">ast</span>
        <span class="VarId">e</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="VarId">show</span> <span class="VarId">e</span>
  <span class="Keyword">where</span>
    <span class="VarId">pm</span> <span class="Symbol">=</span> <span class="VarId">defaultParseMode</span> <span class="Symbol">{</span>
           <span class="VarId">parseFilename</span> <span class="Symbol">=</span> <span class="VarId">f</span>
         <span class="Symbol">,</span><span class="VarId">extensions</span> <span class="Symbol">=</span> <span class="Symbol">[</span><span class="ConId">PatternGuards</span><span class="Symbol">,</span><span class="ConId">ScopedTypeVariables</span><span class="Symbol">]}</span></pre></div></div></div><div id="node-conversions"
    ><h2
      >node conversions</h2
      ><p
      >pass in the list of type names from astinternal so we know which types use a conversion function and which don't when recursing the conversions</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">makeConvertor</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Decl</span><span class="Symbol">]</span>
<span class="Function">makeConvertor</span> <span class="VarId">ts</span> <span class="VarId">d</span> <span class="Symbol">=</span>
  <span class="Symbol">[</span><span class="VarId">makeConvTypeSig</span> <span class="VarId">n</span><span class="Symbol">,</span> <span class="VarId">fromJust</span> <span class="VarId">makeConv</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">makeConv</span> <span class="Symbol">=</span> <span class="VarId">msum</span> <span class="Symbol">[</span>
                <span class="VarId">convertPair</span> <span class="VarId">ts</span> <span class="VarId">d</span>
               <span class="Symbol">,</span><span class="VarId">convertMaybe</span> <span class="VarId">d</span>
               <span class="Symbol">,</span><span class="VarId">convertList</span> <span class="VarId">ts</span> <span class="VarId">d</span>
               <span class="Symbol">,</span><span class="VarId">convertSum</span> <span class="VarId">ts</span> <span class="VarId">d</span>
               <span class="Symbol">,</span><span class="VarId">error</span> <span class="String">&quot;makeConvertor - no convertor found&quot;</span><span class="Symbol">]</span> <span class="Comment">-- Just $ makeUndefined n]</span>
    <span class="VarId">n</span> <span class="Symbol">=</span> <span class="VarId">getDeclName</span> <span class="VarId">d</span>

<span class="Function">makeConvTypeSig</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Decl</span>
<span class="Function">makeConvTypeSig</span> <span class="VarId">s</span> <span class="Symbol">=</span>
  <span class="ConId">TypeSig</span> <span class="VarId">nsrc</span>
          <span class="Symbol">[</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">s</span><span class="Symbol">]</span>
          <span class="Symbol">(</span><span class="ConId">TyFun</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">s</span><span class="Symbol">)))</span>
           <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">Qual</span> <span class="Symbol">(</span><span class="ConId">ModuleName</span> <span class="String">&quot;A&quot;</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">s</span><span class="Symbol">))))</span>


<span class="Comment">{-makeUndefined :: String -&gt; Decl</span>
<span class="Comment">makeUndefined s =</span>
<span class="Comment">  PatBind nsrc</span>
<span class="Comment">          (PVar (Ident $ lowerFirst s))</span>
<span class="Comment">          Nothing</span>
<span class="Comment">          (UnGuardedRhs (Var (UnQual (Ident &quot;undefined&quot;))))</span>
<span class="Comment">          (BDecls [])-}</span>

<span class="Function">convertPair</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">Decl</span>
<span class="Function">convertPair</span> <span class="VarId">ts</span> <span class="Symbol">(</span><span class="ConId">TypeDecl</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">[]</span>
             <span class="Symbol">(</span><span class="ConId">TyTuple</span> <span class="ConId">Boxed</span>
                 <span class="Symbol">[</span><span class="ConId">TyParen</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">t1</span><span class="Symbol">))),</span>
                  <span class="ConId">TyParen</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">t2</span><span class="Symbol">)))]))</span> <span class="Symbol">=</span>
            <span class="ConId">Just</span> <span class="Symbol">$</span> <span class="ConId">FunBind</span>
     <span class="Symbol">[</span><span class="ConId">Match</span> <span class="VarId">nsrc</span>
        <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">t</span><span class="Symbol">)</span>
        <span class="Symbol">[</span><span class="ConId">PTuple</span> <span class="Symbol">[</span><span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;a&quot;</span><span class="Symbol">),</span> <span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;b&quot;</span><span class="Symbol">)]]</span>
        <span class="ConId">Nothing</span>
        <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span>
           <span class="Symbol">(</span><span class="ConId">Tuple</span>
              <span class="Symbol">[</span><span class="VarId">convName</span> <span class="VarId">ts</span> <span class="VarId">t1</span> <span class="String">&quot;a&quot;</span>
              <span class="Symbol">,</span><span class="VarId">convName</span> <span class="VarId">ts</span> <span class="VarId">t2</span> <span class="String">&quot;b&quot;</span><span class="Symbol">]))</span>
        <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])]</span>
<span class="Function">convertPair</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>

<span class="Function">convertMaybe</span> <span class="Symbol">::</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">Decl</span>
<span class="Function">convertMaybe</span> <span class="Symbol">(</span><span class="ConId">TypeDecl</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">[]</span>
                 <span class="Symbol">(</span><span class="ConId">TyParen</span>
                  <span class="Symbol">(</span><span class="ConId">TyApp</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;Maybe&quot;</span><span class="Symbol">)))</span>
                   <span class="Symbol">(</span><span class="ConId">TyParen</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">t1</span><span class="Symbol">)))))))</span> <span class="Symbol">=</span>
             <span class="ConId">Just</span> <span class="Symbol">$</span> <span class="ConId">PatBind</span> <span class="VarId">nsrc</span>
                      <span class="Symbol">(</span><span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">t</span><span class="Symbol">))</span>
                      <span class="ConId">Nothing</span>
                      <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span>
                       <span class="Symbol">(</span><span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;fmap&quot;</span><span class="Symbol">)))</span>
                                <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">t1</span><span class="Symbol">)))))</span>
                      <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])</span>
<span class="Function">convertMaybe</span> <span class="VarId">_</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>

<span class="Function">convertList</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">Decl</span>
<span class="Function">convertList</span> <span class="VarId">ts</span> <span class="Symbol">(</span><span class="ConId">TypeDecl</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">[]</span>
             <span class="Symbol">(</span><span class="ConId">TyList</span> <span class="Symbol">(</span><span class="ConId">TyParen</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">t1</span><span class="Symbol">))))))</span>
             <span class="Symbol">|</span> <span class="VarId">t1</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">ts</span> <span class="Symbol">=</span>
                 <span class="ConId">Just</span> <span class="Symbol">$</span> <span class="ConId">PatBind</span> <span class="VarId">nsrc</span>
                          <span class="Symbol">(</span><span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">t</span><span class="Symbol">))</span>
                          <span class="ConId">Nothing</span>
                          <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span>
                           <span class="Symbol">(</span><span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;fmap&quot;</span><span class="Symbol">)))</span>
                                    <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">t1</span><span class="Symbol">)))))</span>
                          <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])</span>
             <span class="Symbol">|</span> <span class="VarId">otherwise</span> <span class="Symbol">=</span>
                <span class="ConId">Just</span> <span class="Symbol">$</span> <span class="ConId">PatBind</span> <span class="VarId">nsrc</span>
                         <span class="Symbol">(</span><span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">t</span><span class="Symbol">))</span>
                         <span class="ConId">Nothing</span>
                         <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;id&quot;</span><span class="Symbol">))))</span>
                         <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])</span>
<span class="Function">convertList</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span>


<span class="Function">convertSum</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="ConId">Maybe</span> <span class="ConId">Decl</span>
<span class="Function">convertSum</span> <span class="VarId">ts</span> <span class="VarId">d</span> <span class="Symbol">=</span>
  <span class="Keyword">let</span> <span class="VarId">is</span> <span class="Symbol">=</span> <span class="VarId">getCtors</span> <span class="VarId">d</span>
      <span class="VarId">f</span> <span class="Symbol">=</span> <span class="VarId">getDeclName</span> <span class="VarId">d</span>
  <span class="Keyword">in</span> <span class="ConId">Just</span> <span class="Symbol">$</span> <span class="ConId">FunBind</span>
     <span class="Symbol">[</span><span class="ConId">Match</span> <span class="VarId">nsrc</span>
        <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">f</span><span class="Symbol">)</span>
        <span class="Symbol">[</span><span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;x&quot;</span><span class="Symbol">)]</span>
        <span class="ConId">Nothing</span>
        <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span>
           <span class="Symbol">(</span><span class="ConId">Case</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;x&quot;</span><span class="Symbol">)))</span>
              <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(</span><span class="VarId">uncurry</span> <span class="VarId">mkAlt</span><span class="Symbol">)</span> <span class="VarId">is</span><span class="Symbol">)))</span>
        <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])]</span>
  <span class="Keyword">where</span>
    <span class="VarId">mkAlt</span> <span class="VarId">c</span> <span class="VarId">cis</span> <span class="Symbol">=</span> <span class="Keyword">let</span> <span class="VarId">anames</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="Symbol">((</span><span class="String">&quot;a&quot;</span><span class="Symbol">++)</span> <span class="Symbol">.</span> <span class="VarId">show</span> <span class="Symbol">.</span> <span class="VarId">snd</span><span class="Symbol">)</span> <span class="Symbol">$</span> <span class="VarId">zip</span> <span class="VarId">cis</span> <span class="Symbol">[(</span><span class="Number">1</span><span class="Symbol">::</span><span class="ConId">Int</span><span class="Symbol">)..]</span>
                      <span class="VarId">ant</span> <span class="Symbol">=</span> <span class="VarId">zip</span> <span class="VarId">anames</span> <span class="VarId">cis</span>
                  <span class="Keyword">in</span> <span class="ConId">Alt</span> <span class="VarId">nsrc</span>
                  <span class="Symbol">(</span><span class="ConId">PApp</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">c</span><span class="Symbol">))</span>
                     <span class="Symbol">(</span><span class="VarId">map</span> <span class="Symbol">(</span><span class="ConId">PVar</span> <span class="Symbol">.</span> <span class="ConId">Ident</span><span class="Symbol">)</span> <span class="VarId">anames</span><span class="Symbol">))</span>
                  <span class="Symbol">(</span><span class="VarId">mkCtor</span> <span class="VarId">c</span> <span class="VarId">ant</span><span class="Symbol">)</span>
                  <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])</span>
    <span class="VarId">mkCtor</span> <span class="VarId">c</span> <span class="VarId">ant</span> <span class="Symbol">=</span>
        <span class="Keyword">let</span> <span class="VarId">elems</span> <span class="Symbol">=</span> <span class="VarId">flip</span> <span class="VarId">map</span> <span class="VarId">ant</span> <span class="Symbol">$</span> <span class="Symbol">\(</span><span class="VarId">a</span><span class="Symbol">,</span><span class="VarId">t</span><span class="Symbol">)</span> <span class="Symbol">-&gt;</span> <span class="VarId">convName</span> <span class="VarId">ts</span> <span class="VarId">t</span> <span class="VarId">a</span>
        <span class="Keyword">in</span> <span class="ConId">UnGuardedAlt</span> <span class="Symbol">$</span> <span class="VarId">foldl</span> <span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">Con</span> <span class="Symbol">(</span><span class="ConId">Qual</span> <span class="Symbol">(</span><span class="ConId">ModuleName</span> <span class="String">&quot;A&quot;</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">c</span><span class="Symbol">)))</span> <span class="VarId">elems</span>
</pre></div></div></div></div
    ><div id="utils-for-conv-generators"
    ><h2
      >utils for conv generators</h2
      ><p
      >get the constructor information for a type, in a nice simple format</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">getCtors</span> <span class="Symbol">::</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[(</span><span class="ConId">String</span><span class="Symbol">,[</span><span class="ConId">String</span><span class="Symbol">])]</span>
<span class="Function">getCtors</span> <span class="VarId">t</span> <span class="Symbol">=</span>
  <span class="Keyword">case</span> <span class="VarId">t</span> <span class="Keyword">of</span>
       <span class="ConId">DataDecl</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">ctors</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="VarId">map</span> <span class="VarId">ctorInfo</span> <span class="VarId">ctors</span>
       <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[]</span>
  <span class="Keyword">where</span>
    <span class="VarId">ctorInfo</span> <span class="Symbol">(</span><span class="ConId">QualConDecl</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">ConDecl</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="Keyword">as</span><span class="Symbol">))</span> <span class="Symbol">=</span> <span class="Symbol">(</span><span class="VarId">n</span><span class="Symbol">,</span> <span class="VarId">map</span> <span class="VarId">aInfo</span> <span class="Keyword">as</span><span class="Symbol">)</span>
    <span class="VarId">ctorInfo</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;ctorInfo &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">a</span>
    <span class="VarId">aInfo</span> <span class="Symbol">(</span><span class="ConId">UnBangedTy</span> <span class="Symbol">(</span><span class="ConId">TyParen</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">m</span><span class="Symbol">)))))</span> <span class="Symbol">=</span> <span class="VarId">m</span>
    <span class="Comment">-- bit dodgy, if we find a maybe or list, we slap this on the end of the type</span>
    <span class="Comment">-- name and hope everything works out.</span>
    <span class="Comment">-- which it does, since the types in astinternal follow this convention</span>
    <span class="Comment">-- and the convname fn helps out as well</span>
    <span class="VarId">aInfo</span> <span class="Symbol">(</span><span class="ConId">UnBangedTy</span> <span class="Symbol">(</span><span class="ConId">TyParen</span> <span class="Symbol">(</span><span class="ConId">TyList</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">m</span><span class="Symbol">))))))</span> <span class="Symbol">=</span> <span class="VarId">m</span> <span class="Symbol">++</span> <span class="String">&quot;List&quot;</span>
    <span class="VarId">aInfo</span> <span class="Symbol">(</span><span class="ConId">UnBangedTy</span> <span class="Symbol">(</span><span class="ConId">TyList</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">m</span><span class="Symbol">)))))</span> <span class="Symbol">=</span> <span class="VarId">m</span> <span class="Symbol">++</span> <span class="String">&quot;List&quot;</span>
    <span class="VarId">aInfo</span> <span class="Symbol">(</span><span class="ConId">UnBangedTy</span> <span class="Symbol">(</span><span class="ConId">TyParen</span> <span class="Symbol">(</span><span class="ConId">TyApp</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;Maybe&quot;</span><span class="Symbol">)))</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">m</span><span class="Symbol">))))))</span>
          <span class="Symbol">=</span> <span class="String">&quot;Maybe&quot;</span> <span class="Symbol">++</span> <span class="VarId">m</span>
    <span class="VarId">aInfo</span> <span class="Symbol">(</span><span class="ConId">UnBangedTy</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">s</span><span class="Symbol">))))</span> <span class="Symbol">=</span> <span class="VarId">s</span>
    <span class="VarId">aInfo</span> <span class="VarId">a</span> <span class="Symbol">=</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;aInfo &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">a</span>
</pre></div></div></div><p
      >get the conversion for a data type if it is defined in astinternal, apply the conversion function otherwise just use the value unchanged</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">convName</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">String</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">Exp</span>
<span class="Function">convName</span> <span class="VarId">ts</span> <span class="VarId">tn</span> <span class="VarId">l</span> <span class="Symbol">=</span>
  <span class="Keyword">case</span> <span class="Symbol">()</span> <span class="Keyword">of</span>
    <span class="VarId">_</span> <span class="Symbol">|</span> <span class="VarId">tn</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">ts</span> <span class="Symbol">-&gt;</span> <span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">tn</span><span class="Symbol">)))</span>
                        <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">l</span><span class="Symbol">)))</span>
      <span class="Symbol">|</span> <span class="VarId">unlist</span> <span class="Symbol">-&gt;</span> <span class="Keyword">let</span> <span class="VarId">tx</span> <span class="Symbol">=</span> <span class="VarId">upperFirst</span> <span class="VarId">unlistl</span>
                  <span class="Keyword">in</span> <span class="Keyword">if</span> <span class="VarId">tx</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">ts</span>
                     <span class="Keyword">then</span> <span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;fmap&quot;</span><span class="Symbol">)))</span>
                                       <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">unlistl</span><span class="Symbol">))))</span>
                              <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">l</span><span class="Symbol">)))</span>
                     <span class="Keyword">else</span> <span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">l</span><span class="Symbol">))</span>
      <span class="Symbol">|</span> <span class="VarId">unmaybe</span> <span class="Symbol">-&gt;</span> <span class="Keyword">let</span> <span class="VarId">tx</span> <span class="Symbol">=</span> <span class="VarId">upperFirst</span> <span class="VarId">unmaybel</span>
                   <span class="Keyword">in</span> <span class="Keyword">if</span> <span class="VarId">tx</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">ts</span>
                      <span class="Keyword">then</span> <span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;fmap&quot;</span><span class="Symbol">)))</span>
                                        <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="VarId">lowerFirst</span> <span class="VarId">tx</span><span class="Symbol">))))</span>
                               <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">l</span><span class="Symbol">)))</span>
                      <span class="Keyword">else</span> <span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">l</span><span class="Symbol">))</span>
      <span class="Symbol">|</span> <span class="VarId">otherwise</span> <span class="Symbol">-&gt;</span> <span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">l</span><span class="Symbol">))</span>
  <span class="Keyword">where</span>
    <span class="VarId">unlistl</span> <span class="Symbol">=</span> <span class="VarId">lowerFirst</span> <span class="Symbol">$</span> <span class="VarId">take</span> <span class="Symbol">(</span><span class="VarId">length</span> <span class="VarId">tn</span> <span class="Symbol">-</span> <span class="Number">4</span><span class="Symbol">)</span> <span class="VarId">tn</span>
    <span class="VarId">unlist</span> <span class="Symbol">=</span> <span class="String">&quot;List&quot;</span> <span class="Symbol">`</span><span class="VarId">isSuffixOf</span><span class="Symbol">`</span> <span class="VarId">tn</span>
    <span class="VarId">unmaybe</span> <span class="Symbol">=</span> <span class="String">&quot;Maybe&quot;</span> <span class="Symbol">`</span><span class="VarId">isPrefixOf</span><span class="Symbol">`</span> <span class="VarId">tn</span>
    <span class="VarId">unmaybel</span> <span class="Symbol">=</span> <span class="VarId">lowerFirst</span> <span class="Symbol">$</span> <span class="VarId">drop</span> <span class="Number">5</span> <span class="VarId">tn</span></pre></div></div></div><p
      >extract the name of the type being defined from a decl</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">getDeclName</span> <span class="Symbol">::</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">getDeclName</span> <span class="VarId">d</span> <span class="Symbol">=</span>
  <span class="Keyword">case</span> <span class="VarId">d</span> <span class="Keyword">of</span>
     <span class="ConId">DataDecl</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="VarId">n</span>
     <span class="ConId">TypeDecl</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">-&gt;</span> <span class="VarId">n</span>
     <span class="VarId">x</span> <span class="Symbol">-&gt;</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;getDeclName: &quot;</span> <span class="Symbol">++</span> <span class="VarId">ppExpr</span> <span class="VarId">x</span></pre></div></div></div></div
    ><div id="add-antis"
    ><h2
      >add antis</h2
      ><p
      >this is where we run over the tree and add the antictors and error messages in the conversion functions</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">addAntis</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Decl</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Decl</span><span class="Symbol">]</span>
<span class="Function">addAntis</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">antiize</span>
  <span class="Keyword">where</span>
    <span class="VarId">antiTargFns</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="VarId">lowerFirst</span> <span class="VarId">nodesToAntificate</span>
    <span class="VarId">antiize</span> <span class="VarId">d</span><span class="Symbol">@(</span><span class="ConId">FunBind</span>
              <span class="Symbol">[</span><span class="ConId">Match</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">])</span> <span class="Symbol">|</span>
                <span class="VarId">n</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">antiTargFns</span> <span class="Symbol">=</span>
                    <span class="VarId">addAntiError</span> <span class="VarId">d</span>
    <span class="VarId">antiize</span> <span class="VarId">d</span><span class="Symbol">@(</span><span class="ConId">DataDecl</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">_</span> <span class="VarId">_</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">|</span>
                <span class="VarId">n</span> <span class="Symbol">`</span><span class="VarId">elem</span><span class="Symbol">`</span> <span class="VarId">nodesToAntificate</span> <span class="Symbol">=</span>
                    <span class="VarId">addAntiCtor</span> <span class="VarId">d</span>
    <span class="VarId">antiize</span> <span class="VarId">x</span> <span class="Symbol">=</span> <span class="VarId">x</span>

<span class="Function">addAntiCtor</span> <span class="Symbol">::</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="ConId">Decl</span>
<span class="Function">addAntiCtor</span> <span class="Symbol">(</span><span class="ConId">DataDecl</span> <span class="VarId">sl</span> <span class="VarId">dn</span> <span class="VarId">ct</span> <span class="VarId">nm</span><span class="Symbol">@(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">tyv</span> <span class="VarId">qcd</span> <span class="VarId">d</span><span class="Symbol">)</span> <span class="Symbol">=</span>
  <span class="ConId">DataDecl</span> <span class="VarId">sl</span> <span class="VarId">dn</span> <span class="VarId">ct</span> <span class="VarId">nm</span> <span class="VarId">tyv</span> <span class="Symbol">(</span><span class="VarId">qcd</span> <span class="Symbol">++</span> <span class="Symbol">[</span><span class="VarId">antiCtor</span><span class="Symbol">])</span> <span class="VarId">d</span>
  <span class="Keyword">where</span>
    <span class="VarId">antiCtor</span> <span class="Symbol">=</span>
      <span class="ConId">QualConDecl</span> <span class="VarId">nsrc</span> <span class="Symbol">[]</span> <span class="Symbol">[]</span>
        <span class="Symbol">(</span><span class="ConId">ConDecl</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="String">&quot;Anti&quot;</span> <span class="Symbol">++</span> <span class="VarId">n</span><span class="Symbol">)</span>
           <span class="Symbol">[</span><span class="ConId">UnBangedTy</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;String&quot;</span><span class="Symbol">)))])</span>

<span class="Function">addAntiCtor</span> <span class="VarId">e</span> <span class="Symbol">=</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;addAntiCtor &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">e</span>

<span class="Function">addAntiError</span> <span class="Symbol">::</span> <span class="ConId">Decl</span> <span class="Symbol">-&gt;</span> <span class="ConId">Decl</span>
<span class="Function">addAntiError</span> <span class="Symbol">(</span><span class="ConId">FunBind</span>
              <span class="Symbol">[</span><span class="ConId">Match</span> <span class="VarId">sl</span> <span class="VarId">nm</span><span class="Symbol">@(</span><span class="ConId">Ident</span> <span class="VarId">n</span><span class="Symbol">)</span> <span class="VarId">pt</span> <span class="VarId">ty</span>
               <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span>
                <span class="Symbol">(</span><span class="ConId">Case</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;x&quot;</span><span class="Symbol">)))</span> <span class="VarId">alts</span><span class="Symbol">))</span>
                  <span class="VarId">bnd</span><span class="Symbol">])</span> <span class="Symbol">=</span>
  <span class="ConId">FunBind</span>
   <span class="Symbol">[</span><span class="ConId">Match</span> <span class="VarId">sl</span> <span class="VarId">nm</span> <span class="VarId">pt</span> <span class="VarId">ty</span>
    <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span>
     <span class="Symbol">(</span><span class="ConId">Case</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;x&quot;</span><span class="Symbol">)))</span> <span class="Symbol">(</span><span class="VarId">alts</span> <span class="Symbol">++</span> <span class="Symbol">[</span><span class="VarId">antiAlt</span><span class="Symbol">])))</span>
    <span class="VarId">bnd</span><span class="Symbol">]</span>
  <span class="Keyword">where</span>
    <span class="VarId">antiAlt</span> <span class="Symbol">::</span> <span class="ConId">Alt</span>
    <span class="VarId">antiAlt</span> <span class="Symbol">=</span> <span class="ConId">Alt</span> <span class="VarId">nsrc</span>
                 <span class="Symbol">(</span><span class="ConId">PApp</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="Symbol">$</span> <span class="String">&quot;Anti&quot;</span> <span class="Symbol">++</span> <span class="VarId">upperFirst</span> <span class="VarId">n</span><span class="Symbol">))</span> <span class="Symbol">[</span><span class="ConId">PWildCard</span><span class="Symbol">])</span>
                 <span class="Symbol">(</span><span class="ConId">UnGuardedAlt</span>
                    <span class="Symbol">(</span><span class="ConId">App</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;error&quot;</span><span class="Symbol">)))</span>
                       <span class="Symbol">(</span><span class="ConId">Lit</span> <span class="Symbol">(</span><span class="ConId">Exts.String</span> <span class="Symbol">$</span> <span class="String">&quot;can't convert anti &quot;</span> <span class="Symbol">++</span> <span class="VarId">n</span><span class="Symbol">))))</span>
                 <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])</span>
<span class="Function">addAntiError</span> <span class="VarId">e</span> <span class="Symbol">=</span> <span class="VarId">error</span> <span class="Symbol">$</span> <span class="String">&quot;addAntiError &quot;</span> <span class="Symbol">++</span> <span class="VarId">show</span> <span class="VarId">e</span></pre></div></div></div></div
    ><div id="boilerplate"
    ><h2
      >boilerplate</h2
      ><p
      >nice function names to be exported to do anti-&gt;vanilla ast conversions</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">publicConversions</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">Decl</span><span class="Symbol">]</span>
<span class="Function">publicConversions</span> <span class="Symbol">=</span>
  <span class="Symbol">[</span><span class="ConId">TypeSig</span>
     <span class="VarId">nsrc</span>
     <span class="Symbol">[</span><span class="ConId">Ident</span> <span class="String">&quot;convertStatements&quot;</span><span class="Symbol">]</span>
     <span class="Symbol">(</span><span class="ConId">TyFun</span> <span class="Symbol">(</span><span class="ConId">TyList</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;Statement&quot;</span><span class="Symbol">))))</span>
        <span class="Symbol">(</span><span class="ConId">TyList</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">Qual</span> <span class="Symbol">(</span><span class="ConId">ModuleName</span> <span class="String">&quot;A&quot;</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;Statement&quot;</span><span class="Symbol">))))),</span>
   <span class="ConId">PatBind</span>
     <span class="VarId">nsrc</span>
     <span class="Symbol">(</span><span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;convertStatements&quot;</span><span class="Symbol">))</span>
     <span class="ConId">Nothing</span>
     <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;statementList&quot;</span><span class="Symbol">))))</span>
     <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[]),</span>
   <span class="ConId">TypeSig</span>
     <span class="VarId">nsrc</span>
     <span class="Symbol">[</span><span class="ConId">Ident</span> <span class="String">&quot;convertExpression&quot;</span><span class="Symbol">]</span>
     <span class="Symbol">(</span><span class="ConId">TyFun</span> <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;Expression&quot;</span><span class="Symbol">)))</span>
        <span class="Symbol">(</span><span class="ConId">TyCon</span> <span class="Symbol">(</span><span class="ConId">Qual</span> <span class="Symbol">(</span><span class="ConId">ModuleName</span> <span class="String">&quot;A&quot;</span><span class="Symbol">)</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;Expression&quot;</span><span class="Symbol">)))),</span>
   <span class="ConId">PatBind</span>
     <span class="VarId">nsrc</span>
     <span class="Symbol">(</span><span class="ConId">PVar</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;convertExpression&quot;</span><span class="Symbol">))</span>
     <span class="ConId">Nothing</span>
     <span class="Symbol">(</span><span class="ConId">UnGuardedRhs</span> <span class="Symbol">(</span><span class="ConId">Var</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="String">&quot;expression&quot;</span><span class="Symbol">))))</span>
     <span class="Symbol">(</span><span class="ConId">BDecls</span> <span class="Symbol">[])]</span></pre></div></div></div><p
      >get the exports from astinternal, and keep the ones for types, and add the publi conversion functions</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">exports</span> <span class="Symbol">::</span> <span class="Symbol">(</span><span class="ConId">Data</span> <span class="VarId">a</span><span class="Symbol">)</span> <span class="Symbol">=&gt;</span> <span class="VarId">a</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">ExportSpec</span><span class="Symbol">]</span>
<span class="Function">exports</span> <span class="VarId">ast</span> <span class="Symbol">=</span> <span class="VarId">map</span> <span class="Symbol">(\</span><span class="VarId">l</span> <span class="Symbol">-&gt;</span> <span class="ConId">EVar</span> <span class="Symbol">(</span><span class="ConId">UnQual</span> <span class="Symbol">(</span><span class="ConId">Ident</span> <span class="VarId">l</span><span class="Symbol">)))</span>
                 <span class="Symbol">[</span><span class="String">&quot;convertStatements&quot;</span><span class="Symbol">,</span> <span class="String">&quot;convertExpression&quot;</span><span class="Symbol">,</span> <span class="String">&quot;attributeDef&quot;</span><span class="Symbol">]</span> <span class="Symbol">++</span>
              <span class="Symbol">[</span><span class="VarId">ex</span><span class="Symbol">|</span> <span class="VarId">ex</span><span class="Symbol">@(</span><span class="ConId">EThingAll</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">]</span> <span class="Symbol">++</span>
              <span class="Symbol">[</span><span class="VarId">ex</span><span class="Symbol">|</span> <span class="VarId">ex</span><span class="Symbol">@(</span><span class="ConId">EAbs</span> <span class="VarId">_</span><span class="Symbol">)</span> <span class="Symbol">&lt;-</span> <span class="VarId">universeBi</span> <span class="VarId">ast</span><span class="Symbol">]</span></pre></div></div></div><p
      >take all the pieces and make a complete module to be pretty printed ready for compilation</p
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">makeModule</span> <span class="Symbol">::</span> <span class="Symbol">[</span><span class="ConId">ExportSpec</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="Symbol">[</span><span class="ConId">Decl</span><span class="Symbol">]</span> <span class="Symbol">-&gt;</span> <span class="ConId">Module</span>
<span class="Function">makeModule</span> <span class="VarId">es</span> <span class="Symbol">=</span>
    <span class="ConId">Module</span> <span class="VarId">nsrc</span>
        <span class="Symbol">(</span><span class="ConId">ModuleName</span> <span class="String">&quot;Database.HsSqlPpp.AstInternals.AstAnti&quot;</span><span class="Symbol">)</span>
        <span class="Symbol">[</span><span class="ConId">LanguagePragma</span> <span class="VarId">nsrc</span>
         <span class="Symbol">[</span><span class="ConId">Ident</span> <span class="String">&quot;DeriveDataTypeable&quot;</span><span class="Symbol">]]</span>
        <span class="ConId">Nothing</span> <span class="Symbol">(</span><span class="ConId">Just</span> <span class="VarId">es</span><span class="Symbol">)</span>
        <span class="Symbol">[</span><span class="ConId">ImportDecl</span><span class="Symbol">{</span><span class="VarId">importLoc</span> <span class="Symbol">=</span> <span class="VarId">nsrc</span><span class="Symbol">,</span>
                    <span class="VarId">importModule</span> <span class="Symbol">=</span> <span class="ConId">ModuleName</span> <span class="String">&quot;Data.Generics&quot;</span><span class="Symbol">,</span>
                    <span class="VarId">importQualified</span> <span class="Symbol">=</span> <span class="ConId">False</span><span class="Symbol">,</span>
                    <span class="VarId">importSrc</span> <span class="Symbol">=</span> <span class="ConId">False</span><span class="Symbol">,</span> <span class="VarId">importPkg</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">,</span> <span class="VarId">importAs</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">,</span>
                    <span class="VarId">importSpecs</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">},</span>
         <span class="ConId">ImportDecl</span><span class="Symbol">{</span><span class="VarId">importLoc</span> <span class="Symbol">=</span> <span class="VarId">nsrc</span><span class="Symbol">,</span>
                    <span class="VarId">importModule</span> <span class="Symbol">=</span> <span class="ConId">ModuleName</span> <span class="String">&quot;Database.HsSqlPpp.AstInternals.AstAnnotation&quot;</span><span class="Symbol">,</span>
                    <span class="VarId">importQualified</span> <span class="Symbol">=</span> <span class="ConId">False</span><span class="Symbol">,</span> <span class="VarId">importSrc</span> <span class="Symbol">=</span> <span class="ConId">False</span><span class="Symbol">,</span> <span class="VarId">importPkg</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">,</span>
                    <span class="VarId">importAs</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">,</span> <span class="VarId">importSpecs</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">},</span>
         <span class="ConId">ImportDecl</span><span class="Symbol">{</span><span class="VarId">importLoc</span> <span class="Symbol">=</span>
                    <span class="VarId">nsrc</span><span class="Symbol">,</span>
                    <span class="VarId">importModule</span> <span class="Symbol">=</span> <span class="ConId">ModuleName</span> <span class="String">&quot;Database.HsSqlPpp.AstInternals.AstInternal&quot;</span><span class="Symbol">,</span>
                    <span class="VarId">importQualified</span> <span class="Symbol">=</span> <span class="ConId">True</span><span class="Symbol">,</span> <span class="VarId">importSrc</span> <span class="Symbol">=</span> <span class="ConId">False</span><span class="Symbol">,</span> <span class="VarId">importPkg</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">,</span>
                    <span class="VarId">importAs</span> <span class="Symbol">=</span> <span class="ConId">Just</span> <span class="Symbol">(</span><span class="ConId">ModuleName</span> <span class="String">&quot;A&quot;</span><span class="Symbol">),</span> <span class="VarId">importSpecs</span> <span class="Symbol">=</span> <span class="ConId">Nothing</span><span class="Symbol">}]</span></pre></div></div></div></div
    ><div id="boring-little-functions"
    ><h2
      >boring little functions</h2
      ><div class='sourceCode'><div class='literate'><div class='haskell'><pre class="sourceCode"><span class="Function">nsrc</span> <span class="Symbol">::</span> <span class="ConId">SrcLoc</span>
<span class="Function">nsrc</span> <span class="Symbol">=</span> <span class="ConId">SrcLoc</span> <span class="String">&quot;&quot;</span> <span class="Number">0</span> <span class="Number">0</span>

<span class="Function">lowerFirst</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">lowerFirst</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="VarId">toLower</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">s</span><span class="Symbol">):</span><span class="VarId">tail</span> <span class="VarId">s</span>

<span class="Function">upperFirst</span> <span class="Symbol">::</span> <span class="ConId">String</span> <span class="Symbol">-&gt;</span> <span class="ConId">String</span>
<span class="Function">upperFirst</span> <span class="VarId">s</span> <span class="Symbol">=</span> <span class="VarId">toUpper</span> <span class="Symbol">(</span><span class="VarId">head</span> <span class="VarId">s</span><span class="Symbol">):</span><span class="VarId">tail</span> <span class="VarId">s</span></pre></div></div></div></div
    ><br
     /><br
     /><br
     /><div class="footer"
    >generated on 01/29/11 20:06:46, hssqlppp-0.3.0</div
    ></body
  ></html
>
